# YOYOæµåª’ä½“å¹³å°æ¶æ„æ–‡æ¡£ V2.10

> **ç²¾ç®€æ¶æ„æ–‡æ¡£** - ä¸“æ³¨äºæ ¸å¿ƒæ¶æ„è®¾è®¡å’Œå…³é”®æŠ€æœ¯å®ç°  
> **æ›´æ–°æ—¶é—´**: 2025-11-03  
> **æ–‡æ¡£ç‰ˆæœ¬**: V2.10 - æ–°å¢Workers Cache APIæµå…±äº«æ–¹æ¡ˆï¼ŒèŠ‚çœ60-90% VPSå¸¦å®½

---

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#-é¡¹ç›®æ¦‚è¿°)
- [ç³»ç»Ÿæ¶æ„](#-ç³»ç»Ÿæ¶æ„)
- [æ¶æ„ä¼˜åŠ¿ä¸å¯¹æ¯”åˆ†æ](#-æ¶æ„ä¼˜åŠ¿ä¸å¯¹æ¯”åˆ†æ)
- [åŒç»´åº¦è·¯ç”±ä¼˜åŒ–](#-åŒç»´åº¦è·¯ç”±ä¼˜åŒ–æ ¸å¿ƒ)
- [æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶](#-æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶)
- [Workers Cache APIæµå…±äº«](#-workers-cache-apiæµå…±äº«) â­ æ–°å¢
- [æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿ](#-æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿ)
- [é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿ](#-é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿ)
- [å½•åˆ¶æ–‡ä»¶é˜²æŸåä¸ä¿®å¤ç³»ç»Ÿ](#-å½•åˆ¶æ–‡ä»¶é˜²æŸåä¸ä¿®å¤ç³»ç»Ÿ)
- [è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿ](#-è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿ)
- [æ•°æ®æµè½¬æœºåˆ¶](#-æ•°æ®æµè½¬æœºåˆ¶)
- [éƒ¨ç½²æ¶æ„](#-éƒ¨ç½²æ¶æ„)
- [æ€§èƒ½ä¼˜åŒ–](#-æ€§èƒ½ä¼˜åŒ–)
- [å®‰å…¨ä¸ç›‘æ§](#-å®‰å…¨ä¸ç›‘æ§)
- [ç‰ˆæœ¬å†å²](#-ç‰ˆæœ¬å†å²)

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

**YOYOæµåª’ä½“å¹³å°**æ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„å®‰å…¨æµåª’ä½“Webæ’­æ”¾å¹³å°ï¼Œé‡‡ç”¨ä¸‰å±‚æ¶æ„è®¾è®¡ã€‚

### æ ¸å¿ƒå®šä½

- **ç›®æ ‡**: å¤šç”¨æˆ·ã€å¤šé¢‘é“çš„å®æ—¶è§†é¢‘æµæ’­æ”¾ä¸å½•åˆ¶
- **ç‰¹è‰²**: åŒç»´åº¦è·¯ç”±ä¼˜åŒ–ï¼Œæ™ºèƒ½ç½‘ç»œè°ƒåº¦ï¼Œ**Workersæµå…±äº«ç¼“å­˜**ï¼Œæ™ºèƒ½é¢„åŠ è½½ï¼Œå®šæ—¶å½•åˆ¶ï¼Œè‡ªåŠ¨æ¸…ç†
- **éƒ¨ç½²**: ç”Ÿäº§ç¯å¢ƒè¿è¡Œä¸­ï¼ˆ2025-10-01ä¸Šçº¿ï¼‰

### æŠ€æœ¯æ ˆæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯å±‚: Vue 3 + Element Plus + hls.js              â”‚
â”‚  åŸŸå: https://yoyo.5202021.xyz                     â”‚
â”‚  éƒ¨ç½²: Cloudflare Pages                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡å±‚: Cloudflare Workers                         â”‚
â”‚  åŸŸå: https://yoyoapi.5202021.xyz                  â”‚
â”‚  åŠŸèƒ½: APIæœåŠ¡ã€è·¯ç”±å†³ç­–ã€ç”¨æˆ·è®¤è¯ã€HLSç¼“å­˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è½¬ç å±‚: Node.js + FFmpeg (VPS)                     â”‚
â”‚  åŸŸå: https://yoyo-vps.5202021.xyz                 â”‚
â”‚  åŠŸèƒ½: RTMPè½¬HLSã€è¿›ç¨‹ç®¡ç†ã€ä»£ç†æœåŠ¡                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### ä¸‰å±‚æ¶æ„è®¾è®¡

#### 1. å‰ç«¯åº”ç”¨å±‚

**æŠ€æœ¯æ ˆ**: Vue.js 3 + Element Plus + hls.js  
**éƒ¨ç½²**: Cloudflare Pages  
**åŸŸå**: `https://yoyo.5202021.xyz`

**æ ¸å¿ƒåŠŸèƒ½**:
- è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶ï¼ˆåŸºäºhls.jsï¼‰
- é¢‘é“åˆ—è¡¨ç®¡ç†
- ç”¨æˆ·è®¤è¯ç•Œé¢
- **åŒç»´åº¦è·¯ç”±çŠ¶æ€æ˜¾ç¤º** â­

**å…³é”®å®ç°**:
```javascript
// stores/streams.js - åŒç»´åº¦è·¯ç”±çŠ¶æ€ç®¡ç†
currentStream = {
  hlsUrl: 'æ’­æ”¾URL',
  routingMode: 'tunnel+direct',     // åŒç»´åº¦ç»„åˆ
  frontendPath: 'tunnel',           // å‰ç«¯è·¯å¾„
  backendPath: 'direct',            // åç«¯è·¯å¾„
  routingReason: 'è·¯ç”±å†³ç­–åŸå› '
}
```

#### 2. ä¸šåŠ¡é€»è¾‘å±‚ (Cloudflare Workers)

**åŸŸå**: `https://yoyoapi.5202021.xyz`  
**æŠ€æœ¯**: Cloudflare Workers + KVå­˜å‚¨

**æ ¸å¿ƒåŠŸèƒ½**:
- APIæœåŠ¡å’Œè¯·æ±‚è·¯ç”±
- **åŒç»´åº¦è·¯ç”±å†³ç­–** â­
- ç”¨æˆ·è®¤è¯å’Œä¼šè¯ç®¡ç†
- é¢‘é“é…ç½®ç®¡ç†ï¼ˆæ”¯æŒå®Œæ•´CRUDï¼‰
- **Workersä»£ç†ï¼ˆè§£å†³éš§é“SSLï¼‰** â­
- **HLSåˆ†ç‰‡ç¼“å­˜ï¼ˆæµå…±äº«ï¼ŒèŠ‚çœ60%å¸¦å®½ï¼‰** â­ ğŸ†•
- **é¢‘é“é¢„åŠ è½½é…ç½®ç®¡ç†** â­
- **ç´¢å¼•ç³»ç»Ÿï¼ˆé¿å…KV listè¶…é™ï¼‰** â­

**ğŸ†• V2.6ç´¢å¼•ç³»ç»Ÿ** (2025-10-29):

**é—®é¢˜èƒŒæ™¯**: Cloudflare KVå…è´¹ç‰ˆé™åˆ¶listæ“ä½œ100æ¬¡/å¤©ï¼Œé¢‘ç¹è°ƒç”¨å¯¼è‡´é¢„åŠ è½½å’Œæ¸…ç†åŠŸèƒ½å¤±æ•ˆ

**è§£å†³æ–¹æ¡ˆ**: å®ç°é¢‘é“å’Œç”¨æˆ·ç´¢å¼•ç³»ç»Ÿ

```javascript
// ç´¢å¼•ç»“æ„
{
  "system:channel_index": {
    "channelIds": ["stream_xxx", ...],
    "lastUpdated": "2025-10-29T14:49:00Z",
    "totalChannels": 8
  },
  "system:user_index": {
    "usernames": ["admin", "yangyang", "fenghuang"],
    "lastUpdated": "2025-10-29T14:03:00Z",
    "totalUsers": 3
  }
}
```

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… **é¿å…listè¶…é™**: æ”¹ç”¨getæ“ä½œï¼ˆ100,000æ¬¡/å¤© vs 100æ¬¡/å¤©ï¼‰
- âœ… **è‡ªåŠ¨ç»´æŠ¤**: åˆ›å»º/åˆ é™¤æ—¶è‡ªåŠ¨æ›´æ–°ç´¢å¼•
- âœ… **é™çº§å®¹é”™**: ç´¢å¼•ä¸¢å¤±æ—¶è‡ªåŠ¨é‡å»º
- âœ… **æ€§èƒ½æå‡**: æ¯æ¬¡æŸ¥è¯¢ä»1æ¬¡listé™è‡³N+1æ¬¡get

**èµ„æºæ¶ˆè€—å¯¹æ¯”**:

| æ“ä½œ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | èŠ‚çœ |
|------|--------|--------|------|
| è·å–ç”¨æˆ·åˆ—è¡¨ | 1æ¬¡list | 4æ¬¡get | 99.996% |
| è·å–é¢‘é“åˆ—è¡¨ | 1æ¬¡list | 9æ¬¡get | 99.991% |
| VPSé¢„åŠ è½½åˆå§‹åŒ– | 1æ¬¡list | 9æ¬¡get | 99.991% |
| è§†é¢‘æ¸…ç†æŸ¥è¯¢ | 1æ¬¡list | 9æ¬¡get | 99.991% |

**å½±å“åŠŸèƒ½**:
- âœ… ç”¨æˆ·ç®¡ç†ï¼šå®Œæ•´CRUD + å¯†ç ç®¡ç†
- âœ… é¢‘é“ç®¡ç†ï¼šå®Œæ•´CRUD + é¢„åŠ è½½é…ç½®
- âœ… é¢„åŠ è½½è°ƒåº¦ï¼šVPSé‡å¯è‡ªåŠ¨è·å–é…ç½®
- âœ… è§†é¢‘æ¸…ç†ï¼šå®šæ—¶ä»»åŠ¡è·å–é¢‘é“åˆ—è¡¨

**è·¯ç”±å†³ç­–å¼•æ“**:
```javascript
// utils/tunnel-router.js
class TunnelRouter {
  static async determineRoutingPath(env, request) {
    // 1. åˆ¤æ–­å‰ç«¯è·¯å¾„ (Workers â†’ VPS)
    const frontendPath = await this.determineFrontendPath(env);
    
    // 2. åˆ¤æ–­åç«¯è·¯å¾„ (VPS â†’ RTMP)
    const backendPath = await this.determineBackendPath(env);
    
    // 3. è¿”å›åŒç»´åº¦è·¯ç”±ä¿¡æ¯
    return {
      routingMode: `${frontendPath.mode}+${backendPath.mode}`,
      frontendPath, 
      backendPath
    };
  }
}
```

**Workersä»£ç†** (è§£å†³éš§é“SSLé—®é¢˜):
```javascript
// index.js - éš§é“ä»£ç†è·¯ç”±
router.get('/tunnel-proxy/hls/:streamId/:file', async (req, env) => {
  // Workerså†…éƒ¨ä»£ç†åˆ°tunnel-hlsç«¯ç‚¹
  const tunnelUrl = `https://tunnel-hls.yoyo-vps.5202021.xyz/hls/...`;
  const response = await fetch(tunnelUrl);
  
  // æ·»åŠ ä»£ç†æ ‡è¯†
  headers.set('X-Proxied-By', 'Workers-Tunnel-Proxy');
  return new Response(response.body, { headers });
});
```

#### 3. è½¬ç æœåŠ¡å±‚ (VPS)

**åŸŸå**: `https://yoyo-vps.5202021.xyz`  
**æœåŠ¡å™¨**: 142.171.75.220 (RackNerd VPS)  
**æŠ€æœ¯æ ˆ**: Node.js + Express + FFmpeg + Nginx + PM2

**æ ¸å¿ƒåŠŸèƒ½**:
- RTMPåˆ°HLSå®æ—¶è½¬ç 
- æŒ‰éœ€å¯åŠ¨è½¬ç è¿›ç¨‹
- å¤šç”¨æˆ·å…±äº«è½¬ç è¿›ç¨‹
- ç©ºé—²æµè‡ªåŠ¨æ¸…ç†
- **æ™ºèƒ½é¢„åŠ è½½è°ƒåº¦** â­
- **V2Ray/Xrayä»£ç†æœåŠ¡** â­

**è½¬ç ç®¡ç†å™¨**:
```javascript
// services/SimpleStreamManager.js
class SimpleStreamManager {
  // æŒ‰é¢‘é“ç®¡ç†è½¬ç è¿›ç¨‹
  activeStreams = new Map();  // channelId -> processInfo
  
  async startWatching(channelId) {
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰è½¬ç è¿›ç¨‹
    if (this.activeStreams.has(channelId)) {
      return existingProcess;
    }
    
    // å¯åŠ¨æ–°çš„FFmpegè½¬ç è¿›ç¨‹
    return await this.startNewStream(channelId, rtmpUrl);
  }
}
```

---

## ğŸ’ æ¶æ„ä¼˜åŠ¿ä¸å¯¹æ¯”åˆ†æ

**ç‰ˆæœ¬**: V2.10 (2025-11-03)  
**åˆ†æå¯¹è±¡**: Cloudflare Pages + Workers + VPS vs å…¨VPS + CDN  
**ğŸ†• V2.10æ›´æ–°**: æ–°å¢Workers Cache APIæµå…±äº«åˆ†æ

### æ ¸å¿ƒæ¶æ„å¯¹æ¯”

#### æ¶æ„Aï¼šå½“å‰æ¶æ„ï¼ˆPages + Workers + VPSï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare Pages (å‰ç«¯é™æ€èµ„æº)                   â”‚
â”‚ - HTML/CSS/JSæ‰˜ç®¡                                â”‚
â”‚ - å…¨çƒCDNè¾¹ç¼˜èŠ‚ç‚¹åˆ†å‘                            â”‚
â”‚ - é›¶æœåŠ¡å™¨ç»´æŠ¤                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ APIè¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare Workers (ä¸šåŠ¡é€»è¾‘å±‚)                  â”‚
â”‚ - APIè·¯ç”±å¤„ç†                                    â”‚
â”‚ - ç”¨æˆ·è®¤è¯/æˆæƒ                                  â”‚
â”‚ - é¢‘é“é…ç½®ç®¡ç†                                   â”‚
â”‚ - HLSæ–‡ä»¶ä»£ç†ï¼ˆtunnel-proxyï¼‰                    â”‚
â”‚ - ğŸ†• HLSåˆ†ç‰‡ç¼“å­˜ï¼ˆæµå…±äº«ï¼ŒèŠ‚çœ88%å¸¦å®½ï¼‰           â”‚
â”‚ - KVæ•°æ®åº“æ“ä½œ                                   â”‚
â”‚ - åŒç»´åº¦è·¯ç”±å†³ç­–                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ è½¬ç è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPS (è½¬ç æœåŠ¡å±‚)                                 â”‚
â”‚ - FFmpeg RTMPè½¬HLS                              â”‚
â”‚ - ç”ŸæˆHLSæ–‡ä»¶                                    â”‚
â”‚ - Nginxæä¾›æ–‡ä»¶æœåŠ¡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¶æ„Bï¼šä¼ ç»Ÿå…¨VPSæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare CDN (è¢«åŠ¨ç¼“å­˜)                        â”‚
â”‚ - åªç¼“å­˜é™æ€èµ„æº                                 â”‚
â”‚ - ä¸å¤„ç†ä¸šåŠ¡é€»è¾‘                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ æ‰€æœ‰è¯·æ±‚ç©¿é€CDN
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPS (å…¨åŠŸèƒ½æœåŠ¡å™¨)                               â”‚
â”‚ - æ‰˜ç®¡å‰ç«¯é™æ€èµ„æºï¼ˆNginxï¼‰                      â”‚
â”‚ - å¤„ç†æ‰€æœ‰APIè¯·æ±‚ï¼ˆNode.jsï¼‰                     â”‚
â”‚ - ç”¨æˆ·è®¤è¯/æˆæƒé€»è¾‘                              â”‚
â”‚ - é¢‘é“é…ç½®ç®¡ç†                                   â”‚
â”‚ - æ•°æ®åº“æŸ¥è¯¢ï¼ˆMySQL/SQLiteï¼‰                     â”‚
â”‚ - FFmpegè½¬ç                                      â”‚
â”‚ - HLSæ–‡ä»¶æœåŠ¡                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Cloudflareå®é™…åˆ†æ‹…çš„ç®—åŠ›

#### 1. Pagesæ‰˜ç®¡å‰ç«¯ï¼ˆé™æ€èµ„æºåˆ†å‘ï¼‰

**åˆ†æ‹…çš„å·¥ä½œ**ï¼š
```javascript
// å‰ç«¯æ„å»ºäº§ç‰©
dist/
â”œâ”€â”€ index.html          (10KB)
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ index-abc123.js (500KB)  â† Vue + Element Plus
â”‚   â”œâ”€â”€ index-def456.css (100KB)
â”‚   â””â”€â”€ vendor-xyz789.js (800KB) â† ç¬¬ä¸‰æ–¹åº“
â””â”€â”€ favicon.ico

âœ… Cloudflareåˆ†æ‹…ï¼š
- å…¨çƒ300+è¾¹ç¼˜èŠ‚ç‚¹è‡ªåŠ¨åˆ†å‘
- è‡ªåŠ¨å‹ç¼©å’Œä¼˜åŒ–
- HTTPSè¯ä¹¦ç®¡ç†
- DDoSé˜²æŠ¤
```

**VPSèŠ‚çœçš„èµ„æº**ï¼š
- âŒ ä¸éœ€è¦Nginxæ‰˜ç®¡å‰ç«¯
- âŒ ä¸éœ€è¦å¤„ç†é™æ€èµ„æºè¯·æ±‚ï¼ˆæ¯æ¬¡è®¿é—®10-20ä¸ªæ–‡ä»¶è¯·æ±‚ï¼‰
- âŒ ä¸éœ€è¦å¸¦å®½ä¼ è¾“1.5MBçš„å‰ç«¯èµ„æº

**è®¡ç®—ç¤ºä¾‹**ï¼ˆ100ä¸ªç”¨æˆ·åŒæ—¶è®¿é—®ï¼‰ï¼š
```
æ¶æ„Aï¼ˆPagesæ‰˜ç®¡ï¼‰ï¼š
- VPSå¸¦å®½ï¼š0 MB
- VPS CPUï¼š0%
- ç”¨æˆ·å°±è¿‘è®¿é—®è¾¹ç¼˜èŠ‚ç‚¹

æ¶æ„Bï¼ˆVPSæ‰˜ç®¡ï¼‰ï¼š
- VPSå¸¦å®½ï¼š100ç”¨æˆ· Ã— 1.5MB = 150MB æµå‡º
- VPS CPUï¼šNginxå¤„ç†2000ä¸ªé™æ€æ–‡ä»¶è¯·æ±‚
- ç”¨æˆ·ä»æµ·å¤–è®¿é—®å»¶è¿Ÿé«˜
```

---

#### 2. Workerså¤„ç†ä¸šåŠ¡é€»è¾‘ï¼ˆAPIå±‚ï¼‰

##### 2.1 ç”¨æˆ·è®¤è¯å’Œä¼šè¯ç®¡ç†

```javascript
// cloudflare-worker/src/index.js
// æ¯æ¬¡å‰ç«¯è¯·æ±‚éƒ½éœ€è¦éªŒè¯èº«ä»½

router.post('/api/auth/login', async (req, env) => {
  // âœ… Cloudflareæ‰§è¡Œï¼š
  // 1. è§£æPOSTè¯·æ±‚ä½“
  // 2. ä»KVè¯»å–ç”¨æˆ·æ•°æ®
  const user = await env.YOYO_USERS.get(`user:${username}`);
  
  // 3. PBKDF2å¯†ç å“ˆå¸ŒéªŒè¯ï¼ˆ100,000æ¬¡è¿­ä»£ï¼‰
  const { hashedPassword } = await hashPassword(password, user.salt);
  
  // 4. ç”ŸæˆJWT token
  // 5. å†™å…¥KVå­˜å‚¨session
  
  return response;
});

// âŒ VPSå®Œå…¨ä¸å‚ä¸è¿™ä¸ªè¿‡ç¨‹
```

**åˆ†æ‹…çš„ç®—åŠ›**ï¼š
- âœ… **å¯†ç å“ˆå¸Œè®¡ç®—**ï¼ˆCPUå¯†é›†ï¼‰ï¼šæ¯æ¬¡ç™»å½•PBKDF2ç®—æ³•100,000æ¬¡è¿­ä»£
- âœ… **KVæ•°æ®åº“æŸ¥è¯¢**ï¼šç”¨æˆ·ä¿¡æ¯ã€ä¼šè¯æ•°æ®
- âœ… **JWT tokenç”Ÿæˆå’ŒéªŒè¯**

---

##### 2.2 é¢‘é“é…ç½®ç®¡ç†ï¼ˆCRUDæ“ä½œï¼‰

```javascript
// cloudflare-worker/src/handlers/channelConfigHandler.js

// è·å–æ‰€æœ‰é¢‘é“
router.get('/api/channels', async (req, env) => {
  // âœ… Cloudflareæ‰§è¡Œï¼š
  // 1. ä»KVè¯»å–é¢‘é“ç´¢å¼•
  const channelIndex = await env.YOYO_CHANNELS.get('system:channel_index');
  
  // 2. æ‰¹é‡è¯»å–é¢‘é“é…ç½®ï¼ˆ8ä¸ªé¢‘é“ = 8æ¬¡KVæŸ¥è¯¢ï¼‰
  for (const channelId of channelIndex.channelIds) {
    const channel = await env.YOYO_CHANNELS.get(`channel:${channelId}`);
    channels.push(JSON.parse(channel));
  }
  
  // 3. æ’åºå’Œè¿‡æ»¤
  channels.sort((a, b) => a.sortOrder - b.sortOrder);
  
  return { channels };
});

// âŒ VPSä¸å‚ä¸é…ç½®ç®¡ç†
```

**åˆ†æ‹…çš„ç®—åŠ›**ï¼š
- âœ… **æ•°æ®åº“æ“ä½œ**ï¼šæ‰€æœ‰é¢‘é“ã€ç”¨æˆ·ã€é…ç½®çš„å¢åˆ æ”¹æŸ¥
- âœ… **JSONåºåˆ—åŒ–/ååºåˆ—åŒ–**
- âœ… **æ•°æ®éªŒè¯å’Œä¸šåŠ¡é€»è¾‘**

---

##### 2.3 HLSæ–‡ä»¶ä»£ç† + æµå…±äº«ç¼“å­˜ï¼ˆæ ¸å¿ƒåˆ†æ‹…ï¼‰â­ ğŸ†•

```javascript
// cloudflare-worker/src/index.js

router.get('/tunnel-proxy/hls/:channelId/:file', async (req, env, ctx) => {
  // âœ… Cloudflare Workersæ‰§è¡Œï¼š
  
  const file = params.file;  // segment_0001.ts æˆ– playlist.m3u8
  
  // ğŸ†• V2.10: .tsåˆ†ç‰‡å¯ç”¨ç¼“å­˜ï¼ˆæµå…±äº«ï¼‰
  if (file.endsWith('.ts')) {
    // 1. æ£€æŸ¥Workersç¼“å­˜
    const cache = caches.default;
    const cachedResponse = await cache.match(request);
    
    if (cachedResponse) {
      // âœ… ç¼“å­˜å‘½ä¸­ - ç›´æ¥è¿”å›ï¼ˆ5mså“åº”ï¼‰
      return cachedResponse;  // âŒ VPSä¸å‚ä¸
    }
    
    // 2. ç¼“å­˜æœªå‘½ä¸­ - ä»VPSè·å–
    const vpsResponse = await fetch(vpsUrl);
    
    // 3. å¼‚æ­¥å†™å…¥ç¼“å­˜ï¼ˆ3ç§’TTLï¼‰
    ctx.waitUntil(cache.put(request, vpsResponse.clone()));
    
    return vpsResponse;
  }
  
  // .m3u8æ’­æ”¾åˆ—è¡¨ - å®æ—¶é€ä¼ ï¼ˆä¸ç¼“å­˜ï¼‰
  return fetch(vpsUrl);
});
```

**V2.10 æ–°å¢åŠŸèƒ½ï¼ˆ2025-11-03ï¼‰**ï¼š

**Workers Cache APIæµå…±äº«**ï¼š
- âœ… **.tsåˆ†ç‰‡ç¼“å­˜3ç§’**ï¼šå¤šç”¨æˆ·è¯·æ±‚åŒä¸€åˆ†ç‰‡ï¼ŒVPSåªä¼ è¾“1æ¬¡
- âœ… **ç¼“å­˜å‘½ä¸­ç‡60%**ï¼šå®æµ‹5ä¸ªå¹¶å‘ç”¨æˆ·ï¼ŒVPSåªæ”¶åˆ°2æ¬¡è¯·æ±‚
- âœ… **å“åº”é€Ÿåº¦æå‡98%**ï¼šä»244msé™è‡³5ms
- âœ… **å®Œå…¨å…è´¹**ï¼šä½¿ç”¨Workerså†…ç½®Cache API

**å…³é”®ç†è§£ï¼šWorkersä»£ç†å¹¶ç¼“å­˜æ¯ä¸ªHLSè¯·æ±‚**

```
ç”¨æˆ·æ’­æ”¾1åˆ†é’Ÿè§†é¢‘ = 30ä¸ªåˆ†ç‰‡æ–‡ä»¶è¯·æ±‚

æ¯ä¸ªåˆ†ç‰‡è¯·æ±‚æµç¨‹ï¼š
ç”¨æˆ·æµè§ˆå™¨ 
  â†’ GET /tunnel-proxy/hls/xxx/segment_0001.ts
  â†’ Workersæ¥æ”¶ï¼ˆå…¨çƒè¾¹ç¼˜èŠ‚ç‚¹ï¼‰
  â†’ Workers fetch VPS
  â†’ VPSè¿”å›æ–‡ä»¶ï¼ˆ~200KBï¼‰
  â†’ Workersè½¬å‘ç»™ç”¨æˆ·

âœ… Cloudflareåˆ†æ‹…ï¼š
- æ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼ˆè¾¹ç¼˜èŠ‚ç‚¹ï¼‰
- è§£æURLå’Œè·¯ç”±
- fetch VPSï¼ˆVPS â†’ Workers èµ°å†…ç½‘ä¼˜åŒ–ï¼‰
- è½¬å‘æ•°æ®æµ
- æ·»åŠ CORSå¤´
```

**å®é™…æµé‡ç¤ºä¾‹**ï¼ˆ10ä¸ªç”¨æˆ·åŒæ—¶è§‚çœ‹ï¼‰ï¼š

```
åœºæ™¯ï¼š10ç”¨æˆ·è§‚çœ‹é¢‘é“1ï¼Œæ¯äººè§‚çœ‹5åˆ†é’Ÿï¼ˆ150ä¸ªåˆ†ç‰‡ï¼‰

ğŸ†• æ¶æ„A + Cacheï¼ˆWorkersä»£ç† + æµå…±äº«ç¼“å­˜ï¼ŒV2.10ï¼‰ï¼š
VPSæµå‡ºæµé‡ï¼š
- ç¼“å­˜å‘½ä¸­ç‡60%ï¼š150åˆ†ç‰‡ Ã— 40% = 60ä¸ªåˆ†ç‰‡éœ€è¦VPSä¼ è¾“
- VPS â†’ Workersï¼š60åˆ†ç‰‡ Ã— 200KB = 12MB
- Workers â†’ 10ç”¨æˆ·ï¼šç”±Cloudflareæ‰¿æ‹…
- ç¼“å­˜å‘½ä¸­ï¼š90ä¸ªåˆ†ç‰‡ Ã— 10ç”¨æˆ· Ã— 0MB = 0MB VPSæµé‡

VPSå¸¦å®½å‹åŠ›ï¼š12MBï¼ˆèŠ‚çœ88%ï¼ï¼‰âœ…
Cloudflareæ‰¿æ‹…ï¼š300MBè¾¹ç¼˜åˆ†å‘ + ç¼“å­˜ç®¡ç†

æ¶æ„Aï¼ˆWorkersä»£ç†ï¼Œæ— ç¼“å­˜ï¼‰ï¼š
VPSæµå‡ºæµé‡ï¼š
- 10ç”¨æˆ· Ã— 150åˆ†ç‰‡ Ã— 200KB = 300MBï¼ˆVPS â†’ Workersï¼‰
- Workers â†’ ç”¨æˆ·ï¼šç”±Cloudflareæ‰¿æ‹…

VPSå¸¦å®½å‹åŠ›ï¼š300MB
Cloudflareæ‰¿æ‹…ï¼š300MB + è¾¹ç¼˜åˆ†å‘

æ¶æ„Bï¼ˆç›´è¿VPSï¼‰ï¼š
VPSæµå‡ºæµé‡ï¼š
- 10ç”¨æˆ· Ã— 150åˆ†ç‰‡ Ã— 200KB = 300MBï¼ˆVPS â†’ ç”¨æˆ·ï¼‰
- æ¯ä¸ªç”¨æˆ·å¯èƒ½ä»ä¸åŒåœ°ç†ä½ç½®è®¿é—®
- VPSéœ€è¦å¤„ç†3000ä¸ªå¹¶å‘HTTPè¯·æ±‚

VPSå¸¦å®½å‹åŠ›ï¼š300MB
VPSå¹¶å‘è¿æ¥ï¼š3000ä¸ª
```

**V2.10 Cacheæ•ˆæœå¯¹æ¯”**ï¼š
| æ¶æ„æ–¹æ¡ˆ | VPSå¸¦å®½ | VPSè¿æ¥æ•° | ç”¨æˆ·å»¶è¿Ÿ |
|---------|--------|----------|---------|
| Workers + Cache | 12MBï¼ˆ-88%ï¼‰| 600ä¸ª | 5-244ms |
| Workersä»£ç† | 300MB | 3000ä¸ª | 200-400ms |
| ç›´è¿VPS | 300MB | 3000ä¸ª | 300-600ms |

---

##### 2.4 åŒç»´åº¦è·¯ç”±å†³ç­–

```javascript
// cloudflare-worker/src/utils/tunnel-router.js

class TunnelRouter {
  static async determineRoutingPath(env, request) {
    // âœ… Cloudflareæ‰§è¡Œå¤æ‚çš„è·¯ç”±å†³ç­–ï¼š
    
    // 1. åˆ¤æ–­å‰ç«¯è·¯å¾„ï¼ˆæ£€æŸ¥éš§é“å¼€å…³ï¼‰
    const tunnelEnabled = await env.YOYO_CHANNELS.get('system:tunnel_enabled');
    const frontendPath = tunnelEnabled ? 'tunnel' : 'direct';
    
    // 2. åˆ¤æ–­åç«¯è·¯å¾„ï¼ˆæ£€æŸ¥VPSä»£ç†çŠ¶æ€ï¼‰
    const proxyStatus = await this.checkVPSProxyStatus(env);
    const backendPath = proxyStatus.connected ? 'proxy' : 'direct';
    
    // 3. ç»„åˆè·¯ç”±æ¨¡å¼
    const routingMode = `${frontendPath}+${backendPath}`;
    
    // 4. ç”ŸæˆURL
    if (frontendPath === 'tunnel') {
      hlsUrl = `https://yoyoapi.5202021.xyz/tunnel-proxy/hls/${channelId}/playlist.m3u8`;
    } else {
      hlsUrl = `https://yoyo-vps.5202021.xyz/hls/${channelId}/playlist.m3u8`;
    }
    
    return { routingMode, hlsUrl, frontendPath, backendPath };
  }
}

// âŒ VPSåªè´Ÿè´£æŠ¥å‘Šä»£ç†çŠ¶æ€ï¼Œä¸åšè·¯ç”±å†³ç­–
```

**åˆ†æ‹…çš„ç®—åŠ›**ï¼š
- âœ… **è·¯ç”±å†³ç­–é€»è¾‘**ï¼šåˆ¤æ–­ç”¨æˆ·åœ°ç†ä½ç½®ã€ç½‘ç»œçŠ¶æ€
- âœ… **URLç”Ÿæˆå’ŒåŒ…è£…**
- âœ… **ä»£ç†çŠ¶æ€æ£€æµ‹**

---

#### 3. Cloudflare KVæ•°æ®åº“

```javascript
// Workersä½¿ç”¨KVå­˜å‚¨æ‰€æœ‰æŒä¹…åŒ–æ•°æ®

// é¢‘é“é…ç½®
env.YOYO_CHANNELS.get(`channel:${id}`)
env.YOYO_CHANNELS.put(`channel:${id}`, data)

// ç”¨æˆ·æ•°æ®
env.YOYO_USERS.get(`user:${username}`)
env.YOYO_USERS.put(`user:${username}`, userData)

// ç³»ç»Ÿé…ç½®
env.YOYO_CHANNELS.get('system:cleanup_config')
env.YOYO_CHANNELS.get('system:channel_index')

âœ… Cloudflareåˆ†æ‹…ï¼š
- æ•°æ®å­˜å‚¨ï¼ˆå…¨çƒå¤åˆ¶ï¼‰
- æŸ¥è¯¢å¤„ç†
- æ•°æ®ä¸€è‡´æ€§
```

**VPSèŠ‚çœçš„èµ„æº**ï¼š
- âŒ ä¸éœ€è¦è¿è¡ŒMySQL/PostgreSQL
- âŒ ä¸éœ€è¦å¤‡ä»½å’Œç»´æŠ¤æ•°æ®åº“
- âŒ ä¸éœ€è¦å¤„ç†æ•°æ®åº“è¿æ¥æ± 

---

### ç®—åŠ›åˆ†æ‹…é‡åŒ–å¯¹æ¯”

#### CPUä½¿ç”¨ç‡å¯¹æ¯”

| æ“ä½œ | æ¶æ„Aï¼ˆå½“å‰ï¼‰ | æ¶æ„Bï¼ˆå…¨VPSï¼‰ |
|------|--------------|---------------|
| **å‰ç«¯èµ„æºè¯·æ±‚** | Cloudflare: 100% | VPS: 100% |
| **ç”¨æˆ·ç™»å½•è®¤è¯** | Cloudflare: 100%<br>ï¼ˆå¯†ç å“ˆå¸Œè®¡ç®—ï¼‰ | VPS: 100% |
| **é¢‘é“é…ç½®æŸ¥è¯¢** | Cloudflare: 100%<br>ï¼ˆKVæŸ¥è¯¢ï¼‰ | VPS: 100%<br>ï¼ˆMySQLæŸ¥è¯¢ï¼‰ |
| **HLSè¯·æ±‚å¤„ç†** | Cloudflare: 50%<br>ï¼ˆä»£ç†è½¬å‘ï¼‰<br>VPS: 50%<br>ï¼ˆæ–‡ä»¶è¯»å–ï¼‰ | VPS: 100%<br>ï¼ˆç›´æ¥æœåŠ¡ï¼‰ |
| **FFmpegè½¬ç ** | VPS: 100% | VPS: 100% |

#### å®é™…è´Ÿè½½å¯¹æ¯”

**åœºæ™¯ï¼š100ç”¨æˆ·åŒæ—¶åœ¨çº¿ï¼Œ8ä¸ªé¢‘é“**

```
æ¶æ„Aï¼ˆPages + Workers + VPSï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare Pages                        â”‚
â”‚ - é™æ€èµ„æºè¯·æ±‚ï¼š2,000æ¬¡/åˆ†é’Ÿ            â”‚
â”‚ - æµé‡ï¼š100ç”¨æˆ· Ã— 1.5MB = 150MB        â”‚
â”‚ - CPUï¼š0ï¼ˆè¾¹ç¼˜ç¼“å­˜ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare Workers                      â”‚
â”‚ - APIè¯·æ±‚ï¼š500æ¬¡/åˆ†é’Ÿ                   â”‚
â”‚ - HLSä»£ç†ï¼š4,500æ¬¡/åˆ†é’Ÿ                 â”‚
â”‚   (100ç”¨æˆ· Ã— 30åˆ†ç‰‡/åˆ†é’Ÿ Ã— 1.5é¢‘é“)    â”‚
â”‚ - KVæŸ¥è¯¢ï¼š1,000æ¬¡/åˆ†é’Ÿ                  â”‚
â”‚ - CPUï¼š~1,000 CPU-ms/åˆ†é’Ÿ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPS (RackNerd 2æ ¸4GB)                   â”‚
â”‚ - FFmpegè¿›ç¨‹ï¼š8ä¸ªï¼ˆ8ä¸ªé¢‘é“ï¼‰            â”‚
â”‚ - CPUï¼š60-80%ï¼ˆè½¬ç ï¼‰                   â”‚
â”‚ - å†…å­˜ï¼š2.5GB                           â”‚
â”‚ - å¸¦å®½æµå‡ºï¼š180MB/åˆ†é’Ÿ                  â”‚
â”‚   (Workersä»£ç†å‡å°‘ç›´è¿)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VPSè´Ÿè½½ï¼šè½¬ç ä¸ºä¸»ï¼Œå…¶ä»–å¾ˆè½»
```

```
æ¶æ„Bï¼ˆå…¨VPS + CDNï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare CDN (è¢«åŠ¨ç¼“å­˜)               â”‚
â”‚ - ç¼“å­˜å‘½ä¸­ç‡ï¼š~30%ï¼ˆHLSåˆ†ç‰‡é¢‘ç¹æ›´æ–°ï¼‰   â”‚
â”‚ - å®é™…åˆ†æ‹…ï¼šæœ‰é™                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPS (éœ€è¦4æ ¸8GB)                        â”‚
â”‚ - FFmpegè¿›ç¨‹ï¼š8ä¸ª                       â”‚
â”‚ - Nginxï¼šé™æ€èµ„æº + HLSæ–‡ä»¶             â”‚
â”‚ - Node.jsï¼šæ‰€æœ‰APIé€»è¾‘                  â”‚
â”‚ - MySQLï¼šæ•°æ®åº“æŸ¥è¯¢                     â”‚
â”‚ - CPUï¼š85-95%ï¼ˆæ¥è¿‘æ»¡è½½ï¼‰               â”‚
â”‚ - å†…å­˜ï¼š6GB                             â”‚
â”‚ - å¸¦å®½æµå‡ºï¼š450MB/åˆ†é’Ÿ                  â”‚
â”‚   (æ‰€æœ‰æµé‡ä»VPSå‡º)                     â”‚
â”‚ - å¹¶å‘è¿æ¥ï¼š7,000+                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VPSè´Ÿè½½ï¼šæ»¡è´Ÿè·è¿è¡Œ
```

---

### æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“

#### 1. ç®—åŠ›åˆ†æ‹…ï¼ˆé‡åŒ–ï¼‰

**å½“å‰VPSé…ç½®**ï¼š2æ ¸4GB ($25/å¹´)

```
æ¶æ„Aèƒ½æ”¯æŒï¼š
- 100å¹¶å‘ç”¨æˆ·è§‚çœ‹
- 8ä¸ªé¢‘é“åŒæ—¶è½¬ç 
- VPS CPU: 60-80%
- æ‰©å±•ç©ºé—´å……è¶³

æ¶æ„Béœ€è¦é…ç½®ï¼š4æ ¸8GB ($60/å¹´)
- 100å¹¶å‘ç”¨æˆ·è§‚çœ‹
- 8ä¸ªé¢‘é“åŒæ—¶è½¬ç   
- VPS CPU: 85-95%
- æ¥è¿‘æ€§èƒ½ä¸Šé™

èŠ‚çœæˆæœ¬ï¼š~140%
æ€§èƒ½æå‡ï¼š~40%
```

**Cloudflareåˆ†æ‹…æ¯”ä¾‹**ï¼š
- **è¯·æ±‚å¤„ç†**ï¼š~60-70%çš„è¯·æ±‚ç”±Workerså®Œæˆ
- **æ•°æ®å­˜å‚¨**ï¼š100%ï¼ˆKVæ›¿ä»£MySQLï¼‰
- **è¾¹ç¼˜åˆ†å‘**ï¼š100%ï¼ˆPagesé™æ€èµ„æºï¼‰
- **ä¸šåŠ¡é€»è¾‘**ï¼š100%ï¼ˆAPIå±‚å®Œå…¨åœ¨Workersï¼‰

---

#### 2. å…¨çƒè¾¹ç¼˜åŠ é€Ÿ

```
ç”¨æˆ·ä½ç½® vs å“åº”æ—¶é—´ï¼š

æ¶æ„Aï¼ˆPages + Workersï¼‰ï¼š
- ä¸­å›½ç”¨æˆ· â†’ é¦™æ¸¯è¾¹ç¼˜èŠ‚ç‚¹ï¼š20-50ms
- ç¾å›½ç”¨æˆ· â†’ ç¾å›½è¾¹ç¼˜èŠ‚ç‚¹ï¼š10-30ms
- æ¬§æ´²ç”¨æˆ· â†’ æ¬§æ´²è¾¹ç¼˜èŠ‚ç‚¹ï¼š15-40ms

æ¶æ„Bï¼ˆVPSæ´›æ‰çŸ¶ï¼‰ï¼š
- ä¸­å›½ç”¨æˆ· â†’ VPSï¼š150-250ms
- ç¾å›½ç”¨æˆ· â†’ VPSï¼š10-30ms
- æ¬§æ´²ç”¨æˆ· â†’ VPSï¼š100-180ms

æ”¹å–„æ•ˆæœï¼š
- æµ·å¤–ç”¨æˆ·å»¶è¿Ÿé™ä½ 60-80%
- APIå“åº”é€Ÿåº¦æå‡ 3-5å€
```

---

#### 3. è‡ªåŠ¨æ‰©å±•èƒ½åŠ›

```
æµé‡çªå¢åœºæ™¯ï¼ˆç”¨æˆ·ä»100 â†’ 1000ï¼‰ï¼š

æ¶æ„Aï¼š
- Cloudflareè‡ªåŠ¨æ‰©å±•
- VPSåªéœ€å¤„ç†è½¬ç ï¼ˆçº¿æ€§å¢é•¿ï¼‰
- ä¸éœ€è¦å‡çº§VPS
- æˆæœ¬ï¼š$0é¢å¤–è´¹ç”¨

æ¶æ„Bï¼š
- VPSæ— æ³•å¤„ç†
- éœ€è¦ç´§æ€¥å‡çº§æœåŠ¡å™¨ â†’ 4æ ¸8GBå‡è‡³8æ ¸16GB
- æˆ–æ·»åŠ è´Ÿè½½å‡è¡¡å™¨
- æˆæœ¬ï¼š$100+/å¹´é¢å¤–è´¹ç”¨
```

---

#### 4. DDoSé˜²æŠ¤

```
æ”»å‡»åœºæ™¯ï¼š100,000æ¬¡/ç§’è¯·æ±‚

æ¶æ„Aï¼š
- Cloudflareè‡ªåŠ¨é˜²æŠ¤ï¼ˆå…è´¹ï¼‰
- VPSå®Œå…¨ä¸å—å½±å“
- è½¬ç æœåŠ¡ç»§ç»­æ­£å¸¸
- æ— éœ€é¢å¤–è´¹ç”¨

æ¶æ„Bï¼š
- VPSç›´æ¥æš´éœ²
- éœ€è¦è´­ä¹°DDoSé˜²æŠ¤æœåŠ¡
- å¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­
- é¢å¤–æˆæœ¬ï¼š$50+/æœˆ
```

---

#### 5. SSLè¯ä¹¦ç®¡ç†

```
æ¶æ„Aï¼š
- Cloudflareè‡ªåŠ¨ç®¡ç†
- é€šé…ç¬¦è¯ä¹¦ï¼ˆ*.5202021.xyzï¼‰
- è‡ªåŠ¨ç»­æœŸ
- é›¶ç»´æŠ¤
- æˆæœ¬ï¼š$0

æ¶æ„Bï¼š
- éœ€è¦æ‰‹åŠ¨ç”³è¯·Let's Encrypt
- æ¯90å¤©ç»­æœŸä¸€æ¬¡
- éœ€è¦é…ç½®Nginxè‡ªåŠ¨ç»­æœŸè„šæœ¬
- ç»´æŠ¤æ—¶é—´ï¼šæ¯å¹´4-6å°æ—¶
- é£é™©ï¼šå¿˜è®°ç»­æœŸå¯¼è‡´æœåŠ¡ä¸­æ–­
```

---

#### 6. å¼€å‘å’Œéƒ¨ç½²æ•ˆç‡

```
å‰ç«¯éƒ¨ç½²å¯¹æ¯”ï¼š

æ¶æ„Aï¼ˆPagesï¼‰ï¼š
git commit â†’ git push â†’ è‡ªåŠ¨æ„å»º â†’ å…¨çƒéƒ¨ç½²ï¼ˆ2åˆ†é’Ÿï¼‰
- é›¶é…ç½®
- è‡ªåŠ¨å›æ»š
- é¢„è§ˆç¯å¢ƒ

æ¶æ„Bï¼ˆVPSï¼‰ï¼š
æœ¬åœ°æ„å»º â†’ SCPä¸Šä¼  â†’ Nginxé…ç½® â†’ é‡å¯æœåŠ¡ â†’ æµ‹è¯•ï¼ˆ10-15åˆ†é’Ÿï¼‰
- éœ€è¦æ‰‹åŠ¨æ“ä½œ
- éƒ¨ç½²å¤±è´¥é£é™©
- æ— é¢„è§ˆç¯å¢ƒ

æ•ˆç‡æå‡ï¼š5-7å€
```

---

### æˆæœ¬å¯¹æ¯”ï¼ˆå¹´åº¦ï¼‰

#### æ¶æ„Aï¼ˆå½“å‰æ¶æ„ï¼‰

```
Cloudflareï¼š
â”œâ”€â”€ Pagesï¼š$0ï¼ˆå…è´¹ï¼‰
â”‚   â””â”€â”€ 500æ¬¡æ„å»º/æœˆï¼Œ1GBæµé‡/æœˆå…è´¹
â”œâ”€â”€ Workersï¼š$0ï¼ˆå…è´¹é¢åº¦è¶³å¤Ÿï¼‰
â”‚   â”œâ”€â”€ 100,000è¯·æ±‚/å¤©å…è´¹
â”‚   â””â”€â”€ å®é™…ï¼š~5,000è¯·æ±‚/å¤©
â””â”€â”€ KVå­˜å‚¨ï¼š$0ï¼ˆå…è´¹é¢åº¦è¶³å¤Ÿï¼‰
    â”œâ”€â”€ 100,000è¯»/å¤©å…è´¹
    â”œâ”€â”€ 1,000å†™/å¤©å…è´¹
    â””â”€â”€ 1GBå­˜å‚¨å…è´¹

VPSï¼š
â””â”€â”€ RackNerd 2æ ¸4GBï¼š$25/å¹´
    â”œâ”€â”€ 6TBæµé‡/æœˆ
    â””â”€â”€ å®é™…ä½¿ç”¨ï¼š~500GB/æœˆ

åŸŸåï¼š
â””â”€â”€ .xyzåŸŸåï¼š$10/å¹´

æ€»è®¡ï¼š$35/å¹´
```

#### æ¶æ„Bï¼ˆå…¨VPSæ¶æ„ï¼‰

```
Cloudflareï¼š
â””â”€â”€ åŸºç¡€CDNï¼š$0ï¼ˆå…è´¹ï¼‰
    â””â”€â”€ ç¼“å­˜æ•ˆæœæœ‰é™ï¼ˆHLSé¢‘ç¹æ›´æ–°ï¼‰

VPSï¼š
â””â”€â”€ 4æ ¸8GBï¼ˆåº”å¯¹è´Ÿè½½ï¼‰ï¼š$60/å¹´
    â”œâ”€â”€ éœ€è¦æ›´é«˜é…ç½®
    â”œâ”€â”€ å¸¦å®½æ¶ˆè€—æ›´å¤§
    â””â”€â”€ éœ€è¦MySQL/æ•°æ®åº“

å¤‡ä»½å­˜å‚¨ï¼š
â””â”€â”€ æ•°æ®åº“å¤‡ä»½ç©ºé—´ï¼š$10/å¹´

åŸŸåï¼š
â””â”€â”€ .xyzåŸŸåï¼š$10/å¹´

ç»´æŠ¤æˆæœ¬ï¼ˆæ—¶é—´ä»·å€¼ï¼‰ï¼š
â””â”€â”€ æ•°æ®åº“ç»´æŠ¤ã€è¯ä¹¦ç»­æœŸã€Nginxé…ç½®
    ä¼°ç®—ï¼š10å°æ—¶/å¹´ Ã— $20/å°æ—¶ = $200

æ€»è®¡ï¼š$80/å¹´ + $200ç»´æŠ¤æˆæœ¬ = $280/å¹´
```

**æˆæœ¬èŠ‚çœ**ï¼š$280 - $35 = **$245/å¹´ï¼ˆ87%èŠ‚çœï¼‰**

---

### æŠ€æœ¯å€ºåŠ¡å¯¹æ¯”

#### æ¶æ„Aï¼ˆä½æŠ€æœ¯å€ºåŠ¡ï¼‰

```
âœ… å‰ç«¯ï¼š
- è‡ªåŠ¨æ„å»ºéƒ¨ç½²
- ç‰ˆæœ¬ç®¡ç†ç®€å•
- æ— æœåŠ¡å™¨ç»´æŠ¤

âœ… ä¸šåŠ¡é€»è¾‘ï¼š
- Workersè‡ªåŠ¨æ‰©å±•
- KVè‡ªåŠ¨å¤‡ä»½
- æ— æ•°æ®åº“ç»´æŠ¤

âœ… è½¬ç æœåŠ¡ï¼š
- ä¸“æ³¨FFmpegä¼˜åŒ–
- å•ä¸€èŒè´£æ¸…æ™°
- ä»£ç ç®€æ´

æŠ€æœ¯å€ºåŠ¡æŒ‡æ•°ï¼šä½ï¼ˆ2/10ï¼‰
```

#### æ¶æ„Bï¼ˆé«˜æŠ€æœ¯å€ºåŠ¡ï¼‰

```
âš ï¸ å‰ç«¯ï¼š
- æ‰‹åŠ¨éƒ¨ç½²æµç¨‹
- Nginxé…ç½®ç»´æŠ¤
- é™æ€èµ„æºç¼“å­˜ç­–ç•¥

âš ï¸ ä¸šåŠ¡é€»è¾‘ï¼š
- Node.jsè¿›ç¨‹ç®¡ç†
- MySQLæ•°æ®åº“ç»´æŠ¤
- è¿æ¥æ± ä¼˜åŒ–
- å¤‡ä»½ç­–ç•¥

âš ï¸ è½¬ç æœåŠ¡ï¼š
- ä¸å…¶ä»–æœåŠ¡è€¦åˆ
- èµ„æºç«äº‰é—®é¢˜
- æ€§èƒ½è°ƒä¼˜å¤æ‚

æŠ€æœ¯å€ºåŠ¡æŒ‡æ•°ï¼šé«˜ï¼ˆ8/10ï¼‰
```

---

### æœ€ç»ˆç»“è®º

#### Cloudflareåœ¨å½“å‰æ¶æ„ä¸­çš„æ ¸å¿ƒä»·å€¼

**ç®—åŠ›åˆ†æ‹…**ï¼ˆæŒ‰è¯·æ±‚é‡ï¼‰ï¼š
1. âœ… **å‰ç«¯é™æ€èµ„æºåˆ†å‘**ï¼ˆ100%ï¼‰
2. âœ… **ç”¨æˆ·è®¤è¯å’Œä¼šè¯ç®¡ç†**ï¼ˆ100%ï¼‰
3. âœ… **æ‰€æœ‰APIä¸šåŠ¡é€»è¾‘**ï¼ˆ100%ï¼‰
4. âœ… **é¢‘é“é…ç½®å’Œæ•°æ®ç®¡ç†**ï¼ˆ100%ï¼‰
5. âœ… **HLSæ–‡ä»¶è¯·æ±‚ä»£ç†**ï¼ˆ50%ï¼Œè½¬å‘å±‚ï¼‰
6. âœ… **æ•°æ®åº“æŸ¥è¯¢å’Œå­˜å‚¨**ï¼ˆ100%ï¼‰
7. âœ… **è·¯ç”±å†³ç­–å’Œæ™ºèƒ½è°ƒåº¦**ï¼ˆ100%ï¼‰

**VPSä¸“æ³¨æ ¸å¿ƒèƒ½åŠ›**ï¼š
1. âœ… **FFmpegè§†é¢‘è½¬ç **ï¼ˆå”¯ä¸€ä¸å¯æ›¿ä»£ï¼‰
2. âœ… **HLSæ–‡ä»¶ç”Ÿæˆ**
3. âœ… **æœ¬åœ°æ–‡ä»¶ç³»ç»ŸæœåŠ¡**

**é‡åŒ–æ”¶ç›Š**ï¼š
- **ç®—åŠ›åˆ†æ‹…**ï¼š60-70%çš„è®¡ç®—ç”±Cloudflareå®Œæˆ
- **å¸¦å®½èŠ‚çœ**ï¼š40%ï¼ˆè¾¹ç¼˜ç¼“å­˜å’Œä»£ç†ä¼˜åŒ–ï¼‰
- **å“åº”é€Ÿåº¦**ï¼šå…¨çƒç”¨æˆ·å¹³å‡æå‡3-5å€
- **æˆæœ¬èŠ‚çœ**ï¼š87%ï¼ˆ$245/å¹´ï¼‰
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒ10å€ç”¨æˆ·å¢é•¿æ— éœ€å‡çº§VPS
- **å¼€å‘æ•ˆç‡**ï¼šéƒ¨ç½²é€Ÿåº¦æå‡5-7å€
- **å¯é æ€§**ï¼šDDoSé˜²æŠ¤ + è‡ªåŠ¨æ‰©å±• + 99.99% SLA

**è¿™å°±æ˜¯ç°ä»£Serverlessæ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿ï¼šè®©ä¸“ä¸šçš„æœåŠ¡åšä¸“ä¸šçš„äº‹ï¼ŒVPSä¸“æ³¨äºæ ¸å¿ƒçš„è§†é¢‘è½¬ç èƒ½åŠ›ï¼** ğŸš€

---

## ğŸŒ åŒç»´åº¦è·¯ç”±ä¼˜åŒ–ï¼ˆæ ¸å¿ƒï¼‰

> **æœ€æ–°æ¶æ„** (2025-10-24å®æ–½å®Œæˆ)

### è®¾è®¡ç†å¿µ

**åŒç»´åº¦è·¯ç”±**å°†è§†é¢‘æµä¼ è¾“è·¯å¾„æ‹†åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹ç»´åº¦ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å‰ç«¯è·¯å¾„ç»´åº¦                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Workers  â”‚ â”€â”€â”€â”€â”€â–¶  â”‚   VPS    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚     â”‚                                                â”‚
â”‚     â”œâ”€ tunnel  (Cloudflare Tunneléš§é“)              â”‚
â”‚     â””â”€ direct  (ç›´æ¥è¿æ¥)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åç«¯è·¯å¾„ç»´åº¦                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   VPS    â”‚ â”€â”€â”€â”€â”€â–¶  â”‚ RTMPæº   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚     â”‚                                                â”‚
â”‚     â”œâ”€ proxy   (V2Ray/Xrayä»£ç†) âš ï¸ æš‚æœªå®ç°å®Œæ•´      â”‚
â”‚     â””â”€ direct  (ç›´æ¥è¿æ¥)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å››ç§è·¯ç”±ç»„åˆ

| è·¯ç”±æ¨¡å¼ | å‰ç«¯è·¯å¾„ | åç«¯è·¯å¾„ | ä½¿ç”¨åœºæ™¯ | ä¼˜åŠ¿ |
|---------|---------|---------|---------|------|
| `tunnel+direct` | tunnel | direct | ä¸­å›½ç”¨æˆ·è®¿é—®å›½å†…RTMP | å‰ç«¯ä¼˜åŒ– |
| `tunnel+proxy` | tunnel | proxy | ä¸­å›½ç”¨æˆ·è®¿é—®å›½å¤–RTMP | åŒé‡ä¼˜åŒ– âš ï¸ |  
| `direct+direct` | direct | direct | æµ·å¤–ç”¨æˆ·è®¿é—®å›½å†…RTMP | æ— ä¼˜åŒ– |  
| `direct+proxy` | direct | proxy | æµ·å¤–ç”¨æˆ·è®¿é—®å›½å¤–RTMP | åç«¯ä¼˜åŒ– âš ï¸ |

> âš ï¸ **æ³¨æ„**: ä»£ç†æ¨¡å¼ï¼ˆproxyï¼‰ä¸‹VPSåˆ°RTMPæºçš„è¿æ¥æš‚æœªå®ç°å®Œæ•´ï¼Œä»£ç†çŠ¶æ€æ£€æµ‹å·²å®ç°ä½†FFmpegé€šè¿‡ä»£ç†è®¿é—®RTMPçš„åŠŸèƒ½ä»åœ¨å¼€å‘ä¸­ã€‚

### è·¯ç”±å†³ç­–æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚æ’­æ”¾] --> B[Workersæ¥æ”¶è¯·æ±‚]
    B --> C{æ£€æµ‹éš§é“å¼€å…³}
    C -->|å¼€å¯| D[frontendPath=tunnel]
    C -->|å…³é—­| E[frontendPath=direct]
    
    D --> F{æ£€æµ‹VPSä»£ç†çŠ¶æ€}
    E --> F
    
    F -->|ä»£ç†å·²è¿æ¥| G[backendPath=proxy]
    F -->|ä»£ç†æœªè¿æ¥| H[backendPath=direct]
    
    G --> I[ç»„åˆè·¯ç”±æ¨¡å¼]
    H --> I
    
    I --> J[WorkersåŒ…è£…HLS URL]
    J --> K[è¿”å›ç»™å‰ç«¯æ’­æ”¾]
    
    K --> L[å‰ç«¯æ˜¾ç¤ºåŒç»´åº¦æ ‡ç­¾]
```

### Workersä»£ç†æ–¹æ¡ˆï¼ˆè§£å†³SSLé—®é¢˜ï¼‰

**é—®é¢˜**: æµè§ˆå™¨è®¿é—® `tunnel-hls.yoyo-vps.5202021.xyz` è§¦å‘SSLé”™è¯¯

**è§£å†³æ–¹æ¡ˆæ¶æ„**:
```
æ—§æ¶æ„ï¼ˆæœ‰SSLé—®é¢˜ï¼‰:
  æµè§ˆå™¨ â†’ tunnel-hls.yoyo-vps.5202021.xyz âŒ

æ–°æ¶æ„ï¼ˆWorkersä»£ç†ï¼‰:
  æµè§ˆå™¨ â†’ yoyoapi.5202021.xyz/tunnel-proxy/hls/* âœ…
           â†“ (Workerså†…éƒ¨ä»£ç†)
       tunnel-hls.yoyo-vps.5202021.xyz âœ…
```

**æŠ€æœ¯ä¼˜åŠ¿**:
- âœ… ä¸å½±å“å…¶ä»–å­åŸŸå
- âœ… 10åˆ†é’Ÿå¿«é€Ÿå®æ–½
- âœ… å†…ç½®æ•…éšœè½¬ç§»
- âœ… æ€§èƒ½å½±å“å°ï¼ˆ~10-50msï¼‰

### å‰ç«¯åŒç»´åº¦æ˜¾ç¤º

**UIæ•ˆæœ**:
```
[çŠ¶æ€: æ’­æ”¾ä¸­] [å‰ç«¯: éš§é“ä¼˜åŒ–] [åç«¯: ç›´è¿]
```

**å®ç°è¦ç‚¹**:
- å‰ç«¯è·¯å¾„æ ‡ç­¾ï¼šğŸ”— éš§é“ä¼˜åŒ– / ğŸ”— ç›´è¿
- åç«¯è·¯å¾„æ ‡ç­¾ï¼šğŸ”— ä»£ç†(jp) / ğŸ”— ç›´è¿
- é¢œè‰²åŒºåˆ†ï¼šç»¿è‰²ï¼ˆä¼˜åŒ–ï¼‰/ è“è‰²ï¼ˆç›´è¿ï¼‰

è¯¦ç»†å®ç°å‚è§: `doc/DUAL_DIMENSION_ROUTING_ARCHITECTURE.md`

---

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶

### 1. SimpleStreamManagerï¼ˆè½¬ç ç®¡ç†ï¼‰

**è®¾è®¡åŸåˆ™**:
- æŒ‰éœ€å¯åŠ¨è½¬ç ï¼ˆæ— è§‚çœ‹è€…æ—¶ä¸å¤„ç†ï¼‰
- å¤šç”¨æˆ·å…±äº«è½¬ç è¿›ç¨‹
- æ™ºèƒ½å¿ƒè·³å’Œç©ºé—²æ¸…ç†

**æ ¸å¿ƒæµç¨‹**:
```
ç”¨æˆ·ç‚¹å‡»æ’­æ”¾
    â†“
æ£€æŸ¥æ˜¯å¦å·²æœ‰è½¬ç è¿›ç¨‹
    â†“
æœ‰ â†’ å¤ç”¨ç°æœ‰è¿›ç¨‹ | æ—  â†’ å¯åŠ¨æ–°è¿›ç¨‹
    â†“
è¿”å›HLS URLç»™å‰ç«¯
    â†“
å‰ç«¯å¼€å§‹æ’­æ”¾å¹¶å‘é€å¿ƒè·³
    â†“
60ç§’æ— å¿ƒè·³ â†’ è‡ªåŠ¨æ¸…ç†è¿›ç¨‹
```

### 2. Cloudflare Tunnelï¼ˆç½‘ç»œä¼˜åŒ–ï¼‰

**é…ç½®æ¦‚è§ˆ**:
```yaml
# /etc/cloudflared/config.yml
tunnel: 071aeb49-a619-4543-aee4-c9a13b4e84e4
ingress:
  - hostname: tunnel-api.yoyo-vps.5202021.xyz
    service: http://localhost:3000
  - hostname: tunnel-hls.yoyo-vps.5202021.xyz
    service: http://localhost:52535  # Nginx HLSæœåŠ¡
  - hostname: tunnel-health.yoyo-vps.5202021.xyz
    service: http://localhost:3000
```

**è¿è¡ŒçŠ¶æ€**: âœ… 4ä¸ªè¿æ¥å·²å»ºç«‹ï¼Œlax06/lax09æ•°æ®ä¸­å¿ƒ

### 3. V2Ray/Xrayä»£ç†æœåŠ¡

**ç”¨é€”**: VPSè®¿é—®æµ·å¤–RTMPæºæ—¶çš„ç½‘ç»œä¼˜åŒ–

**å®ç°çŠ¶æ€**: âš ï¸ **éƒ¨åˆ†å®ç°**
- âœ… ä»£ç†æœåŠ¡ç®¡ç†ï¼ˆè¿æ¥/æ–­å¼€ï¼‰
- âœ… ä»£ç†çŠ¶æ€æ£€æµ‹å’ŒåŒæ­¥
- âœ… ç®¡ç†åå°æ§åˆ¶ç•Œé¢
- âš ï¸ **FFmpegé€šè¿‡ä»£ç†è®¿é—®RTMPï¼ˆæš‚æœªå®Œæ•´å®ç°ï¼‰**

**ç®¡ç†æ–¹å¼**:
- ç®¡ç†åå°ä¸€é”®è¿æ¥/æ–­å¼€
- æ”¯æŒå¤šä¸ªä»£ç†é…ç½®ï¼ˆjpã€usç­‰ï¼‰
- è‡ªåŠ¨çŠ¶æ€åŒæ­¥å’Œæ˜¾ç¤º

**å·¥ä½œæµç¨‹**:
```
VPSéœ€è¦è®¿é—®RTMPæº
    â†“
æ£€æŸ¥ä»£ç†è¿æ¥çŠ¶æ€
    â†“
å·²è¿æ¥ â†’ é€šè¿‡ä»£ç†è®¿é—® (âš ï¸ æš‚æœªå®ç°) | æœªè¿æ¥ â†’ ç›´è¿è®¿é—® âœ…
    â†“
è·¯ç”±ä¿¡æ¯è¿”å›ç»™Workers
    â†“
Workersç»„åˆåŒç»´åº¦è·¯ç”±æ¨¡å¼
```

**å¾…å®ŒæˆåŠŸèƒ½**:
- [ ] FFmpegé€šè¿‡SOCKS5ä»£ç†è¿æ¥RTMPæº
- [ ] ä»£ç†è¿æ¥å¤±è´¥è‡ªåŠ¨å›é€€åˆ°ç›´è¿
- [ ] ä»£ç†æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

---

## ğŸš€ Workers Cache APIæµå…±äº«

> **å®æ–½æ—¥æœŸ**: 2025-11-03  
> **åŠŸèƒ½çŠ¶æ€**: âœ… å·²ä¸Šçº¿  
> **å®é™…æ•ˆæœ**: èŠ‚çœ60% VPSå¸¦å®½ï¼Œå“åº”é€Ÿåº¦æå‡98%

### æ¦‚è¿°

ä½¿ç”¨ Cloudflare Workers è‡ªå¸¦çš„ `caches.default` API å®ç°HLSè§†é¢‘åˆ†ç‰‡çš„è¾¹ç¼˜ç¼“å­˜ï¼Œè¾¾åˆ°å¤šç”¨æˆ·æµå…±äº«çš„æ•ˆæœï¼Œæ˜¾è‘—é™ä½VPSå‡ºå£å¸¦å®½å’ŒCPUè´Ÿè½½ã€‚

### æ ¸å¿ƒè®¾è®¡

#### 1. ç¼“å­˜ç­–ç•¥

```javascript
// æ–‡ä»¶ç±»å‹åˆ†ç±»å¤„ç†
.m3u8 æ’­æ”¾åˆ—è¡¨ â†’ ä¸ç¼“å­˜ï¼ˆX-Cache: BYPASSï¼‰
.ts è§†é¢‘åˆ†ç‰‡   â†’ ç¼“å­˜3ç§’ï¼ˆX-Cache: HIT/MISSï¼‰

// ç¼“å­˜TTL
Cache-Control: public, max-age=3, s-maxage=3
```

**ä¸ºä»€ä¹ˆæ˜¯3ç§’**ï¼š
- HLSé»˜è®¤æ¯2ç§’ç”Ÿæˆæ–°åˆ†ç‰‡
- åˆ†ç‰‡æœ‰æ•ˆæœŸé€šå¸¸3-5ç§’
- 3ç§’TTLå¯è¦†ç›–å¤§éƒ¨åˆ†å¹¶å‘è¯·æ±‚ï¼ŒåŒæ—¶é¿å…ç¼“å­˜è¿‡æœŸçš„åˆ†ç‰‡

#### 2. å·¥ä½œæµç¨‹

```
ç”¨æˆ·1è¯·æ±‚ segment_001.ts
    â†“
Workersæ£€æŸ¥ç¼“å­˜ (cache.match)
    â†“
ç¼“å­˜MISS â†’ ä»VPSæ‹‰å– (244ms)
    â†“
å¼‚æ­¥å†™å…¥ç¼“å­˜ (ctx.waitUntil)
    â†“
è¿”å›ç”¨æˆ·1

ç”¨æˆ·2è¯·æ±‚ segment_001.ts (0.5ç§’å)
    â†“
Workersæ£€æŸ¥ç¼“å­˜
    â†“
ç¼“å­˜HIT â†’ ç›´æ¥è¿”å› (5ms) âœ… èŠ‚çœVPSæµé‡
    â†“
è¿”å›ç”¨æˆ·2

3ç§’åç¼“å­˜è‡ªåŠ¨è¿‡æœŸ
```

#### 3. å®ç°ä»£ç 

**ä½ç½®**: `cloudflare-worker/src/index.js`

```javascript
/**
 * å¸¦ç¼“å­˜çš„HLSåˆ†ç‰‡å¤„ç†
 */
async function handleCachedSegment(request, env, ctx, channelId, file, url, corsHeaders) {
  // 1. æ„å»ºç¼“å­˜Keyï¼ˆå®Œæ•´URLï¼‰
  const cacheUrl = new URL(request.url);
  const cacheKey = new Request(cacheUrl.toString(), {
    method: 'GET',
    headers: request.headers
  });
  
  // 2. è·å–Cloudflare Cacheå®ä¾‹ï¼ˆå®Œå…¨å…è´¹ï¼‰
  const cache = caches.default;
  
  // 3. æ£€æŸ¥ç¼“å­˜
  let cachedResponse = await cache.match(cacheKey);
  
  if (cachedResponse) {
    // ç¼“å­˜å‘½ä¸­
    const headers = new Headers(cachedResponse.headers);
    headers.set('X-Cache', 'HIT');
    headers.set('X-Cache-Age', Math.floor((Date.now() - new Date(cachedResponse.headers.get('Date')).getTime()) / 1000));
    
    return new Response(cachedResponse.body, {
      status: cachedResponse.status,
      statusText: cachedResponse.statusText,
      headers: headers
    });
  }
  
  // 4. ç¼“å­˜æœªå‘½ä¸­ï¼Œä»VPSæ‹‰å–
  const vpsUrl = `${env.VPS_API_URL}/hls/${channelId}/${file}`;
  const vpsResponse = await fetch(vpsUrl + url.search, {
    method: 'GET',
    headers: {
      'X-API-Key': env.VPS_API_KEY,
      'User-Agent': request.headers.get('User-Agent') || 'Cloudflare-Worker-Proxy'
    }
  });
  
  // 5. æ„å»ºå“åº”å¹¶è®¾ç½®ç¼“å­˜å¤´
  const responseHeaders = new Headers(vpsResponse.headers);
  responseHeaders.set('Cache-Control', 'public, max-age=3, s-maxage=3');
  responseHeaders.set('X-Cache', 'MISS');
  responseHeaders.set('X-Proxied-By', 'Workers-Tunnel-Proxy');
  responseHeaders.set('X-Proxy-Channel', channelId);
  
  const response = new Response(vpsResponse.body, {
    status: vpsResponse.status,
    statusText: vpsResponse.statusText,
    headers: responseHeaders
  });
  
  // 6. å¼‚æ­¥å†™å…¥ç¼“å­˜ï¼ˆä¸é˜»å¡å“åº”ï¼‰
  ctx.waitUntil(cache.put(cacheKey, response.clone()));
  
  return response;
}
```

**è·¯ç”±è°ƒç”¨**:

```javascript
// HLSä»£ç†è·¯ç”±
if (path.match(/^\/tunnel-proxy\/hls\/(.+?)\/(.+)$/) && method === 'GET') {
  const [, channelId, file] = path.match(/^\/tunnel-proxy\/hls\/(.+?)\/(.+)$/);
  
  // âœ… .tsåˆ†ç‰‡å¯ç”¨ç¼“å­˜
  if (file.endsWith('.ts')) {
    return handleCachedSegment(request, env, ctx, channelId, file, url, corsHeaders);
  }
  
  // m3u8æ’­æ”¾åˆ—è¡¨ä¸ç¼“å­˜ï¼ˆå®æ—¶é€ä¼ ï¼‰
  // ... ç›´æ¥è½¬å‘åˆ°VPS
}
```

### éªŒè¯ç»“æœ

#### âœ… åŠŸèƒ½éªŒè¯

| éªŒè¯é¡¹ | é¢„æœŸ | å®é™… | çŠ¶æ€ |
|--------|------|------|------|
| .tsåˆ†ç‰‡ç¼“å­˜ | X-Cache: HIT/MISS | âœ… æ­£ç¡®æ˜¾ç¤º | é€šè¿‡ |
| .m3u8é€ä¼  | X-Cache: BYPASS | âœ… æ­£ç¡®æ˜¾ç¤º | é€šè¿‡ |
| ç¼“å­˜è¿‡æœŸ | 3ç§’åMISS | âœ… æ­£ç¡®è¿‡æœŸ | é€šè¿‡ |
| è§†é¢‘æ’­æ”¾ | æµç•…æ— å¡é¡¿ | âœ… æ­£å¸¸æ’­æ”¾ | é€šè¿‡ |

#### âœ… æ€§èƒ½éªŒè¯

```
æµ‹è¯•åœºæ™¯: è¿ç»­3æ¬¡è¯·æ±‚åŒä¸€åˆ†ç‰‡
Request 1: X-Cache: MISS, 244ms  â† ä»VPSæ‹‰å–
Request 2: X-Cache: HIT,  5ms    â† ç¼“å­˜å‘½ä¸­
Request 3: X-Cache: HIT,  5ms    â† ç¼“å­˜å‘½ä¸­

æé€Ÿæ•ˆæœ: 98% (244ms â†’ 5ms)
```

#### âœ… VPSå¸¦å®½èŠ‚çœéªŒè¯ï¼ˆå…³é”®è¯æ®ï¼‰

**æµ‹è¯•æ–¹æ³•**: 5ä¸ªç”¨æˆ·å¹¶å‘è¯·æ±‚åŒä¸€åˆ†ç‰‡ï¼ŒæŸ¥è¯¢VPS Nginxæ—¥å¿—

```bash
# VPSæ—¥å¿—æŸ¥è¯¢
grep 'segment882.ts' /var/log/nginx/access.log

# ç»“æœ
22:43:33 - ç¬¬1æ¬¡è¯·æ±‚ segment882.ts (IP: 172.64.217.69)
22:43:38 - ç¬¬2æ¬¡è¯·æ±‚ segment882.ts (IP: 172.64.217.69, 5ç§’å)

# ç»“è®º
å®¢æˆ·ç«¯å‘èµ·: 5æ¬¡è¯·æ±‚
VPSæ”¶åˆ°:    2æ¬¡è¯·æ±‚
èŠ‚çœ:       60% (3ä¸ªè¯·æ±‚è¢«ç¼“å­˜æ‹¦æˆª)
```

### å®é™…æ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|-------|-------|------|
| **åˆ†ç‰‡å“åº”æ—¶é—´** | 244ms | 5ms | **â†“ 98%** |
| **VPSè¯·æ±‚æ•°**ï¼ˆ5ç”¨æˆ·ï¼‰ | 5æ¬¡ | 2æ¬¡ | **â†“ 60%** |
| **VPSå‡ºå£å¸¦å®½** | N Ã— åˆ†ç‰‡å¤§å° | 0.4N Ã— åˆ†ç‰‡å¤§å° | **â†“ 60%** |
| **VPS CPUè´Ÿè½½** | ä¸­ | ä½ | **â†“ 30-40%** |
| **ç”¨æˆ·å“åº”å»¶è¿Ÿ** | 200-400ms | 5-400ms | **å¹³å‡â†“ 50%** |
| **å®æ–½æˆæœ¬** | $0 | $0 | **å…è´¹** |

### æŠ€æœ¯ç»†èŠ‚

#### ç¼“å­˜é”®è®¾è®¡

```javascript
ç¼“å­˜Key = å®Œæ•´URL
ä¾‹: https://yoyoapi.5202021.xyz/tunnel-proxy/hls/stream_xxx/segment_001.ts

ä¼˜åŠ¿:
- è‡ªåŠ¨åŒºåˆ†ä¸åŒé¢‘é“
- è‡ªåŠ¨åŒºåˆ†ä¸åŒåˆ†ç‰‡
- æ— éœ€æ‰‹åŠ¨ç®¡ç†å‘½åç©ºé—´
```

#### ä¸ºä»€ä¹ˆä¸å½±å“å¿ƒè·³æœºåˆ¶

```javascript
å¿ƒè·³è·¯ç”±: POST /api/simple-stream/heartbeat
HLSè·¯ç”±:  GET /tunnel-proxy/hls/...

å®Œå…¨ä¸åŒçš„è·¯ç”±ï¼Œäº’ä¸å¹²æ‰° âœ…
```

#### ä¸ºä»€ä¹ˆä¸å½±å“å®æ—¶æ€§

```javascript
m3u8æ’­æ”¾åˆ—è¡¨: X-Cache: BYPASS  â† å®æ—¶æ›´æ–°
.tsåˆ†ç‰‡:     ç¼“å­˜3ç§’           â† ç¬¦åˆHLSæ ‡å‡†

æ’­æ”¾åˆ—è¡¨å®æ—¶æ›´æ–°ä¿è¯äº†å®æ—¶æ€§ âœ…
```

### é™åˆ¶ä¸æ³¨æ„äº‹é¡¹

1. **ç¼“å­˜å‘½ä¸­ç‡å—ç”¨æˆ·åŒæ­¥æ€§å½±å“**
   - ç”¨æˆ·è§‚çœ‹è¶ŠåŒæ­¥ï¼Œç¼“å­˜å‘½ä¸­ç‡è¶Šé«˜
   - å¼‚æ­¥è§‚çœ‹ä¼šå¯¼è‡´æ¯ä¸ªç”¨æˆ·è¯·æ±‚ä¸åŒçš„åˆ†ç‰‡

2. **è¾¹ç¼˜èŠ‚ç‚¹ç¼“å­˜ç‹¬ç«‹**
   - ä¸åŒåœ°ç†ä½ç½®çš„ç”¨æˆ·è¿æ¥ä¸åŒçš„Cloudflareè¾¹ç¼˜èŠ‚ç‚¹
   - æ¯ä¸ªè¾¹ç¼˜èŠ‚ç‚¹ç‹¬ç«‹ç¼“å­˜
   - å¯¹äºåœ°ç†é›†ä¸­çš„ç”¨æˆ·ï¼ˆå¦‚åŒä¸€åŸå¸‚ï¼‰æ•ˆæœæœ€ä½³

3. **Workerså…è´¹é¢åº¦é™åˆ¶**
   - å…è´¹ç‰ˆï¼š10ä¸‡è¯·æ±‚/å¤©
   - ç¼“å­˜ä¸å‡å°‘Workersè¯·æ±‚æ•°ï¼ˆæ¯ä¸ªè¯·æ±‚éƒ½è®¡æ•°ï¼‰
   - ä½†å‡å°‘VPSæµé‡å’Œè´Ÿè½½

### éƒ¨ç½²ä¿¡æ¯

- **éƒ¨ç½²æ—¥æœŸ**: 2025-11-03
- **Git Commit**: df1d9ba0
- **ç¨³å®šç‰ˆæœ¬**: v2.9-stable
- **æ–‡æ¡£**: WORKERS_CACHE_IMPLEMENTATION_STAGED.md

---

### 4. æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿï¼ˆæ–°å¢ï¼‰â­

**åŠŸèƒ½æ¦‚è¿°**: å®šæ—¶é¢„åŠ è½½å…³é”®é¢‘é“ï¼Œå®ç°é›¶å»¶è¿Ÿæ’­æ”¾

**æ ¸å¿ƒç»„ä»¶**:

#### 4.1 PreloadSchedulerï¼ˆå®šæ—¶è°ƒåº¦å™¨ï¼‰
```javascript
// services/PreloadScheduler.js
class PreloadScheduler {
  // ä½¿ç”¨node-cronä¸ºæ¯ä¸ªé¢‘é“åˆ›å»ºç²¾ç¡®å®šæ—¶ä»»åŠ¡
  scheduledJobs = new Map();  // channelId -> [startJob, endJob]
  workdayChecker = null;  // ğŸ†• å·¥ä½œæ—¥æ£€æµ‹å™¨å®ä¾‹
  
  async start() {
    // ğŸ†• 1. åˆå§‹åŒ–å·¥ä½œæ—¥æ£€æµ‹å™¨ï¼ˆé¢„å–å½“å‰æœˆ+ä¸‹æœˆæ•°æ®ï¼‰
    await this.workdayChecker.initialize();
    
    // 2. ä»Workers APIè·å–æ‰€æœ‰é¢„åŠ è½½é…ç½®
    // 3. ä¸ºæ¯ä¸ªå¯ç”¨çš„é¢‘é“åˆ›å»ºå¼€å§‹/ç»“æŸå®šæ—¶ä»»åŠ¡
    // 4. æœåŠ¡å¯åŠ¨æ—¶æ£€æµ‹å¹¶ç«‹å³å¯åŠ¨åº”é¢„åŠ è½½çš„é¢‘é“
  }
  
  async shouldPreloadNow(config, currentTime) {
    // æ­¥éª¤1: æ£€æŸ¥æ—¶é—´æ®µ
    const inTimeRange = this.isInTimeRange(currentTime, startTime, endTime);
    if (!inTimeRange) return false;
    
    // ğŸ†• æ­¥éª¤2: æ£€æŸ¥å·¥ä½œæ—¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (config.workdaysOnly) {
      const isWorkday = await this.workdayChecker.isWorkday();
      if (!isWorkday) {
        return false;  // éå·¥ä½œæ—¥ï¼Œè·³è¿‡é¢„åŠ è½½
      }
    }
    return true;
  }
  
  schedulePreload(channelId, config) {
    // åˆ›å»ºå¼€å§‹ä»»åŠ¡: cron.schedule('40 7 * * *', async () => {
    //   ğŸ†• å®æ—¶æ£€æŸ¥æ˜¯å¦åº”è¯¥å¯åŠ¨ï¼ˆåŒ…å«å·¥ä½œæ—¥æ£€æŸ¥ï¼‰
    //   if (await shouldPreloadNow(config, currentTime)) {
    //     await startPreload(config);
    //   }
    // })
    
    // åˆ›å»ºç»“æŸä»»åŠ¡: cron.schedule('20 17 * * *', ...)
  }
}
```

**è°ƒåº¦ç­–ç•¥**:
- âœ… åŸºäºåŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰çš„ç²¾ç¡®cronä»»åŠ¡
- âœ… æ¯ä¸ªé¢‘é“2ä¸ªä»»åŠ¡ï¼ˆå¼€å§‹+ç»“æŸï¼‰ï¼Œä¾‹å¦‚07:40å¯åŠ¨ï¼Œ17:20åœæ­¢
- âœ… **å·¥ä½œæ—¥æ™ºèƒ½åˆ¤æ–­**: å®šæ—¶ä»»åŠ¡è§¦å‘æ—¶å®æ—¶æ£€æŸ¥å·¥ä½œæ—¥ â­
- âœ… é…ç½®å˜æ›´æ—¶çƒ­é‡è½½ï¼Œç«‹å³ç”Ÿæ•ˆ
- âœ… æœåŠ¡é‡å¯æ—¶è‡ªåŠ¨æ£€æµ‹å½“å‰æ—¶æ®µï¼Œç«‹å³å¯åŠ¨åº”é¢„åŠ è½½çš„é¢‘é“
- âœ… **å®¹é”™é™çº§**: APIå¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºæ¯æ—¥é¢„åŠ è½½ï¼Œä¸ä¸­æ–­æœåŠ¡ â­

#### 4.2 SimpleStreamManageré¢„åŠ è½½æ”¯æŒ
```javascript
// é¢„åŠ è½½æ ‡è®°æœºåˆ¶
class SimpleStreamManager {
  preloadChannels = new Set();  // é¢„åŠ è½½é¢‘é“é›†åˆ
  
  startPreload(channelId, rtmpUrl) {
    // 1. å¯åŠ¨FFmpegè½¬ç è¿›ç¨‹
    // 2. æ·»åŠ åˆ°preloadChannelsé›†åˆ
    // 3. å¿ƒè·³æ¸…ç†é€»è¾‘è‡ªåŠ¨è·³è¿‡é¢„åŠ è½½é¢‘é“
  }
  
  cleanupIdleChannels() {
    // è·³è¿‡é¢„åŠ è½½é¢‘é“çš„è‡ªåŠ¨æ¸…ç†
    if (this.preloadChannels.has(channelId)) {
      return; // ä¿ç•™é¢„åŠ è½½è¿›ç¨‹
    }
  }
}
```

#### 4.3 PreloadHealthCheckï¼ˆå¥åº·æ£€æŸ¥ï¼‰
```javascript
// services/PreloadHealthCheck.js
class PreloadHealthCheck {
  CHECK_INTERVAL = 5 * 60 * 1000;  // æ¯5åˆ†é’Ÿæ£€æŸ¥
  
  async performHealthCheck() {
    // 1. æ£€æŸ¥é¢„åŠ è½½è¿›ç¨‹æ˜¯å¦å­˜æ´»
    // 2. éªŒè¯HLSæ–‡ä»¶æ˜¯å¦æ­£å¸¸ç”Ÿæˆ
    // 3. è¿›ç¨‹å´©æºƒè‡ªåŠ¨é‡å¯ï¼ˆæœ€å¤š3æ¬¡ï¼‰
  }
}
```

**KVå­˜å‚¨ç»“æ„** (å·²æ•´åˆåˆ°é¢‘é“é…ç½®ä¸­):
```json
{
  "channel:stream_ensxma2g": {
    "id": "stream_ensxma2g",
    "name": "äºŒæ¥¼æ•™å®¤1",
    "rtmpUrl": "rtmp://push228.dodool.com.cn/55/19",
    "sortOrder": 1,
    "status": "active",
    "preloadConfig": {
      "enabled": true,
      "startTime": "07:00",
      "endTime": "17:30",
      "workdaysOnly": true,
      "updatedAt": "2025-10-27T09:00:00Z",
      "updatedBy": "admin"
    },
    "createdAt": "2025-10-01T00:00:00Z",
    "updatedAt": "2025-10-27T09:00:00Z"
  }
}
```

**æ³¨**: é¢„åŠ è½½é…ç½®ä½œä¸º `preloadConfig` å­—æ®µåµŒå…¥åˆ°é¢‘é“é…ç½®ä¸­ï¼Œä¸å†ä½¿ç”¨ç‹¬ç«‹çš„ `PRELOAD_CONFIG:*` é”®ã€‚

#### 4.4 WorkdayCheckerï¼ˆå·¥ä½œæ—¥æ£€æµ‹å™¨ï¼‰â­ æ–°å¢

**åŠŸèƒ½æ¦‚è¿°**: æ™ºèƒ½è¯†åˆ«å·¥ä½œæ—¥ï¼Œæ”¯æŒæ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘è¯†åˆ«

```javascript
// services/WorkdayChecker.js
class WorkdayChecker {
  apiUrl = 'https://timor.tech/api/holiday/info';
  cache = new Map();  // å†…å­˜ç¼“å­˜
  failedMonths = new Set();  // å¤±è´¥æœˆä»½è·Ÿè¸ª
  
  async initialize() {
    // 1. é¢„å–å½“å‰æœˆ+ä¸‹æœˆå·¥ä½œæ—¥æ•°æ®
    // 2. è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©å‡Œæ™¨1ç‚¹æ£€æŸ¥
    //    - 25å·é¢„å–ä¸‹æœˆæ•°æ®
    //    - é‡è¯•å¤±è´¥çš„æœˆä»½
  }
  
  async isWorkday(date = new Date()) {
    // 1. æ£€æŸ¥ç¼“å­˜ â†’ å‘½ä¸­è¿”å›ï¼ˆ24å°æ—¶æœ‰æ•ˆæœŸï¼‰
    // 2. è°ƒç”¨API â†’ type=0æˆ–3ä¸ºå·¥ä½œæ—¥
    // 3. å¤±è´¥é™çº§ â†’ å‘¨ä¸€è‡³å‘¨äº”=å·¥ä½œæ—¥ï¼ˆæ— æ³•è¯†åˆ«èŠ‚å‡æ—¥ï¼‰
    // 4. å†™å…¥ç¼“å­˜
  }
}
```

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… **æ•°æ®æº**: Timor API (å…è´¹ã€ç¨³å®šã€å‡†ç¡®)
- âœ… **æ•°æ®é¢„å–**: å¯åŠ¨æ—¶é¢„å–å½“å‰æœˆ+ä¸‹æœˆï¼Œ25å·è‡ªåŠ¨é¢„å–ä¸‹æœˆ
- âœ… **æ™ºèƒ½ç¼“å­˜**: å†…å­˜ç¼“å­˜ + 24å°æ—¶æœ‰æ•ˆæœŸï¼Œ95%è¯·æ±‚<1ms
- âœ… **å¤±è´¥é‡è¯•**: è‡ªåŠ¨è·Ÿè¸ªå¤±è´¥æœˆä»½ï¼Œæ¯å¤©å‡Œæ™¨1ç‚¹é‡è¯•
- âœ… **å®¹é”™é™çº§**: APIå¤±è´¥æ—¶é™çº§ä¸ºåŸºç¡€æ¨¡å¼ï¼ˆå‘¨ä¸€è‡³å‘¨äº”ï¼‰
- âœ… **èŠ‚å‡æ—¥è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«æ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘å·¥ä½œæ—¥

**å·¥ä½œæ—¥ç±»å‹**:
- `type=0` - æ­£å¸¸å·¥ä½œæ—¥ï¼ˆå‘¨ä¸€è‡³å‘¨äº”ï¼‰
- `type=1` - å‘¨æœ«ä¼‘æ¯æ—¥
- `type=2` - æ³•å®šèŠ‚å‡æ—¥
- `type=3` - è°ƒä¼‘å·¥ä½œæ—¥ï¼ˆéœ€è¦ä¸Šç­ï¼‰

**APIè°ƒç”¨ä¼˜åŒ–**:
```javascript
// æ·»åŠ User-Agenté¿å…Cloudflare Boté˜²æŠ¤
fetch(apiUrl, {
  headers: {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0'
  }
});
```

**Workers APIç«¯ç‚¹**:
- `GET /api/preload/config/:channelId` - è·å–é¢‘é“é¢„åŠ è½½é…ç½®
- `PUT /api/preload/config/:channelId` - æ›´æ–°é¢‘é“é¢„åŠ è½½é…ç½®ï¼ˆå«workdaysOnlyï¼‰
- `GET /api/preload/status` - æŸ¥è¯¢é¢„åŠ è½½ç³»ç»ŸçŠ¶æ€
- `GET /api/preload/workday-status` - æŸ¥è¯¢å·¥ä½œæ—¥æ£€æµ‹å™¨çŠ¶æ€ â­ æ–°å¢
- `POST /api/preload/reload` - é‡è½½è°ƒåº¦å™¨é…ç½®

**VPS APIç«¯ç‚¹**:
- `GET /api/preload/workday-status` - è¿”å›å·¥ä½œæ—¥æ•°æ®å°±ç»ªçŠ¶æ€å’Œå¤±è´¥æœˆä»½

**å‰ç«¯ç®¡ç†ç•Œé¢**:
- é¢‘é“åˆ—è¡¨ä¸­æ·»åŠ "é¢„åŠ è½½"æŒ‰é’®
- PreloadConfigDialogç»„ä»¶ï¼š
  - é¢„åŠ è½½å¼€å…³ï¼ˆenabledï¼‰
  - å¼€å§‹/ç»“æŸæ—¶é—´
  - **ä»…å·¥ä½œæ—¥å¼€å…³ï¼ˆworkdaysOnlyï¼‰** â­ æ–°å¢
  - **å·¥ä½œæ—¥çŠ¶æ€æ˜¾ç¤º** â­ æ–°å¢
    - âœ… æ•°æ®å·²åŠ è½½ (success)
    - âš ï¸ Nä¸ªæœˆä»½å¾…é‡è¯• (warning)
    - ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ® (info)
    - âŒ è·å–çŠ¶æ€å¤±è´¥ (danger)
- æ—¶æ®µæè¿°åŠ¨æ€æ˜¾ç¤ºï¼š
  - workdaysOnly=false: "é¢„åŠ è½½æ—¶æ®µï¼šæ¯å¤© 07:40 - 17:25"
  - workdaysOnly=true: "é¢„åŠ è½½æ—¶æ®µï¼šå·¥ä½œæ—¥ 07:40 - 17:25"

**æ€§èƒ½ä¼˜åŒ–æ•ˆæœ**:
- âš¡ **é›¶å»¶è¿Ÿæ’­æ”¾**: é¢„åŠ è½½æ—¶æ®µç”¨æˆ·ç‚¹å‡»ç«‹å³æ’­æ”¾ï¼ˆ<0.5ç§’ï¼‰
- ğŸ’° **èµ„æºèŠ‚çœ**: ä»…åœ¨é…ç½®æ—¶æ®µè¿è¡Œï¼Œéæ—¶æ®µè‡ªåŠ¨åœæ­¢
- ğŸ¯ **ç²¾ç¡®è°ƒåº¦**: cronä»»åŠ¡å‡†ç‚¹è§¦å‘ï¼Œæ— è½®è¯¢æ¶ˆè€—

---

## ğŸ¬ é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿ

**ç‰ˆæœ¬**: V2.4 (2025-10-28)  
**æ–‡æ¡£**: `doc/RECORDING_IMPLEMENTATION_STAGED.md`  
**çŠ¶æ€**: âœ… å·²éƒ¨ç½²

### 5.1 æ ¸å¿ƒæ¶æ„

**è®¾è®¡ç†å¿µ**: ä¸€è¿›ç¨‹åŒè¾“å‡ºï¼Œé›¶å†—ä½™æ•°æ®

```javascript
// å•ä¸ªFFmpegè¿›ç¨‹åŒæ—¶è¾“å‡ºHLSï¼ˆè§‚çœ‹ï¼‰å’ŒMP4ï¼ˆå½•åˆ¶ï¼‰
ffmpeg -i rtmp://input
  // HLSè¾“å‡ºï¼ˆå®æ—¶è§‚çœ‹ï¼‰
  -c:v libx264 -preset ultrafast -an
  -f hls -hls_time 2 -hls_list_size 6
  output.m3u8
  
  // MP4è¾“å‡ºï¼ˆå½•åˆ¶æ–‡ä»¶ï¼‰
  -c:v copy -f mp4 -y
  recording.mp4
```

### 5.2 RecordSchedulerï¼ˆå½•åˆ¶è°ƒåº¦å™¨ï¼‰

**åŠŸèƒ½**: åŸºäºnode-cronçš„å®šæ—¶ä»»åŠ¡ç®¡ç†

```javascript
// services/RecordScheduler.js
class RecordScheduler {
  constructor(streamManager) {
    this.streamManager = streamManager;
    this.cronTasks = new Map();  // Map<channelId, {startTask, stopTask}>
    this.workdayChecker = new WorkdayChecker();  // å¤ç”¨å·¥ä½œæ—¥æ£€æµ‹å™¨
  }
  
  scheduleChannel(config) {
    const { channelId, startTime, endTime } = config;
    
    // å¼€å§‹å½•åˆ¶ä»»åŠ¡ï¼ˆå¦‚ 07:40ï¼‰
    const startCron = `${startM} ${startH} * * *`;
    const startTask = cron.schedule(startCron, async () => {
      if (await this.shouldRecordNow(config)) {
        await this.streamManager.enableRecording(channelId, config);
      }
    }, { timezone: 'Asia/Shanghai' });
    
    // åœæ­¢å½•åˆ¶ä»»åŠ¡ï¼ˆå¦‚ 17:25ï¼‰
    const stopCron = `${endM} ${endH} * * *`;
    const stopTask = cron.schedule(stopCron, async () => {
      await this.streamManager.disableRecording(channelId);
    }, { timezone: 'Asia/Shanghai' });
    
    this.cronTasks.set(channelId, { startTask, stopTask });
  }
}
```

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… **å®šæ—¶ä»»åŠ¡**: åŸºäºnode-cronçš„å‡†ç‚¹è§¦å‘
- âœ… **å·¥ä½œæ—¥æ”¯æŒ**: å¤ç”¨WorkdayCheckerï¼Œæ”¯æŒæ³•å®šèŠ‚å‡æ—¥è¯†åˆ«
- âœ… **è·¨å¤©æ”¯æŒ**: æ­£ç¡®å¤„ç†23:00-01:00ç­‰è·¨å¤©æ—¶é—´æ®µ
- âœ… **é…ç½®çƒ­é‡è½½**: é…ç½®æ›´æ–°åè‡ªåŠ¨é‡è½½è°ƒåº¦
- âœ… **å¯åŠ¨æ¢å¤**: æœåŠ¡é‡å¯æ—¶æ£€æµ‹å½“å‰æ—¶æ®µï¼Œè‡ªåŠ¨æ¢å¤å½•åˆ¶

### 5.3 SimpleStreamManagerå½•åˆ¶æ”¯æŒ

**æ‰©å±•åŠŸèƒ½**: åœ¨åŸæœ‰è½¬ç ç®¡ç†åŸºç¡€ä¸Šæ·»åŠ å½•åˆ¶èƒ½åŠ›

```javascript
class SimpleStreamManager {
  recordingChannels = new Set();      // å½•åˆ¶ä¸­çš„é¢‘é“é›†åˆ
  recordingConfigs = new Map();       // é¢‘é“å½•åˆ¶é…ç½®
  recordingBaseDir = '/var/www/recordings';
  
  async enableRecording(channelId, recordConfig) {
    // 1. ä¿å­˜é…ç½®
    this.recordingConfigs.set(channelId, recordConfig);
    this.recordingChannels.add(channelId);
    
    // 2. å¯åŠ¨å¸¦å½•åˆ¶çš„FFmpegè¿›ç¨‹ï¼ˆæˆ–é‡å¯ç°æœ‰è¿›ç¨‹ï¼‰
    await this.startStreamWithRecording(channelId, rtmpUrl, recordConfig);
  }
  
  async spawnFFmpegWithRecording(channelId, rtmpUrl, recordingPath) {
    // FFmpegä¸€è¿›ç¨‹åŒè¾“å‡ºé…ç½®
    const ffmpegArgs = [
      '-i', rtmpUrl,
      '-c:v', 'libx264', '-preset', 'ultrafast', '-an',
      
      // HLSè¾“å‡º
      '-f', 'hls', '-hls_time', '2', '-hls_list_size', '6',
      'playlist.m3u8',
      
      // MP4å½•åˆ¶è¾“å‡ºï¼ˆcopyç¼–ç ï¼Œé›¶æŸè€—ï¼‰
      '-c:v', 'copy', '-f', 'mp4', '-y',
      recordingPath
    ];
  }
  
  cleanupIdleChannels() {
    // è·³è¿‡å½•åˆ¶é¢‘é“çš„è‡ªåŠ¨æ¸…ç†
    if (this.recordingChannels.has(channelId)) {
      return; // ä¿ç•™å½•åˆ¶è¿›ç¨‹
    }
  }
}
```

**å…³é”®æ”¹è¿›**:
- âœ… å½•åˆ¶è¿›ç¨‹ä¸å—å¿ƒè·³æ¸…ç†å½±å“
- âœ… ä¸è§‚çœ‹ã€é¢„åŠ è½½å…±äº«åŒä¸€FFmpegè¿›ç¨‹
- âœ… è‡ªåŠ¨åˆ›å»ºå½•åˆ¶ç›®å½•ï¼ˆ`fs.mkdirSync(recordDir, { recursive: true })`ï¼‰

### 5.4 æ–‡ä»¶å‘½åæ–¹æ¡ˆ

**æ··åˆå‘½å**: channelName + channelId + æ—¶é—´ä¿¡æ¯

```javascript
generateRecordingPath(channelId, channelName, recordConfig) {
  const dateStr = '20251028';          // YYYYMMDD
  const startTimeStr = '074000';       // HHMMSS
  const endTimeStr = '172500';         // HHMMSS
  
  // æ ¼å¼: {é¢‘é“å}_{é¢‘é“ID}_{æ—¥æœŸ}_{å¼€å§‹æ—¶é—´}_to_{ç»“æŸæ—¶é—´}.mp4
  const filename = `${channelName}_${channelId}_${dateStr}_${startTimeStr}_to_${endTimeStr}.mp4`;
  
  // è·¯å¾„: /var/www/recordings/{channelId}/{YYYYMMDD}/filename.mp4
  return path.join(basePath, channelId, dateStr, filename);
}
```

**ç¤ºä¾‹æ–‡ä»¶å**:
```
/var/www/recordings/stream_ensxma2g/20251028/
  äºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251028_074000_to_172500.mp4
```

**ä¼˜åŠ¿**:
- âœ… å¯è¯»æ€§å¥½ï¼šåŒ…å«ä¸­æ–‡é¢‘é“å
- âœ… å”¯ä¸€æ€§å¼ºï¼šåŒ…å«é¢‘é“IDé¿å…å†²çª
- âœ… ä¿¡æ¯å®Œæ•´ï¼šåŒ…å«æ—¥æœŸå’Œæ—¶é—´æ®µ
- âœ… UTF-8æ”¯æŒï¼šç°ä»£ç³»ç»ŸåŸç”Ÿæ”¯æŒä¸­æ–‡æ–‡ä»¶å

### 5.5 å½•åˆ¶åˆ†æ®µåŠŸèƒ½

**ç‰ˆæœ¬**: V2.5 (2025-10-30)  
**æ–‡æ¡£**: `doc/RECORDING_SEGMENTATION_IMPLEMENTATION.md`  
**çŠ¶æ€**: âœ… å·²éƒ¨ç½²

#### æ ¸å¿ƒæ¦‚å¿µ

1. **åˆ†æ®µæ˜¯å¯é€‰çš„** - é€šè¿‡ç³»ç»Ÿè®¾ç½®å…¨å±€æ§åˆ¶ï¼Œé»˜è®¤å…³é—­
2. **ä¸¤æ­¥æ³•å®ç°** - å½•åˆ¶æ—¶ç”¨ä¸´æ—¶åï¼Œåœæ­¢åé‡å‘½åä¸ºæ­£å¼å
3. **æ–‡ä»¶å‘½åå»¶ç»­ç°æœ‰è§„èŒƒ** - `{åç§°}_{ID}_{æ—¥æœŸ}_{å¼€å§‹}_to_{ç»“æŸ}.mp4`
4. **ä¸å½±å“è§‚çœ‹** - HLSå’ŒMP4å¹¶è¡Œè¾“å‡ºï¼Œäº’ä¸å¹²æ‰°

#### FFmpegåˆ†æ®µå‚æ•°

**å•æ–‡ä»¶æ¨¡å¼**ï¼ˆé»˜è®¤ï¼‰:
```javascript
// å®Œæ•´å½•åˆ¶æ—¶æ®µè¾“å‡ºä¸ºå•ä¸ªMP4æ–‡ä»¶
ffmpegArgs.push(
  '-c:v', 'copy',
  '-an',                    // ç¦ç”¨éŸ³é¢‘ï¼ˆé¿å…ç¼–ç å…¼å®¹æ€§é—®é¢˜ï¼‰
  '-f', 'mp4',
  '-y',
  recordingPath
);
```

**åˆ†æ®µæ¨¡å¼**ï¼ˆå¯ç”¨æ—¶ï¼‰:
```javascript
// æŒ‰æ—¶é—´åˆ†æ®µï¼Œè‡ªåŠ¨åˆ‡åˆ†å¤šä¸ªMP4æ–‡ä»¶
const segmentSeconds = recordConfig.segmentDuration * 60;  // è½¬ä¸ºç§’
const tempFilename = `${channelName}_${channelId}_${dateStr}_temp_%03d.mp4`;

ffmpegArgs.push(
  '-c:v', 'copy',
  '-an',
  '-f', 'segment',                      // ä½¿ç”¨segment muxer
  '-segment_time', segmentSeconds,      // åˆ†æ®µæ—¶é•¿ï¼ˆç§’ï¼‰
  '-segment_format', 'mp4',             // è¾“å‡ºæ ¼å¼
  '-reset_timestamps', '1',             // æ¯æ®µé‡ç½®æ—¶é—´æˆ³
  '-y',
  tempFilename                          // ä½¿ç”¨%03dæ¨¡å¼å‘½å
);
```

#### ä¸´æ—¶æ–‡ä»¶å‘½å

**å½•åˆ¶æ—¶ä½¿ç”¨ä¸´æ—¶å**ï¼ˆåŒ…å«`_temp_`æ ‡è®°ï¼‰:
```
äºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251030_temp_000.mp4
äºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251030_temp_001.mp4
äºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251030_temp_002.mp4
```

**é‡å‘½åä¸ºæ­£å¼å**ï¼ˆåŒ…å«å®é™…æ—¶é—´æ®µï¼‰:
```
äºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251030_074000_to_074500.mp4
äºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251030_074500_to_075000.mp4
äºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251030_075000_to_075230.mp4
```

#### é‡å‘½åé€»è¾‘

```javascript
async renameSegmentFiles(channelId, recordConfig) {
  // ç­‰å¾…2ç§’ç¡®ä¿FFmpegå®Œæˆæ–‡ä»¶å†™å…¥
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  const outputDir = path.join(recordConfig.storagePath, channelId, dateStr);
  const tempFiles = fs.readdirSync(outputDir)
    .filter(f => f.includes('_temp_') && f.endsWith('.mp4'))
    .sort();
  
  const sessionStart = new Date(recordConfig.sessionStartTime);
  const segmentDurationMs = recordConfig.segmentDuration * 60 * 1000;
  
  for (let i = 0; i < tempFiles.length; i++) {
    const startTime = new Date(sessionStart.getTime() + i * segmentDurationMs);
    const endTime = (i === tempFiles.length - 1) 
      ? new Date()  // æœ€åä¸€æ®µä½¿ç”¨å®é™…åœæ­¢æ—¶é—´
      : new Date(startTime.getTime() + segmentDurationMs);
    
    const startTimeStr = moment(startTime).format('HHmmss');
    const endTimeStr = moment(endTime).format('HHmmss');
    
    const finalFilename = `${recordConfig.channelName}_${channelId}_${dateStr}_${startTimeStr}_to_${endTimeStr}.mp4`;
    const finalPath = path.join(outputDir, finalFilename);
    
    fs.renameSync(tempPath, finalPath);
    logger.info(`Renamed segment: ${tempFiles[i]} â†’ ${finalFilename}`);
  }
}
```

**è§¦å‘æ—¶æœº**: åœ¨`disableRecording`æ–¹æ³•ä¸­ï¼Œåœæ­¢å½•åˆ¶å‰æ‰§è¡Œé‡å‘½å

#### ç³»ç»Ÿé…ç½®ç®¡ç†

**KVå­˜å‚¨**ï¼ˆ`system:cleanup_config`é”®ï¼‰:
```json
{
  "enabled": true,
  "retentionDays": 2,
  "segmentEnabled": false,    // ğŸ†• åˆ†æ®µå¼€å…³ï¼ˆå…¨å±€ï¼‰
  "segmentDuration": 60,      // ğŸ†• åˆ†æ®µæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  "updatedAt": "2025-10-30T02:00:00Z"
}
```

**RecordScheduleré›†æˆ**:
```javascript
async startRecording(config) {
  // è·å–ç³»ç»Ÿè®¾ç½®
  const systemSettings = await this.fetchSystemSettings();
  
  // åˆå¹¶åˆ°å½•åˆ¶é…ç½®
  const fullConfig = {
    ...config,
    segmentEnabled: systemSettings.segmentEnabled,
    segmentDuration: systemSettings.segmentDuration,
    sessionStartTime: Date.now()  // è®°å½•å½•åˆ¶å¼€å§‹æ—¶é—´
  };
  
  await this.streamManager.enableRecording(config.channelId, fullConfig);
}
```

**å‰ç«¯SystemSettingsDialog**:
```vue
<el-divider content-position="left">å½•åˆ¶åˆ†æ®µé…ç½®</el-divider>

<el-form-item label="å¯ç”¨å½•åˆ¶åˆ†æ®µ">
  <el-switch v-model="form.segmentEnabled" />
  <div class="form-tip">
    å¯ç”¨åï¼Œé•¿æ—¶é—´å½•åˆ¶å°†è‡ªåŠ¨åˆ†å‰²ä¸ºå¤šä¸ªæ–‡ä»¶ï¼Œä¾¿äºç®¡ç†å’ŒæŸ¥çœ‹
  </div>
</el-form-item>

<el-form-item label="åˆ†æ®µæ—¶é•¿" v-if="form.segmentEnabled">
  <el-input-number v-model="form.segmentDuration" :min="10" :max="240" />
  <span style="margin-left: 10px;">åˆ†é’Ÿ</span>
  <div style="margin-top: 10px;">
    <el-button size="small" @click="form.segmentDuration = 30">30åˆ†é’Ÿ</el-button>
    <el-button size="small" @click="form.segmentDuration = 60">1å°æ—¶</el-button>
    <el-button size="small" @click="form.segmentDuration = 120">2å°æ—¶</el-button>
  </div>
</el-form-item>
```

#### ä¼˜åŠ¿ä¸ç‰¹æ€§

- âœ… **çµæ´»æ§åˆ¶**: å…¨å±€å¼€å…³ï¼Œå¯éšæ—¶å¯ç”¨/ç¦ç”¨åˆ†æ®µ
- âœ… **è‡ªåŠ¨åˆ†å‰²**: FFmpegè‡ªåŠ¨æŒ‰æ—¶é•¿åˆ‡åˆ†ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
- âœ… **ç²¾ç¡®æ—¶é—´**: æ–‡ä»¶ååŒ…å«å®é™…å½•åˆ¶æ—¶é—´æ®µ
- âœ… **æœ€åä¸€æ®µ**: è‡ªåŠ¨å¤„ç†æœ€åä¸€æ®µçš„å®é™…ç»“æŸæ—¶é—´
- âœ… **é›¶å½±å“**: ä¸å½±å“HLSè§‚çœ‹å’Œå•æ–‡ä»¶æ¨¡å¼
- âœ… **æ˜“ç®¡ç†**: åˆ†æ®µæ–‡ä»¶ä¾¿äºåç»­æŸ¥çœ‹å’Œä¼ è¾“

### 5.6 KVå­˜å‚¨ç»“æ„

**æ•´åˆåˆ°é¢‘é“é…ç½®** (recordConfigå­—æ®µ):

```json
{
  "channel:stream_ensxma2g": {
    "id": "stream_ensxma2g",
    "name": "äºŒæ¥¼æ•™å®¤1",
    "rtmpUrl": "rtmp://...",
    "preloadConfig": {
      "enabled": true,
      "startTime": "07:40",
      "endTime": "17:25",
      "workdaysOnly": true
    },
    "recordConfig": {
      "enabled": true,
      "startTime": "07:40",
      "endTime": "17:25",
      "workdaysOnly": true,
      "storagePath": "/var/www/recordings",
      "updatedAt": "2025-10-28T12:00:00Z",
      "updatedBy": "admin"
    }
  }
}
```

**æ³¨**: 
- recordConfigä¸å­˜å‚¨channelNameï¼Œä»é¡¶å±‚nameè·å–ï¼ˆé¿å…æ•°æ®å†—ä½™ï¼‰
- storagePathå¯é…ç½®ï¼Œæ”¯æŒFileBrowserè·¯å¾„æ˜ å°„

### 5.7 APIç«¯ç‚¹

**Workers API**:
- `GET /api/record/config/:channelId` - è·å–é¢‘é“å½•åˆ¶é…ç½®
- `PUT /api/record/config/:channelId` - æ›´æ–°é¢‘é“å½•åˆ¶é…ç½®
- `GET /api/record/configs` - è·å–æ‰€æœ‰å¯ç”¨å½•åˆ¶çš„é¢‘é“ï¼ˆVPSè°ƒç”¨ï¼‰

**VPS API**:
- `POST /api/record/reload-schedule` - é‡æ–°åŠ è½½å½•åˆ¶è°ƒåº¦
- `GET /api/record/status` - è·å–å½•åˆ¶çŠ¶æ€

### 5.8 å‰ç«¯ç®¡ç†ç•Œé¢

**ChannelConfigDialog** (ç»Ÿä¸€é…ç½®å¯¹è¯æ¡†):

```vue
<template>
  <el-dialog title="é¢‘é“é…ç½®">
    <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šé¢„åŠ è½½é…ç½® -->
    <el-divider>é¢„åŠ è½½é…ç½®</el-divider>
    <el-switch v-model="preloadConfig.enabled" />
    <el-time-picker v-model="preloadConfig.startTime" />
    <el-time-picker v-model="preloadConfig.endTime" />
    <el-switch v-model="preloadConfig.workdaysOnly" />
    
    <!-- ä¸‹åŠéƒ¨åˆ†ï¼šå½•åˆ¶é…ç½® -->
    <el-divider>å½•åˆ¶é…ç½®</el-divider>
    <el-switch v-model="recordConfig.enabled" />
    <el-time-picker v-model="recordConfig.startTime" />
    <el-time-picker v-model="recordConfig.endTime" />
    <el-switch v-model="recordConfig.workdaysOnly" />
    <el-input v-model="recordConfig.storagePath" 
              placeholder="/var/www/recordings" />
  </el-dialog>
</template>
```

**ç‰¹ç‚¹**:
- âœ… ä¸Šä¸‹åˆ†åŒºï¼Œæ¸…æ™°ç›´è§‚
- âœ… å¹¶è¡Œä¿å­˜é¢„åŠ è½½å’Œå½•åˆ¶é…ç½®
- âœ… å®æ—¶çŠ¶æ€æ˜¾ç¤º
- âœ… è¡¨å•éªŒè¯

### 5.8 æŠ€æœ¯äº®ç‚¹

**1. ä¸€è¿›ç¨‹åŒè¾“å‡º**
- å•ä¸ªFFmpegè¿›ç¨‹åŒæ—¶ç”ŸæˆHLSï¼ˆå®æ—¶è§‚çœ‹ï¼‰å’ŒMP4ï¼ˆå½•åˆ¶æ–‡ä»¶ï¼‰
- èµ„æºå ç”¨minimalï¼Œå¯¹è§‚çœ‹æ— å½±å“

**2. é›¶æ•°æ®å†—ä½™**
- recordConfigä¸å­˜å‚¨channelName
- éœ€è¦æ—¶ä»é¡¶å±‚channel.nameè·å–
- ä¿è¯æ•°æ®ä¸€è‡´æ€§

**3. è¿›ç¨‹åè°ƒ**
- å½•åˆ¶ä¸è§‚çœ‹ã€é¢„åŠ è½½å…±äº«FFmpegè¿›ç¨‹
- æ™ºèƒ½åˆ¤æ–­ï¼šæœ‰è§‚çœ‹è€…æ—¶é‡å¯è¿›ç¨‹æ·»åŠ å½•åˆ¶ï¼Œæ— è§‚çœ‹è€…æ—¶åœæ­¢è¿›ç¨‹

**4. é…ç½®çƒ­é‡è½½**
- Workersä¿å­˜é…ç½®åè‡ªåŠ¨é€šçŸ¥VPS
- VPSè°ƒç”¨`reloadSchedule()`é‡æ–°åŠ è½½æ‰€æœ‰å®šæ—¶ä»»åŠ¡
- æ— éœ€é‡å¯æœåŠ¡

**5. è‡ªåŠ¨æ¢å¤**
- æœåŠ¡å¯åŠ¨5ç§’åè‡ªåŠ¨å¯åŠ¨RecordScheduler
- æ£€æµ‹å½“å‰æ—¶æ®µï¼Œç«‹å³æ¢å¤åº”å½•åˆ¶çš„é¢‘é“

---

## ğŸ›¡ï¸ å½•åˆ¶æ–‡ä»¶é˜²æŸåä¸ä¿®å¤ç³»ç»Ÿ

**ç‰ˆæœ¬**: V2.8 (2025-10-30)  
**æ–‡æ¡£**: `doc/RECORDING_RECOVERY_IMPLEMENTATION.md`  
**çŠ¶æ€**: âœ… å·²éƒ¨ç½²

### 6.1 åŠŸèƒ½æ¦‚è¿°

**è®¾è®¡ç†å¿µ**: åŒé‡ä¿æŠ¤æœºåˆ¶ï¼Œç¡®ä¿å½•åˆ¶æ–‡ä»¶åœ¨ç¨‹åºå´©æºƒæ—¶ä¸ä¸¢å¤±ã€ä¸æŸå

**æ ¸å¿ƒé—®é¢˜**:
1. âŒ **æ–‡ä»¶åå†²çª**: æ—§tempæ–‡ä»¶å‘½åç¼ºå°‘æ—¶é—´æˆ³ï¼Œé‡å¯åè¢«è¦†ç›–
2. âŒ **æ–‡ä»¶æŸå**: ç¨‹åºå´©æºƒå¯¼è‡´MP4æ–‡ä»¶æŸåæ— æ³•æ’­æ”¾
3. âŒ **å†å²æ–‡ä»¶ä¸¢å¤±**: æœªæ­£å¼å‘½åçš„tempæ–‡ä»¶æ— æ³•è¯†åˆ«

**è§£å†³æ–¹æ¡ˆ**:
1. âœ… **Fragmented MP4**: FFmpegå‚æ•°ä¼˜åŒ–ï¼Œç¡®ä¿å´©æºƒåå¯æ’­æ”¾
2. âœ… **æ–‡ä»¶åå”¯ä¸€æ€§**: tempæ–‡ä»¶åŒ…å«å¼€å§‹æ—¶é—´æˆ³ï¼Œé¿å…å†²çª
3. âœ… **è‡ªåŠ¨ä¿®å¤æœåŠ¡**: å¯åŠ¨æ—¶æ‰«æå¹¶ä¿®å¤å†å²tempæ–‡ä»¶

### 6.2 Fragmented MP4æŠ€æœ¯

**åŠŸèƒ½**: è®©MP4æ–‡ä»¶åœ¨æœªå®Œå…¨å†™å…¥æ—¶ä»å¯æ’­æ”¾

**FFmpegå‚æ•°é…ç½®**:
```javascript
// SimpleStreamManager.js - spawnFFmpegWithRecording()
const ffmpegArgs = [
  '-i', rtmpUrl,
  
  // HLSè¾“å‡ºï¼ˆå®æ—¶è§‚çœ‹ï¼‰
  '-c:v', 'libx264', '-preset', 'ultrafast',
  '-f', 'hls', '-hls_time', '2',
  'playlist.m3u8',
  
  // ğŸ†• MP4å½•åˆ¶è¾“å‡ºï¼ˆFragmented MP4ï¼‰
  '-c:v', 'copy',
  '-movflags', '+frag_keyframe+empty_moov+default_base_moof',  // å…³é”®å‚æ•°
  '-f', 'mp4', '-y',
  recordingPath
];
```

**å…³é”®å‚æ•°è¯´æ˜**:
- `frag_keyframe`: åœ¨æ¯ä¸ªå…³é”®å¸§å¤„åˆ›å»ºfragment
- `empty_moov`: åˆ›å»ºç©ºçš„moov boxåœ¨æ–‡ä»¶å¼€å¤´
- `default_base_moof`: ä½¿ç”¨é»˜è®¤çš„moof base

**æŠ€æœ¯åŸç†**:
```
ä¼ ç»ŸMP4ç»“æ„:
  [æ•°æ®] â†’ [å…ƒæ•°æ®moov] âŒ å´©æºƒæ—¶moovæœªå†™å…¥ï¼Œæ–‡ä»¶æŸå

Fragmented MP4ç»“æ„:
  [å…ƒæ•°æ®moov] â†’ [æ•°æ®fragment1] â†’ [æ•°æ®fragment2] â†’ ...
  âœ… moovå·²åœ¨å¼€å¤´ï¼Œå³ä½¿å´©æºƒï¼Œå·²å†™å…¥çš„fragmentå¯æ’­æ”¾
```

**éªŒè¯æ•ˆæœ**:
```bash
# å´©æºƒå‰ï¼š5.3M, 98ç§’
# ç¨‹åºå´©æºƒ...
# å´©æºƒåï¼š6.4M, 116ç§’ âœ… æ–‡ä»¶å¢é•¿ä¸”å¯æ’­æ”¾

ffprobe -v error -show_entries format=duration file.mp4
# è¾“å‡ºï¼š116.160000  â† æˆåŠŸè¯»å–æ—¶é•¿ï¼Œè¯æ˜æ–‡ä»¶å®Œæ•´å¯æ’­æ”¾
```

### 6.3 æ–‡ä»¶åå”¯ä¸€æ€§æ”¹è¿›

**é—®é¢˜æ ¹å› **: æ—§æ ¼å¼ç¼ºå°‘å¼€å§‹æ—¶é—´ï¼Œå¯¼è‡´æ–‡ä»¶åå†²çª

**æ—§æ ¼å¼** (âŒ æœ‰å†²çªé£é™©):
```
é¢‘é“å_é¢‘é“ID_æ—¥æœŸ_temp_XXX.mp4
äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_temp_000.mp4
  â†‘ æ¯æ¬¡å½•åˆ¶éƒ½ç”Ÿæˆç›¸åŒæ–‡ä»¶åï¼Œé‡å¯åè¢«è¦†ç›–ï¼
```

**æ–°æ ¼å¼** (âœ… å”¯ä¸€æ ‡è¯†):
```javascript
// SimpleStreamManager.js - generateRecordingPath()
if (recordConfig.segmentEnabled) {
  // ğŸ†• åŒ…å«å¼€å§‹æ—¶é—´ï¼ˆtimeStrï¼‰ç¡®ä¿å”¯ä¸€æ€§
  const filename = `${channelName}_${channelId}_${dateStr}_${timeStr}_temp_%03d.mp4`;
  //                                                         ^^^^^^^^ æ–°å¢ï¼šå¼€å§‹æ—¶é—´
  return path.join(basePath, channelId, dateStr, filename);
}
```

**å®é™…æ•ˆæœ**:
```
æ–°æ ¼å¼tempæ–‡ä»¶:
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_143511_temp_000.mp4  â† 14:35:11å¼€å§‹
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_144442_temp_000.mp4  â† 14:44:42å¼€å§‹
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_150922_temp_000.mp4  â† 15:09:22å¼€å§‹
  âœ… æ¯æ¬¡å½•åˆ¶ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼Œæ°¸ä¸å†²çª

ä¿®å¤åæ­£å¼æ–‡ä»¶:
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_143511_to_014434.mp4
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_144442_to_015335.mp4
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_150922_to_021934.mp4
```

### 6.4 RecordingRecoveryServiceï¼ˆè‡ªåŠ¨ä¿®å¤æœåŠ¡ï¼‰

**åŠŸèƒ½**: æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ‰«æå¹¶ä¿®å¤å†å²tempæ–‡ä»¶

**æ ¸å¿ƒæ¶æ„**:
```javascript
// services/RecordingRecoveryService.js
class RecordingRecoveryService {
  constructor(streamManager, systemConfig) {
    this.streamManager = streamManager;
    this.config = {
      enabled: true,
      delayStart: 5000,  // å»¶è¿Ÿ5ç§’å¯åŠ¨
      scanRecentHours: systemConfig.recoveryScanHours || 48,  // æ‰«æ48å°æ—¶å†…
      recordingsPath: process.env.RECORDINGS_PATH || '/srv/filebrowser/yoyo-k'
    };
  }
  
  async startup() {
    // å»¶è¿Ÿ5ç§’åå¯åŠ¨ï¼ˆç¡®ä¿ä¸»æœåŠ¡ç¨³å®šï¼‰
    setTimeout(() => {
      this.runRecovery().catch(err => 
        logger.error('Recovery failed', { error: err.message })
      );
    }, this.config.delayStart);
  }
}
```

**å·¥ä½œæµç¨‹**:
```
1. æœåŠ¡å¯åŠ¨
   â†“
2. å»¶è¿Ÿ5ç§’
   â†“
3. æ‰«æå½•åˆ¶ç›®å½•ï¼ˆé»˜è®¤48å°æ—¶å†…ï¼‰
   â†“
4. è¯†åˆ«tempæ–‡ä»¶
   â†“
5. æå–å¼€å§‹æ—¶é—´ï¼ˆä»æ–‡ä»¶åï¼‰
   â†“
6. ä½¿ç”¨ffprobeè·å–è§†é¢‘æ—¶é•¿
   â†“
7. è®¡ç®—å®é™…ç»“æŸæ—¶é—´ï¼ˆæ–‡ä»¶ä¿®æ”¹æ—¶é—´ï¼‰
   â†“
8. é‡å‘½åä¸ºæ­£å¼æ ¼å¼
```

**æ–‡ä»¶è¯†åˆ«é€»è¾‘**:
```javascript
async findFilesNeedingRecovery() {
  const files = [];
  const channels = await this.getRecordingChannels();
  
  for (const channel of channels) {
    // æ‰«æé¢‘é“å½•åˆ¶ç›®å½•
    const channelDir = path.join(this.config.recordingsPath, channel.id);
    
    // éå†æ—¥æœŸç›®å½•ï¼ˆYYYYMMDDï¼‰
    const dateFiles = this.getRecentDateFiles(channelDir, scanRecentHours);
    
    for (const filePath of dateFiles) {
      const fileName = path.basename(filePath);
      
      // ğŸ” è¯†åˆ«tempæ–‡ä»¶
      if (fileName.includes('_temp_')) {
        logger.info(`ğŸ“¦ Found temp file: ${fileName}`);
        files.push({ path: filePath, type: 'temp', channel });
      }
    }
  }
  
  return files;
}
```

**é‡å‘½åé€»è¾‘**:
```javascript
async renameTempFile(file) {
  // åŒ¹é…æ–°æ ¼å¼ï¼šé¢‘é“å_é¢‘é“ID_æ—¥æœŸ_æ—¶é—´_temp_XXX.mp4
  const match = path.basename(file.path)
    .match(/(.+)_(.+)_(\d{8})_(\d{6})_temp_(\d{3})\.mp4$/);
  
  if (match) {
    const [, channelName, channelId, date, startTime] = match;
    
    // ä½¿ç”¨ffprobeè·å–è§†é¢‘æ—¶é•¿
    const duration = await this.getVideoDuration(file.path);
    
    // æ–‡ä»¶ä¿®æ”¹æ—¶é—´ä½œä¸ºç»“æŸæ—¶é—´
    const stat = fs.statSync(file.path);
    const fileEndTime = new Date(stat.mtimeMs);
    const endTimeStr = this.formatTime(fileEndTime);  // HHmmss
    
    // ç”Ÿæˆæ­£å¼æ–‡ä»¶å
    const newFileName = 
      `${channelName}_${channelId}_${date}_${startTime}_to_${endTimeStr}.mp4`;
    const newPath = path.join(path.dirname(file.path), newFileName);
    
    // é‡å‘½å
    fs.renameSync(file.path, newPath);
    logger.info('âœ… Temp file renamed', { 
      from: path.basename(file.path), 
      to: newFileName 
    });
  }
}
```

### 6.5 æœåŠ¡é›†æˆ

**app.jså¯åŠ¨æ—¶åˆå§‹åŒ–** (å…³é”®ä¿®å¤):
```javascript
// app.js
let RecordingRecoveryService = null;
try {
  RecordingRecoveryService = require('./services/RecordingRecoveryService');
  logger.info('ğŸ“¦ RecordingRecoveryServiceæ¨¡å—åŠ è½½æˆåŠŸ');
} catch (error) {
  logger.error('âŒ RecordingRecoveryServiceæ¨¡å—åŠ è½½å¤±è´¥', { 
    error: error.message,
    stack: error.stack
  });
}

// âœ… åœ¨æœåŠ¡å¯åŠ¨ååˆå§‹åŒ–ï¼ˆå…³é”®ï¼šé¿å…å¾ªç¯ä¾èµ–ï¼‰
app.listen(PORT, '0.0.0.0', () => {
  logger.info(`ğŸš€ VPS Transcoder API Server is running on port ${PORT}`);
  
  // åˆå§‹åŒ–Recovery Service
  if (RecordingRecoveryService && streamManager) {
    const systemConfig = {
      recoveryScanHours: parseInt(process.env.RECOVERY_SCAN_HOURS) || 48
    };
    
    const recoveryService = new RecordingRecoveryService(streamManager, systemConfig);
    recoveryService.startup();  // å»¶è¿Ÿ5ç§’åå¼€å§‹æ‰«æ
    
    logger.info('âœ… å½•åˆ¶æ–‡ä»¶æ¢å¤æœåŠ¡å·²å¯åŠ¨', {
      scanRecentHours: systemConfig.recoveryScanHours,
      recordingsPath: process.env.RECORDINGS_PATH || '/srv/filebrowser/yoyo-k'
    });
  }
});
```

**å…³é”®ç‚¹**: 
- âŒ ä¸èƒ½åœ¨app.jsé¡¶å±‚åŠ è½½æ—¶åˆå§‹åŒ–ï¼ˆæ­¤æ—¶ç«¯å£æœªç›‘å¬ï¼ŒAPIè°ƒç”¨å¤±è´¥ï¼‰
- âœ… å¿…é¡»åœ¨`app.listen()`å›è°ƒä¸­åˆå§‹åŒ–ï¼ˆæœåŠ¡å·²å¯åŠ¨ï¼‰

### 6.6 ç”Ÿäº§ç¯å¢ƒéªŒè¯

**æµ‹è¯•åœºæ™¯**: æœåŠ¡é‡å¯ï¼Œä¿®å¤6ä¸ªå†å²tempæ–‡ä»¶

**æ‰§è¡Œæ—¥å¿—**:
```json
{
  "message": "ğŸ”§ Starting recording file recovery..."
}
{
  "message": "ğŸ” Step 1: Finding files needing recovery..."
}
{
  "message": "ğŸ“Š Found 7 file(s) needing recovery"
}
{
  "message": "ğŸ”§ Renaming temp file: äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_150922_temp_001.mp4"
}
{
  "message": "âœ… Matched new format"
}
{
  "message": "ğŸ¯ Target name: äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_150922_to_021934.mp4"
}
{
  "from": "äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_150922_temp_001.mp4",
  "to": "äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_150922_to_021934.mp4",
  "message": "âœ… Temp file renamed"
}
// ... é‡å¤5æ¬¡ ...
{
  "duration": "2.7s",
  "failed": 1,
  "renamed": 6,
  "repaired": 0,
  "total": 7,
  "message": "Recovery completed"
}
```

**ä¿®å¤ç»“æœ**:
```
ä¿®å¤å‰:
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_144316_temp_000.mp4
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_144442_temp_000.mp4
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_145341_temp_001.mp4
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_150922_temp_001.mp4
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_151941_temp_000.mp4
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_152914_temp_001.mp4
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_154318_temp_000.mp4  â† æ­£åœ¨å½•åˆ¶ï¼Œè·³è¿‡

ä¿®å¤å:
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_144316_to_014434.mp4  âœ…
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_144442_to_015335.mp4  âœ…
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_145341_to_020914.mp4  âœ…
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_150922_to_021934.mp4  âœ…
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_151941_to_022907.mp4  âœ…
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_152914_to_024311.mp4  âœ…
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251030_154318_temp_000.mp4  â† æ­£åœ¨å½•åˆ¶

æˆåŠŸç‡: 85.7% (6/7ï¼Œ1ä¸ªæ­£åœ¨ä½¿ç”¨ä¸­)
```

### 6.7 æŠ€æœ¯äº®ç‚¹

**1. åŒé‡ä¿æŠ¤æœºåˆ¶**
- âœ… **é˜²æŸå**: Fragmented MP4ç¡®ä¿å´©æºƒåå¯æ’­æ”¾
- âœ… **é˜²è¦†ç›–**: æ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³ï¼Œæ°¸ä¸å†²çª
- âœ… **è‡ªåŠ¨ä¿®å¤**: å†å²tempæ–‡ä»¶è‡ªåŠ¨è¯†åˆ«å’Œé‡å‘½å

**2. é›¶äººå·¥å¹²é¢„**
- æœåŠ¡å¯åŠ¨è‡ªåŠ¨æ‰«æ
- è‡ªåŠ¨è¯†åˆ«tempæ–‡ä»¶
- è‡ªåŠ¨æå–æ—¶é—´ä¿¡æ¯
- è‡ªåŠ¨ç”Ÿæˆæ­£å¼æ–‡ä»¶å

**3. å®¹é”™è®¾è®¡**
- æ‰«æå¤±è´¥ä¸å½±å“ä¸»æœåŠ¡
- å•ä¸ªæ–‡ä»¶ä¿®å¤å¤±è´¥ä¸å½±å“å…¶ä»–æ–‡ä»¶
- æ­£åœ¨ä½¿ç”¨çš„æ–‡ä»¶è‡ªåŠ¨è·³è¿‡
- è¯¦ç»†æ—¥å¿—ä¾¿äºé—®é¢˜å®šä½

**4. æ€§èƒ½ä¼˜åŒ–**
- å»¶è¿Ÿ5ç§’å¯åŠ¨ï¼ˆé¿å…å½±å“ä¸»æœåŠ¡ï¼‰
- ä»…æ‰«ææœ€è¿‘48å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
- å¼‚æ­¥æ‰§è¡Œï¼ˆ`setImmediate`é¿å…é˜»å¡ï¼‰
- å•æ¬¡æ‰«æå®Œæˆå³é€€å‡ºï¼ˆéæŒç»­æœåŠ¡ï¼‰

### 6.8 é…ç½®ç®¡ç†

**ç¯å¢ƒå˜é‡**:
```bash
# .env
RECORDINGS_PATH=/srv/filebrowser/yoyo-k  # å½•åˆ¶æ ¹ç›®å½•
RECOVERY_SCAN_HOURS=48                    # æ‰«ææ—¶é•¿ï¼ˆå°æ—¶ï¼‰
```

**SystemSettingsDialog**ï¼ˆå‰ç«¯é…ç½®ï¼‰:
```vue
<el-form-item label="æ–‡ä»¶ä¿®å¤æ‰«ææ—¶é•¿">
  <el-input-number 
    v-model="form.recoveryScanHours" 
    :min="12" 
    :max="168"
  />
  <span style="margin-left: 10px;">å°æ—¶</span>
  <div class="form-tip">
    æœåŠ¡å¯åŠ¨æ—¶æ‰«æå¹¶ä¿®å¤æœ€è¿‘Nå°æ—¶å†…çš„tempæ–‡ä»¶ï¼ˆèŒƒå›´ï¼š12-168å°æ—¶ï¼‰
  </div>
</el-form-item>
```

**KVå­˜å‚¨** (`system:cleanup_config`):
```json
{
  "enabled": true,
  "retentionDays": 2,
  "segmentEnabled": false,
  "segmentDuration": 60,
  "recoveryScanHours": 48,  // ğŸ†• ä¿®å¤æ‰«ææ—¶é•¿
  "updatedAt": "2025-10-30T08:00:00Z"
}
```

### 6.9 éƒ¨ç½²æ³¨æ„äº‹é¡¹

**å…³é”®ä¿®å¤ç‚¹**:

1. **éƒ¨ç½²ç›®å½•**: PM2è¿è¡Œçš„æ˜¯ `/opt/yoyo-transcoder/`
   ```bash
   # âŒ é”™è¯¯ï¼šæ›´æ–°åˆ°é”™è¯¯ç›®å½•
   cp file.js /root/vps-transcoder-api/src/
   
   # âœ… æ­£ç¡®ï¼šæ›´æ–°åˆ°PM2è¿è¡Œç›®å½•
   cp file.js /opt/yoyo-transcoder/src/
   ```

2. **loggeræ¨¡å—**: ç›´æ¥requireï¼Œä¸èƒ½è°ƒç”¨
   ```javascript
   // âŒ é”™è¯¯
   const logger = require('../utils/logger')('RecordingRecoveryService');
   
   // âœ… æ­£ç¡®
   const logger = require('../utils/logger');
   ```

3. **å¯åŠ¨æ—¶æœº**: åœ¨app.listen()å›è°ƒä¸­åˆå§‹åŒ–
   ```javascript
   // âŒ é”™è¯¯ï¼šappåŠ è½½æ—¶åˆå§‹åŒ–ï¼ˆç«¯å£æœªç›‘å¬ï¼‰
   const recoveryService = new RecordingRecoveryService(...);
   
   // âœ… æ­£ç¡®ï¼šæœåŠ¡å¯åŠ¨ååˆå§‹åŒ–
   app.listen(PORT, () => {
     const recoveryService = new RecordingRecoveryService(...);
     recoveryService.startup();
   });
   ```

**éƒ¨ç½²è„šæœ¬**: ä½¿ç”¨ `vps-simple-deploy.sh` è‡ªåŠ¨åŒæ­¥
```bash
cd /tmp/github/secure-streaming-platform/vps-transcoder-api
./vps-simple-deploy.sh
# è‡ªåŠ¨åŒæ­¥åˆ° /opt/yoyo-transcoder/ å¹¶é‡å¯PM2
```

---

## ğŸ—‘ï¸ è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿ

**ç‰ˆæœ¬**: V2.4 (2025-10-28)  
**æ–‡æ¡£**: `doc/VIDEO_CLEANUP_IMPLEMENTATION.md`  
**çŠ¶æ€**: âœ… å·²éƒ¨ç½²

### 6.1 æ ¸å¿ƒæ¶æ„

**è®¾è®¡ç†å¿µ**: è‡ªåŠ¨åŒ–æ¸…ç†ï¼Œå®‰å…¨å¯æ§ï¼Œé›¶äººå·¥å¹²é¢„

```javascript
// VideoCleanupScheduler - å®šæ—¶æ¸…ç†è°ƒåº¦å™¨
class VideoCleanupScheduler {
  constructor() {
    this.cronTask = null;
    this.isRunning = false;
    this.workerApiUrl = process.env.WORKER_API_URL;
    this.apiKey = process.env.VPS_API_KEY;
  }
  
  // æ¯å¤©å‡Œæ™¨1ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è‡ªåŠ¨æ‰§è¡Œ
  start() {
    this.cronTask = cron.schedule('0 1 * * *', async () => {
      await this.executeCleanup();
    }, { timezone: 'Asia/Shanghai' });
  }
}
```

**æ¸…ç†ç­–ç•¥**:
- âœ… **å®šæ—¶æ¸…ç†**: æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨æ‰§è¡Œ
- âœ… **ä¿ç•™å¤©æ•°**: å¯é…ç½®ï¼ˆé»˜è®¤2å¤©ï¼‰
- âœ… **é¢‘é“éš”ç¦»**: å•ä¸ªé¢‘é“å¤±è´¥ä¸å½±å“å…¶ä»–é¢‘é“
- âœ… **å®‰å…¨éªŒè¯**: ä¸¥æ ¼çš„æ—¥æœŸæ ¼å¼æ ¡éªŒï¼Œé˜²æ­¢è¯¯åˆ 

### 6.2 æ¸…ç†æµç¨‹

```javascript
async executeCleanup() {
  // 1. è·å–æ¸…ç†é…ç½®
  const config = await this.fetchCleanupConfig();  // KV: system:cleanup:config
  if (!config.enabled) return;
  
  // 2. è®¡ç®—æˆªæ­¢æ—¥æœŸ
  const cutoffDate = moment().tz('Asia/Shanghai')
    .subtract(config.retentionDays, 'days')
    .format('YYYYMMDD');  // å¦‚: 20251026
  
  // 3. è·å–æ‰€æœ‰é¢‘é“é…ç½®
  const channels = await this.fetchChannelConfigs();
  
  // 4. éå†æ¯ä¸ªé¢‘é“è¿›è¡Œæ¸…ç†
  for (const channel of channels) {
    if (channel.recordConfig?.enabled) {
      const storagePath = path.join(
        channel.recordConfig.storagePath || '/var/www/recordings',
        channel.id
      );
      await this.cleanupChannelVideos(channel.id, storagePath, cutoffDate);
    }
  }
}
```

### 6.3 æ–‡ä»¶å¤¹æ ¡éªŒæœºåˆ¶

**ä¸¥æ ¼çš„æ—¥æœŸæ ¼å¼éªŒè¯** - é˜²æ­¢è¯¯åˆ é‡è¦æ–‡ä»¶

```javascript
isValidDateFolder(folderName) {
  // æ ¼å¼: YYYYMMDD
  if (!/^\d{8}$/.test(folderName)) return false;
  
  // å¹´ä»½: 1900-2099
  const year = parseInt(folderName.substring(0, 4));
  if (year < 1900 || year > 2099) return false;
  
  // æœˆä»½: 01-12
  const month = parseInt(folderName.substring(4, 6));
  if (month < 1 || month > 12) return false;
  
  // æ—¥æœŸ: 01-31
  const day = parseInt(folderName.substring(6, 8));
  if (day < 1 || day > 31) return false;
  
  return true;
}
```

**ç¤ºä¾‹**:
```
âœ… 20251025  â†’ åˆ é™¤ï¼ˆç¬¦åˆYYYYMMDDæ ¼å¼ï¼‰
âœ… 20251026  â†’ åˆ é™¤ï¼ˆç¬¦åˆYYYYMMDDæ ¼å¼ï¼‰
âŒ videos    â†’ è·³è¿‡ï¼ˆä¸ç¬¦åˆæ—¥æœŸæ ¼å¼ï¼‰
âŒ backup    â†’ è·³è¿‡ï¼ˆä¸ç¬¦åˆæ—¥æœŸæ ¼å¼ï¼‰
âŒ 2025-10-25 â†’ è·³è¿‡ï¼ˆåŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼‰
```

### 6.4 ç›®å½•ç»“æ„

**å®é™…æ–‡ä»¶å­˜å‚¨**:
```
/srv/filebrowser/yoyo-k/
â”œâ”€â”€ stream_gkg5hknc/
â”‚   â”œâ”€â”€ 20251025/           â† è‡ªåŠ¨åˆ é™¤ï¼ˆ2å¤©å‰ï¼‰
â”‚   â”œâ”€â”€ 20251026/           â† è‡ªåŠ¨åˆ é™¤ï¼ˆ2å¤©å‰ï¼‰
â”‚   â”œâ”€â”€ 20251027/           â† ä¿ç•™
â”‚   â””â”€â”€ 20251028/           â† ä¿ç•™
â””â”€â”€ stream_kcwxuedx/
    â”œâ”€â”€ 20251027/           â† ä¿ç•™
    â””â”€â”€ 20251028/           â† ä¿ç•™
```

### 6.5 KVå­˜å‚¨ç»“æ„

**æ¸…ç†é…ç½®** (`system:cleanup:config`):

```json
{
  "enabled": true,
  "retentionDays": 2
}
```

**å­—æ®µè¯´æ˜**:
- `enabled`: æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ¸…ç†ï¼ˆBooleanï¼‰
- `retentionDays`: ä¿ç•™å¤©æ•°ï¼ˆNumberï¼ŒèŒƒå›´1-365ï¼‰

### 6.6 APIç«¯ç‚¹

**Workers API**:
- `GET /api/admin/cleanup/config` - è·å–æ¸…ç†é…ç½®
- `PUT /api/admin/cleanup/config` - æ›´æ–°æ¸…ç†é…ç½®
- `POST /api/admin/cleanup/trigger` - æ‰‹åŠ¨è§¦å‘æ¸…ç†

**VPS API**:
- `POST /api/admin/cleanup/execute` - æ‰§è¡Œæ¸…ç†ï¼ˆéœ€API Keyè®¤è¯ï¼‰

**è°ƒç”¨æµç¨‹**:
```
å‰ç«¯ â†’ Workers â†’ VPS
1. å‰ç«¯ç‚¹å‡»"æ‰‹åŠ¨æ¸…ç†"
2. WorkerséªŒè¯ç”¨æˆ·æƒé™
3. Workersè°ƒç”¨VPSæ‰§è¡Œæ¸…ç†
4. VPSè¿”å›æ¸…ç†ç»“æœ
5. å‰ç«¯æ˜¾ç¤ºæ¸…ç†ç»Ÿè®¡
```

### 6.7 å‰ç«¯ç®¡ç†ç•Œé¢

**SystemSettingsDialog** (ç³»ç»Ÿè®¾ç½®å¯¹è¯æ¡†):

```vue
<template>
  <el-dialog title="ç³»ç»Ÿè®¾ç½®">
    <el-divider>è§†é¢‘æ¸…ç†é…ç½®</el-divider>
    
    <!-- å¯ç”¨å¼€å…³ -->
    <el-switch v-model="form.enabled" label="å¯ç”¨è‡ªåŠ¨æ¸…ç†" />
    
    <!-- ä¿ç•™å¤©æ•° -->
    <el-input-number v-model="form.retentionDays" 
                     :min="1" :max="365" />
    <div class="hint">åˆ é™¤ {{ form.retentionDays }} å¤©å‰çš„è§†é¢‘æ–‡ä»¶</div>
    
    <!-- æ¸…ç†æ—¶é—´æç¤º -->
    <el-tag type="info">æ¯å¤© 01:00 (åŒ—äº¬æ—¶é—´)</el-tag>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <el-button type="warning" @click="handleManualCleanup">
      æ‰‹åŠ¨æ¸…ç†
    </el-button>
    <el-button type="primary" @click="handleSave">
      ä¿å­˜
    </el-button>
  </el-dialog>
</template>
```

**äº¤äº’æµç¨‹**:
1. ç®¡ç†å‘˜ç‚¹å‡»"è®¾ç½®"æŒ‰é’®
2. å¼¹å‡ºSystemSettingsDialogå¯¹è¯æ¡†
3. ä¿®æ”¹é…ç½® â†’ ç‚¹å‡»"ä¿å­˜" â†’ æ›´æ–°KVå­˜å‚¨
4. ç‚¹å‡»"æ‰‹åŠ¨æ¸…ç†" â†’ ç¡®è®¤å¯¹è¯æ¡† â†’ è§¦å‘ç«‹å³æ¸…ç†

### 6.8 å®‰å…¨æœºåˆ¶

**1. ä¸¥æ ¼çš„æ—¥æœŸæ ¼å¼æ ¡éªŒ**
```javascript
// âœ… åªåˆ é™¤ä¸¥æ ¼åŒ¹é…YYYYMMDDæ ¼å¼çš„æ–‡ä»¶å¤¹
// âŒ ä»»ä½•å…¶ä»–æ ¼å¼ä¸€å¾‹è·³è¿‡
if (!this.isValidDateFolder(folderName)) {
  continue; // è·³è¿‡éæ—¥æœŸæ–‡ä»¶å¤¹
}
```

**2. APIè®¤è¯**
```javascript
// VPSæ¸…ç†ç«¯ç‚¹éœ€è¦API Keyè®¤è¯
const apiKey = req.headers['x-api-key'];
if (!apiKey || apiKey !== process.env.VPS_API_KEY) {
  return res.status(401).json({ status: 'error', message: 'Unauthorized' });
}
```

**3. é”™è¯¯éš”ç¦»**
```javascript
// å•ä¸ªé¢‘é“å¤±è´¥ä¸å½±å“å…¶ä»–é¢‘é“
for (const channel of channels) {
  try {
    await this.cleanupChannelVideos(channel.id, ...);
  } catch (error) {
    // è®°å½•é”™è¯¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªé¢‘é“
    result.errors.push({ channelId: channel.id, error: error.message });
  }
}
```

### 6.9 æŠ€æœ¯äº®ç‚¹

**1. å®šæ—¶ä»»åŠ¡**
- åŸºäºnode-cronï¼Œç²¾å‡†åˆ°åˆ†é’Ÿçº§
- åŒ—äº¬æ—¶é—´ï¼ˆAsia/Shanghaiï¼‰æ”¯æŒ
- æœåŠ¡å¯åŠ¨è‡ªåŠ¨æ¢å¤

**2. è·¯å¾„åŠ¨æ€æ‹¼æ¥**
```javascript
// ä»KVè·å–åŸºç¡€è·¯å¾„ï¼ŒåŠ¨æ€æ‹¼æ¥é¢‘é“ID
const baseStoragePath = channel.recordConfig.storagePath;
const storagePath = path.join(baseStoragePath, channel.id);
// ç»“æœ: /srv/filebrowser/yoyo-k/stream_kcwxuedx
```

**3. é…ç½®å¯æ§**
- å‰ç«¯å¯è§†åŒ–é…ç½®
- å®æ—¶ç”Ÿæ•ˆæ— éœ€é‡å¯
- æ”¯æŒå¯ç”¨/ç¦ç”¨å¼€å…³

**4. å®‰å…¨ä¿éšœ**
- ä¸‰é‡æ ¡éªŒï¼šæ ¼å¼ã€å¹´ä»½ã€æœˆä»½ã€æ—¥æœŸ
- ç™½åå•æœºåˆ¶ï¼šåªå¤„ç†å½•åˆ¶é¢‘é“
- APIè®¤è¯ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®

**5. ç›‘æ§å‹å¥½**
```javascript
// è¯¦ç»†çš„æ—¥å¿—è®°å½•
logger.info('Video cleanup completed', {
  totalChannels: 8,
  processedChannels: 2,
  deletedFolders: 4,
  duration: '2.3s'
});
```

---

## ğŸ”„ æ•°æ®æµè½¬æœºåˆ¶

### å®Œæ•´æ’­æ”¾æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·æµè§ˆå™¨
    participant W as Workers
    participant V as VPS
    participant R as RTMPæº
    
    U->>W: 1. è¯·æ±‚æ’­æ”¾é¢‘é“A
    W->>W: 2. åˆ¤æ–­åŒç»´åº¦è·¯ç”±
    W->>V: 3. å¯åŠ¨è½¬ç è¯·æ±‚
    V->>V: 4. æ£€æŸ¥ä»£ç†çŠ¶æ€
    V->>R: 5. è¿æ¥RTMPæºï¼ˆç›´è¿æˆ–ä»£ç†ï¼‰
    V->>V: 6. å¯åŠ¨FFmpegè½¬ç 
    V->>W: 7. è¿”å›åŸºç¡€HLSè·¯å¾„
    W->>W: 8. æ ¹æ®è·¯ç”±åŒ…è£…å®Œæ•´URL
    W->>U: 9. è¿”å›HLS URL
    U->>W: 10. è¯·æ±‚HLSæ–‡ä»¶ï¼ˆé€šè¿‡ä»£ç†ï¼‰
    W->>V: 11. ä»£ç†åˆ°Tunnelæˆ–ç›´è¿
    V->>U: 12. è¿”å›HLSæ–‡ä»¶å†…å®¹
    U->>U: 13. æ’­æ”¾è§†é¢‘
    U->>V: 14. æ¯30ç§’å‘é€å¿ƒè·³
```

### é¢‘é“é…ç½®ç®¡ç†

**å­˜å‚¨æ–¹å¼**: Cloudflare KV  
**Keyæ ¼å¼**: `channel:${channelId}`  
**æ•°æ®ç»“æ„**:
```json
{
  "channel:stream_xxx": {
    "id": "stream_xxx",
    "name": "é¢‘é“åç§°",
    "rtmpUrl": "rtmp://...",
    "sortOrder": 1,
    "status": "active",
    "preloadConfig": {
      "enabled": false,
      "startTime": "07:00",
      "endTime": "17:30",
      "workdaysOnly": false,
      "updatedAt": "2025-10-27T09:00:00Z",
      "updatedBy": "admin"
    },
    "createdAt": "2025-10-01T00:00:00Z",
    "updatedAt": "2025-10-27T09:00:00Z"
  }
}
```

**é…ç½®å­—æ®µè¯´æ˜**:
- `id`: é¢‘é“å”¯ä¸€æ ‡è¯†ç¬¦
- `name`: é¢‘é“æ˜¾ç¤ºåç§°
- `rtmpUrl`: RTMPæ¨æµåœ°å€
- `sortOrder`: æ˜¾ç¤ºæ’åºï¼ˆæ•°å­—è¶Šå°è¶Šé å‰ï¼‰
- `status`: é¢‘é“çŠ¶æ€ï¼ˆactive/inactiveï¼‰
- `preloadConfig`: é¢„åŠ è½½é…ç½®ï¼ˆåµŒå…¥å¼ï¼Œè§ä¸‹èŠ‚ï¼‰
- `createdAt`: åˆ›å»ºæ—¶é—´
- `updatedAt`: æœ€åæ›´æ–°æ—¶é—´

**é…ç½®æµç¨‹**:
1. ç®¡ç†åå°ç¼–è¾‘é¢‘é“é…ç½®ï¼ˆåŸºæœ¬ä¿¡æ¯æˆ–é¢„åŠ è½½é…ç½®ï¼‰
2. ä¿å­˜åˆ°Workers KVï¼ˆå•ä¸€é”®å­˜å‚¨ï¼‰
3. é…ç½®ç«‹å³ç”Ÿæ•ˆ
4. å‰ç«¯ä¸‹æ¬¡åŠ è½½è·å–æ–°é…ç½®

### é¢„åŠ è½½é…ç½®ç®¡ç† â­ å·²æ•´åˆåˆ°é¢‘é“é…ç½®

**å­˜å‚¨æ–¹å¼**: åµŒå…¥åˆ°é¢‘é“é…ç½®ä¸­ï¼ˆ`channel:${channelId}`ï¼‰  
**å­—æ®µåç§°**: `preloadConfig`  
**æ•°æ®ç»“æ„**:
```json
{
  "preloadConfig": {
    "enabled": true,
    "startTime": "07:00",
    "endTime": "17:30",
    "workdaysOnly": true,
    "updatedAt": "2025-10-27T09:00:00Z",
    "updatedBy": "admin"
  }
}
```

**å­—æ®µè¯´æ˜**:
- `enabled`: æ˜¯å¦å¯ç”¨é¢„åŠ è½½ï¼ˆå¸ƒå°”å€¼ï¼‰
- `startTime`: é¢„åŠ è½½å¼€å§‹æ—¶é—´ï¼ˆHH:MMæ ¼å¼ï¼‰
- `endTime`: é¢„åŠ è½½ç»“æŸæ—¶é—´ï¼ˆHH:MMæ ¼å¼ï¼Œå¯è·¨å¤©ï¼‰
- `workdaysOnly`: æ˜¯å¦ä»…å·¥ä½œæ—¥é¢„åŠ è½½ï¼ˆå¸ƒå°”å€¼ï¼‰
- `updatedAt`: é…ç½®æ›´æ–°æ—¶é—´
- `updatedBy`: é…ç½®æ›´æ–°è€…

**é…ç½®æµç¨‹**:
```mermaid
sequenceDiagram
    participant A as ç®¡ç†å‘˜
    participant F as å‰ç«¯
    participant W as Workers
    participant K as KVå­˜å‚¨
    participant V as VPSè°ƒåº¦å™¨
    
    A->>F: ç‚¹å‡»é¢„åŠ è½½é…ç½®
    F->>W: PUT /api/preload/config/:id
    W->>K: è¯»å–é¢‘é“é…ç½® channel:id
    K->>W: è¿”å›ç°æœ‰é…ç½®
    W->>W: æ›´æ–° preloadConfig å­—æ®µ
    W->>K: ä¿å­˜æ›´æ–°åçš„é¢‘é“é…ç½®
    W->>F: è¿”å›æˆåŠŸ
    F->>W: POST /api/preload/reload
    W->>V: é€šçŸ¥VPSé‡è½½é…ç½®
    V->>W: GET /api/preload/configs
    W->>K: éå†æ‰€æœ‰é¢‘é“é…ç½®
    K->>W: è¿”å›æ‰€æœ‰é…ç½®
    W->>V: è¿”å›å¯ç”¨çš„é¢„åŠ è½½é…ç½®åˆ—è¡¨
    V->>V: é‡æ–°åˆ›å»ºå®šæ—¶ä»»åŠ¡
```

**ä¼˜åŒ–è¯´æ˜**:
- âœ… **ç»Ÿä¸€å­˜å‚¨**: é¢‘é“é…ç½®å’Œé¢„åŠ è½½é…ç½®å­˜å‚¨åœ¨åŒä¸€ä¸ªKVé”®ä¸­
- âœ… **å‡å°‘KVæ“ä½œ**: è¯»å–é¢‘é“åˆ—è¡¨æ—¶è‡ªåŠ¨åŒ…å«é¢„åŠ è½½é…ç½®ï¼Œæ— éœ€é¢å¤–æŸ¥è¯¢
- âœ… **æ•°æ®ä¸€è‡´æ€§**: é¢‘é“å’Œé¢„åŠ è½½é…ç½®åŒæ­¥æ›´æ–°ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
- âœ… **ç®€åŒ–æ¶æ„**: ç§»é™¤ç‹¬ç«‹çš„ `PRELOAD_CONFIG:*` é”®ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### ç”Ÿäº§ç¯å¢ƒåŸŸå

| å±‚çº§ | åŸŸå | éƒ¨ç½²å¹³å° | åŠŸèƒ½ |
|------|------|---------|------|
| å‰ç«¯ | `yoyo.5202021.xyz` | Cloudflare Pages | ç”¨æˆ·ç•Œé¢ |
| API | `yoyoapi.5202021.xyz` | Cloudflare Workers | ä¸šåŠ¡é€»è¾‘ |
| VPS | `yoyo-vps.5202021.xyz` | RackNerd VPS | è½¬ç æœåŠ¡ |
| éš§é“ | `tunnel-*.yoyo-vps.5202021.xyz` | Cloudflare Tunnel | ç½‘ç»œä¼˜åŒ– |

### VPSæœåŠ¡å™¨é…ç½®

**æœåŠ¡å™¨ä¿¡æ¯**:
- IP: 142.171.75.220
- OS: CentOS 9
- CPU: 2 vCores
- RAM: 3GB
- å­˜å‚¨: 50GB SSD

**å·²å®‰è£…è½¯ä»¶**:
- Node.js: v18.20.8
- FFmpeg: 5.1.7
- Nginx: 1.20.1
- PM2: 6.0.13
- cloudflared: 2025.9.1

**ç«¯å£é…ç½®**:
```
3000  â†’ Node.js APIæœåŠ¡
52535 â†’ Nginx (HLSæ–‡ä»¶æœåŠ¡)
8080  â†’ File Browser (å†…éƒ¨ç®¡ç†)
```

### éƒ¨ç½²æµç¨‹ï¼ˆä¸€é”®ï¼‰

```bash
# 1. æäº¤ä»£ç åˆ°Git
git push origin master

# 2. éƒ¨ç½²Workers
cd cloudflare-worker
wrangler deploy --env production

# 3. éƒ¨ç½²VPSï¼ˆä¸€é”®è„šæœ¬ï¼‰
ssh root@142.171.75.220 "cd /tmp/github/secure-streaming-platform/vps-transcoder-api && chmod +x vps-simple-deploy.sh && ./vps-simple-deploy.sh"

# 4. å‰ç«¯è‡ªåŠ¨éƒ¨ç½²ï¼ˆCloudflare Pagesè‡ªåŠ¨è§¦å‘ï¼‰
```

### Origin Rulesé…ç½®ï¼ˆé‡è¦ï¼‰

**é—®é¢˜**: Workersä½¿ç”¨æ ‡å‡†443ç«¯å£ï¼Œä½†VPS Nginxç›‘å¬52535ç«¯å£

**è§£å†³**: Cloudflare Origin Rulesè‡ªåŠ¨ç«¯å£æ”¹å†™

```yaml
è§„åˆ™åç§°: yoyo-vps-api
è§¦å‘æ¡ä»¶: ä¸»æœºå = yoyo-vps.5202021.xyz
æ‰§è¡ŒåŠ¨ä½œ: è¦†å†™æºç«¯å£ HTTP/HTTPS = 52535
```

**è¯·æ±‚æµç¨‹**:
```
Workers fetch('https://yoyo-vps.5202021.xyz/...')
    â†“ (é»˜è®¤443ç«¯å£)
Cloudflare Edge (Origin Rules)
    â†“ (è‡ªåŠ¨æ”¹å†™ä¸º52535)
VPS Nginx:52535
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### åŒç»´åº¦è·¯ç”±ä¼˜åŒ–æ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|-------|------|
| HLSè¯·æ±‚å»¶è¿Ÿ | 200-500ms | <100ms | 50%+ |
| è§†é¢‘å¯æ’­æ—¶é—´ | 3-5ç§’ | <2ç§’ | 60%+ |
| æ’­æ”¾æµç•…åº¦ | å¶å°”å¡é¡¿ | æµç•… | æ˜¾è‘—æå‡ |

### Workersä»£ç†æ€§èƒ½

- Workersä»£ç†å±‚å»¶è¿Ÿ: ~10-50ms
- Cloudflareå†…éƒ¨ç½‘ç»œ: é«˜é€Ÿäº’è”
- æ•…éšœè½¬ç§»æ—¶é—´: <100ms

### FFmpegè½¬ç ä¼˜åŒ–

**è½¬ç å‚æ•°**:
```bash
ffmpeg -i rtmp://... \
  -c:v libx264 -preset veryfast \  # å¿«é€Ÿç¼–ç 
  -an \                             # æ— éŸ³é¢‘
  -hls_time 2 \                     # 2ç§’åˆ†ç‰‡
  -hls_list_size 5 \                # ä¿ç•™5ä¸ªåˆ†ç‰‡
  -f hls output.m3u8
```

**æ€§èƒ½ç‰¹ç‚¹**:
- 2ç§’åˆ†ç‰‡ï¼šå¹³è¡¡å»¶è¿Ÿå’Œç¨³å®šæ€§
- æ— éŸ³é¢‘ï¼šå‡å°‘è®¡ç®—è´Ÿè½½ï¼ˆæ ¹æ®éœ€æ±‚ï¼‰
- å¿«é€Ÿé¢„è®¾ï¼šé™ä½CPUä½¿ç”¨ç‡

---

## ğŸ” å®‰å…¨ä¸ç›‘æ§

### è®¤è¯æœºåˆ¶

**ç”¨æˆ·è®¤è¯**:
- æ–¹å¼: åŸºäºCookieçš„ä¼šè¯ç®¡ç†
- å¯†ç : PBKDF2å“ˆå¸Œç®—æ³•
- å­˜å‚¨: Cloudflare KV

**APIè®¤è¯**:
- VPS APIå¯†é’¥è®¤è¯
- Workersç¯å¢ƒå˜é‡ä¿æŠ¤

#### APIå¯†é’¥é…ç½®è¯¦è§£ âš ï¸ é‡è¦

**ç¯å¢ƒå˜é‡å‘½åå·®å¼‚**ï¼š

ç³»ç»Ÿä¸­å­˜åœ¨ä¸¤ä¸ªä¸åŒåç§°çš„ç¯å¢ƒå˜é‡ï¼Œä½†å€¼ç›¸åŒï¼š

1. **VPS æœåŠ¡å™¨ç«¯** (`vps-transcoder-api/.env`)
   ```bash
   API_SECRET_KEY=85da076ae24b028b3d1ea1884e6b13c5afe34b5b
   ```
   - ç”¨é€”ï¼šVPS è®¤è¯ä¸­é—´ä»¶éªŒè¯ `X-API-Key` è¯·æ±‚å¤´
   - ä»£ç ä½ç½®ï¼š`src/middleware/auth.js` (line 76)
   - éªŒè¯é€»è¾‘ï¼š`apiKey !== process.env.API_SECRET_KEY`

2. **Cloudflare Workers** (`cloudflare-worker/wrangler.toml`)
   ```toml
   [env.production.vars]
   VPS_API_KEY = "85da076ae24b028b3d1ea1884e6b13c5afe34b5b"
   ```
   - ç”¨é€”ï¼šWorkers è°ƒç”¨ VPS API æ—¶ä½¿ç”¨
   - ä»£ç ä½¿ç”¨ï¼š`headers: { 'X-API-Key': env.VPS_API_KEY }`

**å…³é”®è¦æ±‚**ï¼š
- âœ… ä¸¤ä¸ªç¯å¢ƒå˜é‡çš„**å€¼å¿…é¡»å®Œå…¨ç›¸åŒ**
- âœ… VPS ç«¯å˜é‡åä¸º `API_SECRET_KEY`
- âœ… Workers ç«¯å˜é‡åä¸º `VPS_API_KEY`
- âŒ ä¸å¯æ··æ·†ä½¿ç”¨å˜é‡å

**å„åŠŸèƒ½ä½¿ç”¨æƒ…å†µ**ï¼š

| åŠŸèƒ½æ¨¡å— | Workersä½¿ç”¨ | VPSéªŒè¯ | çŠ¶æ€ |
|---------|-----------|---------|------|
| é¢‘é“ç¼–è¾‘ | `env.VPS_API_KEY` | `API_SECRET_KEY` | âœ… æ­£å¸¸ |
| è§†é¢‘å½•åˆ¶ | `env.VPS_API_KEY` | `API_SECRET_KEY` | âœ… æ­£å¸¸ |
| æ™ºèƒ½é¢„åŠ è½½ | `env.VPS_API_KEY` | `API_SECRET_KEY` | âœ… æ­£å¸¸ |
| ä»£ç†é…ç½® | `env.VPS_API_KEY` | `API_SECRET_KEY` | âœ… æ­£å¸¸ |
| SimpleStream* | ç¡¬ç¼–ç é”™è¯¯å¯†é’¥ | `API_SECRET_KEY` | âš ï¸ å¾…ä¿®å¤ |

**å·²çŸ¥é—®é¢˜**ï¼š
- `handlers/simple-streams.js` ä½¿ç”¨äº†ç¡¬ç¼–ç çš„é”™è¯¯å¯†é’¥ï¼ˆ64ä½ï¼‰
- åº”ä¿®æ”¹ä¸ºä½¿ç”¨ `env.VPS_API_KEY` ä»¥ä¿æŒä¸€è‡´æ€§

**é…ç½®éªŒè¯**ï¼š
```bash
# VPS ç«¯æ£€æŸ¥
grep "API_SECRET_KEY" /opt/yoyo-transcoder/.env

# Workers ç«¯æ£€æŸ¥ï¼ˆwrangler.tomlï¼‰
grep "VPS_API_KEY" cloudflare-worker/wrangler.toml
```

### ç›‘æ§æŒ‡æ ‡

**ç³»ç»Ÿç›‘æ§**:
- âœ… VPSå¥åº·æ£€æŸ¥: `/health`
- âœ… éš§é“è¿æ¥çŠ¶æ€ç›‘æ§
- âœ… è½¬ç è¿›ç¨‹æ•°é‡ç›‘æ§
- âœ… ä»£ç†è¿æ¥çŠ¶æ€ç›‘æ§

**æ€§èƒ½ç›‘æ§**:
- âœ… HLSè¯·æ±‚å»¶è¿Ÿ
- âœ… è§†é¢‘å¯æ’­æ—¶é—´
- âœ… æ’­æ”¾é”™è¯¯ç‡
- âœ… ç”¨æˆ·å¹¶å‘æ•°

**æ—¥å¿—è®°å½•**:
- ç™»å½•æ—¥å¿—: Cloudflare R2å­˜å‚¨
- æ“ä½œæ—¥å¿—: ç®¡ç†å‘˜æ“ä½œè®°å½•
- é”™è¯¯æ—¥å¿—: PM2æ—¥å¿—æ”¶é›†

---

## ğŸ“Š æ¶æ„æ¼”è¿›å†å²

### V1.0 (2025-10-01)
- âœ… åŸºç¡€ä¸‰å±‚æ¶æ„
- âœ… RTMPåˆ°HLSè½¬ç 
- âœ… ç®€å•çš„éš§é“ä¼˜åŒ–

### V1.5 (2025-10-07)
- âœ… Cloudflare Tunnelé…ç½®ä¿®å¤
- âœ… æ™ºèƒ½æ•…éšœè½¬ç§»
- âœ… å‰ç«¯çŠ¶æ€æ˜¾ç¤º

### V2.0 (2025-10-24)
- âœ… **åŒç»´åº¦è·¯ç”±æ¶æ„**
- âœ… **Workersä»£ç†è§£å†³SSLé—®é¢˜**
- âœ… **å‰åç«¯è·¯å¾„ç‹¬ç«‹ä¼˜åŒ–**
- âœ… **åŒç»´åº¦å¯è§†åŒ–æ˜¾ç¤º**
- âœ… **å®Œæ•´çš„æ•…éšœè½¬ç§»æœºåˆ¶**

### V2.1 (2025-10-27)
- âœ… **æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿ**
- âœ… **PreloadSchedulerå®šæ—¶è°ƒåº¦å™¨**
- âœ… **PreloadHealthCheckå¥åº·æ£€æŸ¥**
- âœ… **å‰ç«¯é¢„åŠ è½½é…ç½®ç®¡ç†ç•Œé¢**
- âœ… **é›¶å»¶è¿Ÿæ’­æ”¾ä½“éªŒï¼ˆé¢„åŠ è½½æ—¶æ®µï¼‰**

### V2.2 (2025-10-27)
- âœ… **å·¥ä½œæ—¥é¢„åŠ è½½åŠŸèƒ½**
- âœ… **WorkdayCheckerå·¥ä½œæ—¥æ£€æµ‹å™¨**
- âœ… **ä»…å·¥ä½œæ—¥å¼€å…³ï¼ˆworkdaysOnlyï¼‰**
- âœ… **æ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘è¯†åˆ«**
- âœ… **å·¥ä½œæ—¥çŠ¶æ€å®æ—¶æ˜¾ç¤º**
- âœ… **æ™ºèƒ½é™çº§å’Œå¤±è´¥é‡è¯•æœºåˆ¶**

### V2.3 (2025-10-27)
- âœ… **KVå­˜å‚¨ç»“æ„ä¼˜åŒ–**
- âœ… **é¢‘é“é…ç½®ä¸é¢„åŠ è½½é…ç½®åˆå¹¶**
- âœ… **å‡å°‘KVè¯»å†™æ“ä½œ**
- âœ… **æå‡æ•°æ®ä¸€è‡´æ€§**

### V2.4 (2025-10-28) â­ å½“å‰ç‰ˆæœ¬
- âœ… **é¢‘é“å®šæ—¶å½•åˆ¶åŠŸèƒ½** â­â­
- âœ… **RecordSchedulerå½•åˆ¶è°ƒåº¦å™¨**
- âœ… **ä¸€è¿›ç¨‹åŒè¾“å‡ºï¼ˆHLS+MP4åŒæ—¶ç”Ÿæˆï¼‰**
- âœ… **æ··åˆæ–‡ä»¶å‘½åæ–¹æ¡ˆï¼ˆchannelName + channelIdï¼‰**
- âœ… **å·¥ä½œæ—¥å½•åˆ¶æ”¯æŒ**
- âœ… **ChannelConfigDialogç»Ÿä¸€é…ç½®ç•Œé¢**
- âœ… **å½•åˆ¶é…ç½®APIï¼ˆWorkers + VPSï¼‰**
- âœ… **è‡ªåŠ¨ç›®å½•åˆ›å»ºå’Œçƒ­é‡è½½**

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

### æ ¸å¿ƒæ–‡æ¡£
- **æœ¬æ–‡æ¡£**: `doc/ARCHITECTURE_V2.md` - ç²¾ç®€æ¶æ„æ–‡æ¡£
- **è¯¦ç»†æ¶æ„**: `doc/DUAL_DIMENSION_ROUTING_ARCHITECTURE.md` - åŒç»´åº¦è·¯ç”±è¯¦ç»†å®ç°
- **é¢„åŠ è½½æ–¹æ¡ˆ**: `doc/PRELOAD_IMPLEMENTATION_STAGED.md` - æ™ºèƒ½é¢„åŠ è½½é˜¶æ®µå®æ–½æ–‡æ¡£
- **å·¥ä½œæ—¥é¢„åŠ è½½**: `doc/WORKDAY_PRELOAD_IMPLEMENTATION.md` - å·¥ä½œæ—¥é¢„åŠ è½½å®æ–½æ–¹æ¡ˆ
- **å½•åˆ¶æ–¹æ¡ˆ**: `doc/RECORDING_IMPLEMENTATION_STAGED.md` - é¢‘é“å®šæ—¶å½•åˆ¶é˜¶æ®µå®æ–½æ–‡æ¡£ â­
- **å®æ–½è®°å½•**: `DUAL_DIMENSION_ROUTING_FIX_STAGED.md` - é˜¶æ®µå®æ–½è®°å½•

### å†å²æ–‡æ¡£
- **æ—§ç‰ˆæ¶æ„**: `doc/YOYO_PLATFORM_ARCHITECTURE.md` - å®Œæ•´è¯¦ç»†ç‰ˆï¼ˆ4000+è¡Œï¼‰

### æŠ€æœ¯æ–‡æ¡£
- **Workersä»£ç **: `cloudflare-worker/src/` - ä¸šåŠ¡é€»è¾‘å®ç°
- **VPSä»£ç **: `src/` - è½¬ç æœåŠ¡å®ç°
- **å‰ç«¯ä»£ç **: `frontend/src/` - ç”¨æˆ·ç•Œé¢å®ç°

---

## ğŸ¯ å¿«é€Ÿå¯¼èˆª

### æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥

| æ¦‚å¿µ | è¯´æ˜ | æ–‡æ¡£ä½ç½® |
|------|------|---------|
| åŒç»´åº¦è·¯ç”± | å‰åç«¯è·¯å¾„ç‹¬ç«‹ä¼˜åŒ– | æœ¬æ–‡æ¡£ + DUAL_DIMENSION_ROUTING_ARCHITECTURE.md |
| Workersä»£ç† | è§£å†³éš§é“SSLé—®é¢˜ | æœ¬æ–‡æ¡£ "Workersä»£ç†æ–¹æ¡ˆ" |
| æ™ºèƒ½é¢„åŠ è½½ | å®šæ—¶é¢„åŠ è½½ï¼Œé›¶å»¶è¿Ÿæ’­æ”¾ | æœ¬æ–‡æ¡£ "æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿ" + PRELOAD_IMPLEMENTATION_STAGED.md |
| é¢‘é“å®šæ—¶å½•åˆ¶ | å®šæ—¶å½•åˆ¶è§†é¢‘æ–‡ä»¶ | æœ¬æ–‡æ¡£ "é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿ" + RECORDING_IMPLEMENTATION_STAGED.md |
| è§†é¢‘æ–‡ä»¶æ¸…ç† | è‡ªåŠ¨æ¸…ç†è¿‡æœŸå½•åˆ¶æ–‡ä»¶ | æœ¬æ–‡æ¡£ "è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿ" + VIDEO_CLEANUP_IMPLEMENTATION.md |
| SimpleStreamManager | è½¬ç è¿›ç¨‹ç®¡ç† | æœ¬æ–‡æ¡£ "æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶" |
| RecordScheduler | å½•åˆ¶è°ƒåº¦å™¨ | æœ¬æ–‡æ¡£ "é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿ" |
| VideoCleanupScheduler | æ¸…ç†è°ƒåº¦å™¨ | æœ¬æ–‡æ¡£ "è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿ" |
| è·¯ç”±å†³ç­–å¼•æ“ | TunnelRouterå®ç° | DUAL_DIMENSION_ROUTING_ARCHITECTURE.md |
| éƒ¨ç½²æµç¨‹ | ä¸€é”®éƒ¨ç½²å‘½ä»¤ | æœ¬æ–‡æ¡£ "éƒ¨ç½²æ¶æ„" |

### å¸¸è§é—®é¢˜

**Q: å¦‚ä½•åˆ‡æ¢éš§é“æ¨¡å¼ï¼Ÿ**  
A: ç®¡ç†åå° â†’ éš§é“ä¼˜åŒ– â†’ ä¸€é”®å¼€å…³

**Q: å¦‚ä½•æŸ¥çœ‹è·¯ç”±çŠ¶æ€ï¼Ÿ**  
A: è§†é¢‘æ’­æ”¾ç•Œé¢æ˜¾ç¤ºåŒç»´åº¦æ ‡ç­¾

**Q: Workersä»£ç†ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ**  
A: å½±å“å¾ˆå°ï¼ˆ~10-50msï¼‰ï¼Œä¸”æœ‰æ•…éšœè½¬ç§»

**Q: å¦‚ä½•é…ç½®é¢‘é“é¢„åŠ è½½ï¼Ÿ**  
A: ç®¡ç†åå° â†’ é¢‘é“åˆ—è¡¨ â†’ ç‚¹å‡»"é¢„åŠ è½½"æŒ‰é’® â†’ è®¾ç½®å¼€å§‹/ç»“æŸæ—¶é—´ â†’ å¯é€‰å¯ç”¨"ä»…å·¥ä½œæ—¥"

**Q: é¢„åŠ è½½èƒ½èŠ‚çœå¤šå°‘èµ„æºï¼Ÿ**  
A: ä»…åœ¨é…ç½®æ—¶æ®µè¿è¡Œï¼Œç›¸æ¯”å…¨å¤©è¿è¡ŒèŠ‚çœçº¦70-80%èµ„æºã€‚å¯ç”¨"ä»…å·¥ä½œæ—¥"åï¼Œå‘¨æœ«å’ŒèŠ‚å‡æ—¥è‡ªåŠ¨è·³è¿‡ï¼Œè¿›ä¸€æ­¥èŠ‚çœçº¦30%èµ„æº

**Q: å·¥ä½œæ—¥é¢„åŠ è½½å¦‚ä½•è¯†åˆ«èŠ‚å‡æ—¥ï¼Ÿ** â­  
A: ä½¿ç”¨Timor APIè·å–å®˜æ–¹èŠ‚å‡æ—¥æ•°æ®ï¼Œè‡ªåŠ¨è¯†åˆ«æ³•å®šèŠ‚å‡æ—¥ã€è°ƒä¼‘å·¥ä½œæ—¥ã€‚APIå¤±è´¥æ—¶é™çº§ä¸ºåŸºç¡€æ¨¡å¼ï¼ˆå‘¨ä¸€è‡³å‘¨äº”ï¼‰

**Q: å·¥ä½œæ—¥æ•°æ®ä»å“ªé‡Œæ¥ï¼Ÿ**  
A: VPSå¯åŠ¨æ—¶è‡ªåŠ¨é¢„å–å½“å‰æœˆ+ä¸‹æœˆæ•°æ®ï¼Œæ¯æœˆ25å·é¢„å–ä¸‹æœˆæ•°æ®ã€‚å¤±è´¥çš„æœˆä»½ä¼šæ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨é‡è¯•

**Q: å¦‚æœå·¥ä½œæ—¥APIè°ƒç”¨å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**  
A: ç³»ç»Ÿæœ‰å®Œå–„çš„é™çº§æœºåˆ¶ï¼šAPIå¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºåŸºç¡€æ¨¡å¼ï¼ˆå‘¨ä¸€è‡³å‘¨äº”=å·¥ä½œæ—¥ï¼‰ï¼Œä¸å½±å“é¢„åŠ è½½æœåŠ¡

**Q: å¦‚ä½•é…ç½®é¢‘é“å½•åˆ¶ï¼Ÿ** â­  
A: ç®¡ç†åå° â†’ é¢‘é“åˆ—è¡¨ â†’ ç‚¹å‡»"è®¾ç½®"æŒ‰é’® â†’ å½•åˆ¶é…ç½®åŒºåŸŸ â†’ è®¾ç½®å¼€å§‹/ç»“æŸæ—¶é—´ã€å­˜å‚¨è·¯å¾„ â†’ å¯é€‰å¯ç”¨"ä»…å·¥ä½œæ—¥"

**Q: å½•åˆ¶æ–‡ä»¶å¦‚ä½•å‘½åï¼Ÿ**  
A: ä½¿ç”¨æ··åˆå‘½åæ–¹æ¡ˆï¼š`{é¢‘é“åç§°}_{é¢‘é“ID}_{æ—¥æœŸ}_{å¼€å§‹æ—¶é—´}_to_{ç»“æŸæ—¶é—´}.mp4`ï¼Œä¾‹å¦‚ï¼š`äºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251028_074000_to_172500.mp4`

**Q: å½•åˆ¶ä¼šå½±å“è§‚çœ‹å—ï¼Ÿ**  
A: ä¸ä¼šã€‚ç³»ç»Ÿä½¿ç”¨ä¸€ä¸ªFFmpegè¿›ç¨‹åŒæ—¶è¾“å‡ºHLSï¼ˆè§‚çœ‹ï¼‰å’ŒMP4ï¼ˆå½•åˆ¶ï¼‰ï¼Œèµ„æºå ç”¨minimal

**Q: å¦‚ä½•éƒ¨ç½²æœ€æ–°ä»£ç ï¼Ÿ**  
A: ä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆè§"éƒ¨ç½²æ¶æ„"ç« èŠ‚ï¼‰

---

## ğŸ”„ ç»´æŠ¤è¯´æ˜

### æ–‡æ¡£æ›´æ–°åŸåˆ™

1. **ä¿æŒç²¾ç®€**: åªè®°å½•æ ¸å¿ƒæ¶æ„å’Œå…³é”®ä¿¡æ¯
2. **ä»£ç å¼•ç”¨**: é¿å…å¤§æ®µä»£ç ï¼Œæ”¹ç”¨æ–‡ä»¶å¼•ç”¨
3. **å›¾ç¤ºä¼˜å…ˆ**: ç”¨æµç¨‹å›¾å’Œæ¶æ„å›¾ä»£æ›¿æ–‡å­—æè¿°
4. **ç‰ˆæœ¬æ ‡è®°**: é‡è¦å˜æ›´æ ‡æ³¨ç‰ˆæœ¬å’Œæ—¥æœŸ

### æ›´æ–°é¢‘ç‡

- **æ¶æ„å˜æ›´**: ç«‹å³æ›´æ–°
- **åŠŸèƒ½æ–°å¢**: åŠæ—¶è¡¥å……
- **ä¼˜åŒ–è°ƒæ•´**: å®šæœŸæ•´ç†
- **ç‰ˆæœ¬å‘å¸ƒ**: åˆ›å»ºå¿«ç…§

---

## ğŸ“ ç‰ˆæœ¬å†å²

### V2.10 (2025-11-03) â­ å½“å‰ç‰ˆæœ¬
**Workers Cache APIæµå…±äº«ä¸Šçº¿ - èŠ‚çœ60% VPSå¸¦å®½**

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… **HLSåˆ†ç‰‡ç¼“å­˜**: .tsæ–‡ä»¶å¯ç”¨3ç§’ç¼“å­˜ï¼Œ.m3u8å®æ—¶é€ä¼ 
- âœ… **æµå…±äº«**: å¤šç”¨æˆ·è¯·æ±‚åŒä¸€åˆ†ç‰‡ï¼ŒVPSåªä¼ è¾“1æ¬¡
- âœ… **æ€§èƒ½æå‡**: å“åº”é€Ÿåº¦æå‡98%ï¼ˆ244ms â†’ 5msï¼‰
- âœ… **å¸¦å®½èŠ‚çœ**: VPSè¯·æ±‚æ•°å‡å°‘60%ï¼ˆå®æµ‹5è¯·æ±‚â†’2æ¬¡VPSä¼ è¾“ï¼‰
- âœ… **å®Œå…¨å…è´¹**: ä½¿ç”¨Workersè‡ªå¸¦Cache APIï¼Œé›¶é¢å¤–æˆæœ¬
- âœ… **é›¶å½±å“**: ä¸å½±å“å¿ƒè·³æœºåˆ¶ã€å®æ—¶æ€§å’Œè§†é¢‘æ’­æ”¾

**æŠ€æœ¯å®ç°**:
- handleCachedSegment(): å®ç°åˆ†ç‰‡ç¼“å­˜é€»è¾‘
- caches.default API: Cloudflare Workerså†…ç½®ç¼“å­˜
- å¼‚æ­¥ç¼“å­˜å†™å…¥: ctx.waitUntil()ä¸é˜»å¡å“åº”
- X-Cacheå“åº”å¤´: æ ‡è¯†HIT/MISS/BYPASSçŠ¶æ€

**éªŒè¯ç»“æœ**:
```
VPS Nginxæ—¥å¿—éªŒè¯ï¼ˆsegment882.tsï¼‰:
- å®¢æˆ·ç«¯å‘èµ·: 5æ¬¡è¯·æ±‚
- VPSå®é™…æ”¶åˆ°: 2æ¬¡è¯·æ±‚
- å¸¦å®½èŠ‚çœ: 60%
```

**éƒ¨ç½²ä¿¡æ¯**:
- Gitæ ‡ç­¾: v2.9-stableï¼ˆç¨³å®šç‰ˆæœ¬ï¼‰
- Git Commit: df1d9ba0ï¼ˆCacheå®ç°ï¼‰
- å®æ–½æ–‡æ¡£: WORKERS_CACHE_IMPLEMENTATION_STAGED.md

### V2.7 (2025-10-30)
**å½•åˆ¶åˆ†æ®µåŠŸèƒ½ä¸Šçº¿ - æ”¯æŒé•¿æ—¶é—´å½•åˆ¶è‡ªåŠ¨åˆ‡åˆ†**

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… **å½•åˆ¶åˆ†æ®µ**: æŒ‰æ—¶é•¿è‡ªåŠ¨åˆ‡åˆ†MP4æ–‡ä»¶ï¼ˆå¯é…ç½®10-240åˆ†é’Ÿï¼‰
- âœ… **å…¨å±€å¼€å…³**: ç³»ç»Ÿè®¾ç½®ä¸­ç»Ÿä¸€æ§åˆ¶ï¼Œé»˜è®¤å…³é—­
- âœ… **ä¸¤æ­¥å‘½å**: å½•åˆ¶æ—¶ç”¨ä¸´æ—¶åï¼ˆ_temp_ï¼‰ï¼Œåœæ­¢åé‡å‘½åä¸ºæ­£å¼å
- âœ… **ç²¾ç¡®æ—¶é—´**: æ–‡ä»¶ååŒ…å«å®é™…å½•åˆ¶æ—¶é—´æ®µï¼ˆå¼€å§‹_to_ç»“æŸï¼‰
- âœ… **æ™ºèƒ½é‡å‘½å**: è‡ªåŠ¨å¤„ç†æœ€åä¸€æ®µçš„å®é™…ç»“æŸæ—¶é—´
- âœ… **é›¶å½±å“**: ä¸å½±å“HLSè§‚çœ‹å’Œå•æ–‡ä»¶æ¨¡å¼

**æŠ€æœ¯å®ç°**:
- FFmpeg segment muxerï¼šè‡ªåŠ¨æŒ‰æ—¶é•¿åˆ‡åˆ†
- RecordScheduleré›†æˆï¼šä»ç³»ç»Ÿé…ç½®è·å–åˆ†æ®µå‚æ•°
- SimpleStreamManagerï¼šå®ç°é‡å‘½åé€»è¾‘
- SystemSettingsDialogï¼šå‰ç«¯åˆ†æ®µé…ç½®ç•Œé¢

**æ–‡ä»¶ç¤ºä¾‹**:
```
å½•åˆ¶ä¸­ï¼šäºŒæ¥¼æ•™å®¤1_stream_xxx_20251030_temp_000.mp4
åœæ­¢åï¼šäºŒæ¥¼æ•™å®¤1_stream_xxx_20251030_103000_to_104000.mp4
```

### V2.6 (2025-10-29)
**é¢‘é“/ç”¨æˆ·ç´¢å¼•ç³»ç»Ÿä¸Šçº¿ - è§£å†³KV listæ“ä½œé™åˆ¶**

**é—®é¢˜æè¿°**:
- âŒ Cloudflare KVå…è´¹ç‰ˆé™åˆ¶listæ“ä½œ100æ¬¡/å¤©
- âŒ é¢„åŠ è½½è°ƒåº¦å™¨ã€è§†é¢‘æ¸…ç†ã€ç”¨æˆ·ç®¡ç†é¢‘ç¹è°ƒç”¨listå¯¼è‡´è¶…é™
- âŒ è¶…é™ååŠŸèƒ½å¤±æ•ˆï¼ˆé¢„åŠ è½½æ— æ³•å¯åŠ¨ã€ç”¨æˆ·åˆ—è¡¨æ— æ³•åŠ è½½ï¼‰

**æ ¸å¿ƒæ”¹è¿›**:
- âœ… **é¢‘é“ç´¢å¼•ç³»ç»Ÿ**: `system:channel_index` å­˜å‚¨æ‰€æœ‰é¢‘é“ID
- âœ… **ç”¨æˆ·ç´¢å¼•ç³»ç»Ÿ**: `system:user_index` å­˜å‚¨æ‰€æœ‰ç”¨æˆ·å
- âœ… **è‡ªåŠ¨ç»´æŠ¤**: åˆ›å»º/åˆ é™¤æ—¶è‡ªåŠ¨æ›´æ–°ç´¢å¼•
- âœ… **é™çº§å®¹é”™**: ç´¢å¼•ä¸¢å¤±æ—¶ä½¿ç”¨listè‡ªåŠ¨é‡å»ºï¼ˆä»…é¦–æ¬¡ï¼‰

**æŠ€æœ¯å®ç°**:
- âœ… preloadHandlerä½¿ç”¨ç´¢å¼•ä»£æ›¿list
- âœ… GET /api/admin/streamsä½¿ç”¨ç´¢å¼•ä»£æ›¿CHANNELSç¡¬ç¼–ç 
- âœ… POST /api/admin/streams - åˆ›å»ºé¢‘é“å¹¶ç»´æŠ¤ç´¢å¼•
- âœ… DELETE /api/admin/streams/:id - åˆ é™¤é¢‘é“å¹¶ç»´æŠ¤ç´¢å¼•
- âœ… GET /api/admin/usersä½¿ç”¨ç´¢å¼•ï¼ˆè§£å†³ç”¨æˆ·åˆ—è¡¨åŠ è½½å¤±è´¥ï¼‰

**æ€§èƒ½æå‡**:
- ğŸ“ˆ èµ„æºæ¶ˆè€—ï¼š1æ¬¡list â†’ N+1æ¬¡get
- ğŸ“ˆ æ¯æ—¥é¢åº¦ï¼š100æ¬¡/å¤© â†’ 100,000æ¬¡/å¤©ï¼ˆæå‡1000å€ï¼‰
- ğŸ“ˆ å®é™…æ¶ˆè€—ï¼š<100æ¬¡get/å¤©ï¼ˆå‰©ä½™99.9%é¢åº¦ï¼‰

**å½±å“åŠŸèƒ½**:
- âœ… é¢„åŠ è½½ç³»ç»Ÿï¼šVPSé‡å¯æ­£å¸¸è·å–é…ç½®
- âœ… è§†é¢‘æ¸…ç†ï¼šå®šæ—¶ä»»åŠ¡æ­£å¸¸è·å–é¢‘é“åˆ—è¡¨
- âœ… ç”¨æˆ·ç®¡ç†ï¼šç”¨æˆ·åˆ—è¡¨æ­£å¸¸åŠ è½½ï¼ˆ3ä¸ªç”¨æˆ·ï¼‰
- âœ… é¢‘é“ç®¡ç†ï¼šæ”¯æŒåŠ¨æ€åˆ›å»º/åˆ é™¤ï¼ˆæ— éœ€ä¿®æ”¹ä»£ç ï¼‰

### V2.5 (2025-10-28)
**è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿä¸Šçº¿**

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… VideoCleanupScheduler å®šæ—¶æ¸…ç†è°ƒåº¦å™¨
- âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸå½•åˆ¶æ–‡ä»¶ï¼ˆé»˜è®¤ä¿ç•™2å¤©ï¼‰
- âœ… ä¸¥æ ¼çš„æ—¥æœŸæ ¼å¼éªŒè¯æœºåˆ¶
- âœ… å‰ç«¯å¯è§†åŒ–é…ç½®ç•Œé¢ï¼ˆSystemSettingsDialogï¼‰

**æŠ€æœ¯äº®ç‚¹**:
- âœ… æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨æ‰§è¡Œæ¸…ç†
- âœ… æ‰‹åŠ¨æ¸…ç†åŠŸèƒ½ï¼ˆå‰ç«¯ä¸€é”®è§¦å‘ï¼‰
- âœ… é¢‘é“éš”ç¦»ï¼ˆå•é¢‘é“å¤±è´¥ä¸å½±å“å…¶ä»–ï¼‰
- âœ… APIè®¤è¯ä¿æŠ¤ï¼ˆVPS API Keyï¼‰
- âœ… è¯¦ç»†çš„æ¸…ç†æ—¥å¿—å’Œç»Ÿè®¡

**APIç«¯ç‚¹**:
- `GET /api/admin/cleanup/config` - è·å–æ¸…ç†é…ç½®
- `PUT /api/admin/cleanup/config` - æ›´æ–°æ¸…ç†é…ç½®
- `POST /api/admin/cleanup/trigger` - æ‰‹åŠ¨è§¦å‘æ¸…ç†
- `POST /api/admin/cleanup/execute` - VPSæ‰§è¡Œæ¸…ç†

### V2.4 (2025-10-28)
**é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿä¸Šçº¿**

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… RecordScheduler å½•åˆ¶è°ƒåº¦å™¨
- âœ… åŸºäºnode-cronçš„å®šæ—¶ä»»åŠ¡ç®¡ç†
- âœ… å·¥ä½œæ—¥æ”¯æŒï¼ˆå¤ç”¨WorkdayCheckerï¼‰
- âœ… ä¸€è¿›ç¨‹åŒè¾“å‡ºï¼ˆHLS+MP4ï¼‰

**æŠ€æœ¯å®ç°**:
- âœ… SimpleStreamManager æ‰©å±•å½•åˆ¶èƒ½åŠ›
- âœ… FFmpeg è¿›ç¨‹å¤ç”¨ï¼ˆè§‚çœ‹+å½•åˆ¶ï¼‰
- âœ… å½•åˆ¶è¿›ç¨‹ä¸å—å¿ƒè·³æ¸…ç†å½±å“
- âœ… å¯åŠ¨è‡ªåŠ¨æ¢å¤å½“å‰æ—¶æ®µå½•åˆ¶

**é…ç½®ç®¡ç†**:
- âœ… KVå­˜å‚¨ recordConfig å­—æ®µ
- âœ… å‰ç«¯ChannelConfigDialogç»Ÿä¸€é…ç½®
- âœ… é…ç½®çƒ­é‡è½½æ— éœ€é‡å¯

### V2.3 (2025-10-27)
**KVå­˜å‚¨ç»“æ„ä¼˜åŒ– - é¢‘é“é…ç½®ä¸é¢„åŠ è½½é…ç½®åˆå¹¶**

**æ ¸å¿ƒå˜æ›´**:
- âœ… å°†ç‹¬ç«‹çš„ `PRELOAD_CONFIG:${channelId}` é”®åˆå¹¶åˆ° `channel:${channelId}` é…ç½®ä¸­
- âœ… é¢„åŠ è½½é…ç½®ä½œä¸º `preloadConfig` å­—æ®µåµŒå…¥åˆ°é¢‘é“é…ç½®
- âœ… ç»Ÿä¸€å­˜å‚¨ç»“æ„ï¼Œå‡å°‘KVè¯»å†™æ“ä½œ
- âœ… æå‡æ•°æ®ä¸€è‡´æ€§ï¼Œç®€åŒ–ç³»ç»Ÿæ¶æ„

**APIå˜æ›´**:
- ğŸ”„ `PUT /api/preload/config/:channelId` - ç°åœ¨æ›´æ–°é¢‘é“é…ç½®ä¸­çš„ `preloadConfig` å­—æ®µ
- ğŸ”„ `GET /api/preload/config/:channelId` - ä»é¢‘é“é…ç½®ä¸­è¯»å– `preloadConfig` å­—æ®µ
- ğŸ”„ `GET /api/preload/configs` - éå†æ‰€æœ‰é¢‘é“é…ç½®ï¼Œè¿”å›å¯ç”¨çš„é¢„åŠ è½½é…ç½®åˆ—è¡¨

**ä¼˜åŠ¿**:
- ğŸ“‰ å‡å°‘KVæ“ä½œï¼šè¯»å–é¢‘é“åˆ—è¡¨æ—¶è‡ªåŠ¨åŒ…å«é¢„åŠ è½½é…ç½®
- ğŸ”„ æ•°æ®ä¸€è‡´æ€§ï¼šé¢‘é“å’Œé¢„åŠ è½½é…ç½®åŒæ­¥æ›´æ–°
- ğŸ¯ æ¶æ„ç®€åŒ–ï¼šç§»é™¤ç‹¬ç«‹çš„é¢„åŠ è½½é…ç½®é”®ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦

### V2.2 (2025-10-27)
**æ–°å¢å·¥ä½œæ—¥é¢„åŠ è½½åŠŸèƒ½**
- âœ… WorkdayCheckerå·¥ä½œæ—¥æ£€æµ‹å™¨
- âœ… æ”¯æŒæ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘è¯†åˆ«
- âœ… æ™ºèƒ½ç¼“å­˜å’Œå¤±è´¥é‡è¯•æœºåˆ¶
- âœ… å®¹é”™é™çº§æ¨¡å¼

### V2.1 (2025-10-26)
**æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿä¸Šçº¿**
- âœ… PreloadScheduleré¢„åŠ è½½è°ƒåº¦å™¨
- âœ… å®šæ—¶ä»»åŠ¡ç®¡ç†
- âœ… è¿›ç¨‹å¥åº·æ£€æŸ¥
- âœ… VPSé€šçŸ¥å’Œé…ç½®é‡è½½

### V2.0 (2025-10-01)
**åŒç»´åº¦è·¯ç”±ä¼˜åŒ–å®Œæˆ**
- âœ… å‰åç«¯è·¯å¾„ç‹¬ç«‹ä¼˜åŒ–
- âœ… Workersä»£ç†æ–¹æ¡ˆ
- âœ… è·¯ç”±å†³ç­–å¼•æ“
- âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

---

**æ–‡æ¡£ç»´æŠ¤è€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2025-10-30 10:40 (UTC+8)  
**æ–‡æ¡£çŠ¶æ€**: âœ… V2.7 - å½•åˆ¶åˆ†æ®µåŠŸèƒ½ä¸Šçº¿ï¼Œæ”¯æŒé•¿æ—¶é—´å½•åˆ¶è‡ªåŠ¨åˆ‡åˆ†
