# YOYOæµåª’ä½“å¹³å°æ¶æ„æ–‡æ¡£ V2.6

> **ç²¾ç®€æ¶æ„æ–‡æ¡£** - ä¸“æ³¨äºæ ¸å¿ƒæ¶æ„è®¾è®¡å’Œå…³é”®æŠ€æœ¯å®ç°  
> **æ›´æ–°æ—¶é—´**: 2025-10-29  
> **æ–‡æ¡£ç‰ˆæœ¬**: V2.6 - æ–°å¢é¢‘é“/ç”¨æˆ·ç´¢å¼•ç³»ç»Ÿï¼Œè§£å†³KV listæ“ä½œé™åˆ¶

---

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#-é¡¹ç›®æ¦‚è¿°)
- [ç³»ç»Ÿæ¶æ„](#-ç³»ç»Ÿæ¶æ„)
- [åŒç»´åº¦è·¯ç”±ä¼˜åŒ–](#-åŒç»´åº¦è·¯ç”±ä¼˜åŒ–æ ¸å¿ƒ)
- [æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶](#-æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶)
- [æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿ](#-æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿ)
- [é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿ](#-é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿ)
- [è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿ](#-è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿ)
- [æ•°æ®æµè½¬æœºåˆ¶](#-æ•°æ®æµè½¬æœºåˆ¶)
- [éƒ¨ç½²æ¶æ„](#-éƒ¨ç½²æ¶æ„)
- [æ€§èƒ½ä¼˜åŒ–](#-æ€§èƒ½ä¼˜åŒ–)
- [å®‰å…¨ä¸ç›‘æ§](#-å®‰å…¨ä¸ç›‘æ§)
- [ç‰ˆæœ¬å†å²](#-ç‰ˆæœ¬å†å²)

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

**YOYOæµåª’ä½“å¹³å°**æ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„å®‰å…¨æµåª’ä½“Webæ’­æ”¾å¹³å°ï¼Œé‡‡ç”¨ä¸‰å±‚æ¶æ„è®¾è®¡ã€‚

### æ ¸å¿ƒå®šä½

- **ç›®æ ‡**: å¤šç”¨æˆ·ã€å¤šé¢‘é“çš„å®æ—¶è§†é¢‘æµæ’­æ”¾ä¸å½•åˆ¶
- **ç‰¹è‰²**: åŒç»´åº¦è·¯ç”±ä¼˜åŒ–ï¼Œæ™ºèƒ½ç½‘ç»œè°ƒåº¦ï¼Œæ™ºèƒ½é¢„åŠ è½½ï¼Œå®šæ—¶å½•åˆ¶ï¼Œè‡ªåŠ¨æ¸…ç†
- **éƒ¨ç½²**: ç”Ÿäº§ç¯å¢ƒè¿è¡Œä¸­ï¼ˆ2025-10-01ä¸Šçº¿ï¼‰

### æŠ€æœ¯æ ˆæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯å±‚: Vue 3 + Element Plus + hls.js              â”‚
â”‚  åŸŸå: https://yoyo.5202021.xyz                     â”‚
â”‚  éƒ¨ç½²: Cloudflare Pages                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡å±‚: Cloudflare Workers                         â”‚
â”‚  åŸŸå: https://yoyoapi.5202021.xyz                  â”‚
â”‚  åŠŸèƒ½: APIæœåŠ¡ã€è·¯ç”±å†³ç­–ã€ç”¨æˆ·è®¤è¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è½¬ç å±‚: Node.js + FFmpeg (VPS)                     â”‚
â”‚  åŸŸå: https://yoyo-vps.5202021.xyz                 â”‚
â”‚  åŠŸèƒ½: RTMPè½¬HLSã€è¿›ç¨‹ç®¡ç†ã€ä»£ç†æœåŠ¡                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### ä¸‰å±‚æ¶æ„è®¾è®¡

#### 1. å‰ç«¯åº”ç”¨å±‚

**æŠ€æœ¯æ ˆ**: Vue.js 3 + Element Plus + hls.js  
**éƒ¨ç½²**: Cloudflare Pages  
**åŸŸå**: `https://yoyo.5202021.xyz`

**æ ¸å¿ƒåŠŸèƒ½**:
- è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶ï¼ˆåŸºäºhls.jsï¼‰
- é¢‘é“åˆ—è¡¨ç®¡ç†
- ç”¨æˆ·è®¤è¯ç•Œé¢
- **åŒç»´åº¦è·¯ç”±çŠ¶æ€æ˜¾ç¤º** â­

**å…³é”®å®ç°**:
```javascript
// stores/streams.js - åŒç»´åº¦è·¯ç”±çŠ¶æ€ç®¡ç†
currentStream = {
  hlsUrl: 'æ’­æ”¾URL',
  routingMode: 'tunnel+direct',     // åŒç»´åº¦ç»„åˆ
  frontendPath: 'tunnel',           // å‰ç«¯è·¯å¾„
  backendPath: 'direct',            // åç«¯è·¯å¾„
  routingReason: 'è·¯ç”±å†³ç­–åŸå› '
}
```

#### 2. ä¸šåŠ¡é€»è¾‘å±‚ (Cloudflare Workers)

**åŸŸå**: `https://yoyoapi.5202021.xyz`  
**æŠ€æœ¯**: Cloudflare Workers + KVå­˜å‚¨

**æ ¸å¿ƒåŠŸèƒ½**:
- APIæœåŠ¡å’Œè¯·æ±‚è·¯ç”±
- **åŒç»´åº¦è·¯ç”±å†³ç­–** â­
- ç”¨æˆ·è®¤è¯å’Œä¼šè¯ç®¡ç†
- é¢‘é“é…ç½®ç®¡ç†ï¼ˆæ”¯æŒå®Œæ•´CRUDï¼‰
- **Workersä»£ç†ï¼ˆè§£å†³éš§é“SSLï¼‰** â­
- **é¢‘é“é¢„åŠ è½½é…ç½®ç®¡ç†** â­
- **ğŸ†• ç´¢å¼•ç³»ç»Ÿï¼ˆé¿å…KV listè¶…é™ï¼‰** â­

**ğŸ†• V2.6ç´¢å¼•ç³»ç»Ÿ** (2025-10-29):

**é—®é¢˜èƒŒæ™¯**: Cloudflare KVå…è´¹ç‰ˆé™åˆ¶listæ“ä½œ100æ¬¡/å¤©ï¼Œé¢‘ç¹è°ƒç”¨å¯¼è‡´é¢„åŠ è½½å’Œæ¸…ç†åŠŸèƒ½å¤±æ•ˆ

**è§£å†³æ–¹æ¡ˆ**: å®ç°é¢‘é“å’Œç”¨æˆ·ç´¢å¼•ç³»ç»Ÿ

```javascript
// ç´¢å¼•ç»“æ„
{
  "system:channel_index": {
    "channelIds": ["stream_xxx", ...],
    "lastUpdated": "2025-10-29T14:49:00Z",
    "totalChannels": 8
  },
  "system:user_index": {
    "usernames": ["admin", "yangyang", "fenghuang"],
    "lastUpdated": "2025-10-29T14:03:00Z",
    "totalUsers": 3
  }
}
```

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… **é¿å…listè¶…é™**: æ”¹ç”¨getæ“ä½œï¼ˆ100,000æ¬¡/å¤© vs 100æ¬¡/å¤©ï¼‰
- âœ… **è‡ªåŠ¨ç»´æŠ¤**: åˆ›å»º/åˆ é™¤æ—¶è‡ªåŠ¨æ›´æ–°ç´¢å¼•
- âœ… **é™çº§å®¹é”™**: ç´¢å¼•ä¸¢å¤±æ—¶è‡ªåŠ¨é‡å»º
- âœ… **æ€§èƒ½æå‡**: æ¯æ¬¡æŸ¥è¯¢ä»1æ¬¡listé™è‡³N+1æ¬¡get

**èµ„æºæ¶ˆè€—å¯¹æ¯”**:

| æ“ä½œ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | èŠ‚çœ |
|------|--------|--------|------|
| è·å–ç”¨æˆ·åˆ—è¡¨ | 1æ¬¡list | 4æ¬¡get | 99.996% |
| è·å–é¢‘é“åˆ—è¡¨ | 1æ¬¡list | 9æ¬¡get | 99.991% |
| VPSé¢„åŠ è½½åˆå§‹åŒ– | 1æ¬¡list | 9æ¬¡get | 99.991% |
| è§†é¢‘æ¸…ç†æŸ¥è¯¢ | 1æ¬¡list | 9æ¬¡get | 99.991% |

**å½±å“åŠŸèƒ½**:
- âœ… ç”¨æˆ·ç®¡ç†ï¼šå®Œæ•´CRUD + å¯†ç ç®¡ç†
- âœ… é¢‘é“ç®¡ç†ï¼šå®Œæ•´CRUD + é¢„åŠ è½½é…ç½®
- âœ… é¢„åŠ è½½è°ƒåº¦ï¼šVPSé‡å¯è‡ªåŠ¨è·å–é…ç½®
- âœ… è§†é¢‘æ¸…ç†ï¼šå®šæ—¶ä»»åŠ¡è·å–é¢‘é“åˆ—è¡¨

**è·¯ç”±å†³ç­–å¼•æ“**:
```javascript
// utils/tunnel-router.js
class TunnelRouter {
  static async determineRoutingPath(env, request) {
    // 1. åˆ¤æ–­å‰ç«¯è·¯å¾„ (Workers â†’ VPS)
    const frontendPath = await this.determineFrontendPath(env);
    
    // 2. åˆ¤æ–­åç«¯è·¯å¾„ (VPS â†’ RTMP)
    const backendPath = await this.determineBackendPath(env);
    
    // 3. è¿”å›åŒç»´åº¦è·¯ç”±ä¿¡æ¯
    return {
      routingMode: `${frontendPath.mode}+${backendPath.mode}`,
      frontendPath, 
      backendPath
    };
  }
}
```

**Workersä»£ç†** (è§£å†³éš§é“SSLé—®é¢˜):
```javascript
// index.js - éš§é“ä»£ç†è·¯ç”±
router.get('/tunnel-proxy/hls/:streamId/:file', async (req, env) => {
  // Workerså†…éƒ¨ä»£ç†åˆ°tunnel-hlsç«¯ç‚¹
  const tunnelUrl = `https://tunnel-hls.yoyo-vps.5202021.xyz/hls/...`;
  const response = await fetch(tunnelUrl);
  
  // æ·»åŠ ä»£ç†æ ‡è¯†
  headers.set('X-Proxied-By', 'Workers-Tunnel-Proxy');
  return new Response(response.body, { headers });
});
```

#### 3. è½¬ç æœåŠ¡å±‚ (VPS)

**åŸŸå**: `https://yoyo-vps.5202021.xyz`  
**æœåŠ¡å™¨**: 142.171.75.220 (RackNerd VPS)  
**æŠ€æœ¯æ ˆ**: Node.js + Express + FFmpeg + Nginx + PM2

**æ ¸å¿ƒåŠŸèƒ½**:
- RTMPåˆ°HLSå®æ—¶è½¬ç 
- æŒ‰éœ€å¯åŠ¨è½¬ç è¿›ç¨‹
- å¤šç”¨æˆ·å…±äº«è½¬ç è¿›ç¨‹
- ç©ºé—²æµè‡ªåŠ¨æ¸…ç†
- **æ™ºèƒ½é¢„åŠ è½½è°ƒåº¦** â­
- **V2Ray/Xrayä»£ç†æœåŠ¡** â­

**è½¬ç ç®¡ç†å™¨**:
```javascript
// services/SimpleStreamManager.js
class SimpleStreamManager {
  // æŒ‰é¢‘é“ç®¡ç†è½¬ç è¿›ç¨‹
  activeStreams = new Map();  // channelId -> processInfo
  
  async startWatching(channelId) {
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰è½¬ç è¿›ç¨‹
    if (this.activeStreams.has(channelId)) {
      return existingProcess;
    }
    
    // å¯åŠ¨æ–°çš„FFmpegè½¬ç è¿›ç¨‹
    return await this.startNewStream(channelId, rtmpUrl);
  }
}
```

---

## ğŸŒ åŒç»´åº¦è·¯ç”±ä¼˜åŒ–ï¼ˆæ ¸å¿ƒï¼‰

> **æœ€æ–°æ¶æ„** (2025-10-24å®æ–½å®Œæˆ)

### è®¾è®¡ç†å¿µ

**åŒç»´åº¦è·¯ç”±**å°†è§†é¢‘æµä¼ è¾“è·¯å¾„æ‹†åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹ç»´åº¦ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å‰ç«¯è·¯å¾„ç»´åº¦                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Workers  â”‚ â”€â”€â”€â”€â”€â–¶  â”‚   VPS    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚     â”‚                                                â”‚
â”‚     â”œâ”€ tunnel  (Cloudflare Tunneléš§é“)              â”‚
â”‚     â””â”€ direct  (ç›´æ¥è¿æ¥)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åç«¯è·¯å¾„ç»´åº¦                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   VPS    â”‚ â”€â”€â”€â”€â”€â–¶  â”‚ RTMPæº   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚     â”‚                                                â”‚
â”‚     â”œâ”€ proxy   (V2Ray/Xrayä»£ç†) âš ï¸ æš‚æœªå®ç°å®Œæ•´      â”‚
â”‚     â””â”€ direct  (ç›´æ¥è¿æ¥)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å››ç§è·¯ç”±ç»„åˆ

| è·¯ç”±æ¨¡å¼ | å‰ç«¯è·¯å¾„ | åç«¯è·¯å¾„ | ä½¿ç”¨åœºæ™¯ | ä¼˜åŠ¿ |
|---------|---------|---------|---------|------|
| `tunnel+direct` | tunnel | direct | ä¸­å›½ç”¨æˆ·è®¿é—®å›½å†…RTMP | å‰ç«¯ä¼˜åŒ– |
| `tunnel+proxy` | tunnel | proxy | ä¸­å›½ç”¨æˆ·è®¿é—®å›½å¤–RTMP | åŒé‡ä¼˜åŒ– âš ï¸ |  
| `direct+direct` | direct | direct | æµ·å¤–ç”¨æˆ·è®¿é—®å›½å†…RTMP | æ— ä¼˜åŒ– |  
| `direct+proxy` | direct | proxy | æµ·å¤–ç”¨æˆ·è®¿é—®å›½å¤–RTMP | åç«¯ä¼˜åŒ– âš ï¸ |

> âš ï¸ **æ³¨æ„**: ä»£ç†æ¨¡å¼ï¼ˆproxyï¼‰ä¸‹VPSåˆ°RTMPæºçš„è¿æ¥æš‚æœªå®ç°å®Œæ•´ï¼Œä»£ç†çŠ¶æ€æ£€æµ‹å·²å®ç°ä½†FFmpegé€šè¿‡ä»£ç†è®¿é—®RTMPçš„åŠŸèƒ½ä»åœ¨å¼€å‘ä¸­ã€‚

### è·¯ç”±å†³ç­–æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚æ’­æ”¾] --> B[Workersæ¥æ”¶è¯·æ±‚]
    B --> C{æ£€æµ‹éš§é“å¼€å…³}
    C -->|å¼€å¯| D[frontendPath=tunnel]
    C -->|å…³é—­| E[frontendPath=direct]
    
    D --> F{æ£€æµ‹VPSä»£ç†çŠ¶æ€}
    E --> F
    
    F -->|ä»£ç†å·²è¿æ¥| G[backendPath=proxy]
    F -->|ä»£ç†æœªè¿æ¥| H[backendPath=direct]
    
    G --> I[ç»„åˆè·¯ç”±æ¨¡å¼]
    H --> I
    
    I --> J[WorkersåŒ…è£…HLS URL]
    J --> K[è¿”å›ç»™å‰ç«¯æ’­æ”¾]
    
    K --> L[å‰ç«¯æ˜¾ç¤ºåŒç»´åº¦æ ‡ç­¾]
```

### Workersä»£ç†æ–¹æ¡ˆï¼ˆè§£å†³SSLé—®é¢˜ï¼‰

**é—®é¢˜**: æµè§ˆå™¨è®¿é—® `tunnel-hls.yoyo-vps.5202021.xyz` è§¦å‘SSLé”™è¯¯

**è§£å†³æ–¹æ¡ˆæ¶æ„**:
```
æ—§æ¶æ„ï¼ˆæœ‰SSLé—®é¢˜ï¼‰:
  æµè§ˆå™¨ â†’ tunnel-hls.yoyo-vps.5202021.xyz âŒ

æ–°æ¶æ„ï¼ˆWorkersä»£ç†ï¼‰:
  æµè§ˆå™¨ â†’ yoyoapi.5202021.xyz/tunnel-proxy/hls/* âœ…
           â†“ (Workerså†…éƒ¨ä»£ç†)
       tunnel-hls.yoyo-vps.5202021.xyz âœ…
```

**æŠ€æœ¯ä¼˜åŠ¿**:
- âœ… ä¸å½±å“å…¶ä»–å­åŸŸå
- âœ… 10åˆ†é’Ÿå¿«é€Ÿå®æ–½
- âœ… å†…ç½®æ•…éšœè½¬ç§»
- âœ… æ€§èƒ½å½±å“å°ï¼ˆ~10-50msï¼‰

### å‰ç«¯åŒç»´åº¦æ˜¾ç¤º

**UIæ•ˆæœ**:
```
[çŠ¶æ€: æ’­æ”¾ä¸­] [å‰ç«¯: éš§é“ä¼˜åŒ–] [åç«¯: ç›´è¿]
```

**å®ç°è¦ç‚¹**:
- å‰ç«¯è·¯å¾„æ ‡ç­¾ï¼šğŸ”— éš§é“ä¼˜åŒ– / ğŸ”— ç›´è¿
- åç«¯è·¯å¾„æ ‡ç­¾ï¼šğŸ”— ä»£ç†(jp) / ğŸ”— ç›´è¿
- é¢œè‰²åŒºåˆ†ï¼šç»¿è‰²ï¼ˆä¼˜åŒ–ï¼‰/ è“è‰²ï¼ˆç›´è¿ï¼‰

è¯¦ç»†å®ç°å‚è§: `doc/DUAL_DIMENSION_ROUTING_ARCHITECTURE.md`

---

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶

### 1. SimpleStreamManagerï¼ˆè½¬ç ç®¡ç†ï¼‰

**è®¾è®¡åŸåˆ™**:
- æŒ‰éœ€å¯åŠ¨è½¬ç ï¼ˆæ— è§‚çœ‹è€…æ—¶ä¸å¤„ç†ï¼‰
- å¤šç”¨æˆ·å…±äº«è½¬ç è¿›ç¨‹
- æ™ºèƒ½å¿ƒè·³å’Œç©ºé—²æ¸…ç†

**æ ¸å¿ƒæµç¨‹**:
```
ç”¨æˆ·ç‚¹å‡»æ’­æ”¾
    â†“
æ£€æŸ¥æ˜¯å¦å·²æœ‰è½¬ç è¿›ç¨‹
    â†“
æœ‰ â†’ å¤ç”¨ç°æœ‰è¿›ç¨‹ | æ—  â†’ å¯åŠ¨æ–°è¿›ç¨‹
    â†“
è¿”å›HLS URLç»™å‰ç«¯
    â†“
å‰ç«¯å¼€å§‹æ’­æ”¾å¹¶å‘é€å¿ƒè·³
    â†“
60ç§’æ— å¿ƒè·³ â†’ è‡ªåŠ¨æ¸…ç†è¿›ç¨‹
```

### 2. Cloudflare Tunnelï¼ˆç½‘ç»œä¼˜åŒ–ï¼‰

**é…ç½®æ¦‚è§ˆ**:
```yaml
# /etc/cloudflared/config.yml
tunnel: 071aeb49-a619-4543-aee4-c9a13b4e84e4
ingress:
  - hostname: tunnel-api.yoyo-vps.5202021.xyz
    service: http://localhost:3000
  - hostname: tunnel-hls.yoyo-vps.5202021.xyz
    service: http://localhost:52535  # Nginx HLSæœåŠ¡
  - hostname: tunnel-health.yoyo-vps.5202021.xyz
    service: http://localhost:3000
```

**è¿è¡ŒçŠ¶æ€**: âœ… 4ä¸ªè¿æ¥å·²å»ºç«‹ï¼Œlax06/lax09æ•°æ®ä¸­å¿ƒ

### 3. V2Ray/Xrayä»£ç†æœåŠ¡

**ç”¨é€”**: VPSè®¿é—®æµ·å¤–RTMPæºæ—¶çš„ç½‘ç»œä¼˜åŒ–

**å®ç°çŠ¶æ€**: âš ï¸ **éƒ¨åˆ†å®ç°**
- âœ… ä»£ç†æœåŠ¡ç®¡ç†ï¼ˆè¿æ¥/æ–­å¼€ï¼‰
- âœ… ä»£ç†çŠ¶æ€æ£€æµ‹å’ŒåŒæ­¥
- âœ… ç®¡ç†åå°æ§åˆ¶ç•Œé¢
- âš ï¸ **FFmpegé€šè¿‡ä»£ç†è®¿é—®RTMPï¼ˆæš‚æœªå®Œæ•´å®ç°ï¼‰**

**ç®¡ç†æ–¹å¼**:
- ç®¡ç†åå°ä¸€é”®è¿æ¥/æ–­å¼€
- æ”¯æŒå¤šä¸ªä»£ç†é…ç½®ï¼ˆjpã€usç­‰ï¼‰
- è‡ªåŠ¨çŠ¶æ€åŒæ­¥å’Œæ˜¾ç¤º

**å·¥ä½œæµç¨‹**:
```
VPSéœ€è¦è®¿é—®RTMPæº
    â†“
æ£€æŸ¥ä»£ç†è¿æ¥çŠ¶æ€
    â†“
å·²è¿æ¥ â†’ é€šè¿‡ä»£ç†è®¿é—® (âš ï¸ æš‚æœªå®ç°) | æœªè¿æ¥ â†’ ç›´è¿è®¿é—® âœ…
    â†“
è·¯ç”±ä¿¡æ¯è¿”å›ç»™Workers
    â†“
Workersç»„åˆåŒç»´åº¦è·¯ç”±æ¨¡å¼
```

**å¾…å®ŒæˆåŠŸèƒ½**:
- [ ] FFmpegé€šè¿‡SOCKS5ä»£ç†è¿æ¥RTMPæº
- [ ] ä»£ç†è¿æ¥å¤±è´¥è‡ªåŠ¨å›é€€åˆ°ç›´è¿
- [ ] ä»£ç†æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

### 4. æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿï¼ˆæ–°å¢ï¼‰â­

**åŠŸèƒ½æ¦‚è¿°**: å®šæ—¶é¢„åŠ è½½å…³é”®é¢‘é“ï¼Œå®ç°é›¶å»¶è¿Ÿæ’­æ”¾

**æ ¸å¿ƒç»„ä»¶**:

#### 4.1 PreloadSchedulerï¼ˆå®šæ—¶è°ƒåº¦å™¨ï¼‰
```javascript
// services/PreloadScheduler.js
class PreloadScheduler {
  // ä½¿ç”¨node-cronä¸ºæ¯ä¸ªé¢‘é“åˆ›å»ºç²¾ç¡®å®šæ—¶ä»»åŠ¡
  scheduledJobs = new Map();  // channelId -> [startJob, endJob]
  workdayChecker = null;  // ğŸ†• å·¥ä½œæ—¥æ£€æµ‹å™¨å®ä¾‹
  
  async start() {
    // ğŸ†• 1. åˆå§‹åŒ–å·¥ä½œæ—¥æ£€æµ‹å™¨ï¼ˆé¢„å–å½“å‰æœˆ+ä¸‹æœˆæ•°æ®ï¼‰
    await this.workdayChecker.initialize();
    
    // 2. ä»Workers APIè·å–æ‰€æœ‰é¢„åŠ è½½é…ç½®
    // 3. ä¸ºæ¯ä¸ªå¯ç”¨çš„é¢‘é“åˆ›å»ºå¼€å§‹/ç»“æŸå®šæ—¶ä»»åŠ¡
    // 4. æœåŠ¡å¯åŠ¨æ—¶æ£€æµ‹å¹¶ç«‹å³å¯åŠ¨åº”é¢„åŠ è½½çš„é¢‘é“
  }
  
  async shouldPreloadNow(config, currentTime) {
    // æ­¥éª¤1: æ£€æŸ¥æ—¶é—´æ®µ
    const inTimeRange = this.isInTimeRange(currentTime, startTime, endTime);
    if (!inTimeRange) return false;
    
    // ğŸ†• æ­¥éª¤2: æ£€æŸ¥å·¥ä½œæ—¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (config.workdaysOnly) {
      const isWorkday = await this.workdayChecker.isWorkday();
      if (!isWorkday) {
        return false;  // éå·¥ä½œæ—¥ï¼Œè·³è¿‡é¢„åŠ è½½
      }
    }
    return true;
  }
  
  schedulePreload(channelId, config) {
    // åˆ›å»ºå¼€å§‹ä»»åŠ¡: cron.schedule('40 7 * * *', async () => {
    //   ğŸ†• å®æ—¶æ£€æŸ¥æ˜¯å¦åº”è¯¥å¯åŠ¨ï¼ˆåŒ…å«å·¥ä½œæ—¥æ£€æŸ¥ï¼‰
    //   if (await shouldPreloadNow(config, currentTime)) {
    //     await startPreload(config);
    //   }
    // })
    
    // åˆ›å»ºç»“æŸä»»åŠ¡: cron.schedule('20 17 * * *', ...)
  }
}
```

**è°ƒåº¦ç­–ç•¥**:
- âœ… åŸºäºåŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰çš„ç²¾ç¡®cronä»»åŠ¡
- âœ… æ¯ä¸ªé¢‘é“2ä¸ªä»»åŠ¡ï¼ˆå¼€å§‹+ç»“æŸï¼‰ï¼Œä¾‹å¦‚07:40å¯åŠ¨ï¼Œ17:20åœæ­¢
- âœ… **å·¥ä½œæ—¥æ™ºèƒ½åˆ¤æ–­**: å®šæ—¶ä»»åŠ¡è§¦å‘æ—¶å®æ—¶æ£€æŸ¥å·¥ä½œæ—¥ â­
- âœ… é…ç½®å˜æ›´æ—¶çƒ­é‡è½½ï¼Œç«‹å³ç”Ÿæ•ˆ
- âœ… æœåŠ¡é‡å¯æ—¶è‡ªåŠ¨æ£€æµ‹å½“å‰æ—¶æ®µï¼Œç«‹å³å¯åŠ¨åº”é¢„åŠ è½½çš„é¢‘é“
- âœ… **å®¹é”™é™çº§**: APIå¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºæ¯æ—¥é¢„åŠ è½½ï¼Œä¸ä¸­æ–­æœåŠ¡ â­

#### 4.2 SimpleStreamManageré¢„åŠ è½½æ”¯æŒ
```javascript
// é¢„åŠ è½½æ ‡è®°æœºåˆ¶
class SimpleStreamManager {
  preloadChannels = new Set();  // é¢„åŠ è½½é¢‘é“é›†åˆ
  
  startPreload(channelId, rtmpUrl) {
    // 1. å¯åŠ¨FFmpegè½¬ç è¿›ç¨‹
    // 2. æ·»åŠ åˆ°preloadChannelsé›†åˆ
    // 3. å¿ƒè·³æ¸…ç†é€»è¾‘è‡ªåŠ¨è·³è¿‡é¢„åŠ è½½é¢‘é“
  }
  
  cleanupIdleChannels() {
    // è·³è¿‡é¢„åŠ è½½é¢‘é“çš„è‡ªåŠ¨æ¸…ç†
    if (this.preloadChannels.has(channelId)) {
      return; // ä¿ç•™é¢„åŠ è½½è¿›ç¨‹
    }
  }
}
```

#### 4.3 PreloadHealthCheckï¼ˆå¥åº·æ£€æŸ¥ï¼‰
```javascript
// services/PreloadHealthCheck.js
class PreloadHealthCheck {
  CHECK_INTERVAL = 5 * 60 * 1000;  // æ¯5åˆ†é’Ÿæ£€æŸ¥
  
  async performHealthCheck() {
    // 1. æ£€æŸ¥é¢„åŠ è½½è¿›ç¨‹æ˜¯å¦å­˜æ´»
    // 2. éªŒè¯HLSæ–‡ä»¶æ˜¯å¦æ­£å¸¸ç”Ÿæˆ
    // 3. è¿›ç¨‹å´©æºƒè‡ªåŠ¨é‡å¯ï¼ˆæœ€å¤š3æ¬¡ï¼‰
  }
}
```

**KVå­˜å‚¨ç»“æ„** (å·²æ•´åˆåˆ°é¢‘é“é…ç½®ä¸­):
```json
{
  "channel:stream_ensxma2g": {
    "id": "stream_ensxma2g",
    "name": "äºŒæ¥¼æ•™å®¤1",
    "rtmpUrl": "rtmp://push228.dodool.com.cn/55/19",
    "sortOrder": 1,
    "status": "active",
    "preloadConfig": {
      "enabled": true,
      "startTime": "07:00",
      "endTime": "17:30",
      "workdaysOnly": true,
      "updatedAt": "2025-10-27T09:00:00Z",
      "updatedBy": "admin"
    },
    "createdAt": "2025-10-01T00:00:00Z",
    "updatedAt": "2025-10-27T09:00:00Z"
  }
}
```

**æ³¨**: é¢„åŠ è½½é…ç½®ä½œä¸º `preloadConfig` å­—æ®µåµŒå…¥åˆ°é¢‘é“é…ç½®ä¸­ï¼Œä¸å†ä½¿ç”¨ç‹¬ç«‹çš„ `PRELOAD_CONFIG:*` é”®ã€‚

#### 4.4 WorkdayCheckerï¼ˆå·¥ä½œæ—¥æ£€æµ‹å™¨ï¼‰â­ æ–°å¢

**åŠŸèƒ½æ¦‚è¿°**: æ™ºèƒ½è¯†åˆ«å·¥ä½œæ—¥ï¼Œæ”¯æŒæ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘è¯†åˆ«

```javascript
// services/WorkdayChecker.js
class WorkdayChecker {
  apiUrl = 'https://timor.tech/api/holiday/info';
  cache = new Map();  // å†…å­˜ç¼“å­˜
  failedMonths = new Set();  // å¤±è´¥æœˆä»½è·Ÿè¸ª
  
  async initialize() {
    // 1. é¢„å–å½“å‰æœˆ+ä¸‹æœˆå·¥ä½œæ—¥æ•°æ®
    // 2. è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©å‡Œæ™¨1ç‚¹æ£€æŸ¥
    //    - 25å·é¢„å–ä¸‹æœˆæ•°æ®
    //    - é‡è¯•å¤±è´¥çš„æœˆä»½
  }
  
  async isWorkday(date = new Date()) {
    // 1. æ£€æŸ¥ç¼“å­˜ â†’ å‘½ä¸­è¿”å›ï¼ˆ24å°æ—¶æœ‰æ•ˆæœŸï¼‰
    // 2. è°ƒç”¨API â†’ type=0æˆ–3ä¸ºå·¥ä½œæ—¥
    // 3. å¤±è´¥é™çº§ â†’ å‘¨ä¸€è‡³å‘¨äº”=å·¥ä½œæ—¥ï¼ˆæ— æ³•è¯†åˆ«èŠ‚å‡æ—¥ï¼‰
    // 4. å†™å…¥ç¼“å­˜
  }
}
```

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… **æ•°æ®æº**: Timor API (å…è´¹ã€ç¨³å®šã€å‡†ç¡®)
- âœ… **æ•°æ®é¢„å–**: å¯åŠ¨æ—¶é¢„å–å½“å‰æœˆ+ä¸‹æœˆï¼Œ25å·è‡ªåŠ¨é¢„å–ä¸‹æœˆ
- âœ… **æ™ºèƒ½ç¼“å­˜**: å†…å­˜ç¼“å­˜ + 24å°æ—¶æœ‰æ•ˆæœŸï¼Œ95%è¯·æ±‚<1ms
- âœ… **å¤±è´¥é‡è¯•**: è‡ªåŠ¨è·Ÿè¸ªå¤±è´¥æœˆä»½ï¼Œæ¯å¤©å‡Œæ™¨1ç‚¹é‡è¯•
- âœ… **å®¹é”™é™çº§**: APIå¤±è´¥æ—¶é™çº§ä¸ºåŸºç¡€æ¨¡å¼ï¼ˆå‘¨ä¸€è‡³å‘¨äº”ï¼‰
- âœ… **èŠ‚å‡æ—¥è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«æ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘å·¥ä½œæ—¥

**å·¥ä½œæ—¥ç±»å‹**:
- `type=0` - æ­£å¸¸å·¥ä½œæ—¥ï¼ˆå‘¨ä¸€è‡³å‘¨äº”ï¼‰
- `type=1` - å‘¨æœ«ä¼‘æ¯æ—¥
- `type=2` - æ³•å®šèŠ‚å‡æ—¥
- `type=3` - è°ƒä¼‘å·¥ä½œæ—¥ï¼ˆéœ€è¦ä¸Šç­ï¼‰

**APIè°ƒç”¨ä¼˜åŒ–**:
```javascript
// æ·»åŠ User-Agenté¿å…Cloudflare Boté˜²æŠ¤
fetch(apiUrl, {
  headers: {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0'
  }
});
```

**Workers APIç«¯ç‚¹**:
- `GET /api/preload/config/:channelId` - è·å–é¢‘é“é¢„åŠ è½½é…ç½®
- `PUT /api/preload/config/:channelId` - æ›´æ–°é¢‘é“é¢„åŠ è½½é…ç½®ï¼ˆå«workdaysOnlyï¼‰
- `GET /api/preload/status` - æŸ¥è¯¢é¢„åŠ è½½ç³»ç»ŸçŠ¶æ€
- `GET /api/preload/workday-status` - æŸ¥è¯¢å·¥ä½œæ—¥æ£€æµ‹å™¨çŠ¶æ€ â­ æ–°å¢
- `POST /api/preload/reload` - é‡è½½è°ƒåº¦å™¨é…ç½®

**VPS APIç«¯ç‚¹**:
- `GET /api/preload/workday-status` - è¿”å›å·¥ä½œæ—¥æ•°æ®å°±ç»ªçŠ¶æ€å’Œå¤±è´¥æœˆä»½

**å‰ç«¯ç®¡ç†ç•Œé¢**:
- é¢‘é“åˆ—è¡¨ä¸­æ·»åŠ "é¢„åŠ è½½"æŒ‰é’®
- PreloadConfigDialogç»„ä»¶ï¼š
  - é¢„åŠ è½½å¼€å…³ï¼ˆenabledï¼‰
  - å¼€å§‹/ç»“æŸæ—¶é—´
  - **ä»…å·¥ä½œæ—¥å¼€å…³ï¼ˆworkdaysOnlyï¼‰** â­ æ–°å¢
  - **å·¥ä½œæ—¥çŠ¶æ€æ˜¾ç¤º** â­ æ–°å¢
    - âœ… æ•°æ®å·²åŠ è½½ (success)
    - âš ï¸ Nä¸ªæœˆä»½å¾…é‡è¯• (warning)
    - ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ® (info)
    - âŒ è·å–çŠ¶æ€å¤±è´¥ (danger)
- æ—¶æ®µæè¿°åŠ¨æ€æ˜¾ç¤ºï¼š
  - workdaysOnly=false: "é¢„åŠ è½½æ—¶æ®µï¼šæ¯å¤© 07:40 - 17:25"
  - workdaysOnly=true: "é¢„åŠ è½½æ—¶æ®µï¼šå·¥ä½œæ—¥ 07:40 - 17:25"

**æ€§èƒ½ä¼˜åŒ–æ•ˆæœ**:
- âš¡ **é›¶å»¶è¿Ÿæ’­æ”¾**: é¢„åŠ è½½æ—¶æ®µç”¨æˆ·ç‚¹å‡»ç«‹å³æ’­æ”¾ï¼ˆ<0.5ç§’ï¼‰
- ğŸ’° **èµ„æºèŠ‚çœ**: ä»…åœ¨é…ç½®æ—¶æ®µè¿è¡Œï¼Œéæ—¶æ®µè‡ªåŠ¨åœæ­¢
- ğŸ¯ **ç²¾ç¡®è°ƒåº¦**: cronä»»åŠ¡å‡†ç‚¹è§¦å‘ï¼Œæ— è½®è¯¢æ¶ˆè€—

---

## ğŸ¬ é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿ

**ç‰ˆæœ¬**: V2.4 (2025-10-28)  
**æ–‡æ¡£**: `doc/RECORDING_IMPLEMENTATION_STAGED.md`  
**çŠ¶æ€**: âœ… å·²éƒ¨ç½²

### 5.1 æ ¸å¿ƒæ¶æ„

**è®¾è®¡ç†å¿µ**: ä¸€è¿›ç¨‹åŒè¾“å‡ºï¼Œé›¶å†—ä½™æ•°æ®

```javascript
// å•ä¸ªFFmpegè¿›ç¨‹åŒæ—¶è¾“å‡ºHLSï¼ˆè§‚çœ‹ï¼‰å’ŒMP4ï¼ˆå½•åˆ¶ï¼‰
ffmpeg -i rtmp://input
  // HLSè¾“å‡ºï¼ˆå®æ—¶è§‚çœ‹ï¼‰
  -c:v libx264 -preset ultrafast -an
  -f hls -hls_time 2 -hls_list_size 6
  output.m3u8
  
  // MP4è¾“å‡ºï¼ˆå½•åˆ¶æ–‡ä»¶ï¼‰
  -c:v copy -f mp4 -y
  recording.mp4
```

### 5.2 RecordSchedulerï¼ˆå½•åˆ¶è°ƒåº¦å™¨ï¼‰

**åŠŸèƒ½**: åŸºäºnode-cronçš„å®šæ—¶ä»»åŠ¡ç®¡ç†

```javascript
// services/RecordScheduler.js
class RecordScheduler {
  constructor(streamManager) {
    this.streamManager = streamManager;
    this.cronTasks = new Map();  // Map<channelId, {startTask, stopTask}>
    this.workdayChecker = new WorkdayChecker();  // å¤ç”¨å·¥ä½œæ—¥æ£€æµ‹å™¨
  }
  
  scheduleChannel(config) {
    const { channelId, startTime, endTime } = config;
    
    // å¼€å§‹å½•åˆ¶ä»»åŠ¡ï¼ˆå¦‚ 07:40ï¼‰
    const startCron = `${startM} ${startH} * * *`;
    const startTask = cron.schedule(startCron, async () => {
      if (await this.shouldRecordNow(config)) {
        await this.streamManager.enableRecording(channelId, config);
      }
    }, { timezone: 'Asia/Shanghai' });
    
    // åœæ­¢å½•åˆ¶ä»»åŠ¡ï¼ˆå¦‚ 17:25ï¼‰
    const stopCron = `${endM} ${endH} * * *`;
    const stopTask = cron.schedule(stopCron, async () => {
      await this.streamManager.disableRecording(channelId);
    }, { timezone: 'Asia/Shanghai' });
    
    this.cronTasks.set(channelId, { startTask, stopTask });
  }
}
```

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… **å®šæ—¶ä»»åŠ¡**: åŸºäºnode-cronçš„å‡†ç‚¹è§¦å‘
- âœ… **å·¥ä½œæ—¥æ”¯æŒ**: å¤ç”¨WorkdayCheckerï¼Œæ”¯æŒæ³•å®šèŠ‚å‡æ—¥è¯†åˆ«
- âœ… **è·¨å¤©æ”¯æŒ**: æ­£ç¡®å¤„ç†23:00-01:00ç­‰è·¨å¤©æ—¶é—´æ®µ
- âœ… **é…ç½®çƒ­é‡è½½**: é…ç½®æ›´æ–°åè‡ªåŠ¨é‡è½½è°ƒåº¦
- âœ… **å¯åŠ¨æ¢å¤**: æœåŠ¡é‡å¯æ—¶æ£€æµ‹å½“å‰æ—¶æ®µï¼Œè‡ªåŠ¨æ¢å¤å½•åˆ¶

### 5.3 SimpleStreamManagerå½•åˆ¶æ”¯æŒ

**æ‰©å±•åŠŸèƒ½**: åœ¨åŸæœ‰è½¬ç ç®¡ç†åŸºç¡€ä¸Šæ·»åŠ å½•åˆ¶èƒ½åŠ›

```javascript
class SimpleStreamManager {
  recordingChannels = new Set();      // å½•åˆ¶ä¸­çš„é¢‘é“é›†åˆ
  recordingConfigs = new Map();       // é¢‘é“å½•åˆ¶é…ç½®
  recordingBaseDir = '/var/www/recordings';
  
  async enableRecording(channelId, recordConfig) {
    // 1. ä¿å­˜é…ç½®
    this.recordingConfigs.set(channelId, recordConfig);
    this.recordingChannels.add(channelId);
    
    // 2. å¯åŠ¨å¸¦å½•åˆ¶çš„FFmpegè¿›ç¨‹ï¼ˆæˆ–é‡å¯ç°æœ‰è¿›ç¨‹ï¼‰
    await this.startStreamWithRecording(channelId, rtmpUrl, recordConfig);
  }
  
  async spawnFFmpegWithRecording(channelId, rtmpUrl, recordingPath) {
    // FFmpegä¸€è¿›ç¨‹åŒè¾“å‡ºé…ç½®
    const ffmpegArgs = [
      '-i', rtmpUrl,
      '-c:v', 'libx264', '-preset', 'ultrafast', '-an',
      
      // HLSè¾“å‡º
      '-f', 'hls', '-hls_time', '2', '-hls_list_size', '6',
      'playlist.m3u8',
      
      // MP4å½•åˆ¶è¾“å‡ºï¼ˆcopyç¼–ç ï¼Œé›¶æŸè€—ï¼‰
      '-c:v', 'copy', '-f', 'mp4', '-y',
      recordingPath
    ];
  }
  
  cleanupIdleChannels() {
    // è·³è¿‡å½•åˆ¶é¢‘é“çš„è‡ªåŠ¨æ¸…ç†
    if (this.recordingChannels.has(channelId)) {
      return; // ä¿ç•™å½•åˆ¶è¿›ç¨‹
    }
  }
}
```

**å…³é”®æ”¹è¿›**:
- âœ… å½•åˆ¶è¿›ç¨‹ä¸å—å¿ƒè·³æ¸…ç†å½±å“
- âœ… ä¸è§‚çœ‹ã€é¢„åŠ è½½å…±äº«åŒä¸€FFmpegè¿›ç¨‹
- âœ… è‡ªåŠ¨åˆ›å»ºå½•åˆ¶ç›®å½•ï¼ˆ`fs.mkdirSync(recordDir, { recursive: true })`ï¼‰

### 5.4 æ–‡ä»¶å‘½åæ–¹æ¡ˆ

**æ··åˆå‘½å**: channelName + channelId + æ—¶é—´ä¿¡æ¯

```javascript
generateRecordingPath(channelId, channelName, recordConfig) {
  const dateStr = '20251028';          // YYYYMMDD
  const startTimeStr = '074000';       // HHMMSS
  const endTimeStr = '172500';         // HHMMSS
  
  // æ ¼å¼: {é¢‘é“å}_{é¢‘é“ID}_{æ—¥æœŸ}_{å¼€å§‹æ—¶é—´}_to_{ç»“æŸæ—¶é—´}.mp4
  const filename = `${channelName}_${channelId}_${dateStr}_${startTimeStr}_to_${endTimeStr}.mp4`;
  
  // è·¯å¾„: /var/www/recordings/{channelId}/{YYYYMMDD}/filename.mp4
  return path.join(basePath, channelId, dateStr, filename);
}
```

**ç¤ºä¾‹æ–‡ä»¶å**:
```
/var/www/recordings/stream_ensxma2g/20251028/
  äºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251028_074000_to_172500.mp4
```

**ä¼˜åŠ¿**:
- âœ… å¯è¯»æ€§å¥½ï¼šåŒ…å«ä¸­æ–‡é¢‘é“å
- âœ… å”¯ä¸€æ€§å¼ºï¼šåŒ…å«é¢‘é“IDé¿å…å†²çª
- âœ… ä¿¡æ¯å®Œæ•´ï¼šåŒ…å«æ—¥æœŸå’Œæ—¶é—´æ®µ
- âœ… UTF-8æ”¯æŒï¼šç°ä»£ç³»ç»ŸåŸç”Ÿæ”¯æŒä¸­æ–‡æ–‡ä»¶å

### 5.5 KVå­˜å‚¨ç»“æ„

**æ•´åˆåˆ°é¢‘é“é…ç½®** (recordConfigå­—æ®µ):

```json
{
  "channel:stream_ensxma2g": {
    "id": "stream_ensxma2g",
    "name": "äºŒæ¥¼æ•™å®¤1",
    "rtmpUrl": "rtmp://...",
    "preloadConfig": {
      "enabled": true,
      "startTime": "07:40",
      "endTime": "17:25",
      "workdaysOnly": true
    },
    "recordConfig": {
      "enabled": true,
      "startTime": "07:40",
      "endTime": "17:25",
      "workdaysOnly": true,
      "storagePath": "/var/www/recordings",
      "updatedAt": "2025-10-28T12:00:00Z",
      "updatedBy": "admin"
    }
  }
}
```

**æ³¨**: 
- recordConfigä¸å­˜å‚¨channelNameï¼Œä»é¡¶å±‚nameè·å–ï¼ˆé¿å…æ•°æ®å†—ä½™ï¼‰
- storagePathå¯é…ç½®ï¼Œæ”¯æŒFileBrowserè·¯å¾„æ˜ å°„

### 5.6 APIç«¯ç‚¹

**Workers API**:
- `GET /api/record/config/:channelId` - è·å–é¢‘é“å½•åˆ¶é…ç½®
- `PUT /api/record/config/:channelId` - æ›´æ–°é¢‘é“å½•åˆ¶é…ç½®
- `GET /api/record/configs` - è·å–æ‰€æœ‰å¯ç”¨å½•åˆ¶çš„é¢‘é“ï¼ˆVPSè°ƒç”¨ï¼‰

**VPS API**:
- `POST /api/record/reload-schedule` - é‡æ–°åŠ è½½å½•åˆ¶è°ƒåº¦
- `GET /api/record/status` - è·å–å½•åˆ¶çŠ¶æ€

### 5.7 å‰ç«¯ç®¡ç†ç•Œé¢

**ChannelConfigDialog** (ç»Ÿä¸€é…ç½®å¯¹è¯æ¡†):

```vue
<template>
  <el-dialog title="é¢‘é“é…ç½®">
    <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šé¢„åŠ è½½é…ç½® -->
    <el-divider>é¢„åŠ è½½é…ç½®</el-divider>
    <el-switch v-model="preloadConfig.enabled" />
    <el-time-picker v-model="preloadConfig.startTime" />
    <el-time-picker v-model="preloadConfig.endTime" />
    <el-switch v-model="preloadConfig.workdaysOnly" />
    
    <!-- ä¸‹åŠéƒ¨åˆ†ï¼šå½•åˆ¶é…ç½® -->
    <el-divider>å½•åˆ¶é…ç½®</el-divider>
    <el-switch v-model="recordConfig.enabled" />
    <el-time-picker v-model="recordConfig.startTime" />
    <el-time-picker v-model="recordConfig.endTime" />
    <el-switch v-model="recordConfig.workdaysOnly" />
    <el-input v-model="recordConfig.storagePath" 
              placeholder="/var/www/recordings" />
  </el-dialog>
</template>
```

**ç‰¹ç‚¹**:
- âœ… ä¸Šä¸‹åˆ†åŒºï¼Œæ¸…æ™°ç›´è§‚
- âœ… å¹¶è¡Œä¿å­˜é¢„åŠ è½½å’Œå½•åˆ¶é…ç½®
- âœ… å®æ—¶çŠ¶æ€æ˜¾ç¤º
- âœ… è¡¨å•éªŒè¯

### 5.8 æŠ€æœ¯äº®ç‚¹

**1. ä¸€è¿›ç¨‹åŒè¾“å‡º**
- å•ä¸ªFFmpegè¿›ç¨‹åŒæ—¶ç”ŸæˆHLSï¼ˆå®æ—¶è§‚çœ‹ï¼‰å’ŒMP4ï¼ˆå½•åˆ¶æ–‡ä»¶ï¼‰
- èµ„æºå ç”¨minimalï¼Œå¯¹è§‚çœ‹æ— å½±å“

**2. é›¶æ•°æ®å†—ä½™**
- recordConfigä¸å­˜å‚¨channelName
- éœ€è¦æ—¶ä»é¡¶å±‚channel.nameè·å–
- ä¿è¯æ•°æ®ä¸€è‡´æ€§

**3. è¿›ç¨‹åè°ƒ**
- å½•åˆ¶ä¸è§‚çœ‹ã€é¢„åŠ è½½å…±äº«FFmpegè¿›ç¨‹
- æ™ºèƒ½åˆ¤æ–­ï¼šæœ‰è§‚çœ‹è€…æ—¶é‡å¯è¿›ç¨‹æ·»åŠ å½•åˆ¶ï¼Œæ— è§‚çœ‹è€…æ—¶åœæ­¢è¿›ç¨‹

**4. é…ç½®çƒ­é‡è½½**
- Workersä¿å­˜é…ç½®åè‡ªåŠ¨é€šçŸ¥VPS
- VPSè°ƒç”¨`reloadSchedule()`é‡æ–°åŠ è½½æ‰€æœ‰å®šæ—¶ä»»åŠ¡
- æ— éœ€é‡å¯æœåŠ¡

**5. è‡ªåŠ¨æ¢å¤**
- æœåŠ¡å¯åŠ¨5ç§’åè‡ªåŠ¨å¯åŠ¨RecordScheduler
- æ£€æµ‹å½“å‰æ—¶æ®µï¼Œç«‹å³æ¢å¤åº”å½•åˆ¶çš„é¢‘é“

---

## ğŸ—‘ï¸ è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿ

**ç‰ˆæœ¬**: V2.4 (2025-10-28)  
**æ–‡æ¡£**: `doc/VIDEO_CLEANUP_IMPLEMENTATION.md`  
**çŠ¶æ€**: âœ… å·²éƒ¨ç½²

### 6.1 æ ¸å¿ƒæ¶æ„

**è®¾è®¡ç†å¿µ**: è‡ªåŠ¨åŒ–æ¸…ç†ï¼Œå®‰å…¨å¯æ§ï¼Œé›¶äººå·¥å¹²é¢„

```javascript
// VideoCleanupScheduler - å®šæ—¶æ¸…ç†è°ƒåº¦å™¨
class VideoCleanupScheduler {
  constructor() {
    this.cronTask = null;
    this.isRunning = false;
    this.workerApiUrl = process.env.WORKER_API_URL;
    this.apiKey = process.env.VPS_API_KEY;
  }
  
  // æ¯å¤©å‡Œæ™¨1ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è‡ªåŠ¨æ‰§è¡Œ
  start() {
    this.cronTask = cron.schedule('0 1 * * *', async () => {
      await this.executeCleanup();
    }, { timezone: 'Asia/Shanghai' });
  }
}
```

**æ¸…ç†ç­–ç•¥**:
- âœ… **å®šæ—¶æ¸…ç†**: æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨æ‰§è¡Œ
- âœ… **ä¿ç•™å¤©æ•°**: å¯é…ç½®ï¼ˆé»˜è®¤2å¤©ï¼‰
- âœ… **é¢‘é“éš”ç¦»**: å•ä¸ªé¢‘é“å¤±è´¥ä¸å½±å“å…¶ä»–é¢‘é“
- âœ… **å®‰å…¨éªŒè¯**: ä¸¥æ ¼çš„æ—¥æœŸæ ¼å¼æ ¡éªŒï¼Œé˜²æ­¢è¯¯åˆ 

### 6.2 æ¸…ç†æµç¨‹

```javascript
async executeCleanup() {
  // 1. è·å–æ¸…ç†é…ç½®
  const config = await this.fetchCleanupConfig();  // KV: system:cleanup:config
  if (!config.enabled) return;
  
  // 2. è®¡ç®—æˆªæ­¢æ—¥æœŸ
  const cutoffDate = moment().tz('Asia/Shanghai')
    .subtract(config.retentionDays, 'days')
    .format('YYYYMMDD');  // å¦‚: 20251026
  
  // 3. è·å–æ‰€æœ‰é¢‘é“é…ç½®
  const channels = await this.fetchChannelConfigs();
  
  // 4. éå†æ¯ä¸ªé¢‘é“è¿›è¡Œæ¸…ç†
  for (const channel of channels) {
    if (channel.recordConfig?.enabled) {
      const storagePath = path.join(
        channel.recordConfig.storagePath || '/var/www/recordings',
        channel.id
      );
      await this.cleanupChannelVideos(channel.id, storagePath, cutoffDate);
    }
  }
}
```

### 6.3 æ–‡ä»¶å¤¹æ ¡éªŒæœºåˆ¶

**ä¸¥æ ¼çš„æ—¥æœŸæ ¼å¼éªŒè¯** - é˜²æ­¢è¯¯åˆ é‡è¦æ–‡ä»¶

```javascript
isValidDateFolder(folderName) {
  // æ ¼å¼: YYYYMMDD
  if (!/^\d{8}$/.test(folderName)) return false;
  
  // å¹´ä»½: 1900-2099
  const year = parseInt(folderName.substring(0, 4));
  if (year < 1900 || year > 2099) return false;
  
  // æœˆä»½: 01-12
  const month = parseInt(folderName.substring(4, 6));
  if (month < 1 || month > 12) return false;
  
  // æ—¥æœŸ: 01-31
  const day = parseInt(folderName.substring(6, 8));
  if (day < 1 || day > 31) return false;
  
  return true;
}
```

**ç¤ºä¾‹**:
```
âœ… 20251025  â†’ åˆ é™¤ï¼ˆç¬¦åˆYYYYMMDDæ ¼å¼ï¼‰
âœ… 20251026  â†’ åˆ é™¤ï¼ˆç¬¦åˆYYYYMMDDæ ¼å¼ï¼‰
âŒ videos    â†’ è·³è¿‡ï¼ˆä¸ç¬¦åˆæ—¥æœŸæ ¼å¼ï¼‰
âŒ backup    â†’ è·³è¿‡ï¼ˆä¸ç¬¦åˆæ—¥æœŸæ ¼å¼ï¼‰
âŒ 2025-10-25 â†’ è·³è¿‡ï¼ˆåŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼‰
```

### 6.4 ç›®å½•ç»“æ„

**å®é™…æ–‡ä»¶å­˜å‚¨**:
```
/srv/filebrowser/yoyo-k/
â”œâ”€â”€ stream_gkg5hknc/
â”‚   â”œâ”€â”€ 20251025/           â† è‡ªåŠ¨åˆ é™¤ï¼ˆ2å¤©å‰ï¼‰
â”‚   â”œâ”€â”€ 20251026/           â† è‡ªåŠ¨åˆ é™¤ï¼ˆ2å¤©å‰ï¼‰
â”‚   â”œâ”€â”€ 20251027/           â† ä¿ç•™
â”‚   â””â”€â”€ 20251028/           â† ä¿ç•™
â””â”€â”€ stream_kcwxuedx/
    â”œâ”€â”€ 20251027/           â† ä¿ç•™
    â””â”€â”€ 20251028/           â† ä¿ç•™
```

### 6.5 KVå­˜å‚¨ç»“æ„

**æ¸…ç†é…ç½®** (`system:cleanup:config`):

```json
{
  "enabled": true,
  "retentionDays": 2
}
```

**å­—æ®µè¯´æ˜**:
- `enabled`: æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ¸…ç†ï¼ˆBooleanï¼‰
- `retentionDays`: ä¿ç•™å¤©æ•°ï¼ˆNumberï¼ŒèŒƒå›´1-365ï¼‰

### 6.6 APIç«¯ç‚¹

**Workers API**:
- `GET /api/admin/cleanup/config` - è·å–æ¸…ç†é…ç½®
- `PUT /api/admin/cleanup/config` - æ›´æ–°æ¸…ç†é…ç½®
- `POST /api/admin/cleanup/trigger` - æ‰‹åŠ¨è§¦å‘æ¸…ç†

**VPS API**:
- `POST /api/admin/cleanup/execute` - æ‰§è¡Œæ¸…ç†ï¼ˆéœ€API Keyè®¤è¯ï¼‰

**è°ƒç”¨æµç¨‹**:
```
å‰ç«¯ â†’ Workers â†’ VPS
1. å‰ç«¯ç‚¹å‡»"æ‰‹åŠ¨æ¸…ç†"
2. WorkerséªŒè¯ç”¨æˆ·æƒé™
3. Workersè°ƒç”¨VPSæ‰§è¡Œæ¸…ç†
4. VPSè¿”å›æ¸…ç†ç»“æœ
5. å‰ç«¯æ˜¾ç¤ºæ¸…ç†ç»Ÿè®¡
```

### 6.7 å‰ç«¯ç®¡ç†ç•Œé¢

**SystemSettingsDialog** (ç³»ç»Ÿè®¾ç½®å¯¹è¯æ¡†):

```vue
<template>
  <el-dialog title="ç³»ç»Ÿè®¾ç½®">
    <el-divider>è§†é¢‘æ¸…ç†é…ç½®</el-divider>
    
    <!-- å¯ç”¨å¼€å…³ -->
    <el-switch v-model="form.enabled" label="å¯ç”¨è‡ªåŠ¨æ¸…ç†" />
    
    <!-- ä¿ç•™å¤©æ•° -->
    <el-input-number v-model="form.retentionDays" 
                     :min="1" :max="365" />
    <div class="hint">åˆ é™¤ {{ form.retentionDays }} å¤©å‰çš„è§†é¢‘æ–‡ä»¶</div>
    
    <!-- æ¸…ç†æ—¶é—´æç¤º -->
    <el-tag type="info">æ¯å¤© 01:00 (åŒ—äº¬æ—¶é—´)</el-tag>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <el-button type="warning" @click="handleManualCleanup">
      æ‰‹åŠ¨æ¸…ç†
    </el-button>
    <el-button type="primary" @click="handleSave">
      ä¿å­˜
    </el-button>
  </el-dialog>
</template>
```

**äº¤äº’æµç¨‹**:
1. ç®¡ç†å‘˜ç‚¹å‡»"è®¾ç½®"æŒ‰é’®
2. å¼¹å‡ºSystemSettingsDialogå¯¹è¯æ¡†
3. ä¿®æ”¹é…ç½® â†’ ç‚¹å‡»"ä¿å­˜" â†’ æ›´æ–°KVå­˜å‚¨
4. ç‚¹å‡»"æ‰‹åŠ¨æ¸…ç†" â†’ ç¡®è®¤å¯¹è¯æ¡† â†’ è§¦å‘ç«‹å³æ¸…ç†

### 6.8 å®‰å…¨æœºåˆ¶

**1. ä¸¥æ ¼çš„æ—¥æœŸæ ¼å¼æ ¡éªŒ**
```javascript
// âœ… åªåˆ é™¤ä¸¥æ ¼åŒ¹é…YYYYMMDDæ ¼å¼çš„æ–‡ä»¶å¤¹
// âŒ ä»»ä½•å…¶ä»–æ ¼å¼ä¸€å¾‹è·³è¿‡
if (!this.isValidDateFolder(folderName)) {
  continue; // è·³è¿‡éæ—¥æœŸæ–‡ä»¶å¤¹
}
```

**2. APIè®¤è¯**
```javascript
// VPSæ¸…ç†ç«¯ç‚¹éœ€è¦API Keyè®¤è¯
const apiKey = req.headers['x-api-key'];
if (!apiKey || apiKey !== process.env.VPS_API_KEY) {
  return res.status(401).json({ status: 'error', message: 'Unauthorized' });
}
```

**3. é”™è¯¯éš”ç¦»**
```javascript
// å•ä¸ªé¢‘é“å¤±è´¥ä¸å½±å“å…¶ä»–é¢‘é“
for (const channel of channels) {
  try {
    await this.cleanupChannelVideos(channel.id, ...);
  } catch (error) {
    // è®°å½•é”™è¯¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªé¢‘é“
    result.errors.push({ channelId: channel.id, error: error.message });
  }
}
```

### 6.9 æŠ€æœ¯äº®ç‚¹

**1. å®šæ—¶ä»»åŠ¡**
- åŸºäºnode-cronï¼Œç²¾å‡†åˆ°åˆ†é’Ÿçº§
- åŒ—äº¬æ—¶é—´ï¼ˆAsia/Shanghaiï¼‰æ”¯æŒ
- æœåŠ¡å¯åŠ¨è‡ªåŠ¨æ¢å¤

**2. è·¯å¾„åŠ¨æ€æ‹¼æ¥**
```javascript
// ä»KVè·å–åŸºç¡€è·¯å¾„ï¼ŒåŠ¨æ€æ‹¼æ¥é¢‘é“ID
const baseStoragePath = channel.recordConfig.storagePath;
const storagePath = path.join(baseStoragePath, channel.id);
// ç»“æœ: /srv/filebrowser/yoyo-k/stream_kcwxuedx
```

**3. é…ç½®å¯æ§**
- å‰ç«¯å¯è§†åŒ–é…ç½®
- å®æ—¶ç”Ÿæ•ˆæ— éœ€é‡å¯
- æ”¯æŒå¯ç”¨/ç¦ç”¨å¼€å…³

**4. å®‰å…¨ä¿éšœ**
- ä¸‰é‡æ ¡éªŒï¼šæ ¼å¼ã€å¹´ä»½ã€æœˆä»½ã€æ—¥æœŸ
- ç™½åå•æœºåˆ¶ï¼šåªå¤„ç†å½•åˆ¶é¢‘é“
- APIè®¤è¯ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®

**5. ç›‘æ§å‹å¥½**
```javascript
// è¯¦ç»†çš„æ—¥å¿—è®°å½•
logger.info('Video cleanup completed', {
  totalChannels: 8,
  processedChannels: 2,
  deletedFolders: 4,
  duration: '2.3s'
});
```

---

## ğŸ”„ æ•°æ®æµè½¬æœºåˆ¶

### å®Œæ•´æ’­æ”¾æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·æµè§ˆå™¨
    participant W as Workers
    participant V as VPS
    participant R as RTMPæº
    
    U->>W: 1. è¯·æ±‚æ’­æ”¾é¢‘é“A
    W->>W: 2. åˆ¤æ–­åŒç»´åº¦è·¯ç”±
    W->>V: 3. å¯åŠ¨è½¬ç è¯·æ±‚
    V->>V: 4. æ£€æŸ¥ä»£ç†çŠ¶æ€
    V->>R: 5. è¿æ¥RTMPæºï¼ˆç›´è¿æˆ–ä»£ç†ï¼‰
    V->>V: 6. å¯åŠ¨FFmpegè½¬ç 
    V->>W: 7. è¿”å›åŸºç¡€HLSè·¯å¾„
    W->>W: 8. æ ¹æ®è·¯ç”±åŒ…è£…å®Œæ•´URL
    W->>U: 9. è¿”å›HLS URL
    U->>W: 10. è¯·æ±‚HLSæ–‡ä»¶ï¼ˆé€šè¿‡ä»£ç†ï¼‰
    W->>V: 11. ä»£ç†åˆ°Tunnelæˆ–ç›´è¿
    V->>U: 12. è¿”å›HLSæ–‡ä»¶å†…å®¹
    U->>U: 13. æ’­æ”¾è§†é¢‘
    U->>V: 14. æ¯30ç§’å‘é€å¿ƒè·³
```

### é¢‘é“é…ç½®ç®¡ç†

**å­˜å‚¨æ–¹å¼**: Cloudflare KV  
**Keyæ ¼å¼**: `channel:${channelId}`  
**æ•°æ®ç»“æ„**:
```json
{
  "channel:stream_xxx": {
    "id": "stream_xxx",
    "name": "é¢‘é“åç§°",
    "rtmpUrl": "rtmp://...",
    "sortOrder": 1,
    "status": "active",
    "preloadConfig": {
      "enabled": false,
      "startTime": "07:00",
      "endTime": "17:30",
      "workdaysOnly": false,
      "updatedAt": "2025-10-27T09:00:00Z",
      "updatedBy": "admin"
    },
    "createdAt": "2025-10-01T00:00:00Z",
    "updatedAt": "2025-10-27T09:00:00Z"
  }
}
```

**é…ç½®å­—æ®µè¯´æ˜**:
- `id`: é¢‘é“å”¯ä¸€æ ‡è¯†ç¬¦
- `name`: é¢‘é“æ˜¾ç¤ºåç§°
- `rtmpUrl`: RTMPæ¨æµåœ°å€
- `sortOrder`: æ˜¾ç¤ºæ’åºï¼ˆæ•°å­—è¶Šå°è¶Šé å‰ï¼‰
- `status`: é¢‘é“çŠ¶æ€ï¼ˆactive/inactiveï¼‰
- `preloadConfig`: é¢„åŠ è½½é…ç½®ï¼ˆåµŒå…¥å¼ï¼Œè§ä¸‹èŠ‚ï¼‰
- `createdAt`: åˆ›å»ºæ—¶é—´
- `updatedAt`: æœ€åæ›´æ–°æ—¶é—´

**é…ç½®æµç¨‹**:
1. ç®¡ç†åå°ç¼–è¾‘é¢‘é“é…ç½®ï¼ˆåŸºæœ¬ä¿¡æ¯æˆ–é¢„åŠ è½½é…ç½®ï¼‰
2. ä¿å­˜åˆ°Workers KVï¼ˆå•ä¸€é”®å­˜å‚¨ï¼‰
3. é…ç½®ç«‹å³ç”Ÿæ•ˆ
4. å‰ç«¯ä¸‹æ¬¡åŠ è½½è·å–æ–°é…ç½®

### é¢„åŠ è½½é…ç½®ç®¡ç† â­ å·²æ•´åˆåˆ°é¢‘é“é…ç½®

**å­˜å‚¨æ–¹å¼**: åµŒå…¥åˆ°é¢‘é“é…ç½®ä¸­ï¼ˆ`channel:${channelId}`ï¼‰  
**å­—æ®µåç§°**: `preloadConfig`  
**æ•°æ®ç»“æ„**:
```json
{
  "preloadConfig": {
    "enabled": true,
    "startTime": "07:00",
    "endTime": "17:30",
    "workdaysOnly": true,
    "updatedAt": "2025-10-27T09:00:00Z",
    "updatedBy": "admin"
  }
}
```

**å­—æ®µè¯´æ˜**:
- `enabled`: æ˜¯å¦å¯ç”¨é¢„åŠ è½½ï¼ˆå¸ƒå°”å€¼ï¼‰
- `startTime`: é¢„åŠ è½½å¼€å§‹æ—¶é—´ï¼ˆHH:MMæ ¼å¼ï¼‰
- `endTime`: é¢„åŠ è½½ç»“æŸæ—¶é—´ï¼ˆHH:MMæ ¼å¼ï¼Œå¯è·¨å¤©ï¼‰
- `workdaysOnly`: æ˜¯å¦ä»…å·¥ä½œæ—¥é¢„åŠ è½½ï¼ˆå¸ƒå°”å€¼ï¼‰
- `updatedAt`: é…ç½®æ›´æ–°æ—¶é—´
- `updatedBy`: é…ç½®æ›´æ–°è€…

**é…ç½®æµç¨‹**:
```mermaid
sequenceDiagram
    participant A as ç®¡ç†å‘˜
    participant F as å‰ç«¯
    participant W as Workers
    participant K as KVå­˜å‚¨
    participant V as VPSè°ƒåº¦å™¨
    
    A->>F: ç‚¹å‡»é¢„åŠ è½½é…ç½®
    F->>W: PUT /api/preload/config/:id
    W->>K: è¯»å–é¢‘é“é…ç½® channel:id
    K->>W: è¿”å›ç°æœ‰é…ç½®
    W->>W: æ›´æ–° preloadConfig å­—æ®µ
    W->>K: ä¿å­˜æ›´æ–°åçš„é¢‘é“é…ç½®
    W->>F: è¿”å›æˆåŠŸ
    F->>W: POST /api/preload/reload
    W->>V: é€šçŸ¥VPSé‡è½½é…ç½®
    V->>W: GET /api/preload/configs
    W->>K: éå†æ‰€æœ‰é¢‘é“é…ç½®
    K->>W: è¿”å›æ‰€æœ‰é…ç½®
    W->>V: è¿”å›å¯ç”¨çš„é¢„åŠ è½½é…ç½®åˆ—è¡¨
    V->>V: é‡æ–°åˆ›å»ºå®šæ—¶ä»»åŠ¡
```

**ä¼˜åŒ–è¯´æ˜**:
- âœ… **ç»Ÿä¸€å­˜å‚¨**: é¢‘é“é…ç½®å’Œé¢„åŠ è½½é…ç½®å­˜å‚¨åœ¨åŒä¸€ä¸ªKVé”®ä¸­
- âœ… **å‡å°‘KVæ“ä½œ**: è¯»å–é¢‘é“åˆ—è¡¨æ—¶è‡ªåŠ¨åŒ…å«é¢„åŠ è½½é…ç½®ï¼Œæ— éœ€é¢å¤–æŸ¥è¯¢
- âœ… **æ•°æ®ä¸€è‡´æ€§**: é¢‘é“å’Œé¢„åŠ è½½é…ç½®åŒæ­¥æ›´æ–°ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
- âœ… **ç®€åŒ–æ¶æ„**: ç§»é™¤ç‹¬ç«‹çš„ `PRELOAD_CONFIG:*` é”®ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### ç”Ÿäº§ç¯å¢ƒåŸŸå

| å±‚çº§ | åŸŸå | éƒ¨ç½²å¹³å° | åŠŸèƒ½ |
|------|------|---------|------|
| å‰ç«¯ | `yoyo.5202021.xyz` | Cloudflare Pages | ç”¨æˆ·ç•Œé¢ |
| API | `yoyoapi.5202021.xyz` | Cloudflare Workers | ä¸šåŠ¡é€»è¾‘ |
| VPS | `yoyo-vps.5202021.xyz` | RackNerd VPS | è½¬ç æœåŠ¡ |
| éš§é“ | `tunnel-*.yoyo-vps.5202021.xyz` | Cloudflare Tunnel | ç½‘ç»œä¼˜åŒ– |

### VPSæœåŠ¡å™¨é…ç½®

**æœåŠ¡å™¨ä¿¡æ¯**:
- IP: 142.171.75.220
- OS: CentOS 9
- CPU: 2 vCores
- RAM: 3GB
- å­˜å‚¨: 50GB SSD

**å·²å®‰è£…è½¯ä»¶**:
- Node.js: v18.20.8
- FFmpeg: 5.1.7
- Nginx: 1.20.1
- PM2: 6.0.13
- cloudflared: 2025.9.1

**ç«¯å£é…ç½®**:
```
3000  â†’ Node.js APIæœåŠ¡
52535 â†’ Nginx (HLSæ–‡ä»¶æœåŠ¡)
8080  â†’ File Browser (å†…éƒ¨ç®¡ç†)
```

### éƒ¨ç½²æµç¨‹ï¼ˆä¸€é”®ï¼‰

```bash
# 1. æäº¤ä»£ç åˆ°Git
git push origin master

# 2. éƒ¨ç½²Workers
cd cloudflare-worker
wrangler deploy --env production

# 3. éƒ¨ç½²VPSï¼ˆä¸€é”®è„šæœ¬ï¼‰
ssh root@142.171.75.220 "cd /tmp/github/secure-streaming-platform/vps-transcoder-api && ./vps-simple-deploy.sh"

# 4. å‰ç«¯è‡ªåŠ¨éƒ¨ç½²ï¼ˆCloudflare Pagesè‡ªåŠ¨è§¦å‘ï¼‰
```

### Origin Rulesé…ç½®ï¼ˆé‡è¦ï¼‰

**é—®é¢˜**: Workersä½¿ç”¨æ ‡å‡†443ç«¯å£ï¼Œä½†VPS Nginxç›‘å¬52535ç«¯å£

**è§£å†³**: Cloudflare Origin Rulesè‡ªåŠ¨ç«¯å£æ”¹å†™

```yaml
è§„åˆ™åç§°: yoyo-vps-api
è§¦å‘æ¡ä»¶: ä¸»æœºå = yoyo-vps.5202021.xyz
æ‰§è¡ŒåŠ¨ä½œ: è¦†å†™æºç«¯å£ HTTP/HTTPS = 52535
```

**è¯·æ±‚æµç¨‹**:
```
Workers fetch('https://yoyo-vps.5202021.xyz/...')
    â†“ (é»˜è®¤443ç«¯å£)
Cloudflare Edge (Origin Rules)
    â†“ (è‡ªåŠ¨æ”¹å†™ä¸º52535)
VPS Nginx:52535
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### åŒç»´åº¦è·¯ç”±ä¼˜åŒ–æ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|-------|------|
| HLSè¯·æ±‚å»¶è¿Ÿ | 200-500ms | <100ms | 50%+ |
| è§†é¢‘å¯æ’­æ—¶é—´ | 3-5ç§’ | <2ç§’ | 60%+ |
| æ’­æ”¾æµç•…åº¦ | å¶å°”å¡é¡¿ | æµç•… | æ˜¾è‘—æå‡ |

### Workersä»£ç†æ€§èƒ½

- Workersä»£ç†å±‚å»¶è¿Ÿ: ~10-50ms
- Cloudflareå†…éƒ¨ç½‘ç»œ: é«˜é€Ÿäº’è”
- æ•…éšœè½¬ç§»æ—¶é—´: <100ms

### FFmpegè½¬ç ä¼˜åŒ–

**è½¬ç å‚æ•°**:
```bash
ffmpeg -i rtmp://... \
  -c:v libx264 -preset veryfast \  # å¿«é€Ÿç¼–ç 
  -an \                             # æ— éŸ³é¢‘
  -hls_time 2 \                     # 2ç§’åˆ†ç‰‡
  -hls_list_size 5 \                # ä¿ç•™5ä¸ªåˆ†ç‰‡
  -f hls output.m3u8
```

**æ€§èƒ½ç‰¹ç‚¹**:
- 2ç§’åˆ†ç‰‡ï¼šå¹³è¡¡å»¶è¿Ÿå’Œç¨³å®šæ€§
- æ— éŸ³é¢‘ï¼šå‡å°‘è®¡ç®—è´Ÿè½½ï¼ˆæ ¹æ®éœ€æ±‚ï¼‰
- å¿«é€Ÿé¢„è®¾ï¼šé™ä½CPUä½¿ç”¨ç‡

---

## ğŸ” å®‰å…¨ä¸ç›‘æ§

### è®¤è¯æœºåˆ¶

**ç”¨æˆ·è®¤è¯**:
- æ–¹å¼: åŸºäºCookieçš„ä¼šè¯ç®¡ç†
- å¯†ç : PBKDF2å“ˆå¸Œç®—æ³•
- å­˜å‚¨: Cloudflare KV

**APIè®¤è¯**:
- VPS APIå¯†é’¥è®¤è¯
- Workersç¯å¢ƒå˜é‡ä¿æŠ¤

#### APIå¯†é’¥é…ç½®è¯¦è§£ âš ï¸ é‡è¦

**ç¯å¢ƒå˜é‡å‘½åå·®å¼‚**ï¼š

ç³»ç»Ÿä¸­å­˜åœ¨ä¸¤ä¸ªä¸åŒåç§°çš„ç¯å¢ƒå˜é‡ï¼Œä½†å€¼ç›¸åŒï¼š

1. **VPS æœåŠ¡å™¨ç«¯** (`vps-transcoder-api/.env`)
   ```bash
   API_SECRET_KEY=85da076ae24b028b3d1ea1884e6b13c5afe34b5b
   ```
   - ç”¨é€”ï¼šVPS è®¤è¯ä¸­é—´ä»¶éªŒè¯ `X-API-Key` è¯·æ±‚å¤´
   - ä»£ç ä½ç½®ï¼š`src/middleware/auth.js` (line 76)
   - éªŒè¯é€»è¾‘ï¼š`apiKey !== process.env.API_SECRET_KEY`

2. **Cloudflare Workers** (`cloudflare-worker/wrangler.toml`)
   ```toml
   [env.production.vars]
   VPS_API_KEY = "85da076ae24b028b3d1ea1884e6b13c5afe34b5b"
   ```
   - ç”¨é€”ï¼šWorkers è°ƒç”¨ VPS API æ—¶ä½¿ç”¨
   - ä»£ç ä½¿ç”¨ï¼š`headers: { 'X-API-Key': env.VPS_API_KEY }`

**å…³é”®è¦æ±‚**ï¼š
- âœ… ä¸¤ä¸ªç¯å¢ƒå˜é‡çš„**å€¼å¿…é¡»å®Œå…¨ç›¸åŒ**
- âœ… VPS ç«¯å˜é‡åä¸º `API_SECRET_KEY`
- âœ… Workers ç«¯å˜é‡åä¸º `VPS_API_KEY`
- âŒ ä¸å¯æ··æ·†ä½¿ç”¨å˜é‡å

**å„åŠŸèƒ½ä½¿ç”¨æƒ…å†µ**ï¼š

| åŠŸèƒ½æ¨¡å— | Workersä½¿ç”¨ | VPSéªŒè¯ | çŠ¶æ€ |
|---------|-----------|---------|------|
| é¢‘é“ç¼–è¾‘ | `env.VPS_API_KEY` | `API_SECRET_KEY` | âœ… æ­£å¸¸ |
| è§†é¢‘å½•åˆ¶ | `env.VPS_API_KEY` | `API_SECRET_KEY` | âœ… æ­£å¸¸ |
| æ™ºèƒ½é¢„åŠ è½½ | `env.VPS_API_KEY` | `API_SECRET_KEY` | âœ… æ­£å¸¸ |
| ä»£ç†é…ç½® | `env.VPS_API_KEY` | `API_SECRET_KEY` | âœ… æ­£å¸¸ |
| SimpleStream* | ç¡¬ç¼–ç é”™è¯¯å¯†é’¥ | `API_SECRET_KEY` | âš ï¸ å¾…ä¿®å¤ |

**å·²çŸ¥é—®é¢˜**ï¼š
- `handlers/simple-streams.js` ä½¿ç”¨äº†ç¡¬ç¼–ç çš„é”™è¯¯å¯†é’¥ï¼ˆ64ä½ï¼‰
- åº”ä¿®æ”¹ä¸ºä½¿ç”¨ `env.VPS_API_KEY` ä»¥ä¿æŒä¸€è‡´æ€§

**é…ç½®éªŒè¯**ï¼š
```bash
# VPS ç«¯æ£€æŸ¥
grep "API_SECRET_KEY" /opt/yoyo-transcoder/.env

# Workers ç«¯æ£€æŸ¥ï¼ˆwrangler.tomlï¼‰
grep "VPS_API_KEY" cloudflare-worker/wrangler.toml
```

### ç›‘æ§æŒ‡æ ‡

**ç³»ç»Ÿç›‘æ§**:
- âœ… VPSå¥åº·æ£€æŸ¥: `/health`
- âœ… éš§é“è¿æ¥çŠ¶æ€ç›‘æ§
- âœ… è½¬ç è¿›ç¨‹æ•°é‡ç›‘æ§
- âœ… ä»£ç†è¿æ¥çŠ¶æ€ç›‘æ§

**æ€§èƒ½ç›‘æ§**:
- âœ… HLSè¯·æ±‚å»¶è¿Ÿ
- âœ… è§†é¢‘å¯æ’­æ—¶é—´
- âœ… æ’­æ”¾é”™è¯¯ç‡
- âœ… ç”¨æˆ·å¹¶å‘æ•°

**æ—¥å¿—è®°å½•**:
- ç™»å½•æ—¥å¿—: Cloudflare R2å­˜å‚¨
- æ“ä½œæ—¥å¿—: ç®¡ç†å‘˜æ“ä½œè®°å½•
- é”™è¯¯æ—¥å¿—: PM2æ—¥å¿—æ”¶é›†

---

## ğŸ“Š æ¶æ„æ¼”è¿›å†å²

### V1.0 (2025-10-01)
- âœ… åŸºç¡€ä¸‰å±‚æ¶æ„
- âœ… RTMPåˆ°HLSè½¬ç 
- âœ… ç®€å•çš„éš§é“ä¼˜åŒ–

### V1.5 (2025-10-07)
- âœ… Cloudflare Tunnelé…ç½®ä¿®å¤
- âœ… æ™ºèƒ½æ•…éšœè½¬ç§»
- âœ… å‰ç«¯çŠ¶æ€æ˜¾ç¤º

### V2.0 (2025-10-24)
- âœ… **åŒç»´åº¦è·¯ç”±æ¶æ„**
- âœ… **Workersä»£ç†è§£å†³SSLé—®é¢˜**
- âœ… **å‰åç«¯è·¯å¾„ç‹¬ç«‹ä¼˜åŒ–**
- âœ… **åŒç»´åº¦å¯è§†åŒ–æ˜¾ç¤º**
- âœ… **å®Œæ•´çš„æ•…éšœè½¬ç§»æœºåˆ¶**

### V2.1 (2025-10-27)
- âœ… **æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿ**
- âœ… **PreloadSchedulerå®šæ—¶è°ƒåº¦å™¨**
- âœ… **PreloadHealthCheckå¥åº·æ£€æŸ¥**
- âœ… **å‰ç«¯é¢„åŠ è½½é…ç½®ç®¡ç†ç•Œé¢**
- âœ… **é›¶å»¶è¿Ÿæ’­æ”¾ä½“éªŒï¼ˆé¢„åŠ è½½æ—¶æ®µï¼‰**

### V2.2 (2025-10-27)
- âœ… **å·¥ä½œæ—¥é¢„åŠ è½½åŠŸèƒ½**
- âœ… **WorkdayCheckerå·¥ä½œæ—¥æ£€æµ‹å™¨**
- âœ… **ä»…å·¥ä½œæ—¥å¼€å…³ï¼ˆworkdaysOnlyï¼‰**
- âœ… **æ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘è¯†åˆ«**
- âœ… **å·¥ä½œæ—¥çŠ¶æ€å®æ—¶æ˜¾ç¤º**
- âœ… **æ™ºèƒ½é™çº§å’Œå¤±è´¥é‡è¯•æœºåˆ¶**

### V2.3 (2025-10-27)
- âœ… **KVå­˜å‚¨ç»“æ„ä¼˜åŒ–**
- âœ… **é¢‘é“é…ç½®ä¸é¢„åŠ è½½é…ç½®åˆå¹¶**
- âœ… **å‡å°‘KVè¯»å†™æ“ä½œ**
- âœ… **æå‡æ•°æ®ä¸€è‡´æ€§**

### V2.4 (2025-10-28) â­ å½“å‰ç‰ˆæœ¬
- âœ… **é¢‘é“å®šæ—¶å½•åˆ¶åŠŸèƒ½** â­â­
- âœ… **RecordSchedulerå½•åˆ¶è°ƒåº¦å™¨**
- âœ… **ä¸€è¿›ç¨‹åŒè¾“å‡ºï¼ˆHLS+MP4åŒæ—¶ç”Ÿæˆï¼‰**
- âœ… **æ··åˆæ–‡ä»¶å‘½åæ–¹æ¡ˆï¼ˆchannelName + channelIdï¼‰**
- âœ… **å·¥ä½œæ—¥å½•åˆ¶æ”¯æŒ**
- âœ… **ChannelConfigDialogç»Ÿä¸€é…ç½®ç•Œé¢**
- âœ… **å½•åˆ¶é…ç½®APIï¼ˆWorkers + VPSï¼‰**
- âœ… **è‡ªåŠ¨ç›®å½•åˆ›å»ºå’Œçƒ­é‡è½½**

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

### æ ¸å¿ƒæ–‡æ¡£
- **æœ¬æ–‡æ¡£**: `doc/ARCHITECTURE_V2.md` - ç²¾ç®€æ¶æ„æ–‡æ¡£
- **è¯¦ç»†æ¶æ„**: `doc/DUAL_DIMENSION_ROUTING_ARCHITECTURE.md` - åŒç»´åº¦è·¯ç”±è¯¦ç»†å®ç°
- **é¢„åŠ è½½æ–¹æ¡ˆ**: `doc/PRELOAD_IMPLEMENTATION_STAGED.md` - æ™ºèƒ½é¢„åŠ è½½é˜¶æ®µå®æ–½æ–‡æ¡£
- **å·¥ä½œæ—¥é¢„åŠ è½½**: `doc/WORKDAY_PRELOAD_IMPLEMENTATION.md` - å·¥ä½œæ—¥é¢„åŠ è½½å®æ–½æ–¹æ¡ˆ
- **å½•åˆ¶æ–¹æ¡ˆ**: `doc/RECORDING_IMPLEMENTATION_STAGED.md` - é¢‘é“å®šæ—¶å½•åˆ¶é˜¶æ®µå®æ–½æ–‡æ¡£ â­
- **å®æ–½è®°å½•**: `DUAL_DIMENSION_ROUTING_FIX_STAGED.md` - é˜¶æ®µå®æ–½è®°å½•

### å†å²æ–‡æ¡£
- **æ—§ç‰ˆæ¶æ„**: `doc/YOYO_PLATFORM_ARCHITECTURE.md` - å®Œæ•´è¯¦ç»†ç‰ˆï¼ˆ4000+è¡Œï¼‰

### æŠ€æœ¯æ–‡æ¡£
- **Workersä»£ç **: `cloudflare-worker/src/` - ä¸šåŠ¡é€»è¾‘å®ç°
- **VPSä»£ç **: `src/` - è½¬ç æœåŠ¡å®ç°
- **å‰ç«¯ä»£ç **: `frontend/src/` - ç”¨æˆ·ç•Œé¢å®ç°

---

## ğŸ¯ å¿«é€Ÿå¯¼èˆª

### æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥

| æ¦‚å¿µ | è¯´æ˜ | æ–‡æ¡£ä½ç½® |
|------|------|---------|
| åŒç»´åº¦è·¯ç”± | å‰åç«¯è·¯å¾„ç‹¬ç«‹ä¼˜åŒ– | æœ¬æ–‡æ¡£ + DUAL_DIMENSION_ROUTING_ARCHITECTURE.md |
| Workersä»£ç† | è§£å†³éš§é“SSLé—®é¢˜ | æœ¬æ–‡æ¡£ "Workersä»£ç†æ–¹æ¡ˆ" |
| æ™ºèƒ½é¢„åŠ è½½ | å®šæ—¶é¢„åŠ è½½ï¼Œé›¶å»¶è¿Ÿæ’­æ”¾ | æœ¬æ–‡æ¡£ "æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿ" + PRELOAD_IMPLEMENTATION_STAGED.md |
| é¢‘é“å®šæ—¶å½•åˆ¶ | å®šæ—¶å½•åˆ¶è§†é¢‘æ–‡ä»¶ | æœ¬æ–‡æ¡£ "é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿ" + RECORDING_IMPLEMENTATION_STAGED.md |
| è§†é¢‘æ–‡ä»¶æ¸…ç† | è‡ªåŠ¨æ¸…ç†è¿‡æœŸå½•åˆ¶æ–‡ä»¶ | æœ¬æ–‡æ¡£ "è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿ" + VIDEO_CLEANUP_IMPLEMENTATION.md |
| SimpleStreamManager | è½¬ç è¿›ç¨‹ç®¡ç† | æœ¬æ–‡æ¡£ "æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶" |
| RecordScheduler | å½•åˆ¶è°ƒåº¦å™¨ | æœ¬æ–‡æ¡£ "é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿ" |
| VideoCleanupScheduler | æ¸…ç†è°ƒåº¦å™¨ | æœ¬æ–‡æ¡£ "è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿ" |
| è·¯ç”±å†³ç­–å¼•æ“ | TunnelRouterå®ç° | DUAL_DIMENSION_ROUTING_ARCHITECTURE.md |
| éƒ¨ç½²æµç¨‹ | ä¸€é”®éƒ¨ç½²å‘½ä»¤ | æœ¬æ–‡æ¡£ "éƒ¨ç½²æ¶æ„" |

### å¸¸è§é—®é¢˜

**Q: å¦‚ä½•åˆ‡æ¢éš§é“æ¨¡å¼ï¼Ÿ**  
A: ç®¡ç†åå° â†’ éš§é“ä¼˜åŒ– â†’ ä¸€é”®å¼€å…³

**Q: å¦‚ä½•æŸ¥çœ‹è·¯ç”±çŠ¶æ€ï¼Ÿ**  
A: è§†é¢‘æ’­æ”¾ç•Œé¢æ˜¾ç¤ºåŒç»´åº¦æ ‡ç­¾

**Q: Workersä»£ç†ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ**  
A: å½±å“å¾ˆå°ï¼ˆ~10-50msï¼‰ï¼Œä¸”æœ‰æ•…éšœè½¬ç§»

**Q: å¦‚ä½•é…ç½®é¢‘é“é¢„åŠ è½½ï¼Ÿ**  
A: ç®¡ç†åå° â†’ é¢‘é“åˆ—è¡¨ â†’ ç‚¹å‡»"é¢„åŠ è½½"æŒ‰é’® â†’ è®¾ç½®å¼€å§‹/ç»“æŸæ—¶é—´ â†’ å¯é€‰å¯ç”¨"ä»…å·¥ä½œæ—¥"

**Q: é¢„åŠ è½½èƒ½èŠ‚çœå¤šå°‘èµ„æºï¼Ÿ**  
A: ä»…åœ¨é…ç½®æ—¶æ®µè¿è¡Œï¼Œç›¸æ¯”å…¨å¤©è¿è¡ŒèŠ‚çœçº¦70-80%èµ„æºã€‚å¯ç”¨"ä»…å·¥ä½œæ—¥"åï¼Œå‘¨æœ«å’ŒèŠ‚å‡æ—¥è‡ªåŠ¨è·³è¿‡ï¼Œè¿›ä¸€æ­¥èŠ‚çœçº¦30%èµ„æº

**Q: å·¥ä½œæ—¥é¢„åŠ è½½å¦‚ä½•è¯†åˆ«èŠ‚å‡æ—¥ï¼Ÿ** â­  
A: ä½¿ç”¨Timor APIè·å–å®˜æ–¹èŠ‚å‡æ—¥æ•°æ®ï¼Œè‡ªåŠ¨è¯†åˆ«æ³•å®šèŠ‚å‡æ—¥ã€è°ƒä¼‘å·¥ä½œæ—¥ã€‚APIå¤±è´¥æ—¶é™çº§ä¸ºåŸºç¡€æ¨¡å¼ï¼ˆå‘¨ä¸€è‡³å‘¨äº”ï¼‰

**Q: å·¥ä½œæ—¥æ•°æ®ä»å“ªé‡Œæ¥ï¼Ÿ**  
A: VPSå¯åŠ¨æ—¶è‡ªåŠ¨é¢„å–å½“å‰æœˆ+ä¸‹æœˆæ•°æ®ï¼Œæ¯æœˆ25å·é¢„å–ä¸‹æœˆæ•°æ®ã€‚å¤±è´¥çš„æœˆä»½ä¼šæ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨é‡è¯•

**Q: å¦‚æœå·¥ä½œæ—¥APIè°ƒç”¨å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**  
A: ç³»ç»Ÿæœ‰å®Œå–„çš„é™çº§æœºåˆ¶ï¼šAPIå¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºåŸºç¡€æ¨¡å¼ï¼ˆå‘¨ä¸€è‡³å‘¨äº”=å·¥ä½œæ—¥ï¼‰ï¼Œä¸å½±å“é¢„åŠ è½½æœåŠ¡

**Q: å¦‚ä½•é…ç½®é¢‘é“å½•åˆ¶ï¼Ÿ** â­  
A: ç®¡ç†åå° â†’ é¢‘é“åˆ—è¡¨ â†’ ç‚¹å‡»"è®¾ç½®"æŒ‰é’® â†’ å½•åˆ¶é…ç½®åŒºåŸŸ â†’ è®¾ç½®å¼€å§‹/ç»“æŸæ—¶é—´ã€å­˜å‚¨è·¯å¾„ â†’ å¯é€‰å¯ç”¨"ä»…å·¥ä½œæ—¥"

**Q: å½•åˆ¶æ–‡ä»¶å¦‚ä½•å‘½åï¼Ÿ**  
A: ä½¿ç”¨æ··åˆå‘½åæ–¹æ¡ˆï¼š`{é¢‘é“åç§°}_{é¢‘é“ID}_{æ—¥æœŸ}_{å¼€å§‹æ—¶é—´}_to_{ç»“æŸæ—¶é—´}.mp4`ï¼Œä¾‹å¦‚ï¼š`äºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251028_074000_to_172500.mp4`

**Q: å½•åˆ¶ä¼šå½±å“è§‚çœ‹å—ï¼Ÿ**  
A: ä¸ä¼šã€‚ç³»ç»Ÿä½¿ç”¨ä¸€ä¸ªFFmpegè¿›ç¨‹åŒæ—¶è¾“å‡ºHLSï¼ˆè§‚çœ‹ï¼‰å’ŒMP4ï¼ˆå½•åˆ¶ï¼‰ï¼Œèµ„æºå ç”¨minimal

**Q: å¦‚ä½•éƒ¨ç½²æœ€æ–°ä»£ç ï¼Ÿ**  
A: ä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆè§"éƒ¨ç½²æ¶æ„"ç« èŠ‚ï¼‰

---

## ğŸ”„ ç»´æŠ¤è¯´æ˜

### æ–‡æ¡£æ›´æ–°åŸåˆ™

1. **ä¿æŒç²¾ç®€**: åªè®°å½•æ ¸å¿ƒæ¶æ„å’Œå…³é”®ä¿¡æ¯
2. **ä»£ç å¼•ç”¨**: é¿å…å¤§æ®µä»£ç ï¼Œæ”¹ç”¨æ–‡ä»¶å¼•ç”¨
3. **å›¾ç¤ºä¼˜å…ˆ**: ç”¨æµç¨‹å›¾å’Œæ¶æ„å›¾ä»£æ›¿æ–‡å­—æè¿°
4. **ç‰ˆæœ¬æ ‡è®°**: é‡è¦å˜æ›´æ ‡æ³¨ç‰ˆæœ¬å’Œæ—¥æœŸ

### æ›´æ–°é¢‘ç‡

- **æ¶æ„å˜æ›´**: ç«‹å³æ›´æ–°
- **åŠŸèƒ½æ–°å¢**: åŠæ—¶è¡¥å……
- **ä¼˜åŒ–è°ƒæ•´**: å®šæœŸæ•´ç†
- **ç‰ˆæœ¬å‘å¸ƒ**: åˆ›å»ºå¿«ç…§

---

## ğŸ“ ç‰ˆæœ¬å†å²

### V2.6 (2025-10-29)
**é¢‘é“/ç”¨æˆ·ç´¢å¼•ç³»ç»Ÿä¸Šçº¿ - è§£å†³KV listæ“ä½œé™åˆ¶**

**é—®é¢˜æè¿°**:
- âŒ Cloudflare KVå…è´¹ç‰ˆé™åˆ¶listæ“ä½œ100æ¬¡/å¤©
- âŒ é¢„åŠ è½½è°ƒåº¦å™¨ã€è§†é¢‘æ¸…ç†ã€ç”¨æˆ·ç®¡ç†é¢‘ç¹è°ƒç”¨listå¯¼è‡´è¶…é™
- âŒ è¶…é™ååŠŸèƒ½å¤±æ•ˆï¼ˆé¢„åŠ è½½æ— æ³•å¯åŠ¨ã€ç”¨æˆ·åˆ—è¡¨æ— æ³•åŠ è½½ï¼‰

**æ ¸å¿ƒæ”¹è¿›**:
- âœ… **é¢‘é“ç´¢å¼•ç³»ç»Ÿ**: `system:channel_index` å­˜å‚¨æ‰€æœ‰é¢‘é“ID
- âœ… **ç”¨æˆ·ç´¢å¼•ç³»ç»Ÿ**: `system:user_index` å­˜å‚¨æ‰€æœ‰ç”¨æˆ·å
- âœ… **è‡ªåŠ¨ç»´æŠ¤**: åˆ›å»º/åˆ é™¤æ—¶è‡ªåŠ¨æ›´æ–°ç´¢å¼•
- âœ… **é™çº§å®¹é”™**: ç´¢å¼•ä¸¢å¤±æ—¶ä½¿ç”¨listè‡ªåŠ¨é‡å»ºï¼ˆä»…é¦–æ¬¡ï¼‰

**æŠ€æœ¯å®ç°**:
- âœ… preloadHandlerä½¿ç”¨ç´¢å¼•ä»£æ›¿list
- âœ… GET /api/admin/streamsä½¿ç”¨ç´¢å¼•ä»£æ›¿CHANNELSç¡¬ç¼–ç 
- âœ… POST /api/admin/streams - åˆ›å»ºé¢‘é“å¹¶ç»´æŠ¤ç´¢å¼•
- âœ… DELETE /api/admin/streams/:id - åˆ é™¤é¢‘é“å¹¶ç»´æŠ¤ç´¢å¼•
- âœ… GET /api/admin/usersä½¿ç”¨ç´¢å¼•ï¼ˆè§£å†³ç”¨æˆ·åˆ—è¡¨åŠ è½½å¤±è´¥ï¼‰

**æ€§èƒ½æå‡**:
- ğŸ“ˆ èµ„æºæ¶ˆè€—ï¼š1æ¬¡list â†’ N+1æ¬¡get
- ğŸ“ˆ æ¯æ—¥é¢åº¦ï¼š100æ¬¡/å¤© â†’ 100,000æ¬¡/å¤©ï¼ˆæå‡1000å€ï¼‰
- ğŸ“ˆ å®é™…æ¶ˆè€—ï¼š<100æ¬¡get/å¤©ï¼ˆå‰©ä½™99.9%é¢åº¦ï¼‰

**å½±å“åŠŸèƒ½**:
- âœ… é¢„åŠ è½½ç³»ç»Ÿï¼šVPSé‡å¯æ­£å¸¸è·å–é…ç½®
- âœ… è§†é¢‘æ¸…ç†ï¼šå®šæ—¶ä»»åŠ¡æ­£å¸¸è·å–é¢‘é“åˆ—è¡¨
- âœ… ç”¨æˆ·ç®¡ç†ï¼šç”¨æˆ·åˆ—è¡¨æ­£å¸¸åŠ è½½ï¼ˆ3ä¸ªç”¨æˆ·ï¼‰
- âœ… é¢‘é“ç®¡ç†ï¼šæ”¯æŒåŠ¨æ€åˆ›å»º/åˆ é™¤ï¼ˆæ— éœ€ä¿®æ”¹ä»£ç ï¼‰

### V2.5 (2025-10-28)
**è§†é¢‘æ–‡ä»¶æ¸…ç†ç³»ç»Ÿä¸Šçº¿**

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… VideoCleanupScheduler å®šæ—¶æ¸…ç†è°ƒåº¦å™¨
- âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸå½•åˆ¶æ–‡ä»¶ï¼ˆé»˜è®¤ä¿ç•™2å¤©ï¼‰
- âœ… ä¸¥æ ¼çš„æ—¥æœŸæ ¼å¼éªŒè¯æœºåˆ¶
- âœ… å‰ç«¯å¯è§†åŒ–é…ç½®ç•Œé¢ï¼ˆSystemSettingsDialogï¼‰

**æŠ€æœ¯äº®ç‚¹**:
- âœ… æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨æ‰§è¡Œæ¸…ç†
- âœ… æ‰‹åŠ¨æ¸…ç†åŠŸèƒ½ï¼ˆå‰ç«¯ä¸€é”®è§¦å‘ï¼‰
- âœ… é¢‘é“éš”ç¦»ï¼ˆå•é¢‘é“å¤±è´¥ä¸å½±å“å…¶ä»–ï¼‰
- âœ… APIè®¤è¯ä¿æŠ¤ï¼ˆVPS API Keyï¼‰
- âœ… è¯¦ç»†çš„æ¸…ç†æ—¥å¿—å’Œç»Ÿè®¡

**APIç«¯ç‚¹**:
- `GET /api/admin/cleanup/config` - è·å–æ¸…ç†é…ç½®
- `PUT /api/admin/cleanup/config` - æ›´æ–°æ¸…ç†é…ç½®
- `POST /api/admin/cleanup/trigger` - æ‰‹åŠ¨è§¦å‘æ¸…ç†
- `POST /api/admin/cleanup/execute` - VPSæ‰§è¡Œæ¸…ç†

### V2.4 (2025-10-28)
**é¢‘é“å®šæ—¶å½•åˆ¶ç³»ç»Ÿä¸Šçº¿**

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… RecordScheduler å½•åˆ¶è°ƒåº¦å™¨
- âœ… åŸºäºnode-cronçš„å®šæ—¶ä»»åŠ¡ç®¡ç†
- âœ… å·¥ä½œæ—¥æ”¯æŒï¼ˆå¤ç”¨WorkdayCheckerï¼‰
- âœ… ä¸€è¿›ç¨‹åŒè¾“å‡ºï¼ˆHLS+MP4ï¼‰

**æŠ€æœ¯å®ç°**:
- âœ… SimpleStreamManager æ‰©å±•å½•åˆ¶èƒ½åŠ›
- âœ… FFmpeg è¿›ç¨‹å¤ç”¨ï¼ˆè§‚çœ‹+å½•åˆ¶ï¼‰
- âœ… å½•åˆ¶è¿›ç¨‹ä¸å—å¿ƒè·³æ¸…ç†å½±å“
- âœ… å¯åŠ¨è‡ªåŠ¨æ¢å¤å½“å‰æ—¶æ®µå½•åˆ¶

**é…ç½®ç®¡ç†**:
- âœ… KVå­˜å‚¨ recordConfig å­—æ®µ
- âœ… å‰ç«¯ChannelConfigDialogç»Ÿä¸€é…ç½®
- âœ… é…ç½®çƒ­é‡è½½æ— éœ€é‡å¯

### V2.3 (2025-10-27)
**KVå­˜å‚¨ç»“æ„ä¼˜åŒ– - é¢‘é“é…ç½®ä¸é¢„åŠ è½½é…ç½®åˆå¹¶**

**æ ¸å¿ƒå˜æ›´**:
- âœ… å°†ç‹¬ç«‹çš„ `PRELOAD_CONFIG:${channelId}` é”®åˆå¹¶åˆ° `channel:${channelId}` é…ç½®ä¸­
- âœ… é¢„åŠ è½½é…ç½®ä½œä¸º `preloadConfig` å­—æ®µåµŒå…¥åˆ°é¢‘é“é…ç½®
- âœ… ç»Ÿä¸€å­˜å‚¨ç»“æ„ï¼Œå‡å°‘KVè¯»å†™æ“ä½œ
- âœ… æå‡æ•°æ®ä¸€è‡´æ€§ï¼Œç®€åŒ–ç³»ç»Ÿæ¶æ„

**APIå˜æ›´**:
- ğŸ”„ `PUT /api/preload/config/:channelId` - ç°åœ¨æ›´æ–°é¢‘é“é…ç½®ä¸­çš„ `preloadConfig` å­—æ®µ
- ğŸ”„ `GET /api/preload/config/:channelId` - ä»é¢‘é“é…ç½®ä¸­è¯»å– `preloadConfig` å­—æ®µ
- ğŸ”„ `GET /api/preload/configs` - éå†æ‰€æœ‰é¢‘é“é…ç½®ï¼Œè¿”å›å¯ç”¨çš„é¢„åŠ è½½é…ç½®åˆ—è¡¨

**ä¼˜åŠ¿**:
- ğŸ“‰ å‡å°‘KVæ“ä½œï¼šè¯»å–é¢‘é“åˆ—è¡¨æ—¶è‡ªåŠ¨åŒ…å«é¢„åŠ è½½é…ç½®
- ğŸ”„ æ•°æ®ä¸€è‡´æ€§ï¼šé¢‘é“å’Œé¢„åŠ è½½é…ç½®åŒæ­¥æ›´æ–°
- ğŸ¯ æ¶æ„ç®€åŒ–ï¼šç§»é™¤ç‹¬ç«‹çš„é¢„åŠ è½½é…ç½®é”®ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦

### V2.2 (2025-10-27)
**æ–°å¢å·¥ä½œæ—¥é¢„åŠ è½½åŠŸèƒ½**
- âœ… WorkdayCheckerå·¥ä½œæ—¥æ£€æµ‹å™¨
- âœ… æ”¯æŒæ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘è¯†åˆ«
- âœ… æ™ºèƒ½ç¼“å­˜å’Œå¤±è´¥é‡è¯•æœºåˆ¶
- âœ… å®¹é”™é™çº§æ¨¡å¼

### V2.1 (2025-10-26)
**æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿä¸Šçº¿**
- âœ… PreloadScheduleré¢„åŠ è½½è°ƒåº¦å™¨
- âœ… å®šæ—¶ä»»åŠ¡ç®¡ç†
- âœ… è¿›ç¨‹å¥åº·æ£€æŸ¥
- âœ… VPSé€šçŸ¥å’Œé…ç½®é‡è½½

### V2.0 (2025-10-01)
**åŒç»´åº¦è·¯ç”±ä¼˜åŒ–å®Œæˆ**
- âœ… å‰åç«¯è·¯å¾„ç‹¬ç«‹ä¼˜åŒ–
- âœ… Workersä»£ç†æ–¹æ¡ˆ
- âœ… è·¯ç”±å†³ç­–å¼•æ“
- âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

---

**æ–‡æ¡£ç»´æŠ¤è€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2025-10-28 23:10 (UTC+8)  
**æ–‡æ¡£çŠ¶æ€**: âœ… V2.5 - é¢‘é“å®šæ—¶å½•åˆ¶ä¸è§†é¢‘æ¸…ç†ç³»ç»Ÿä¸Šçº¿
