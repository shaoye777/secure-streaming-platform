# YOYOæµåª’ä½“å¹³å°æ¶æ„æ–‡æ¡£ V2.3

> **ç²¾ç®€æ¶æ„æ–‡æ¡£** - ä¸“æ³¨äºæ ¸å¿ƒæ¶æ„è®¾è®¡å’Œå…³é”®æŠ€æœ¯å®ç°  
> **æ›´æ–°æ—¶é—´**: 2025-10-27  
> **æ–‡æ¡£ç‰ˆæœ¬**: V2.3 - KVå­˜å‚¨ç»“æ„ä¼˜åŒ–ï¼ˆé¢‘é“é…ç½®ä¸é¢„åŠ è½½é…ç½®åˆå¹¶ï¼‰

---

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#-é¡¹ç›®æ¦‚è¿°)
- [ç³»ç»Ÿæ¶æ„](#-ç³»ç»Ÿæ¶æ„)
- [åŒç»´åº¦è·¯ç”±ä¼˜åŒ–](#-åŒç»´åº¦è·¯ç”±ä¼˜åŒ–æ ¸å¿ƒ)
- [æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶](#-æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶)
- [æ•°æ®æµè½¬æœºåˆ¶](#-æ•°æ®æµè½¬æœºåˆ¶)
- [éƒ¨ç½²æ¶æ„](#-éƒ¨ç½²æ¶æ„)
- [æ€§èƒ½ä¼˜åŒ–](#-æ€§èƒ½ä¼˜åŒ–)
- [å®‰å…¨ä¸ç›‘æ§](#-å®‰å…¨ä¸ç›‘æ§)
- [ç‰ˆæœ¬å†å²](#-ç‰ˆæœ¬å†å²)

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

**YOYOæµåª’ä½“å¹³å°**æ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„å®‰å…¨æµåª’ä½“Webæ’­æ”¾å¹³å°ï¼Œé‡‡ç”¨ä¸‰å±‚æ¶æ„è®¾è®¡ã€‚

### æ ¸å¿ƒå®šä½

- **ç›®æ ‡**: å¤šç”¨æˆ·ã€å¤šé¢‘é“çš„å®æ—¶è§†é¢‘æµæ’­æ”¾
- **ç‰¹è‰²**: åŒç»´åº¦è·¯ç”±ä¼˜åŒ–ï¼Œæ™ºèƒ½ç½‘ç»œè°ƒåº¦ï¼Œæ™ºèƒ½é¢„åŠ è½½
- **éƒ¨ç½²**: ç”Ÿäº§ç¯å¢ƒè¿è¡Œä¸­ï¼ˆ2025-10-01ä¸Šçº¿ï¼‰

### æŠ€æœ¯æ ˆæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯å±‚: Vue 3 + Element Plus + hls.js              â”‚
â”‚  åŸŸå: https://yoyo.5202021.xyz                     â”‚
â”‚  éƒ¨ç½²: Cloudflare Pages                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡å±‚: Cloudflare Workers                         â”‚
â”‚  åŸŸå: https://yoyoapi.5202021.xyz                  â”‚
â”‚  åŠŸèƒ½: APIæœåŠ¡ã€è·¯ç”±å†³ç­–ã€ç”¨æˆ·è®¤è¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è½¬ç å±‚: Node.js + FFmpeg (VPS)                     â”‚
â”‚  åŸŸå: https://yoyo-vps.5202021.xyz                 â”‚
â”‚  åŠŸèƒ½: RTMPè½¬HLSã€è¿›ç¨‹ç®¡ç†ã€ä»£ç†æœåŠ¡                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### ä¸‰å±‚æ¶æ„è®¾è®¡

#### 1. å‰ç«¯åº”ç”¨å±‚

**æŠ€æœ¯æ ˆ**: Vue.js 3 + Element Plus + hls.js  
**éƒ¨ç½²**: Cloudflare Pages  
**åŸŸå**: `https://yoyo.5202021.xyz`

**æ ¸å¿ƒåŠŸèƒ½**:
- è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶ï¼ˆåŸºäºhls.jsï¼‰
- é¢‘é“åˆ—è¡¨ç®¡ç†
- ç”¨æˆ·è®¤è¯ç•Œé¢
- **åŒç»´åº¦è·¯ç”±çŠ¶æ€æ˜¾ç¤º** â­

**å…³é”®å®ç°**:
```javascript
// stores/streams.js - åŒç»´åº¦è·¯ç”±çŠ¶æ€ç®¡ç†
currentStream = {
  hlsUrl: 'æ’­æ”¾URL',
  routingMode: 'tunnel+direct',     // åŒç»´åº¦ç»„åˆ
  frontendPath: 'tunnel',           // å‰ç«¯è·¯å¾„
  backendPath: 'direct',            // åç«¯è·¯å¾„
  routingReason: 'è·¯ç”±å†³ç­–åŸå› '
}
```

#### 2. ä¸šåŠ¡é€»è¾‘å±‚ (Cloudflare Workers)

**åŸŸå**: `https://yoyoapi.5202021.xyz`  
**æŠ€æœ¯**: Cloudflare Workers + KVå­˜å‚¨

**æ ¸å¿ƒåŠŸèƒ½**:
- APIæœåŠ¡å’Œè¯·æ±‚è·¯ç”±
- **åŒç»´åº¦è·¯ç”±å†³ç­–** â­
- ç”¨æˆ·è®¤è¯å’Œä¼šè¯ç®¡ç†
- é¢‘é“é…ç½®ç®¡ç†
- **Workersä»£ç†ï¼ˆè§£å†³éš§é“SSLï¼‰** â­
- **é¢‘é“é¢„åŠ è½½é…ç½®ç®¡ç†** â­

**è·¯ç”±å†³ç­–å¼•æ“**:
```javascript
// utils/tunnel-router.js
class TunnelRouter {
  static async determineRoutingPath(env, request) {
    // 1. åˆ¤æ–­å‰ç«¯è·¯å¾„ (Workers â†’ VPS)
    const frontendPath = await this.determineFrontendPath(env);
    
    // 2. åˆ¤æ–­åç«¯è·¯å¾„ (VPS â†’ RTMP)
    const backendPath = await this.determineBackendPath(env);
    
    // 3. è¿”å›åŒç»´åº¦è·¯ç”±ä¿¡æ¯
    return {
      routingMode: `${frontendPath.mode}+${backendPath.mode}`,
      frontendPath, 
      backendPath
    };
  }
}
```

**Workersä»£ç†** (è§£å†³éš§é“SSLé—®é¢˜):
```javascript
// index.js - éš§é“ä»£ç†è·¯ç”±
router.get('/tunnel-proxy/hls/:streamId/:file', async (req, env) => {
  // Workerså†…éƒ¨ä»£ç†åˆ°tunnel-hlsç«¯ç‚¹
  const tunnelUrl = `https://tunnel-hls.yoyo-vps.5202021.xyz/hls/...`;
  const response = await fetch(tunnelUrl);
  
  // æ·»åŠ ä»£ç†æ ‡è¯†
  headers.set('X-Proxied-By', 'Workers-Tunnel-Proxy');
  return new Response(response.body, { headers });
});
```

#### 3. è½¬ç æœåŠ¡å±‚ (VPS)

**åŸŸå**: `https://yoyo-vps.5202021.xyz`  
**æœåŠ¡å™¨**: 142.171.75.220 (RackNerd VPS)  
**æŠ€æœ¯æ ˆ**: Node.js + Express + FFmpeg + Nginx + PM2

**æ ¸å¿ƒåŠŸèƒ½**:
- RTMPåˆ°HLSå®æ—¶è½¬ç 
- æŒ‰éœ€å¯åŠ¨è½¬ç è¿›ç¨‹
- å¤šç”¨æˆ·å…±äº«è½¬ç è¿›ç¨‹
- ç©ºé—²æµè‡ªåŠ¨æ¸…ç†
- **æ™ºèƒ½é¢„åŠ è½½è°ƒåº¦** â­
- **V2Ray/Xrayä»£ç†æœåŠ¡** â­

**è½¬ç ç®¡ç†å™¨**:
```javascript
// services/SimpleStreamManager.js
class SimpleStreamManager {
  // æŒ‰é¢‘é“ç®¡ç†è½¬ç è¿›ç¨‹
  activeStreams = new Map();  // channelId -> processInfo
  
  async startWatching(channelId) {
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰è½¬ç è¿›ç¨‹
    if (this.activeStreams.has(channelId)) {
      return existingProcess;
    }
    
    // å¯åŠ¨æ–°çš„FFmpegè½¬ç è¿›ç¨‹
    return await this.startNewStream(channelId, rtmpUrl);
  }
}
```

---

## ğŸŒ åŒç»´åº¦è·¯ç”±ä¼˜åŒ–ï¼ˆæ ¸å¿ƒï¼‰

> **æœ€æ–°æ¶æ„** (2025-10-24å®æ–½å®Œæˆ)

### è®¾è®¡ç†å¿µ

**åŒç»´åº¦è·¯ç”±**å°†è§†é¢‘æµä¼ è¾“è·¯å¾„æ‹†åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹ç»´åº¦ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å‰ç«¯è·¯å¾„ç»´åº¦                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Workers  â”‚ â”€â”€â”€â”€â”€â–¶  â”‚   VPS    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚     â”‚                                                â”‚
â”‚     â”œâ”€ tunnel  (Cloudflare Tunneléš§é“)              â”‚
â”‚     â””â”€ direct  (ç›´æ¥è¿æ¥)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åç«¯è·¯å¾„ç»´åº¦                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   VPS    â”‚ â”€â”€â”€â”€â”€â–¶  â”‚ RTMPæº   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚     â”‚                                                â”‚
â”‚     â”œâ”€ proxy   (V2Ray/Xrayä»£ç†) âš ï¸ æš‚æœªå®ç°å®Œæ•´      â”‚
â”‚     â””â”€ direct  (ç›´æ¥è¿æ¥)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å››ç§è·¯ç”±ç»„åˆ

| è·¯ç”±æ¨¡å¼ | å‰ç«¯è·¯å¾„ | åç«¯è·¯å¾„ | ä½¿ç”¨åœºæ™¯ | ä¼˜åŠ¿ |
|---------|---------|---------|---------|------|
| `tunnel+direct` | tunnel | direct | ä¸­å›½ç”¨æˆ·è®¿é—®å›½å†…RTMP | å‰ç«¯ä¼˜åŒ– |
| `tunnel+proxy` | tunnel | proxy | ä¸­å›½ç”¨æˆ·è®¿é—®å›½å¤–RTMP | åŒé‡ä¼˜åŒ– âš ï¸ |  
| `direct+direct` | direct | direct | æµ·å¤–ç”¨æˆ·è®¿é—®å›½å†…RTMP | æ— ä¼˜åŒ– |  
| `direct+proxy` | direct | proxy | æµ·å¤–ç”¨æˆ·è®¿é—®å›½å¤–RTMP | åç«¯ä¼˜åŒ– âš ï¸ |

> âš ï¸ **æ³¨æ„**: ä»£ç†æ¨¡å¼ï¼ˆproxyï¼‰ä¸‹VPSåˆ°RTMPæºçš„è¿æ¥æš‚æœªå®ç°å®Œæ•´ï¼Œä»£ç†çŠ¶æ€æ£€æµ‹å·²å®ç°ä½†FFmpegé€šè¿‡ä»£ç†è®¿é—®RTMPçš„åŠŸèƒ½ä»åœ¨å¼€å‘ä¸­ã€‚

### è·¯ç”±å†³ç­–æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚æ’­æ”¾] --> B[Workersæ¥æ”¶è¯·æ±‚]
    B --> C{æ£€æµ‹éš§é“å¼€å…³}
    C -->|å¼€å¯| D[frontendPath=tunnel]
    C -->|å…³é—­| E[frontendPath=direct]
    
    D --> F{æ£€æµ‹VPSä»£ç†çŠ¶æ€}
    E --> F
    
    F -->|ä»£ç†å·²è¿æ¥| G[backendPath=proxy]
    F -->|ä»£ç†æœªè¿æ¥| H[backendPath=direct]
    
    G --> I[ç»„åˆè·¯ç”±æ¨¡å¼]
    H --> I
    
    I --> J[WorkersåŒ…è£…HLS URL]
    J --> K[è¿”å›ç»™å‰ç«¯æ’­æ”¾]
    
    K --> L[å‰ç«¯æ˜¾ç¤ºåŒç»´åº¦æ ‡ç­¾]
```

### Workersä»£ç†æ–¹æ¡ˆï¼ˆè§£å†³SSLé—®é¢˜ï¼‰

**é—®é¢˜**: æµè§ˆå™¨è®¿é—® `tunnel-hls.yoyo-vps.5202021.xyz` è§¦å‘SSLé”™è¯¯

**è§£å†³æ–¹æ¡ˆæ¶æ„**:
```
æ—§æ¶æ„ï¼ˆæœ‰SSLé—®é¢˜ï¼‰:
  æµè§ˆå™¨ â†’ tunnel-hls.yoyo-vps.5202021.xyz âŒ

æ–°æ¶æ„ï¼ˆWorkersä»£ç†ï¼‰:
  æµè§ˆå™¨ â†’ yoyoapi.5202021.xyz/tunnel-proxy/hls/* âœ…
           â†“ (Workerså†…éƒ¨ä»£ç†)
       tunnel-hls.yoyo-vps.5202021.xyz âœ…
```

**æŠ€æœ¯ä¼˜åŠ¿**:
- âœ… ä¸å½±å“å…¶ä»–å­åŸŸå
- âœ… 10åˆ†é’Ÿå¿«é€Ÿå®æ–½
- âœ… å†…ç½®æ•…éšœè½¬ç§»
- âœ… æ€§èƒ½å½±å“å°ï¼ˆ~10-50msï¼‰

### å‰ç«¯åŒç»´åº¦æ˜¾ç¤º

**UIæ•ˆæœ**:
```
[çŠ¶æ€: æ’­æ”¾ä¸­] [å‰ç«¯: éš§é“ä¼˜åŒ–] [åç«¯: ç›´è¿]
```

**å®ç°è¦ç‚¹**:
- å‰ç«¯è·¯å¾„æ ‡ç­¾ï¼šğŸ”— éš§é“ä¼˜åŒ– / ğŸ”— ç›´è¿
- åç«¯è·¯å¾„æ ‡ç­¾ï¼šğŸ”— ä»£ç†(jp) / ğŸ”— ç›´è¿
- é¢œè‰²åŒºåˆ†ï¼šç»¿è‰²ï¼ˆä¼˜åŒ–ï¼‰/ è“è‰²ï¼ˆç›´è¿ï¼‰

è¯¦ç»†å®ç°å‚è§: `doc/DUAL_DIMENSION_ROUTING_ARCHITECTURE.md`

---

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶

### 1. SimpleStreamManagerï¼ˆè½¬ç ç®¡ç†ï¼‰

**è®¾è®¡åŸåˆ™**:
- æŒ‰éœ€å¯åŠ¨è½¬ç ï¼ˆæ— è§‚çœ‹è€…æ—¶ä¸å¤„ç†ï¼‰
- å¤šç”¨æˆ·å…±äº«è½¬ç è¿›ç¨‹
- æ™ºèƒ½å¿ƒè·³å’Œç©ºé—²æ¸…ç†

**æ ¸å¿ƒæµç¨‹**:
```
ç”¨æˆ·ç‚¹å‡»æ’­æ”¾
    â†“
æ£€æŸ¥æ˜¯å¦å·²æœ‰è½¬ç è¿›ç¨‹
    â†“
æœ‰ â†’ å¤ç”¨ç°æœ‰è¿›ç¨‹ | æ—  â†’ å¯åŠ¨æ–°è¿›ç¨‹
    â†“
è¿”å›HLS URLç»™å‰ç«¯
    â†“
å‰ç«¯å¼€å§‹æ’­æ”¾å¹¶å‘é€å¿ƒè·³
    â†“
60ç§’æ— å¿ƒè·³ â†’ è‡ªåŠ¨æ¸…ç†è¿›ç¨‹
```

### 2. Cloudflare Tunnelï¼ˆç½‘ç»œä¼˜åŒ–ï¼‰

**é…ç½®æ¦‚è§ˆ**:
```yaml
# /etc/cloudflared/config.yml
tunnel: 071aeb49-a619-4543-aee4-c9a13b4e84e4
ingress:
  - hostname: tunnel-api.yoyo-vps.5202021.xyz
    service: http://localhost:3000
  - hostname: tunnel-hls.yoyo-vps.5202021.xyz
    service: http://localhost:52535  # Nginx HLSæœåŠ¡
  - hostname: tunnel-health.yoyo-vps.5202021.xyz
    service: http://localhost:3000
```

**è¿è¡ŒçŠ¶æ€**: âœ… 4ä¸ªè¿æ¥å·²å»ºç«‹ï¼Œlax06/lax09æ•°æ®ä¸­å¿ƒ

### 3. V2Ray/Xrayä»£ç†æœåŠ¡

**ç”¨é€”**: VPSè®¿é—®æµ·å¤–RTMPæºæ—¶çš„ç½‘ç»œä¼˜åŒ–

**å®ç°çŠ¶æ€**: âš ï¸ **éƒ¨åˆ†å®ç°**
- âœ… ä»£ç†æœåŠ¡ç®¡ç†ï¼ˆè¿æ¥/æ–­å¼€ï¼‰
- âœ… ä»£ç†çŠ¶æ€æ£€æµ‹å’ŒåŒæ­¥
- âœ… ç®¡ç†åå°æ§åˆ¶ç•Œé¢
- âš ï¸ **FFmpegé€šè¿‡ä»£ç†è®¿é—®RTMPï¼ˆæš‚æœªå®Œæ•´å®ç°ï¼‰**

**ç®¡ç†æ–¹å¼**:
- ç®¡ç†åå°ä¸€é”®è¿æ¥/æ–­å¼€
- æ”¯æŒå¤šä¸ªä»£ç†é…ç½®ï¼ˆjpã€usç­‰ï¼‰
- è‡ªåŠ¨çŠ¶æ€åŒæ­¥å’Œæ˜¾ç¤º

**å·¥ä½œæµç¨‹**:
```
VPSéœ€è¦è®¿é—®RTMPæº
    â†“
æ£€æŸ¥ä»£ç†è¿æ¥çŠ¶æ€
    â†“
å·²è¿æ¥ â†’ é€šè¿‡ä»£ç†è®¿é—® (âš ï¸ æš‚æœªå®ç°) | æœªè¿æ¥ â†’ ç›´è¿è®¿é—® âœ…
    â†“
è·¯ç”±ä¿¡æ¯è¿”å›ç»™Workers
    â†“
Workersç»„åˆåŒç»´åº¦è·¯ç”±æ¨¡å¼
```

**å¾…å®ŒæˆåŠŸèƒ½**:
- [ ] FFmpegé€šè¿‡SOCKS5ä»£ç†è¿æ¥RTMPæº
- [ ] ä»£ç†è¿æ¥å¤±è´¥è‡ªåŠ¨å›é€€åˆ°ç›´è¿
- [ ] ä»£ç†æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

### 4. æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿï¼ˆæ–°å¢ï¼‰â­

**åŠŸèƒ½æ¦‚è¿°**: å®šæ—¶é¢„åŠ è½½å…³é”®é¢‘é“ï¼Œå®ç°é›¶å»¶è¿Ÿæ’­æ”¾

**æ ¸å¿ƒç»„ä»¶**:

#### 4.1 PreloadSchedulerï¼ˆå®šæ—¶è°ƒåº¦å™¨ï¼‰
```javascript
// services/PreloadScheduler.js
class PreloadScheduler {
  // ä½¿ç”¨node-cronä¸ºæ¯ä¸ªé¢‘é“åˆ›å»ºç²¾ç¡®å®šæ—¶ä»»åŠ¡
  scheduledJobs = new Map();  // channelId -> [startJob, endJob]
  workdayChecker = null;  // ğŸ†• å·¥ä½œæ—¥æ£€æµ‹å™¨å®ä¾‹
  
  async start() {
    // ğŸ†• 1. åˆå§‹åŒ–å·¥ä½œæ—¥æ£€æµ‹å™¨ï¼ˆé¢„å–å½“å‰æœˆ+ä¸‹æœˆæ•°æ®ï¼‰
    await this.workdayChecker.initialize();
    
    // 2. ä»Workers APIè·å–æ‰€æœ‰é¢„åŠ è½½é…ç½®
    // 3. ä¸ºæ¯ä¸ªå¯ç”¨çš„é¢‘é“åˆ›å»ºå¼€å§‹/ç»“æŸå®šæ—¶ä»»åŠ¡
    // 4. æœåŠ¡å¯åŠ¨æ—¶æ£€æµ‹å¹¶ç«‹å³å¯åŠ¨åº”é¢„åŠ è½½çš„é¢‘é“
  }
  
  async shouldPreloadNow(config, currentTime) {
    // æ­¥éª¤1: æ£€æŸ¥æ—¶é—´æ®µ
    const inTimeRange = this.isInTimeRange(currentTime, startTime, endTime);
    if (!inTimeRange) return false;
    
    // ğŸ†• æ­¥éª¤2: æ£€æŸ¥å·¥ä½œæ—¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (config.workdaysOnly) {
      const isWorkday = await this.workdayChecker.isWorkday();
      if (!isWorkday) {
        return false;  // éå·¥ä½œæ—¥ï¼Œè·³è¿‡é¢„åŠ è½½
      }
    }
    return true;
  }
  
  schedulePreload(channelId, config) {
    // åˆ›å»ºå¼€å§‹ä»»åŠ¡: cron.schedule('40 7 * * *', async () => {
    //   ğŸ†• å®æ—¶æ£€æŸ¥æ˜¯å¦åº”è¯¥å¯åŠ¨ï¼ˆåŒ…å«å·¥ä½œæ—¥æ£€æŸ¥ï¼‰
    //   if (await shouldPreloadNow(config, currentTime)) {
    //     await startPreload(config);
    //   }
    // })
    
    // åˆ›å»ºç»“æŸä»»åŠ¡: cron.schedule('20 17 * * *', ...)
  }
}
```

**è°ƒåº¦ç­–ç•¥**:
- âœ… åŸºäºåŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰çš„ç²¾ç¡®cronä»»åŠ¡
- âœ… æ¯ä¸ªé¢‘é“2ä¸ªä»»åŠ¡ï¼ˆå¼€å§‹+ç»“æŸï¼‰ï¼Œä¾‹å¦‚07:40å¯åŠ¨ï¼Œ17:20åœæ­¢
- âœ… **å·¥ä½œæ—¥æ™ºèƒ½åˆ¤æ–­**: å®šæ—¶ä»»åŠ¡è§¦å‘æ—¶å®æ—¶æ£€æŸ¥å·¥ä½œæ—¥ â­
- âœ… é…ç½®å˜æ›´æ—¶çƒ­é‡è½½ï¼Œç«‹å³ç”Ÿæ•ˆ
- âœ… æœåŠ¡é‡å¯æ—¶è‡ªåŠ¨æ£€æµ‹å½“å‰æ—¶æ®µï¼Œç«‹å³å¯åŠ¨åº”é¢„åŠ è½½çš„é¢‘é“
- âœ… **å®¹é”™é™çº§**: APIå¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºæ¯æ—¥é¢„åŠ è½½ï¼Œä¸ä¸­æ–­æœåŠ¡ â­

#### 4.2 SimpleStreamManageré¢„åŠ è½½æ”¯æŒ
```javascript
// é¢„åŠ è½½æ ‡è®°æœºåˆ¶
class SimpleStreamManager {
  preloadChannels = new Set();  // é¢„åŠ è½½é¢‘é“é›†åˆ
  
  startPreload(channelId, rtmpUrl) {
    // 1. å¯åŠ¨FFmpegè½¬ç è¿›ç¨‹
    // 2. æ·»åŠ åˆ°preloadChannelsé›†åˆ
    // 3. å¿ƒè·³æ¸…ç†é€»è¾‘è‡ªåŠ¨è·³è¿‡é¢„åŠ è½½é¢‘é“
  }
  
  cleanupIdleChannels() {
    // è·³è¿‡é¢„åŠ è½½é¢‘é“çš„è‡ªåŠ¨æ¸…ç†
    if (this.preloadChannels.has(channelId)) {
      return; // ä¿ç•™é¢„åŠ è½½è¿›ç¨‹
    }
  }
}
```

#### 4.3 PreloadHealthCheckï¼ˆå¥åº·æ£€æŸ¥ï¼‰
```javascript
// services/PreloadHealthCheck.js
class PreloadHealthCheck {
  CHECK_INTERVAL = 5 * 60 * 1000;  // æ¯5åˆ†é’Ÿæ£€æŸ¥
  
  async performHealthCheck() {
    // 1. æ£€æŸ¥é¢„åŠ è½½è¿›ç¨‹æ˜¯å¦å­˜æ´»
    // 2. éªŒè¯HLSæ–‡ä»¶æ˜¯å¦æ­£å¸¸ç”Ÿæˆ
    // 3. è¿›ç¨‹å´©æºƒè‡ªåŠ¨é‡å¯ï¼ˆæœ€å¤š3æ¬¡ï¼‰
  }
}
```

**KVå­˜å‚¨ç»“æ„** (å·²æ•´åˆåˆ°é¢‘é“é…ç½®ä¸­):
```json
{
  "channel:stream_ensxma2g": {
    "id": "stream_ensxma2g",
    "name": "äºŒæ¥¼æ•™å®¤1",
    "rtmpUrl": "rtmp://push228.dodool.com.cn/55/19",
    "sortOrder": 1,
    "status": "active",
    "preloadConfig": {
      "enabled": true,
      "startTime": "07:00",
      "endTime": "17:30",
      "workdaysOnly": true,
      "updatedAt": "2025-10-27T09:00:00Z",
      "updatedBy": "admin"
    },
    "createdAt": "2025-10-01T00:00:00Z",
    "updatedAt": "2025-10-27T09:00:00Z"
  }
}
```

**æ³¨**: é¢„åŠ è½½é…ç½®ä½œä¸º `preloadConfig` å­—æ®µåµŒå…¥åˆ°é¢‘é“é…ç½®ä¸­ï¼Œä¸å†ä½¿ç”¨ç‹¬ç«‹çš„ `PRELOAD_CONFIG:*` é”®ã€‚

#### 4.4 WorkdayCheckerï¼ˆå·¥ä½œæ—¥æ£€æµ‹å™¨ï¼‰â­ æ–°å¢

**åŠŸèƒ½æ¦‚è¿°**: æ™ºèƒ½è¯†åˆ«å·¥ä½œæ—¥ï¼Œæ”¯æŒæ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘è¯†åˆ«

```javascript
// services/WorkdayChecker.js
class WorkdayChecker {
  apiUrl = 'https://timor.tech/api/holiday/info';
  cache = new Map();  // å†…å­˜ç¼“å­˜
  failedMonths = new Set();  // å¤±è´¥æœˆä»½è·Ÿè¸ª
  
  async initialize() {
    // 1. é¢„å–å½“å‰æœˆ+ä¸‹æœˆå·¥ä½œæ—¥æ•°æ®
    // 2. è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©å‡Œæ™¨1ç‚¹æ£€æŸ¥
    //    - 25å·é¢„å–ä¸‹æœˆæ•°æ®
    //    - é‡è¯•å¤±è´¥çš„æœˆä»½
  }
  
  async isWorkday(date = new Date()) {
    // 1. æ£€æŸ¥ç¼“å­˜ â†’ å‘½ä¸­è¿”å›ï¼ˆ24å°æ—¶æœ‰æ•ˆæœŸï¼‰
    // 2. è°ƒç”¨API â†’ type=0æˆ–3ä¸ºå·¥ä½œæ—¥
    // 3. å¤±è´¥é™çº§ â†’ å‘¨ä¸€è‡³å‘¨äº”=å·¥ä½œæ—¥ï¼ˆæ— æ³•è¯†åˆ«èŠ‚å‡æ—¥ï¼‰
    // 4. å†™å…¥ç¼“å­˜
  }
}
```

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… **æ•°æ®æº**: Timor API (å…è´¹ã€ç¨³å®šã€å‡†ç¡®)
- âœ… **æ•°æ®é¢„å–**: å¯åŠ¨æ—¶é¢„å–å½“å‰æœˆ+ä¸‹æœˆï¼Œ25å·è‡ªåŠ¨é¢„å–ä¸‹æœˆ
- âœ… **æ™ºèƒ½ç¼“å­˜**: å†…å­˜ç¼“å­˜ + 24å°æ—¶æœ‰æ•ˆæœŸï¼Œ95%è¯·æ±‚<1ms
- âœ… **å¤±è´¥é‡è¯•**: è‡ªåŠ¨è·Ÿè¸ªå¤±è´¥æœˆä»½ï¼Œæ¯å¤©å‡Œæ™¨1ç‚¹é‡è¯•
- âœ… **å®¹é”™é™çº§**: APIå¤±è´¥æ—¶é™çº§ä¸ºåŸºç¡€æ¨¡å¼ï¼ˆå‘¨ä¸€è‡³å‘¨äº”ï¼‰
- âœ… **èŠ‚å‡æ—¥è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«æ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘å·¥ä½œæ—¥

**å·¥ä½œæ—¥ç±»å‹**:
- `type=0` - æ­£å¸¸å·¥ä½œæ—¥ï¼ˆå‘¨ä¸€è‡³å‘¨äº”ï¼‰
- `type=1` - å‘¨æœ«ä¼‘æ¯æ—¥
- `type=2` - æ³•å®šèŠ‚å‡æ—¥
- `type=3` - è°ƒä¼‘å·¥ä½œæ—¥ï¼ˆéœ€è¦ä¸Šç­ï¼‰

**APIè°ƒç”¨ä¼˜åŒ–**:
```javascript
// æ·»åŠ User-Agenté¿å…Cloudflare Boté˜²æŠ¤
fetch(apiUrl, {
  headers: {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0'
  }
});
```

**Workers APIç«¯ç‚¹**:
- `GET /api/preload/config/:channelId` - è·å–é¢‘é“é¢„åŠ è½½é…ç½®
- `PUT /api/preload/config/:channelId` - æ›´æ–°é¢‘é“é¢„åŠ è½½é…ç½®ï¼ˆå«workdaysOnlyï¼‰
- `GET /api/preload/status` - æŸ¥è¯¢é¢„åŠ è½½ç³»ç»ŸçŠ¶æ€
- `GET /api/preload/workday-status` - æŸ¥è¯¢å·¥ä½œæ—¥æ£€æµ‹å™¨çŠ¶æ€ â­ æ–°å¢
- `POST /api/preload/reload` - é‡è½½è°ƒåº¦å™¨é…ç½®

**VPS APIç«¯ç‚¹**:
- `GET /api/preload/workday-status` - è¿”å›å·¥ä½œæ—¥æ•°æ®å°±ç»ªçŠ¶æ€å’Œå¤±è´¥æœˆä»½

**å‰ç«¯ç®¡ç†ç•Œé¢**:
- é¢‘é“åˆ—è¡¨ä¸­æ·»åŠ "é¢„åŠ è½½"æŒ‰é’®
- PreloadConfigDialogç»„ä»¶ï¼š
  - é¢„åŠ è½½å¼€å…³ï¼ˆenabledï¼‰
  - å¼€å§‹/ç»“æŸæ—¶é—´
  - **ä»…å·¥ä½œæ—¥å¼€å…³ï¼ˆworkdaysOnlyï¼‰** â­ æ–°å¢
  - **å·¥ä½œæ—¥çŠ¶æ€æ˜¾ç¤º** â­ æ–°å¢
    - âœ… æ•°æ®å·²åŠ è½½ (success)
    - âš ï¸ Nä¸ªæœˆä»½å¾…é‡è¯• (warning)
    - ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ® (info)
    - âŒ è·å–çŠ¶æ€å¤±è´¥ (danger)
- æ—¶æ®µæè¿°åŠ¨æ€æ˜¾ç¤ºï¼š
  - workdaysOnly=false: "é¢„åŠ è½½æ—¶æ®µï¼šæ¯å¤© 07:40 - 17:25"
  - workdaysOnly=true: "é¢„åŠ è½½æ—¶æ®µï¼šå·¥ä½œæ—¥ 07:40 - 17:25"

**æ€§èƒ½ä¼˜åŒ–æ•ˆæœ**:
- âš¡ **é›¶å»¶è¿Ÿæ’­æ”¾**: é¢„åŠ è½½æ—¶æ®µç”¨æˆ·ç‚¹å‡»ç«‹å³æ’­æ”¾ï¼ˆ<0.5ç§’ï¼‰
- ğŸ’° **èµ„æºèŠ‚çœ**: ä»…åœ¨é…ç½®æ—¶æ®µè¿è¡Œï¼Œéæ—¶æ®µè‡ªåŠ¨åœæ­¢
- ğŸ¯ **ç²¾ç¡®è°ƒåº¦**: cronä»»åŠ¡å‡†ç‚¹è§¦å‘ï¼Œæ— è½®è¯¢æ¶ˆè€—

---

## ğŸ”„ æ•°æ®æµè½¬æœºåˆ¶

### å®Œæ•´æ’­æ”¾æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·æµè§ˆå™¨
    participant W as Workers
    participant V as VPS
    participant R as RTMPæº
    
    U->>W: 1. è¯·æ±‚æ’­æ”¾é¢‘é“A
    W->>W: 2. åˆ¤æ–­åŒç»´åº¦è·¯ç”±
    W->>V: 3. å¯åŠ¨è½¬ç è¯·æ±‚
    V->>V: 4. æ£€æŸ¥ä»£ç†çŠ¶æ€
    V->>R: 5. è¿æ¥RTMPæºï¼ˆç›´è¿æˆ–ä»£ç†ï¼‰
    V->>V: 6. å¯åŠ¨FFmpegè½¬ç 
    V->>W: 7. è¿”å›åŸºç¡€HLSè·¯å¾„
    W->>W: 8. æ ¹æ®è·¯ç”±åŒ…è£…å®Œæ•´URL
    W->>U: 9. è¿”å›HLS URL
    U->>W: 10. è¯·æ±‚HLSæ–‡ä»¶ï¼ˆé€šè¿‡ä»£ç†ï¼‰
    W->>V: 11. ä»£ç†åˆ°Tunnelæˆ–ç›´è¿
    V->>U: 12. è¿”å›HLSæ–‡ä»¶å†…å®¹
    U->>U: 13. æ’­æ”¾è§†é¢‘
    U->>V: 14. æ¯30ç§’å‘é€å¿ƒè·³
```

### é¢‘é“é…ç½®ç®¡ç†

**å­˜å‚¨æ–¹å¼**: Cloudflare KV  
**Keyæ ¼å¼**: `channel:${channelId}`  
**æ•°æ®ç»“æ„**:
```json
{
  "channel:stream_xxx": {
    "id": "stream_xxx",
    "name": "é¢‘é“åç§°",
    "rtmpUrl": "rtmp://...",
    "sortOrder": 1,
    "status": "active",
    "preloadConfig": {
      "enabled": false,
      "startTime": "07:00",
      "endTime": "17:30",
      "workdaysOnly": false,
      "updatedAt": "2025-10-27T09:00:00Z",
      "updatedBy": "admin"
    },
    "createdAt": "2025-10-01T00:00:00Z",
    "updatedAt": "2025-10-27T09:00:00Z"
  }
}
```

**é…ç½®å­—æ®µè¯´æ˜**:
- `id`: é¢‘é“å”¯ä¸€æ ‡è¯†ç¬¦
- `name`: é¢‘é“æ˜¾ç¤ºåç§°
- `rtmpUrl`: RTMPæ¨æµåœ°å€
- `sortOrder`: æ˜¾ç¤ºæ’åºï¼ˆæ•°å­—è¶Šå°è¶Šé å‰ï¼‰
- `status`: é¢‘é“çŠ¶æ€ï¼ˆactive/inactiveï¼‰
- `preloadConfig`: é¢„åŠ è½½é…ç½®ï¼ˆåµŒå…¥å¼ï¼Œè§ä¸‹èŠ‚ï¼‰
- `createdAt`: åˆ›å»ºæ—¶é—´
- `updatedAt`: æœ€åæ›´æ–°æ—¶é—´

**é…ç½®æµç¨‹**:
1. ç®¡ç†åå°ç¼–è¾‘é¢‘é“é…ç½®ï¼ˆåŸºæœ¬ä¿¡æ¯æˆ–é¢„åŠ è½½é…ç½®ï¼‰
2. ä¿å­˜åˆ°Workers KVï¼ˆå•ä¸€é”®å­˜å‚¨ï¼‰
3. é…ç½®ç«‹å³ç”Ÿæ•ˆ
4. å‰ç«¯ä¸‹æ¬¡åŠ è½½è·å–æ–°é…ç½®

### é¢„åŠ è½½é…ç½®ç®¡ç† â­ å·²æ•´åˆåˆ°é¢‘é“é…ç½®

**å­˜å‚¨æ–¹å¼**: åµŒå…¥åˆ°é¢‘é“é…ç½®ä¸­ï¼ˆ`channel:${channelId}`ï¼‰  
**å­—æ®µåç§°**: `preloadConfig`  
**æ•°æ®ç»“æ„**:
```json
{
  "preloadConfig": {
    "enabled": true,
    "startTime": "07:00",
    "endTime": "17:30",
    "workdaysOnly": true,
    "updatedAt": "2025-10-27T09:00:00Z",
    "updatedBy": "admin"
  }
}
```

**å­—æ®µè¯´æ˜**:
- `enabled`: æ˜¯å¦å¯ç”¨é¢„åŠ è½½ï¼ˆå¸ƒå°”å€¼ï¼‰
- `startTime`: é¢„åŠ è½½å¼€å§‹æ—¶é—´ï¼ˆHH:MMæ ¼å¼ï¼‰
- `endTime`: é¢„åŠ è½½ç»“æŸæ—¶é—´ï¼ˆHH:MMæ ¼å¼ï¼Œå¯è·¨å¤©ï¼‰
- `workdaysOnly`: æ˜¯å¦ä»…å·¥ä½œæ—¥é¢„åŠ è½½ï¼ˆå¸ƒå°”å€¼ï¼‰
- `updatedAt`: é…ç½®æ›´æ–°æ—¶é—´
- `updatedBy`: é…ç½®æ›´æ–°è€…

**é…ç½®æµç¨‹**:
```mermaid
sequenceDiagram
    participant A as ç®¡ç†å‘˜
    participant F as å‰ç«¯
    participant W as Workers
    participant K as KVå­˜å‚¨
    participant V as VPSè°ƒåº¦å™¨
    
    A->>F: ç‚¹å‡»é¢„åŠ è½½é…ç½®
    F->>W: PUT /api/preload/config/:id
    W->>K: è¯»å–é¢‘é“é…ç½® channel:id
    K->>W: è¿”å›ç°æœ‰é…ç½®
    W->>W: æ›´æ–° preloadConfig å­—æ®µ
    W->>K: ä¿å­˜æ›´æ–°åçš„é¢‘é“é…ç½®
    W->>F: è¿”å›æˆåŠŸ
    F->>W: POST /api/preload/reload
    W->>V: é€šçŸ¥VPSé‡è½½é…ç½®
    V->>W: GET /api/preload/configs
    W->>K: éå†æ‰€æœ‰é¢‘é“é…ç½®
    K->>W: è¿”å›æ‰€æœ‰é…ç½®
    W->>V: è¿”å›å¯ç”¨çš„é¢„åŠ è½½é…ç½®åˆ—è¡¨
    V->>V: é‡æ–°åˆ›å»ºå®šæ—¶ä»»åŠ¡
```

**ä¼˜åŒ–è¯´æ˜**:
- âœ… **ç»Ÿä¸€å­˜å‚¨**: é¢‘é“é…ç½®å’Œé¢„åŠ è½½é…ç½®å­˜å‚¨åœ¨åŒä¸€ä¸ªKVé”®ä¸­
- âœ… **å‡å°‘KVæ“ä½œ**: è¯»å–é¢‘é“åˆ—è¡¨æ—¶è‡ªåŠ¨åŒ…å«é¢„åŠ è½½é…ç½®ï¼Œæ— éœ€é¢å¤–æŸ¥è¯¢
- âœ… **æ•°æ®ä¸€è‡´æ€§**: é¢‘é“å’Œé¢„åŠ è½½é…ç½®åŒæ­¥æ›´æ–°ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
- âœ… **ç®€åŒ–æ¶æ„**: ç§»é™¤ç‹¬ç«‹çš„ `PRELOAD_CONFIG:*` é”®ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### ç”Ÿäº§ç¯å¢ƒåŸŸå

| å±‚çº§ | åŸŸå | éƒ¨ç½²å¹³å° | åŠŸèƒ½ |
|------|------|---------|------|
| å‰ç«¯ | `yoyo.5202021.xyz` | Cloudflare Pages | ç”¨æˆ·ç•Œé¢ |
| API | `yoyoapi.5202021.xyz` | Cloudflare Workers | ä¸šåŠ¡é€»è¾‘ |
| VPS | `yoyo-vps.5202021.xyz` | RackNerd VPS | è½¬ç æœåŠ¡ |
| éš§é“ | `tunnel-*.yoyo-vps.5202021.xyz` | Cloudflare Tunnel | ç½‘ç»œä¼˜åŒ– |

### VPSæœåŠ¡å™¨é…ç½®

**æœåŠ¡å™¨ä¿¡æ¯**:
- IP: 142.171.75.220
- OS: CentOS 9
- CPU: 2 vCores
- RAM: 3GB
- å­˜å‚¨: 50GB SSD

**å·²å®‰è£…è½¯ä»¶**:
- Node.js: v18.20.8
- FFmpeg: 5.1.7
- Nginx: 1.20.1
- PM2: 6.0.13
- cloudflared: 2025.9.1

**ç«¯å£é…ç½®**:
```
3000  â†’ Node.js APIæœåŠ¡
52535 â†’ Nginx (HLSæ–‡ä»¶æœåŠ¡)
8080  â†’ File Browser (å†…éƒ¨ç®¡ç†)
```

### éƒ¨ç½²æµç¨‹ï¼ˆä¸€é”®ï¼‰

```bash
# 1. æäº¤ä»£ç åˆ°Git
git push origin master

# 2. éƒ¨ç½²Workers
cd cloudflare-worker
wrangler deploy --env production

# 3. éƒ¨ç½²VPSï¼ˆä¸€é”®è„šæœ¬ï¼‰
ssh root@142.171.75.220 "cd /tmp/github/secure-streaming-platform/vps-transcoder-api && ./vps-simple-deploy.sh"

# 4. å‰ç«¯è‡ªåŠ¨éƒ¨ç½²ï¼ˆCloudflare Pagesè‡ªåŠ¨è§¦å‘ï¼‰
```

### Origin Rulesé…ç½®ï¼ˆé‡è¦ï¼‰

**é—®é¢˜**: Workersä½¿ç”¨æ ‡å‡†443ç«¯å£ï¼Œä½†VPS Nginxç›‘å¬52535ç«¯å£

**è§£å†³**: Cloudflare Origin Rulesè‡ªåŠ¨ç«¯å£æ”¹å†™

```yaml
è§„åˆ™åç§°: yoyo-vps-api
è§¦å‘æ¡ä»¶: ä¸»æœºå = yoyo-vps.5202021.xyz
æ‰§è¡ŒåŠ¨ä½œ: è¦†å†™æºç«¯å£ HTTP/HTTPS = 52535
```

**è¯·æ±‚æµç¨‹**:
```
Workers fetch('https://yoyo-vps.5202021.xyz/...')
    â†“ (é»˜è®¤443ç«¯å£)
Cloudflare Edge (Origin Rules)
    â†“ (è‡ªåŠ¨æ”¹å†™ä¸º52535)
VPS Nginx:52535
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### åŒç»´åº¦è·¯ç”±ä¼˜åŒ–æ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|-------|------|
| HLSè¯·æ±‚å»¶è¿Ÿ | 200-500ms | <100ms | 50%+ |
| è§†é¢‘å¯æ’­æ—¶é—´ | 3-5ç§’ | <2ç§’ | 60%+ |
| æ’­æ”¾æµç•…åº¦ | å¶å°”å¡é¡¿ | æµç•… | æ˜¾è‘—æå‡ |

### Workersä»£ç†æ€§èƒ½

- Workersä»£ç†å±‚å»¶è¿Ÿ: ~10-50ms
- Cloudflareå†…éƒ¨ç½‘ç»œ: é«˜é€Ÿäº’è”
- æ•…éšœè½¬ç§»æ—¶é—´: <100ms

### FFmpegè½¬ç ä¼˜åŒ–

**è½¬ç å‚æ•°**:
```bash
ffmpeg -i rtmp://... \
  -c:v libx264 -preset veryfast \  # å¿«é€Ÿç¼–ç 
  -an \                             # æ— éŸ³é¢‘
  -hls_time 2 \                     # 2ç§’åˆ†ç‰‡
  -hls_list_size 5 \                # ä¿ç•™5ä¸ªåˆ†ç‰‡
  -f hls output.m3u8
```

**æ€§èƒ½ç‰¹ç‚¹**:
- 2ç§’åˆ†ç‰‡ï¼šå¹³è¡¡å»¶è¿Ÿå’Œç¨³å®šæ€§
- æ— éŸ³é¢‘ï¼šå‡å°‘è®¡ç®—è´Ÿè½½ï¼ˆæ ¹æ®éœ€æ±‚ï¼‰
- å¿«é€Ÿé¢„è®¾ï¼šé™ä½CPUä½¿ç”¨ç‡

---

## ğŸ” å®‰å…¨ä¸ç›‘æ§

### è®¤è¯æœºåˆ¶

**ç”¨æˆ·è®¤è¯**:
- æ–¹å¼: åŸºäºCookieçš„ä¼šè¯ç®¡ç†
- å¯†ç : PBKDF2å“ˆå¸Œç®—æ³•
- å­˜å‚¨: Cloudflare KV

**APIè®¤è¯**:
- VPS APIå¯†é’¥è®¤è¯
- Workersç¯å¢ƒå˜é‡ä¿æŠ¤

### ç›‘æ§æŒ‡æ ‡

**ç³»ç»Ÿç›‘æ§**:
- âœ… VPSå¥åº·æ£€æŸ¥: `/health`
- âœ… éš§é“è¿æ¥çŠ¶æ€ç›‘æ§
- âœ… è½¬ç è¿›ç¨‹æ•°é‡ç›‘æ§
- âœ… ä»£ç†è¿æ¥çŠ¶æ€ç›‘æ§

**æ€§èƒ½ç›‘æ§**:
- âœ… HLSè¯·æ±‚å»¶è¿Ÿ
- âœ… è§†é¢‘å¯æ’­æ—¶é—´
- âœ… æ’­æ”¾é”™è¯¯ç‡
- âœ… ç”¨æˆ·å¹¶å‘æ•°

**æ—¥å¿—è®°å½•**:
- ç™»å½•æ—¥å¿—: Cloudflare R2å­˜å‚¨
- æ“ä½œæ—¥å¿—: ç®¡ç†å‘˜æ“ä½œè®°å½•
- é”™è¯¯æ—¥å¿—: PM2æ—¥å¿—æ”¶é›†

---

## ğŸ“Š æ¶æ„æ¼”è¿›å†å²

### V1.0 (2025-10-01)
- âœ… åŸºç¡€ä¸‰å±‚æ¶æ„
- âœ… RTMPåˆ°HLSè½¬ç 
- âœ… ç®€å•çš„éš§é“ä¼˜åŒ–

### V1.5 (2025-10-07)
- âœ… Cloudflare Tunnelé…ç½®ä¿®å¤
- âœ… æ™ºèƒ½æ•…éšœè½¬ç§»
- âœ… å‰ç«¯çŠ¶æ€æ˜¾ç¤º

### V2.0 (2025-10-24)
- âœ… **åŒç»´åº¦è·¯ç”±æ¶æ„**
- âœ… **Workersä»£ç†è§£å†³SSLé—®é¢˜**
- âœ… **å‰åç«¯è·¯å¾„ç‹¬ç«‹ä¼˜åŒ–**
- âœ… **åŒç»´åº¦å¯è§†åŒ–æ˜¾ç¤º**
- âœ… **å®Œæ•´çš„æ•…éšœè½¬ç§»æœºåˆ¶**

### V2.1 (2025-10-27)
- âœ… **æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿ**
- âœ… **PreloadSchedulerå®šæ—¶è°ƒåº¦å™¨**
- âœ… **PreloadHealthCheckå¥åº·æ£€æŸ¥**
- âœ… **å‰ç«¯é¢„åŠ è½½é…ç½®ç®¡ç†ç•Œé¢**
- âœ… **é›¶å»¶è¿Ÿæ’­æ”¾ä½“éªŒï¼ˆé¢„åŠ è½½æ—¶æ®µï¼‰**

### V2.2 (2025-10-27) â­ å½“å‰ç‰ˆæœ¬
- âœ… **å·¥ä½œæ—¥é¢„åŠ è½½åŠŸèƒ½** â­
- âœ… **WorkdayCheckerå·¥ä½œæ—¥æ£€æµ‹å™¨**
- âœ… **ä»…å·¥ä½œæ—¥å¼€å…³ï¼ˆworkdaysOnlyï¼‰**
- âœ… **æ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘è¯†åˆ«**
- âœ… **å·¥ä½œæ—¥çŠ¶æ€å®æ—¶æ˜¾ç¤º**
- âœ… **æ™ºèƒ½é™çº§å’Œå¤±è´¥é‡è¯•æœºåˆ¶**

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

### æ ¸å¿ƒæ–‡æ¡£
- **æœ¬æ–‡æ¡£**: `doc/ARCHITECTURE_V2.md` - ç²¾ç®€æ¶æ„æ–‡æ¡£
- **è¯¦ç»†æ¶æ„**: `doc/DUAL_DIMENSION_ROUTING_ARCHITECTURE.md` - åŒç»´åº¦è·¯ç”±è¯¦ç»†å®ç°
- **é¢„åŠ è½½æ–¹æ¡ˆ**: `doc/PRELOAD_IMPLEMENTATION_STAGED.md` - æ™ºèƒ½é¢„åŠ è½½é˜¶æ®µå®æ–½æ–‡æ¡£
- **å·¥ä½œæ—¥é¢„åŠ è½½**: `doc/WORKDAY_PRELOAD_IMPLEMENTATION.md` - å·¥ä½œæ—¥é¢„åŠ è½½å®æ–½æ–¹æ¡ˆ â­
- **å®æ–½è®°å½•**: `DUAL_DIMENSION_ROUTING_FIX_STAGED.md` - é˜¶æ®µå®æ–½è®°å½•

### å†å²æ–‡æ¡£
- **æ—§ç‰ˆæ¶æ„**: `doc/YOYO_PLATFORM_ARCHITECTURE.md` - å®Œæ•´è¯¦ç»†ç‰ˆï¼ˆ4000+è¡Œï¼‰

### æŠ€æœ¯æ–‡æ¡£
- **Workersä»£ç **: `cloudflare-worker/src/` - ä¸šåŠ¡é€»è¾‘å®ç°
- **VPSä»£ç **: `src/` - è½¬ç æœåŠ¡å®ç°
- **å‰ç«¯ä»£ç **: `frontend/src/` - ç”¨æˆ·ç•Œé¢å®ç°

---

## ğŸ¯ å¿«é€Ÿå¯¼èˆª

### æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥

| æ¦‚å¿µ | è¯´æ˜ | æ–‡æ¡£ä½ç½® |
|------|------|---------|
| åŒç»´åº¦è·¯ç”± | å‰åç«¯è·¯å¾„ç‹¬ç«‹ä¼˜åŒ– | æœ¬æ–‡æ¡£ + DUAL_DIMENSION_ROUTING_ARCHITECTURE.md |
| Workersä»£ç† | è§£å†³éš§é“SSLé—®é¢˜ | æœ¬æ–‡æ¡£ "Workersä»£ç†æ–¹æ¡ˆ" |
| æ™ºèƒ½é¢„åŠ è½½ | å®šæ—¶é¢„åŠ è½½ï¼Œé›¶å»¶è¿Ÿæ’­æ”¾ | æœ¬æ–‡æ¡£ "æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿ" + PRELOAD_IMPLEMENTATION_STAGED.md |
| SimpleStreamManager | è½¬ç è¿›ç¨‹ç®¡ç† | æœ¬æ–‡æ¡£ "æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶" |
| è·¯ç”±å†³ç­–å¼•æ“ | TunnelRouterå®ç° | DUAL_DIMENSION_ROUTING_ARCHITECTURE.md |
| éƒ¨ç½²æµç¨‹ | ä¸€é”®éƒ¨ç½²å‘½ä»¤ | æœ¬æ–‡æ¡£ "éƒ¨ç½²æ¶æ„" |

### å¸¸è§é—®é¢˜

**Q: å¦‚ä½•åˆ‡æ¢éš§é“æ¨¡å¼ï¼Ÿ**  
A: ç®¡ç†åå° â†’ éš§é“ä¼˜åŒ– â†’ ä¸€é”®å¼€å…³

**Q: å¦‚ä½•æŸ¥çœ‹è·¯ç”±çŠ¶æ€ï¼Ÿ**  
A: è§†é¢‘æ’­æ”¾ç•Œé¢æ˜¾ç¤ºåŒç»´åº¦æ ‡ç­¾

**Q: Workersä»£ç†ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ**  
A: å½±å“å¾ˆå°ï¼ˆ~10-50msï¼‰ï¼Œä¸”æœ‰æ•…éšœè½¬ç§»

**Q: å¦‚ä½•é…ç½®é¢‘é“é¢„åŠ è½½ï¼Ÿ**  
A: ç®¡ç†åå° â†’ é¢‘é“åˆ—è¡¨ â†’ ç‚¹å‡»"é¢„åŠ è½½"æŒ‰é’® â†’ è®¾ç½®å¼€å§‹/ç»“æŸæ—¶é—´ â†’ å¯é€‰å¯ç”¨"ä»…å·¥ä½œæ—¥"

**Q: é¢„åŠ è½½èƒ½èŠ‚çœå¤šå°‘èµ„æºï¼Ÿ**  
A: ä»…åœ¨é…ç½®æ—¶æ®µè¿è¡Œï¼Œç›¸æ¯”å…¨å¤©è¿è¡ŒèŠ‚çœçº¦70-80%èµ„æºã€‚å¯ç”¨"ä»…å·¥ä½œæ—¥"åï¼Œå‘¨æœ«å’ŒèŠ‚å‡æ—¥è‡ªåŠ¨è·³è¿‡ï¼Œè¿›ä¸€æ­¥èŠ‚çœçº¦30%èµ„æº

**Q: å·¥ä½œæ—¥é¢„åŠ è½½å¦‚ä½•è¯†åˆ«èŠ‚å‡æ—¥ï¼Ÿ** â­  
A: ä½¿ç”¨Timor APIè·å–å®˜æ–¹èŠ‚å‡æ—¥æ•°æ®ï¼Œè‡ªåŠ¨è¯†åˆ«æ³•å®šèŠ‚å‡æ—¥ã€è°ƒä¼‘å·¥ä½œæ—¥ã€‚APIå¤±è´¥æ—¶é™çº§ä¸ºåŸºç¡€æ¨¡å¼ï¼ˆå‘¨ä¸€è‡³å‘¨äº”ï¼‰

**Q: å·¥ä½œæ—¥æ•°æ®ä»å“ªé‡Œæ¥ï¼Ÿ**  
A: VPSå¯åŠ¨æ—¶è‡ªåŠ¨é¢„å–å½“å‰æœˆ+ä¸‹æœˆæ•°æ®ï¼Œæ¯æœˆ25å·é¢„å–ä¸‹æœˆæ•°æ®ã€‚å¤±è´¥çš„æœˆä»½ä¼šæ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨é‡è¯•

**Q: å¦‚æœå·¥ä½œæ—¥APIè°ƒç”¨å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**  
A: ç³»ç»Ÿæœ‰å®Œå–„çš„é™çº§æœºåˆ¶ï¼šAPIå¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºåŸºç¡€æ¨¡å¼ï¼ˆå‘¨ä¸€è‡³å‘¨äº”=å·¥ä½œæ—¥ï¼‰ï¼Œä¸å½±å“é¢„åŠ è½½æœåŠ¡

**Q: å¦‚ä½•éƒ¨ç½²æœ€æ–°ä»£ç ï¼Ÿ**  
A: ä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆè§"éƒ¨ç½²æ¶æ„"ç« èŠ‚ï¼‰

---

## ğŸ”„ ç»´æŠ¤è¯´æ˜

### æ–‡æ¡£æ›´æ–°åŸåˆ™

1. **ä¿æŒç²¾ç®€**: åªè®°å½•æ ¸å¿ƒæ¶æ„å’Œå…³é”®ä¿¡æ¯
2. **ä»£ç å¼•ç”¨**: é¿å…å¤§æ®µä»£ç ï¼Œæ”¹ç”¨æ–‡ä»¶å¼•ç”¨
3. **å›¾ç¤ºä¼˜å…ˆ**: ç”¨æµç¨‹å›¾å’Œæ¶æ„å›¾ä»£æ›¿æ–‡å­—æè¿°
4. **ç‰ˆæœ¬æ ‡è®°**: é‡è¦å˜æ›´æ ‡æ³¨ç‰ˆæœ¬å’Œæ—¥æœŸ

### æ›´æ–°é¢‘ç‡

- **æ¶æ„å˜æ›´**: ç«‹å³æ›´æ–°
- **åŠŸèƒ½æ–°å¢**: åŠæ—¶è¡¥å……
- **ä¼˜åŒ–è°ƒæ•´**: å®šæœŸæ•´ç†
- **ç‰ˆæœ¬å‘å¸ƒ**: åˆ›å»ºå¿«ç…§

---

## ğŸ“ ç‰ˆæœ¬å†å²

### V2.3 (2025-10-27)
**KVå­˜å‚¨ç»“æ„ä¼˜åŒ– - é¢‘é“é…ç½®ä¸é¢„åŠ è½½é…ç½®åˆå¹¶**

**æ ¸å¿ƒå˜æ›´**:
- âœ… å°†ç‹¬ç«‹çš„ `PRELOAD_CONFIG:${channelId}` é”®åˆå¹¶åˆ° `channel:${channelId}` é…ç½®ä¸­
- âœ… é¢„åŠ è½½é…ç½®ä½œä¸º `preloadConfig` å­—æ®µåµŒå…¥åˆ°é¢‘é“é…ç½®
- âœ… ç»Ÿä¸€å­˜å‚¨ç»“æ„ï¼Œå‡å°‘KVè¯»å†™æ“ä½œ
- âœ… æå‡æ•°æ®ä¸€è‡´æ€§ï¼Œç®€åŒ–ç³»ç»Ÿæ¶æ„

**APIå˜æ›´**:
- ğŸ”„ `PUT /api/preload/config/:channelId` - ç°åœ¨æ›´æ–°é¢‘é“é…ç½®ä¸­çš„ `preloadConfig` å­—æ®µ
- ğŸ”„ `GET /api/preload/config/:channelId` - ä»é¢‘é“é…ç½®ä¸­è¯»å– `preloadConfig` å­—æ®µ
- ğŸ”„ `GET /api/preload/configs` - éå†æ‰€æœ‰é¢‘é“é…ç½®ï¼Œè¿”å›å¯ç”¨çš„é¢„åŠ è½½é…ç½®åˆ—è¡¨

**ä¼˜åŠ¿**:
- ğŸ“‰ å‡å°‘KVæ“ä½œï¼šè¯»å–é¢‘é“åˆ—è¡¨æ—¶è‡ªåŠ¨åŒ…å«é¢„åŠ è½½é…ç½®
- ğŸ”„ æ•°æ®ä¸€è‡´æ€§ï¼šé¢‘é“å’Œé¢„åŠ è½½é…ç½®åŒæ­¥æ›´æ–°
- ğŸ¯ æ¶æ„ç®€åŒ–ï¼šç§»é™¤ç‹¬ç«‹çš„é¢„åŠ è½½é…ç½®é”®ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦

### V2.2 (2025-10-27)
**æ–°å¢å·¥ä½œæ—¥é¢„åŠ è½½åŠŸèƒ½**
- âœ… WorkdayCheckerå·¥ä½œæ—¥æ£€æµ‹å™¨
- âœ… æ”¯æŒæ³•å®šèŠ‚å‡æ—¥å’Œè°ƒä¼‘è¯†åˆ«
- âœ… æ™ºèƒ½ç¼“å­˜å’Œå¤±è´¥é‡è¯•æœºåˆ¶
- âœ… å®¹é”™é™çº§æ¨¡å¼

### V2.1 (2025-10-26)
**æ™ºèƒ½é¢„åŠ è½½ç³»ç»Ÿä¸Šçº¿**
- âœ… PreloadScheduleré¢„åŠ è½½è°ƒåº¦å™¨
- âœ… å®šæ—¶ä»»åŠ¡ç®¡ç†
- âœ… è¿›ç¨‹å¥åº·æ£€æŸ¥
- âœ… VPSé€šçŸ¥å’Œé…ç½®é‡è½½

### V2.0 (2025-10-01)
**åŒç»´åº¦è·¯ç”±ä¼˜åŒ–å®Œæˆ**
- âœ… å‰åç«¯è·¯å¾„ç‹¬ç«‹ä¼˜åŒ–
- âœ… Workersä»£ç†æ–¹æ¡ˆ
- âœ… è·¯ç”±å†³ç­–å¼•æ“
- âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

---

**æ–‡æ¡£ç»´æŠ¤è€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2025-10-27 17:55 (UTC+8)  
**æ–‡æ¡£çŠ¶æ€**: âœ… V2.3 - KVå­˜å‚¨ç»“æ„ä¼˜åŒ–ï¼ˆé¢‘é“é…ç½®ä¸é¢„åŠ è½½é…ç½®åˆå¹¶ï¼‰
