# é¢‘é“å½•åˆ¶åˆ†æ®µåŠŸèƒ½è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: V1.0  
> **åˆ›å»ºæ—¶é—´**: 2025-10-29  
> **è®¾è®¡ç›®æ ‡**: å®žçŽ°é•¿æ—¶é—´å½•åˆ¶çš„è‡ªåŠ¨åˆ†æ®µï¼Œé¿å…å•æ–‡ä»¶è¿‡å¤§å’Œæ„å¤–æŸåé£Žé™©

---

## ðŸ“‹ ç›®å½•

- [éœ€æ±‚èƒŒæ™¯](#éœ€æ±‚èƒŒæ™¯)
- [åŠŸèƒ½è®¾è®¡](#åŠŸèƒ½è®¾è®¡)
- [æŠ€æœ¯æ–¹æ¡ˆ](#æŠ€æœ¯æ–¹æ¡ˆ)
- [å®žçŽ°é€»è¾‘](#å®žçŽ°é€»è¾‘)
- [æ–‡ä»¶å‘½åè§„èŒƒ](#æ–‡ä»¶å‘½åè§„èŒƒ)
- [å…³é”®æŠ€æœ¯ç‚¹](#å…³é”®æŠ€æœ¯ç‚¹)
- [å½±å“åˆ†æž](#å½±å“åˆ†æž)
- [é£Žé™©è¯„ä¼°](#é£Žé™©è¯„ä¼°)
- [å®žæ–½è®¡åˆ’](#å®žæ–½è®¡åˆ’)

---

## ðŸŽ¯ éœ€æ±‚èƒŒæ™¯

### å½“å‰ç—›ç‚¹

1. **é•¿æ—¶é—´å½•åˆ¶é£Žé™©é«˜**
   - å½•åˆ¶æ—¶é—´å¯èƒ½æŒç»­æ•°å°æ—¶ï¼ˆå¦‚07:40-17:25ï¼Œè¿‘10å°æ—¶ï¼‰
   - å•ä¸ªMP4æ–‡ä»¶è¿‡å¤§ï¼ˆ10å°æ—¶ â‰ˆ 10-20GBï¼‰
   - å½•åˆ¶è¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–å¯¼è‡´æ•´ä¸ªæ–‡ä»¶æŸå
   - æ— æ³•æ¢å¤å·²å½•åˆ¶çš„å†…å®¹

2. **æ–‡ä»¶ç®¡ç†å›°éš¾**
   - å•ä¸ªè¶…å¤§æ–‡ä»¶ä¸ä¾¿äºŽç®¡ç†å’Œä¼ è¾“
   - æ— æ³•çµæ´»åˆ é™¤éƒ¨åˆ†æ—¶é—´æ®µçš„å†…å®¹

3. **æ•…éšœæ¢å¤èƒ½åŠ›å¼±**
   - å½•åˆ¶ä¸­æ–­åŽéœ€è¦é‡æ–°å¼€å§‹
   - æ— æ³•ä¿ç•™å·²å½•åˆ¶çš„éƒ¨åˆ†

### è§£å†³æ–¹æ¡ˆ

**å®žçŽ°è‡ªåŠ¨åˆ†æ®µå½•åˆ¶**ï¼š
- æŒ‰æ—¶é—´é•¿åº¦è‡ªåŠ¨åˆ†å‰²å½•åˆ¶æ–‡ä»¶ï¼ˆå¦‚æ¯1å°æ—¶ä¸€ä¸ªæ–‡ä»¶ï¼‰
- åˆ†æ®µåˆ‡æ¢æ—¶**ä¸ä¸­æ–­è½¬ç è¿›ç¨‹**ï¼Œä¸å½±å“è§‚çœ‹
- æ¯æ®µç‹¬ç«‹ä¿å­˜ï¼Œé™ä½Žå•ç‚¹æ•…éšœé£Žé™©

---

## ðŸŽ¨ åŠŸèƒ½è®¾è®¡

### ç”¨æˆ·ç•Œé¢

**ä½ç½®**ï¼šé¢‘é“åˆ—è¡¨å³ä¸Šè§’"è®¾ç½®"æŒ‰é’®å¼¹çª—ï¼ˆ**é›†æˆåˆ°çŽ°æœ‰çš„SystemSettingsDialog**ï¼‰

**åœ¨çŽ°æœ‰å¯¹è¯æ¡†ä¸­æ–°å¢žä¸€ä¸ªåˆ†æ®µ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿè®¾ç½®                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚  â”â”â” è§†é¢‘æ¸…ç†é…ç½® â”â”â”             â”‚
â”‚  [çŽ°æœ‰çš„æ¸…ç†é…ç½®é¡¹...]             â”‚
â”‚                                    â”‚
â”‚  â”â”â” å½•åˆ¶åˆ†æ®µé…ç½® â”â”â” ðŸ†•          â”‚
â”‚                                    â”‚
â”‚  å¯ç”¨å½•åˆ¶åˆ†æ®µ: â–¡                   â”‚
â”‚                                    â”‚
â”‚  åˆ†æ®µæ—¶é•¿: [60] åˆ†é’Ÿ               â”‚
â”‚           èŒƒå›´: 10-240åˆ†é’Ÿ         â”‚
â”‚                                    â”‚
â”‚  å¿«æ·è®¾ç½®:                          â”‚
â”‚  [30åˆ†é’Ÿ] [1å°æ—¶] [2å°æ—¶]         â”‚
â”‚                                    â”‚
â”‚  è¯´æ˜Ž: å½•åˆ¶æ—¶é•¿è¾¾åˆ°è®¾ç½®å€¼æ—¶è‡ªåŠ¨     â”‚
â”‚       åˆ‡æ¢åˆ°æ–°æ–‡ä»¶ï¼Œåˆ†æ®µè¿‡ç¨‹ä¸ä¼š    â”‚
â”‚       å½±å“ç”¨æˆ·è§‚çœ‹ã€‚                â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®ç»“æž„ï¼ˆé›†æˆåˆ°çŽ°æœ‰é…ç½®ï¼‰

**çŽ°æœ‰é…ç½®**ï¼š
```json
{
  "enabled": true,
  "retentionDays": 2
}
```

**æ–°å¢žåŽçš„å®Œæ•´é…ç½®**ï¼š
```json
{
  "enabled": true,
  "retentionDays": 2,
  "segmentEnabled": true,      // ðŸ†• å½•åˆ¶åˆ†æ®µå¼€å…³
  "segmentDuration": 60        // ðŸ†• åˆ†æ®µæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
}
```

**APIç«¯ç‚¹**ï¼š`/api/admin/cleanup/config`ï¼ˆå¤ç”¨çŽ°æœ‰ç«¯ç‚¹ï¼‰  
**å­˜å‚¨ä½ç½®**ï¼š`system:cleanup_config`ï¼ˆå¤ç”¨çŽ°æœ‰keyï¼‰

---

## ðŸ”§ æŠ€æœ¯æ–¹æ¡ˆ

### æ ¸å¿ƒåŽŸç†ï¼šFFmpeg Segment Muxer

- FFmpegåŽŸç”Ÿæ”¯æŒåˆ†æ®µè¾“å‡ºï¼ˆ`-f segment`ï¼‰
- åœ¨**åŒä¸€ä¸ªFFmpegè¿›ç¨‹**å†…å®žçŽ°æ–‡ä»¶åˆ‡æ¢
- **ä¸éœ€è¦é‡å¯è¿›ç¨‹**ï¼Œè¾“å…¥æµæŒç»­ä¸æ–­
- åªæ˜¯æ›´æ¢è¾“å‡ºæ–‡ä»¶åï¼Œå¯¹HLSè¾“å‡ºæ— å½±å“

### FFmpegå‘½ä»¤å¯¹æ¯”

#### å½“å‰å‘½ä»¤ï¼ˆæ— åˆ†æ®µï¼‰

```bash
ffmpeg -i rtmp://input \
  -f hls ... /hls/playlist.m3u8 \
  -c:v copy -c:a copy -f mp4 /recording.mp4
```

#### æ–°å‘½ä»¤ï¼ˆå¯ç”¨åˆ†æ®µï¼‰

```bash
ffmpeg -i rtmp://input \
  -f hls ... /hls/playlist.m3u8 \
  -c:v copy -c:a copy \
  -f segment \
  -segment_time 3600 \
  -segment_format mp4 \
  -reset_timestamps 1 \
  /path/äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_temp_%03d.mp4
```

**è¯´æ˜Ž**ï¼š
- å…ˆä½¿ç”¨ä¸´æ—¶æ–‡ä»¶åï¼š`temp_001.mp4`, `temp_002.mp4`...
- å½•åˆ¶ç»“æŸåŽé‡å‘½åä¸ºï¼š`073000_to_083000.mp4`, `083000_to_093000.mp4`...
- **ä¸ºä»€ä¹ˆéœ€è¦ä¸¤æ­¥ï¼Ÿ** FFmpegåœ¨åˆ†æ®µæ—¶æ— æ³•é¢„çŸ¥ç»“æŸæ—¶é—´ï¼Œå¿…é¡»åœ¨å½•åˆ¶å®ŒæˆåŽè®¡ç®—æ¯æ®µçš„å®žé™…æ—¶é•¿

### ä¸ºä»€ä¹ˆä¸ä¼šå½±å“è§‚çœ‹ï¼Ÿ

**å…³é”®åŽŸå› **ï¼š

1. **åŒè¾“å‡ºç‹¬ç«‹**
   - HLSè¾“å‡ºï¼šç”¨äºŽå®žæ—¶è§‚çœ‹
   - MP4è¾“å‡ºï¼šç”¨äºŽå½•åˆ¶å­˜å‚¨
   - ä¸¤ä¸ªè¾“å‡ºæµå¹¶è¡Œå¤„ç†ï¼Œäº’ä¸å¹²æ‰°

2. **è¿›ç¨‹ä¸é‡å¯**
   - FFmpegè¿›ç¨‹æŒç»­è¿è¡Œ
   - åªæ˜¯MP4è¾“å‡ºéƒ¨åˆ†åˆ‡æ¢æ–‡ä»¶
   - HLSåˆ‡ç‰‡ç”ŸæˆæŒç»­ä¸æ–­

3. **æ— ç¼“å†²ä¸­æ–­**
   - segmentåˆ‡æ¢æ˜¯æ–‡ä»¶ç³»ç»Ÿå±‚é¢çš„æ“ä½œ
   - ä¸å½±å“ç¼–è§£ç ç®¡é“

**å·¥ä½œæµç¨‹**ï¼š

```
RTMPè¾“å…¥ â†’ FFmpegè¿›ç¨‹ï¼ˆæŒç»­è¿è¡Œï¼‰
              â†“
         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
         â†“         â†“
    HLSè¾“å‡º    MP4è¾“å‡º
   ï¼ˆè§‚çœ‹ï¼‰   ï¼ˆå½•åˆ¶åˆ†æ®µï¼‰
```

---

## ðŸ”„ å®žçŽ°é€»è¾‘

### 1. é…ç½®ç®¡ç†ï¼ˆé›†æˆåˆ°çŽ°æœ‰ç³»ç»Ÿï¼‰

**å‰ç«¯ï¼ˆSystemSettingsDialog.vueï¼‰**ï¼š
- åœ¨çŽ°æœ‰formå¯¹è±¡ä¸­æ·»åŠ ä¸¤ä¸ªæ–°å­—æ®µï¼š
  ```javascript
  const form = reactive({
    enabled: true,           // çŽ°æœ‰ï¼šæ¸…ç†å¼€å…³
    retentionDays: 2,       // çŽ°æœ‰ï¼šä¿ç•™å¤©æ•°
    segmentEnabled: false,  // ðŸ†• å½•åˆ¶åˆ†æ®µå¼€å…³
    segmentDuration: 60     // ðŸ†• åˆ†æ®µæ—¶é•¿
  })
  ```
- å¤ç”¨çŽ°æœ‰çš„`fetchConfig()`å’Œ`handleSave()`æ–¹æ³•
- åœ¨UIä¸­æ·»åŠ æ–°çš„åˆ†æ®µé…ç½®åŒºåŸŸ

**Workersç«¯ï¼ˆå¤ç”¨çŽ°æœ‰ç«¯ç‚¹ï¼‰**ï¼š
- `GET/PUT /api/admin/cleanup/config`
- åœ¨çŽ°æœ‰é…ç½®ä¸­æ–°å¢žä¸¤ä¸ªå­—æ®µ
- å‘åŽå…¼å®¹ï¼šæ—§æ•°æ®è‡ªåŠ¨å¡«å……é»˜è®¤å€¼

**VPSç«¯**ï¼š
- RecordSchedulerä»ŽWorkersèŽ·å–é…ç½®æ—¶åŒ…å«åˆ†æ®µè®¾ç½®
- ä¼ é€’ç»™SimpleStreamManager

### 2. å½•åˆ¶å‘½ä»¤æž„å»ºï¼ˆä¸¤æ­¥æ³•ï¼‰

ç”±äºŽFFmpeg segmentåœ¨åˆ‡åˆ†æ—¶æ— æ³•é¢„çŸ¥ç»“æŸæ—¶é—´ï¼Œéœ€è¦é‡‡ç”¨**ä¸¤æ­¥æ³•**ï¼š

**æ­¥éª¤1ï¼šå½•åˆ¶æ—¶ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å**
```javascript
buildRecordingCommand(channelId, channelName, config) {
  const baseCommand = [...];  // HLSè¾“å‡ºéƒ¨åˆ†
  
  if (config.segmentEnabled) {
    // åˆ†æ®µå½•åˆ¶ - å…ˆç”¨ä¸´æ—¶æ–‡ä»¶å
    const segmentSeconds = config.segmentDuration * 60;
    const dateStr = moment().format('YYYYMMDD');
    
    // ä¸´æ—¶æ–‡ä»¶åï¼š{é¢‘é“å}_{é¢‘é“ID}_{æ—¥æœŸ}_temp_%03d.mp4
    const tempFilename = `${channelName}_${channelId}_${dateStr}_temp_%03d.mp4`;
    const outputDir = path.join(config.storagePath, channelId, dateStr);
    const outputPath = path.join(outputDir, tempFilename);
    
    // ç¡®ä¿ç›®å½•å­˜åœ¨
    fs.mkdirSync(outputDir, { recursive: true });
    
    baseCommand.push(
      '-c:v', 'copy', '-c:a', 'copy',
      '-f', 'segment',
      '-segment_time', segmentSeconds,
      '-segment_format', 'mp4',
      '-reset_timestamps', '1',
      outputPath
    );
  } else {
    // å•æ–‡ä»¶å½•åˆ¶ï¼ˆä¿æŒçŽ°æœ‰é€»è¾‘ï¼‰
    const outputPath = buildSingleFilePath(channelId, channelName, config);
    baseCommand.push(
      '-c:v', 'copy', '-c:a', 'copy',
      '-f', 'mp4',
      outputPath
    );
  }
  
  return baseCommand;
}
```

**æ­¥éª¤2ï¼šå½•åˆ¶å®ŒæˆåŽé‡å‘½åæ–‡ä»¶**
```javascript
async renameSegmentFiles(channelId, channelName, recordConfig, sessionStartTime) {
  const dateStr = moment().format('YYYYMMDD');
  const outputDir = path.join(recordConfig.storagePath, channelId, dateStr);
  
  // æŸ¥æ‰¾æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
  const tempFiles = fs.readdirSync(outputDir)
    .filter(f => f.includes('_temp_'))
    .sort();
  
  for (let i = 0; i < tempFiles.length; i++) {
    const tempFile = tempFiles[i];
    const tempPath = path.join(outputDir, tempFile);
    
    // è®¡ç®—æ¯æ®µçš„å¼€å§‹å’Œç»“æŸæ—¶é—´
    const startTime = sessionStartTime.clone().add(i * recordConfig.segmentDuration, 'minutes');
    const endTime = i === tempFiles.length - 1 
      ? moment()  // æœ€åŽä¸€æ®µä½¿ç”¨å½“å‰æ—¶é—´
      : startTime.clone().add(recordConfig.segmentDuration, 'minutes');
    
    // ç”Ÿæˆæ­£å¼æ–‡ä»¶åï¼š{é¢‘é“å}_{é¢‘é“ID}_{æ—¥æœŸ}_{å¼€å§‹æ—¶é—´}_to_{ç»“æŸæ—¶é—´}.mp4
    const startTimeStr = startTime.format('HHmmss');
    const endTimeStr = endTime.format('HHmmss');
    const finalFilename = `${channelName}_${channelId}_${dateStr}_${startTimeStr}_to_${endTimeStr}.mp4`;
    const finalPath = path.join(outputDir, finalFilename);
    
    // é‡å‘½å
    fs.renameSync(tempPath, finalPath);
    logger.info(`Renamed segment: ${tempFile} â†’ ${finalFilename}`);
  }
}
```

**æ­¥éª¤3ï¼šé‡å‘½åè§¦å‘æ—¶æœº**

é‡å‘½åæ“ä½œåœ¨ä»¥ä¸‹æ—¶æœºæ‰§è¡Œï¼š

1. **å½•åˆ¶æ­£å¸¸ç»“æŸæ—¶**
   - RecordScheduleræ£€æµ‹åˆ°ç»“æŸæ—¶é—´å·²åˆ°
   - åœæ­¢FFmpegè¿›ç¨‹
   - è°ƒç”¨`renameSegmentFiles()`é‡å‘½åæ‰€æœ‰ä¸´æ—¶æ–‡ä»¶

2. **è¿›ç¨‹æ„å¤–ä¸­æ–­æ—¶**
   - SimpleStreamManageræ£€æµ‹åˆ°FFmpegè¿›ç¨‹é€€å‡º
   - å¦‚æžœæœ‰ä¸´æ—¶æ–‡ä»¶å­˜åœ¨ï¼Œè‡ªåŠ¨é‡å‘½å
   - ç¡®ä¿å·²å½•åˆ¶çš„å†…å®¹ä¸ä¸¢å¤±

3. **æ‰‹åŠ¨åœæ­¢å½•åˆ¶æ—¶**
   - ç”¨æˆ·æ‰‹åŠ¨åœæ­¢å½•åˆ¶
   - åŒæ ·è°ƒç”¨é‡å‘½åé€»è¾‘

**ç”Ÿæˆæµç¨‹ç¤ºä¾‹**ï¼š
```
å½•åˆ¶ä¸­ï¼š
  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_temp_001.mp4 (æ­£åœ¨å†™å…¥)
  
æ®µç»“æŸï¼š
  temp_001.mp4 (å·²å®Œæˆ) â†’ 073000_to_083000.mp4 (é‡å‘½å)
  temp_002.mp4 (æ­£åœ¨å†™å…¥)
  
å½•åˆ¶ç»“æŸï¼š
  temp_002.mp4 (å·²å®Œæˆ) â†’ 083000_to_093000.mp4
  temp_003.mp4 (å·²å®Œæˆ) â†’ 093000_to_100000.mp4
```

**æœ€ç»ˆæ–‡ä»¶ç¤ºä¾‹ï¼ˆé€šè¿‡å¼€å…³æŽ§åˆ¶ï¼‰**ï¼š

**å¼€å…³æ‰“å¼€ï¼ˆsegmentEnabled: trueï¼‰** â†’ ç”Ÿæˆå¤šä¸ªåˆ†æ®µæ–‡ä»¶
```
äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_073000_to_083000.mp4  (ç‹¬ç«‹æ–‡ä»¶)
äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_083000_to_093000.mp4  (ç‹¬ç«‹æ–‡ä»¶)
äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_093000_to_100000.mp4  (ç‹¬ç«‹æ–‡ä»¶)
```

**å¼€å…³å…³é—­ï¼ˆsegmentEnabled: falseï¼‰** â†’ ç”Ÿæˆå•ä¸ªå®Œæ•´æ–‡ä»¶ï¼ˆçŽ°æœ‰æ–¹å¼ï¼‰
```
äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_074000_to_172500.mp4  (å•ä¸ªå¤§æ–‡ä»¶)
```

**é‡è¦è¯´æ˜Ž**ï¼š
- âœ… åˆ†æ®µæ–‡ä»¶ä¿æŒç‹¬ç«‹ï¼Œ**ä¸ä¼šåˆå¹¶**
- âœ… æ¯æ®µéƒ½å¯ä»¥å•ç‹¬æ’­æ”¾ã€ä¸‹è½½ã€åˆ é™¤
- âœ… é€šè¿‡ç³»ç»Ÿè®¾ç½®ä¸­çš„**ä¸€ä¸ªå¼€å…³**æŽ§åˆ¶æ˜¯å¦åˆ†æ®µ
- âœ… å¼€å…³é»˜è®¤å…³é—­ï¼Œä¿æŒçŽ°æœ‰è¡Œä¸º

### 3. æ–‡ä»¶åˆ‡æ¢æœºåˆ¶

**åˆ‡æ¢æ—¶æœº**ï¼š
- FFmpegæ£€æŸ¥æ¯ä¸ªå…³é”®å¸§ï¼ˆIå¸§ï¼‰
- å½“å‰æ®µæ—¶é•¿è¾¾åˆ°segment_timeæ—¶
- è‡ªåŠ¨ç»“æŸå½“å‰æ–‡ä»¶ï¼Œå¼€å§‹æ–°æ–‡ä»¶

**æ—¶é—´æˆ³å¤„ç†**ï¼š
- `reset_timestamps=1`ï¼šæ¯æ®µä»Ž0å¼€å§‹
- ä¿è¯æ¯æ®µå¯ç‹¬ç«‹æ’­æ”¾

---

## ðŸ“ æ–‡ä»¶å‘½åè§„èŒƒï¼ˆå»¶ç»­çŽ°æœ‰è§„åˆ™ï¼‰

### çŽ°æœ‰çš„å•æ–‡ä»¶å‘½åè§„åˆ™

**æ ¼å¼**ï¼š`{é¢‘é“å}_{é¢‘é“ID}_{æ—¥æœŸ}_{å¼€å§‹æ—¶é—´}_to_{ç»“æŸæ—¶é—´}.mp4`

**ç¤ºä¾‹**ï¼š
```
äºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251028_074000_to_172500.mp4
```

### åˆ†æ®µæ–‡ä»¶å‘½åï¼ˆå®Œå…¨å»¶ç»­çŽ°æœ‰è§„åˆ™ï¼‰

**æ ¼å¼**ï¼š`{é¢‘é“å}_{é¢‘é“ID}_{æ—¥æœŸ}_{æ®µå¼€å§‹æ—¶é—´}_to_{æ®µç»“æŸæ—¶é—´}.mp4`

å…¶ä¸­ï¼š
- `{é¢‘é“å}`ï¼šé¢‘é“ä¸­æ–‡åç§°
- `{é¢‘é“ID}`ï¼šé¢‘é“å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚stream_gkg5hkncï¼‰
- `{æ—¥æœŸ}`ï¼šå½•åˆ¶æ—¥æœŸï¼ˆYYYYMMDDï¼‰
- `{æ®µå¼€å§‹æ—¶é—´}`ï¼šå½“å‰æ®µå®žé™…å¼€å§‹æ—¶é—´ï¼ˆHHMMSSï¼‰
- `{æ®µç»“æŸæ—¶é—´}`ï¼šå½“å‰æ®µå®žé™…ç»“æŸæ—¶é—´ï¼ˆHHMMSSï¼‰

**å¯¹æ¯”å•æ–‡ä»¶å‘½å**ï¼š
```
å•æ–‡ä»¶ï¼šäºŒæ¥¼æ•™å®¤1_stream_ensxma2g_20251028_074000_to_172500.mp4
åˆ†æ®µï¼š  äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_073000_to_083000.mp4
```
**è§„åˆ™å®Œå…¨ä¸€è‡´ï¼** å”¯ä¸€åŒºåˆ«æ˜¯åˆ†æ®µæ–‡ä»¶çš„æ—¶é—´è·¨åº¦æ›´å°ï¼ˆå¦‚1å°æ—¶ï¼‰ã€‚

**ç¤ºä¾‹**ï¼ˆå½•åˆ¶æ—¶é—´7:30-10:00ï¼Œ1å°æ—¶åˆ†æ®µï¼‰ï¼š

```
äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_073000_to_083000.mp4  â† ç¬¬1æ®µ 07:30-08:30
äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_083000_to_093000.mp4  â† ç¬¬2æ®µ 08:30-09:30
äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_093000_to_100000.mp4  â† ç¬¬3æ®µ 09:30-10:00ï¼ˆæœ€åŽä¸€æ®µï¼‰
```

### ç›®å½•ç»“æž„ï¼ˆä¿æŒä¸å˜ï¼‰

```
/srv/filebrowser/yoyo-k/
â””â”€â”€ stream_gkg5hknc/
    â””â”€â”€ 20251029/
        â”œâ”€â”€ äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_073000_to_083000.mp4
        â”œâ”€â”€ äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_083000_to_093000.mp4
        â”œâ”€â”€ äºŒæ¥¼æ•™å®¤2_stream_gkg5hknc_20251029_093000_to_100000.mp4
        â””â”€â”€ ...
```

### å‘½åè§„åˆ™ä¼˜åŠ¿

âœ… **100%å»¶ç»­çŽ°æœ‰è§„èŒƒ**ï¼šä¸Žå•æ–‡ä»¶å‘½åè§„åˆ™å®Œå…¨ä¸€è‡´  
âœ… **æ—¶é—´ç›´è§‚**ï¼šæ¯ä¸ªæ–‡ä»¶åç›´æŽ¥æ˜¾ç¤ºå½•åˆ¶çš„æ—¶é—´æ®µ  
âœ… **å¯è¯»æ€§å¥½**ï¼šåŒ…å«ä¸­æ–‡é¢‘é“åå’Œå®Œæ•´æ—¶é—´ä¿¡æ¯  
âœ… **å”¯ä¸€æ€§å¼º**ï¼šé¢‘é“IDé¿å…å†²çª  
âœ… **æ˜“äºŽæ£€ç´¢**ï¼šæƒ³çœ‹8ç‚¹åˆ°9ç‚¹çš„å†…å®¹ï¼Ÿç›´æŽ¥æ‰¾`083000_to_093000.mp4`  
âœ… **è‡ªç„¶æŽ’åº**ï¼šæŒ‰æ—¶é—´è‡ªåŠ¨æŽ’åº

---

## ðŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

### 1. FFmpeg Segmentç‰¹æ€§

- âœ… ä¸é‡å¯è¿›ç¨‹ï¼šæ•´ä¸ªå½•åˆ¶æœŸé—´æŒç»­è¿è¡Œ
- âœ… ä¸ä¸¢å¸§ï¼šåˆ‡æ¢æ—¶æ— å¸§ä¸¢å¤±
- âœ… ç²¾ç¡®åˆ‡åˆ†ï¼šæŒ‰Iå¸§åˆ‡åˆ†
- âœ… æ—¶é—´å‡†ç¡®ï¼šä½¿ç”¨å…³é”®å¸§æ—¶é—´æˆ³

### 2. åŒè¾“å‡ºç‹¬ç«‹æ€§

```
FFmpegè¿›ç¨‹
  â”œâ”€â”€ HLS Muxer â†’ playlist.m3u8ï¼ˆè§‚çœ‹ï¼‰
  â””â”€â”€ Segment Muxer â†’ file_001.mp4, file_002.mp4ï¼ˆå½•åˆ¶ï¼‰
```

ç‹¬ç«‹bufferå’ŒI/Oçº¿ç¨‹ï¼Œäº’ä¸å½±å“ã€‚

### 3. å®¹é”™å¤„ç†

**å¼‚å¸¸åœºæ™¯**ï¼š
- **ç£ç›˜ç©ºé—´ä¸è¶³**ï¼šå·²å†™å…¥çš„æ®µä¿æŒå®Œæ•´
- **è¿›ç¨‹å´©æºƒ**ï¼šä¹‹å‰çš„æ®µå®Œå…¨æ­£å¸¸ï¼Œæœ€åŽä¸€æ®µå¯èƒ½ä¸å®Œæ•´
- **æ–‡ä»¶æƒé™é—®é¢˜**ï¼šå¯åŠ¨å‰æ£€æŸ¥ç›®å½•æƒé™

---

## ðŸ“Š å½±å“åˆ†æž

### å¯¹çŽ°æœ‰åŠŸèƒ½çš„å½±å“

| åŠŸèƒ½æ¨¡å— | å½±å“ | è¯´æ˜Ž |
|---------|------|------|
| ç”¨æˆ·è§‚çœ‹ | æ— å½±å“ | HLSè¾“å‡ºç‹¬ç«‹ |
| è½¬ç è¿›ç¨‹ | æ— å½±å“ | è¿›ç¨‹æŒç»­è¿è¡Œ |
| å½•åˆ¶è°ƒåº¦ | éœ€é€‚é… | æ”¯æŒåˆ†æ®µé…ç½® |
| æ–‡ä»¶æ¸…ç† | éœ€é€‚é… | è¯†åˆ«åˆ†æ®µæ–‡ä»¶ |

### æ€§èƒ½å½±å“

- **CPUä½¿ç”¨**ï¼šå¢žåŠ  < 1%
- **å†…å­˜ä½¿ç”¨**ï¼šå¢žåŠ  < 10MB
- **ç£ç›˜I/O**ï¼šåˆ‡æ¢æ—¶çŸ­æš‚å³°å€¼ï¼ˆ< 1ç§’ï¼‰
- **ç½‘ç»œå¸¦å®½**ï¼šæ— å½±å“

### ç”¨æˆ·ä½“éªŒ

**è§‚çœ‹ç«¯**ï¼šå®Œå…¨æ— æ„ŸçŸ¥ï¼Œæ— å¡é¡¿  
**ç®¡ç†ç«¯**ï¼šæ›´çµæ´»çš„æ–‡ä»¶ç®¡ç†  
**å­˜å‚¨**ï¼šé™ä½Žé£Žé™©ï¼Œå•ä¸ªæ–‡ä»¶æŸåä¸å½±å“å…¶ä»–æ®µ

---

## âš ï¸ é£Žé™©è¯„ä¼°

| é£Žé™©é¡¹ | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æŽªæ–½ |
|--------|--------|------|----------|
| æ–‡ä»¶åˆ‡æ¢æ—¶å¡é¡¿ | ä½Ž | ä½Ž | FFmpegåŽŸç”Ÿæ”¯æŒ |
| ç£ç›˜I/OåŽ‹åŠ› | ä½Ž | ä¸­ | ä½¿ç”¨SSD |
| æœ€åŽä¸€æ®µä¸å®Œæ•´ | ä¸­ | ä½Ž | æ­£å¸¸æƒ…å†µ |
| ç”¨æˆ·ä¸ç†è§£åˆ†æ®µ | ä¸­ | ä½Ž | UIè¯´æ˜Žæ¸…æ™° |

---

## ðŸ“… å®žæ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆ1-2å¤©ï¼‰

1. **å‰ç«¯UIæ‰©å±•**ï¼ˆ3å°æ—¶ï¼‰
   - ä¿®æ”¹`SystemSettingsDialog.vue`ï¼Œæ·»åŠ å½•åˆ¶åˆ†æ®µé…ç½®åŒºåŸŸ
   - åœ¨formä¸­æ·»åŠ `segmentEnabled`å’Œ`segmentDuration`å­—æ®µ
   - æ·»åŠ åˆ†æ®µæ—¶é•¿è¾“å…¥æ¡†å’Œé¢„è®¾æŒ‰é’®
   - å¤ç”¨çŽ°æœ‰çš„ä¿å­˜å’Œå–æ¶ˆé€»è¾‘

2. **Workers APIæ‰©å±•**ï¼ˆ2å°æ—¶ï¼‰
   - ä¿®æ”¹`/api/admin/cleanup/config`ç«¯ç‚¹
   - åœ¨é…ç½®æ•°æ®ç»“æž„ä¸­æ–°å¢žä¸¤ä¸ªå­—æ®µ
   - æ·»åŠ å­—æ®µéªŒè¯ï¼ˆsegmentDurationèŒƒå›´10-240ï¼‰
   - å‘åŽå…¼å®¹å¤„ç†ï¼ˆæ—§æ•°æ®å¡«å……é»˜è®¤å€¼ï¼‰

3. **VPSå½•åˆ¶é€»è¾‘**ï¼ˆ5å°æ—¶ï¼‰
   - SimpleStreamManagerçš„`buildRecordingCommand`æ–¹æ³•æ”¯æŒåˆ†æ®µ
   - ä¿®æ”¹å‘½ä»¤æž„å»ºé€»è¾‘ï¼Œä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å
   - å®žçŽ°`renameSegmentFiles`æ–¹æ³•ï¼Œå½•åˆ¶ç»“æŸåŽé‡å‘½å
   - åœ¨å½•åˆ¶ç»“æŸã€è¿›ç¨‹ä¸­æ–­ã€æ‰‹åŠ¨åœæ­¢æ—¶è§¦å‘é‡å‘½å
   - æ·»åŠ é…ç½®æ—¥å¿—è¾“å‡ºå’Œé‡å‘½åæ—¥å¿—

4. **æµ‹è¯•éªŒè¯**ï¼ˆ2å°æ—¶ï¼‰
   - å¯åŠ¨åˆ†æ®µå½•åˆ¶
   - éªŒè¯æ–‡ä»¶åˆ‡æ¢æ— å¡é¡¿
   - æ£€æŸ¥æ¯æ®µæ–‡ä»¶å¯ç‹¬ç«‹æ’­æ”¾
   - éªŒè¯ç”¨æˆ·è§‚çœ‹æ— å½±å“

### ç¬¬äºŒé˜¶æ®µï¼šåŠŸèƒ½å®Œå–„ï¼ˆ1å¤©ï¼‰

1. **æ–‡ä»¶æ¸…ç†é€‚é…**ï¼ˆ3å°æ—¶ï¼‰
2. **ç›‘æŽ§å’Œæ—¥å¿—**ï¼ˆ2å°æ—¶ï¼‰
3. **æ–‡æ¡£æ›´æ–°**ï¼ˆ1å°æ—¶ï¼‰

### ç¬¬ä¸‰é˜¶æ®µï¼šç”Ÿäº§éƒ¨ç½²ï¼ˆåŠå¤©ï¼‰

1. **é¢„å‘å¸ƒæµ‹è¯•**ï¼ˆ2å°æ—¶ï¼‰
2. **ç”Ÿäº§éƒ¨ç½²**ï¼ˆ1å°æ—¶ï¼‰
3. **ä¸Šçº¿ç›‘æŽ§**ï¼ˆ1å°æ—¶ï¼‰

---

## ðŸ“– å‚è€ƒèµ„æ–™

- [FFmpeg Segment Muxeræ–‡æ¡£](https://ffmpeg.org/ffmpeg-formats.html#segment)
- HLS Segmentationï¼šç±»ä¼¼çš„åˆ†æ®µæŠ€æœ¯
- ç”Ÿäº§çŽ¯å¢ƒéªŒè¯ï¼šFFmpeg segmentå·²åœ¨å…¨çƒæ•°ç™¾ä¸‡æœåŠ¡å™¨ä¸Šè¿è¡Œ

---

## âœ… è¯„å®¡è¦ç‚¹

è¯·é‡ç‚¹è¯„å®¡ä»¥ä¸‹æ–¹é¢ï¼š

1. **æŠ€æœ¯æ–¹æ¡ˆå¯è¡Œæ€§**ï¼šFFmpeg segmentæ˜¯å¦é€‚åˆï¼Ÿ
2. **ç”¨æˆ·ä½“éªŒå½±å“**ï¼šæ˜¯å¦çœŸçš„ä¸å½±å“è§‚çœ‹ï¼Ÿ
3. **æ–‡ä»¶å‘½åè§„èŒƒ**ï¼šæ˜¯å¦åˆç†æ˜“æ‡‚ï¼Ÿ
4. **é£Žé™©æŽ§åˆ¶**ï¼šæ˜¯å¦æœ‰é—æ¼çš„é£Žé™©ç‚¹ï¼Ÿ
5. **å®žæ–½è®¡åˆ’**ï¼šæ—¶é—´ä¼°ç®—æ˜¯å¦åˆç†ï¼Ÿ

**è¯„å®¡é€šè¿‡åŽå³å¯å¼€å§‹å®žæ–½å¼€å‘å·¥ä½œã€‚**
