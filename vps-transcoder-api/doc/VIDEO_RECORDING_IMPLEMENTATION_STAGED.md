# ğŸ”§ è§†é¢‘å½•åˆ¶åŠŸèƒ½å®æ–½æ–¹æ¡ˆ - é˜¶æ®µåŒ–æ‰§è¡Œæ–‡æ¡£

**ç‰ˆæœ¬**: v1.0 | **åˆ›å»ºæ—¶é—´**: 2025-10-24 22:40  
**åŸºäº**: VIDEO_RECORDING_SOLUTION.md v1.1

---

## ğŸ“– æ–‡æ¡£ä½¿ç”¨è¯´æ˜

### **é‡è¦åŸåˆ™**

âš ï¸ **æœ¬æ–‡æ¡£é‡‡ç”¨é˜¶æ®µåŒ–æ‰§è¡Œç­–ç•¥** - æ¯ä¸ªé˜¶æ®µå®Œæˆåå¿…é¡»éªŒè¯é€šè¿‡æ‰èƒ½ç»§ç»­

**ğŸš¨ æ‰§è¡Œçºªå¾‹ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰**ï¼š
1. âœ… **ç»å¯¹ç¦æ­¢è·³æ­¥** - å¿…é¡»å®Œæˆå½“å‰é˜¶æ®µçš„æ‰€æœ‰æ­¥éª¤ï¼ˆä¿®æ”¹â†’éƒ¨ç½²â†’éªŒè¯â†’æ›´æ–°çŠ¶æ€ï¼‰åæ‰èƒ½è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
2. âœ… **éªŒè¯æ˜¯å¼ºåˆ¶æ€§çš„** - å³ä½¿ä»£ç çœ‹èµ·æ¥æ­£ç¡®ï¼Œä¹Ÿå¿…é¡»æ‰§è¡ŒéªŒè¯æ­¥éª¤ç¡®è®¤åŠŸèƒ½æ­£å¸¸
3. âœ… **éªŒè¯å¤±è´¥å¿…é¡»å›æ»š** - ä½¿ç”¨å¤‡ä»½æ–‡ä»¶æ¢å¤ï¼Œä¸èƒ½å¸¦ç€é—®é¢˜ç»§ç»­
4. âœ… **æ¯æ­¥æ›´æ–°è¿›åº¦è¡¨** - åœ¨ä¸‹æ–¹è¿›åº¦è¡¨ä¸­å®æ—¶æ ‡è®°å½“å‰çŠ¶æ€
5. âœ… **é‡åˆ°é—®é¢˜ç«‹å³åœæ­¢** - ä¸è¦ç»§ç»­æ‰§è¡Œåç»­é˜¶æ®µ

**ä¸ºä»€ä¹ˆè¦é˜¶æ®µåŒ–**ï¼š
- ğŸ”´ æœ¬æ¬¡å®æ–½æ¶‰åŠçº¦15ä¸ªæ–‡ä»¶ã€1000+è¡Œä»£ç 
- ğŸ”´ ä¸€æ¬¡æ€§ä¿®æ”¹é£é™©æé«˜ï¼Œéš¾ä»¥å®šä½é—®é¢˜
- âœ… åˆ†é˜¶æ®µæ‰§è¡Œå¯ä»¥åŠæ—¶å‘ç°å’Œä¿®å¤é—®é¢˜
- âœ… æ¯ä¸ªé˜¶æ®µéƒ½å¯ç‹¬ç«‹å›æ»šï¼Œå½±å“èŒƒå›´å°

**AIæ‰§è¡Œè€…æ³¨æ„**ï¼š
- ğŸ“ **æ¯å®Œæˆä¸€ä¸ªé˜¶æ®µï¼Œå¿…é¡»æ›´æ–°ä¸‹æ–¹è¿›åº¦è¡¨**
- ğŸ“ **åœ¨çŠ¶æ€åˆ—æ ‡è®° âœ… å¹¶å¡«å†™å®Œæˆæ—¶é—´**
- ğŸ“ **å¦‚æœéªŒè¯å¤±è´¥ï¼Œæ ‡è®° âŒ å¹¶è¯´æ˜åŸå› **

---

## ğŸ“Š æ‰§è¡Œè¿›åº¦è¿½è¸ª

### **æ€»ä½“è¿›åº¦**: 0/7 é˜¶æ®µå®Œæˆ

| é˜¶æ®µ | åç§° | çŠ¶æ€ | å®Œæˆæ—¶é—´ | éªŒè¯ç»“æœ |
|------|------|------|----------|---------|
| **å‡†å¤‡** | ç¯å¢ƒé…ç½®å’Œæ–‡ä»¶å¤‡ä»½ | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ1** | D1æ•°æ®åº“è®¾è®¡å’ŒAPI | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ2** | SimpleStreamManageræ ¸å¿ƒæ”¹é€  | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ3** | åˆ†æ®µå½•åˆ¶å’Œæ–‡ä»¶ç®¡ç† | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ4** | è‡ªåŠ¨ä¿®å¤æœºåˆ¶ | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ5** | å‰ç«¯ç®¡ç†ç•Œé¢ | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ6** | å®šæ—¶ä»»åŠ¡å’Œæ¸…ç† | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ7** | å®Œæ•´é›†æˆæµ‹è¯• | â³ æœªå¼€å§‹ | - | - |

**çŠ¶æ€å›¾ä¾‹**ï¼šâ³ æœªå¼€å§‹ | ğŸ”„ è¿›è¡Œä¸­ | âœ… å·²å®Œæˆ | âŒ éªŒè¯å¤±è´¥ | ğŸ”™ å·²å›æ»š

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

### **æ ¸å¿ƒéœ€æ±‚**
1. **å½•åˆ¶æ§åˆ¶**: ç®¡ç†å‘˜å¯å¯ç”¨/ç¦ç”¨é¢‘é“å½•åˆ¶
2. **å®šæ—¶å½•åˆ¶**: é»˜è®¤æ—¶é—´ 7:50-17:20ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
3. **åˆ†æ®µå½•åˆ¶**: æ¯1å°æ—¶ä¸€ä¸ªMP4æ–‡ä»¶
4. **è‡ªåŠ¨æ¸…ç†**: ä¿ç•™2å¤©ï¼Œå‡Œæ™¨3ç‚¹è‡ªåŠ¨åˆ é™¤
5. **æ–‡ä»¶ä¸‹è½½**: é€šè¿‡FileBrowserè®¿é—®å½•åƒ

### **å…³é”®æŠ€æœ¯å†³ç­–**

#### 1. FFmpegè¿›ç¨‹å¤ç”¨ â­
- **ç­–ç•¥**: ä¸€ä¸ªFFmpegè¿›ç¨‹åŒæ—¶è¾“å‡ºHLSå’ŒMP4
- **ä¼˜åŠ¿**: CPUä»…å¢åŠ 30%ï¼ŒèŠ‚çœ50%èµ„æº
- **æƒè¡¡**: ä¿®æ”¹é…ç½®éœ€è¦é‡å¯è¿›ç¨‹ï¼ˆå½±å“è§‚çœ‹ç”¨æˆ·7ç§’ï¼‰

#### 2. D1æ•°æ®åº“è®¿é—® â­
- **é™åˆ¶**: VPSæ— æ³•ç›´æ¥è®¿é—®D1ï¼Œå¿…é¡»é€šè¿‡Workers API
- **è§„èŒƒ**: 
  - ğŸ–¥ï¸ VPSç«¯ä»£ç ï¼šé€šè¿‡HTTP APIè®¿é—®
  - â˜ï¸ Workersç«¯ä»£ç ï¼šç›´æ¥ä½¿ç”¨`env.RECORDING_DB`

#### 3. åˆ†æ®µå½•åˆ¶ â­
- **ç­–ç•¥**: æ¯1å°æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°æ–‡ä»¶
- **ä¼˜åŠ¿**: è¿›ç¨‹å´©æºƒæœ€å¤šæŸå¤±1å°æ—¶ï¼Œå…¶ä»–æ®µå®Œå¥½
- **å®ç°**: FFmpeg `-f segment` å‚æ•°

#### 4. è‡ªåŠ¨ä¿®å¤ â­
- **ç­–ç•¥**: æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤æŸåæ–‡ä»¶
- **ä¸‰çº§ä¿®å¤**: æ ‡å‡†ä¿®å¤ â†’ å¼ºåˆ¶é‡å»º â†’ æå–æ•°æ®
- **æˆåŠŸç‡**: æ­£å¸¸åœæ­¢99%ï¼Œå´©æºƒ85%ï¼Œæ–­ç”µ60%

### **æ–‡ä»¶å‘½åè§„åˆ™**
- **æ ¼å¼**: `YYYY-MM-DD_HH-MM_HH-MM.mp4`
- **ç¤ºä¾‹**: `2025-10-22_07-50_08-50.mp4`
- **è¯´æ˜**: å¼€å§‹æ—¶é—´_ç»“æŸæ—¶é—´

---

## ğŸ¯ å‡†å¤‡é˜¶æ®µï¼šç¯å¢ƒé…ç½®å’Œæ–‡ä»¶å¤‡ä»½

âš ï¸ **åœ¨å¼€å§‹ä»»ä½•ä¿®æ”¹å‰ï¼Œå¿…é¡»å…ˆå®Œæˆå‡†å¤‡å·¥ä½œï¼**

**ç›®æ ‡**ï¼šé…ç½®ç¯å¢ƒå˜é‡ï¼Œåˆ›å»ºD1æ•°æ®åº“ï¼Œå¤‡ä»½å…³é”®æ–‡ä»¶  
**å½±å“èŒƒå›´**ï¼šå…¨å±€é…ç½®  
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½  
**é¢„è®¡æ—¶é—´**ï¼š30åˆ†é’Ÿ

### å‡†å¤‡1ï¼šåˆ›å»ºD1æ•°æ®åº“

```bash
# 1. åˆ›å»ºD1æ•°æ®åº“
cd cloudflare-worker
npx wrangler d1 create yoyo-recordings

# 2. è®°å½•è¿”å›çš„database_id
# 3. æ›´æ–°wrangler.tomlæ·»åŠ ç»‘å®šï¼ˆè§å‡†å¤‡2ï¼‰
```

### å‡†å¤‡2ï¼šé…ç½®ç¯å¢ƒå˜é‡

**Workers (wrangler.toml)**:
```toml
# åœ¨[env.production]éƒ¨åˆ†æ·»åŠ 
RECORDING_ENABLED = "true"
RECORDING_DEFAULT_RETENTION_DAYS = "2"
RECORDING_CLEANUP_HOUR = "3"
RECORDING_MAX_SEGMENT_DURATION = "7200"

# æ·»åŠ D1æ•°æ®åº“ç»‘å®š
[[d1_databases]]
binding = "RECORDING_DB"
database_name = "yoyo-recordings"
database_id = "<your-database-id>"
```

**VPS (.env)**:
```bash
# SSHåˆ°VPSåç¼–è¾‘ /opt/yoyo-transcoder/.env
RECORDINGS_BASE_DIR=/var/recordings
RECORDINGS_CLEANUP_HOUR=3
RECORDINGS_RETENTION_DAYS=2
RECORDINGS_SEGMENT_DURATION=3600
WORKERS_API_URL=https://yoyoapi.5202021.xyz
```

### å‡†å¤‡3ï¼šå¤‡ä»½æ–‡ä»¶

```powershell
cd D:\é¡¹ç›®æ–‡ä»¶\yoyo-kindergarten\code\secure-streaming-platform\vps-transcoder-api

# åˆ›å»ºå¤‡ä»½ç›®å½•
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
New-Item -Path "backups\$timestamp" -ItemType Directory -Force

# å¤‡ä»½å…³é”®æ–‡ä»¶
Copy-Item "vps-transcoder-api\src\services\SimpleStreamManager.js" "backups\$timestamp\"
Copy-Item "vps-transcoder-api\src\routes\simple-stream.js" "backups\$timestamp\"
Copy-Item "cloudflare-worker\src\index.js" "backups\$timestamp\"
Copy-Item "cloudflare-worker\wrangler.toml" "backups\$timestamp\"
```

### å‡†å¤‡4ï¼šåˆ›å»ºVPSå½•åˆ¶ç›®å½•

```bash
# SSHåˆ°VPS
ssh root@142.171.75.220

# åˆ›å»ºç›®å½•
mkdir -p /var/recordings
mkdir -p /var/log/recordings
chmod 755 /var/recordings /var/log/recordings

# éªŒè¯ç£ç›˜ç©ºé—´
df -h /var
```

### å‡†å¤‡5ï¼šéªŒè¯æ¸…å•

- [ ] D1æ•°æ®åº“å·²åˆ›å»º
- [ ] wrangler.tomlå·²æ›´æ–°ç»‘å®š
- [ ] Workersç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] VPSç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] å…³é”®æ–‡ä»¶å·²å¤‡ä»½
- [ ] VPSå½•åˆ¶ç›®å½•å·²åˆ›å»º
- [ ] ç£ç›˜ç©ºé—´ > 200GB

âœ… å®Œæˆåæ›´æ–°è¿›åº¦è¡¨

---

## ğŸ¯ é˜¶æ®µ1ï¼šD1æ•°æ®åº“è®¾è®¡å’ŒWorkers API

**ç›®æ ‡**ï¼šåˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„ï¼Œå®ç°Workersç«¯D1è®¿é—®API  
**å½±å“èŒƒå›´**ï¼šcloudflare-worker/ (3ä¸ªæ–‡ä»¶)  
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­  
**é¢„è®¡æ—¶é—´**ï¼š60åˆ†é’Ÿ

### 1.1 åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„

**åˆ›å»ºæ–‡ä»¶**: `cloudflare-worker/schema.sql`

```sql
-- å½•åˆ¶é…ç½®è¡¨
CREATE TABLE IF NOT EXISTS recording_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  channel_id TEXT NOT NULL UNIQUE,
  enabled INTEGER DEFAULT 0,
  start_time TEXT DEFAULT '07:50',
  end_time TEXT DEFAULT '17:20',
  segment_duration INTEGER DEFAULT 3600,
  video_bitrate INTEGER DEFAULT 1500,
  retention_days INTEGER DEFAULT 2,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- å½•åˆ¶æ–‡ä»¶è¡¨
CREATE TABLE IF NOT EXISTS recording_files (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  channel_id TEXT NOT NULL,
  filename TEXT NOT NULL,
  file_path TEXT NOT NULL,
  start_time TEXT NOT NULL,
  end_time TEXT,
  file_size INTEGER DEFAULT 0,
  status TEXT DEFAULT 'recording',
  repair_attempts INTEGER DEFAULT 0,
  repair_status TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_configs_channel ON recording_configs(channel_id);
CREATE INDEX IF NOT EXISTS idx_files_channel ON recording_files(channel_id);
CREATE INDEX IF NOT EXISTS idx_files_status ON recording_files(status);
```

**æ‰§è¡ŒSQL**:
```bash
cd cloudflare-worker
npx wrangler d1 execute yoyo-recordings --file=schema.sql --env production
```

### 1.2 åˆ›å»ºrecordingHandler.js

**åˆ›å»ºæ–‡ä»¶**: `cloudflare-worker/src/handlers/recordingHandler.js`

è¿™ä¸ªæ–‡ä»¶å®ç°D1æ•°æ®åº“CRUDæ“ä½œã€‚æ ¸å¿ƒæ–¹æ³•ï¼š
- `getRecordingConfig()` - è·å–é¢‘é“å½•åˆ¶é…ç½®
- `updateRecordingConfig()` - æ›´æ–°å½•åˆ¶é…ç½®
- `createRecordingFile()` - åˆ›å»ºå½•åˆ¶æ–‡ä»¶è®°å½•
- `updateRecordingFile()` - æ›´æ–°æ–‡ä»¶çŠ¶æ€
- `getInterruptedRecordings()` - è·å–éœ€è¦ä¿®å¤çš„æ–‡ä»¶
- `getRecordingFiles()` - æŸ¥è¯¢å½•åˆ¶æ–‡ä»¶åˆ—è¡¨

**æ³¨æ„**: ç”±äºä»£ç è¾ƒé•¿ï¼Œå®Œæ•´å®ç°è§VIDEO_RECORDING_SOLUTION.mdç¬¬2200-2500è¡Œ

### 1.3 æ·»åŠ APIè·¯ç”±

**ä¿®æ”¹æ–‡ä»¶**: `cloudflare-worker/src/index.js`

åœ¨è·¯ç”±éƒ¨åˆ†æ·»åŠ ï¼š
```javascript
// å½•åˆ¶é…ç½®API
router.get('/api/recording/config/:channelId', recordingHandler.getRecordingConfig);
router.put('/api/recording/config/:channelId', recordingHandler.updateRecordingConfig);

// å½•åˆ¶æ–‡ä»¶API
router.post('/api/recording/files', recordingHandler.createRecordingFile);
router.patch('/api/recording/files/:id', recordingHandler.updateRecordingFile);
router.get('/api/recording/files/interrupted', recordingHandler.getInterruptedRecordings);
router.get('/api/recording/files', recordingHandler.getRecordingFiles);
```

### 1.4 éƒ¨ç½²Workers

```bash
cd cloudflare-worker
npx wrangler deploy --env production
```

### 1.5 éªŒè¯æµ‹è¯•

**æµ‹è¯•APIç«¯ç‚¹**:
```powershell
# æµ‹è¯•è·å–é…ç½®
$token = "YOUR_ADMIN_TOKEN"
Invoke-RestMethod -Uri "https://yoyoapi.5202021.xyz/api/recording/config/stream_xxx" `
  -Headers @{"Authorization"="Bearer $token"}

# æµ‹è¯•æ›´æ–°é…ç½®
$body = @{
  enabled = $true
  start_time = "07:50"
  end_time = "17:20"
} | ConvertTo-Json

Invoke-RestMethod -Uri "https://yoyoapi.5202021.xyz/api/recording/config/stream_xxx" `
  -Method PUT -Body $body -ContentType "application/json" `
  -Headers @{"Authorization"="Bearer $token"}
```

**éªŒè¯æ¸…å•**:
- [ ] D1è¡¨å·²åˆ›å»ºï¼ˆ3ä¸ªè¡¨ï¼Œ3ä¸ªç´¢å¼•ï¼‰
- [ ] recordingHandler.jså·²åˆ›å»º
- [ ] APIè·¯ç”±å·²æ·»åŠ 
- [ ] Workerséƒ¨ç½²æˆåŠŸ
- [ ] é…ç½®APIè¿”å›200
- [ ] æ–‡ä»¶APIè¿”å›200

**å¦‚æœéªŒè¯å¤±è´¥**: å›æ»šWorkerséƒ¨ç½²ï¼Œæ¢å¤index.jså¤‡ä»½

âœ… å®Œæˆåæ›´æ–°è¿›åº¦è¡¨

---

## ğŸ¯ é˜¶æ®µ2ï¼šSimpleStreamManageræ ¸å¿ƒæ”¹é€ 

**ç›®æ ‡**ï¼šæ‰©å±•SimpleStreamManageræ”¯æŒå½•åˆ¶åŠŸèƒ½  
**å½±å“èŒƒå›´**ï¼šSimpleStreamManager.js (1ä¸ªæ–‡ä»¶ï¼Œçº¦300è¡Œä»£ç )  
**é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š90åˆ†é’Ÿ

**å…³é”®æ”¹åŠ¨**ï¼š
1. `startWatching()` - æ·»åŠ optionså‚æ•°æ”¯æŒå½•åˆ¶é…ç½®
2. `spawnFFmpegProcess()` - æ”¯æŒHLS+MP4åŒè¾“å‡º
3. `cleanupIdleChannels()` - è·³è¿‡æ­£åœ¨å½•åˆ¶çš„é¢‘é“
4. æ–°å¢å½•åˆ¶å¿ƒè·³æœºåˆ¶

### 2.1 ä¿®æ”¹startWatchingæ–¹æ³•

**æ–‡ä»¶**: `vps-transcoder-api/src/services/SimpleStreamManager.js`

åœ¨ç°æœ‰æ–¹æ³•åŸºç¡€ä¸Šæ·»åŠ optionså‚æ•°ï¼ˆå‘åå…¼å®¹ï¼‰ï¼š

```javascript
async startWatching(channelId, rtmpUrl, options = {}) {
  // æ£€æŸ¥é…ç½®æ˜¯å¦å˜æ›´
  const existingChannel = this.activeStreams.get(channelId);
  if (existingChannel) {
    const recordingChanged = this.isRecordingConfigChanged(
      existingChannel.recordingConfig,
      options.recordingConfig
    );
    
    if (existingChannel.rtmpUrl !== rtmpUrl || recordingChanged) {
      await this.stopFFmpegProcess(channelId);
      return await this.startNewStream(channelId, rtmpUrl, options);
    }
    return existingChannel.hlsUrl;
  }
  
  return await this.startNewStream(channelId, rtmpUrl, options);
}
```

### 2.2 ä¿®æ”¹spawnFFmpegProcessæ–¹æ³•

**æ ¸å¿ƒä¿®æ”¹**ï¼šæ”¯æŒFFmpegå¤šè¾“å‡ºï¼ˆHLS + MP4åˆ†æ®µå½•åˆ¶ï¼‰

```javascript
async spawnFFmpegProcess(channelId, rtmpUrl, options = {}) {
  const ffmpegArgs = ['-i', rtmpUrl];
  
  if (options.recordingConfig?.enabled) {
    // è¾“å‡º1: HLSæµ
    ffmpegArgs.push(
      '-map', '0:v:0',
      '-c:v:0', 'libx264', '-preset:v:0', 'ultrafast', '-an',
      '-f', 'hls', '-hls_time', '2',
      // ... HLSå‚æ•°
    );
    
    // è¾“å‡º2: MP4åˆ†æ®µå½•åˆ¶
    const segmentDuration = options.recordingConfig.segment_duration || 3600;
    ffmpegArgs.push(
      '-map', '0:v:0',
      '-c:v:1', 'libx264', '-preset:v:1', 'medium', '-an',
      '-f', 'segment', '-segment_time', segmentDuration,
      '-strftime', '1',
      '-segment_filename', `/var/recordings/${channelId}/%Y-%m-%d_%H-%M_temp.mp4`
    );
  } else {
    // åªè¾“å‡ºHLSï¼ˆç°æœ‰é€»è¾‘ï¼‰
  }
  
  return spawn(this.ffmpegPath, ffmpegArgs, {env});
}
```

### 2.3 æ–°å¢è¾…åŠ©æ–¹æ³•

```javascript
// å½•åˆ¶å¿ƒè·³
setRecordingHeartbeat(channelId) { /* ... */ }
clearRecordingHeartbeat(channelId) { /* ... */ }
isRecordingConfigChanged(oldConfig, newConfig) { /* ... */ }
```

### 2.4 ä¿®æ”¹cleanupIdleChannels

```javascript
async cleanupIdleChannels() {
  for (const [channelId, lastHeartbeat] of this.channelHeartbeats) {
    const processInfo = this.activeStreams.get(channelId);
    
    // è·³è¿‡æ­£åœ¨å½•åˆ¶çš„é¢‘é“
    if (processInfo && processInfo.isRecording) continue;
    
    // æ­£å¸¸æ¸…ç†é€»è¾‘...
  }
}
```

### 2.5 éƒ¨ç½²åˆ°VPS

```bash
# æäº¤ä»£ç 
git add vps-transcoder-api/src/services/SimpleStreamManager.js
git commit -m "feat: SimpleStreamManageræ”¯æŒå½•åˆ¶åŠŸèƒ½"
git push

# éƒ¨ç½²åˆ°VPS
ssh root@142.171.75.220 "cd /tmp/github/secure-streaming-platform/vps-transcoder-api && ./vps-simple-deploy.sh"
```

### 2.6 éªŒè¯æµ‹è¯•

```bash
# æµ‹è¯•å¯åŠ¨å½•åˆ¶
curl -X POST https://yoyo-vps.5202021.xyz/api/simple-stream/start-watching \
  -H "X-API-Key: YOUR_KEY" \
  -d '{
    "channelId": "stream_xxx",
    "rtmpUrl": "rtmp://source/live",
    "options": {
      "recordingConfig": {"enabled": true, "segment_duration": 3600}
    }
  }'

# æ£€æŸ¥è¿›ç¨‹
ssh root@142.171.75.220 "ps aux | grep ffmpeg"

# æ£€æŸ¥æ–‡ä»¶ç”Ÿæˆ
ssh root@142.171.75.220 "ls -la /var/recordings/stream_xxx/"
```

**éªŒè¯æ¸…å•**:
- [ ] FFmpegè¿›ç¨‹åŒ…å«HLSå’ŒMP4è¾“å‡º
- [ ] å½•åˆ¶æ–‡ä»¶å¼€å§‹ç”Ÿæˆ
- [ ] HLSæ’­æ”¾ä»ç„¶æ­£å¸¸
- [ ] æ— JavaScripté”™è¯¯

**å¦‚æœéªŒè¯å¤±è´¥**: æ¢å¤SimpleStreamManager.jså¤‡ä»½ï¼Œé‡æ–°éƒ¨ç½²

âœ… å®Œæˆåæ›´æ–°è¿›åº¦è¡¨

---

## ğŸ“ åç»­é˜¶æ®µæ¦‚è§ˆ

ç”±äºæ–‡æ¡£ç¯‡å¹…é™åˆ¶ï¼Œå‰©ä½™é˜¶æ®µçš„è¯¦ç»†æ­¥éª¤è¯·å‚è€ƒï¼š

- **é˜¶æ®µ3**: åˆ†æ®µå½•åˆ¶ç®¡ç†å™¨ï¼ˆSegmentedRecordingManagerï¼‰
- **é˜¶æ®µ4**: è‡ªåŠ¨ä¿®å¤æœºåˆ¶ï¼ˆRecordingRecoveryManagerï¼‰
- **é˜¶æ®µ5**: å‰ç«¯ç®¡ç†ç•Œé¢ï¼ˆé¢‘é“å½•åˆ¶å¼€å…³ï¼‰
- **é˜¶æ®µ6**: å®šæ—¶ä»»åŠ¡å’Œè‡ªåŠ¨æ¸…ç†
- **é˜¶æ®µ7**: å®Œæ•´é›†æˆæµ‹è¯•

å®Œæ•´å®æ–½ç»†èŠ‚è§ï¼š`VIDEO_RECORDING_SOLUTION.md`

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœä»»ä½•é˜¶æ®µå¤±è´¥ï¼Œç«‹å³æ‰§è¡Œå›æ»šï¼š

```bash
# å›æ»šåˆ°å¤‡ä»½
$timestamp = "YOUR_BACKUP_TIMESTAMP"
Copy-Item "backups\$timestamp\*" -Destination "å¯¹åº”ç›®å½•" -Force

# é‡æ–°éƒ¨ç½²Workers
cd cloudflare-worker
npx wrangler deploy --env production

# é‡æ–°éƒ¨ç½²VPS
ssh root@142.171.75.220 "cd /tmp/github && ./vps-simple-deploy.sh"
```

---

## ğŸ“Œ é‡è¦æé†’

1. âš ï¸ **ä¿®æ”¹é…ç½®ä¼šå¯¼è‡´é‡å¯** - å½±å“è§‚çœ‹ç”¨æˆ·7ç§’
2. âš ï¸ **VPSæ— æ³•ç›´æ¥è®¿é—®D1** - å¿…é¡»é€šè¿‡Workers API
3. âš ï¸ **ç£ç›˜ç©ºé—´ç›‘æ§** - 8é¢‘é“2å¤©çº¦109GB
4. âš ï¸ **æ–‡ä»¶æƒé™** - ç¡®ä¿/var/recordingså¯å†™
5. âš ï¸ **åˆ†æ®µå½•åˆ¶** - æ¯1å°æ—¶è‡ªåŠ¨åˆ‡æ¢æ–‡ä»¶

---

**æ–‡æ¡£ç»´æŠ¤è€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2025-10-24 22:45 (UTC+8)  
**æ–‡æ¡£çŠ¶æ€**: âœ… åˆå§‹ç‰ˆæœ¬å®Œæˆ