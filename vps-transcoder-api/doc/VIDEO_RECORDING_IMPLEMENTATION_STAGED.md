# ğŸ”§ è§†é¢‘å½•åˆ¶åŠŸèƒ½å®æ–½æ–¹æ¡ˆ - é˜¶æ®µåŒ–æ‰§è¡Œæ–‡æ¡£

**ç‰ˆæœ¬**: v1.0 | **åˆ›å»ºæ—¶é—´**: 2025-10-24 22:40  
**åŸºäº**: VIDEO_RECORDING_SOLUTION.md v1.1

---

## ğŸ“– æ–‡æ¡£ä½¿ç”¨è¯´æ˜

### **é‡è¦åŸåˆ™**

âš ï¸ **æœ¬æ–‡æ¡£é‡‡ç”¨é˜¶æ®µåŒ–æ‰§è¡Œç­–ç•¥** - æ¯ä¸ªé˜¶æ®µå®Œæˆåå¿…é¡»éªŒè¯é€šè¿‡æ‰èƒ½ç»§ç»­

**ğŸš¨ æ‰§è¡Œçºªå¾‹ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰**ï¼š
1. âœ… **ç»å¯¹ç¦æ­¢è·³æ­¥** - å¿…é¡»å®Œæˆå½“å‰é˜¶æ®µçš„æ‰€æœ‰æ­¥éª¤ï¼ˆä¿®æ”¹â†’éƒ¨ç½²â†’éªŒè¯â†’æ›´æ–°çŠ¶æ€ï¼‰åæ‰èƒ½è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
2. âœ… **éªŒè¯æ˜¯å¼ºåˆ¶æ€§çš„** - å³ä½¿ä»£ç çœ‹èµ·æ¥æ­£ç¡®ï¼Œä¹Ÿå¿…é¡»æ‰§è¡ŒéªŒè¯æ­¥éª¤ç¡®è®¤åŠŸèƒ½æ­£å¸¸
3. âœ… **éªŒè¯å¤±è´¥å¿…é¡»å›æ»š** - ä½¿ç”¨å¤‡ä»½æ–‡ä»¶æ¢å¤ï¼Œä¸èƒ½å¸¦ç€é—®é¢˜ç»§ç»­
4. âœ… **æ¯æ­¥æ›´æ–°è¿›åº¦è¡¨** - åœ¨ä¸‹æ–¹è¿›åº¦è¡¨ä¸­å®æ—¶æ ‡è®°å½“å‰çŠ¶æ€
5. âœ… **é‡åˆ°é—®é¢˜ç«‹å³åœæ­¢** - ä¸è¦ç»§ç»­æ‰§è¡Œåç»­é˜¶æ®µ

**ä¸ºä»€ä¹ˆè¦é˜¶æ®µåŒ–**ï¼š
- ğŸ”´ æœ¬æ¬¡å®æ–½æ¶‰åŠçº¦15ä¸ªæ–‡ä»¶ã€1000+è¡Œä»£ç 
- ğŸ”´ ä¸€æ¬¡æ€§ä¿®æ”¹é£é™©æé«˜ï¼Œéš¾ä»¥å®šä½é—®é¢˜
- âœ… åˆ†é˜¶æ®µæ‰§è¡Œå¯ä»¥åŠæ—¶å‘ç°å’Œä¿®å¤é—®é¢˜
- âœ… æ¯ä¸ªé˜¶æ®µéƒ½å¯ç‹¬ç«‹å›æ»šï¼Œå½±å“èŒƒå›´å°

**AIæ‰§è¡Œè€…æ³¨æ„**ï¼š
- ğŸ“ **æ¯å®Œæˆä¸€ä¸ªé˜¶æ®µï¼Œå¿…é¡»æ›´æ–°ä¸‹æ–¹è¿›åº¦è¡¨**
- ğŸ“ **åœ¨çŠ¶æ€åˆ—æ ‡è®° âœ… å¹¶å¡«å†™å®Œæˆæ—¶é—´**
- ğŸ“ **å¦‚æœéªŒè¯å¤±è´¥ï¼Œæ ‡è®° âŒ å¹¶è¯´æ˜åŸå› **

---

## ğŸ“Š æ‰§è¡Œè¿›åº¦è¿½è¸ª

### **æ€»ä½“è¿›åº¦**: 0/7 é˜¶æ®µå®Œæˆ

| é˜¶æ®µ | åç§° | çŠ¶æ€ | å®Œæˆæ—¶é—´ | éªŒè¯ç»“æœ |
|------|------|------|----------|---------|
| **å‡†å¤‡** | ç¯å¢ƒé…ç½®å’Œæ–‡ä»¶å¤‡ä»½ | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ1** | D1æ•°æ®åº“è®¾è®¡å’ŒAPI | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ2** | SimpleStreamManageræ ¸å¿ƒæ”¹é€  | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ3** | åˆ†æ®µå½•åˆ¶å’Œæ–‡ä»¶ç®¡ç† | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ4** | è‡ªåŠ¨ä¿®å¤æœºåˆ¶ | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ5** | å‰ç«¯ç®¡ç†ç•Œé¢ | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ6** | å®šæ—¶ä»»åŠ¡å’Œæ¸…ç† | â³ æœªå¼€å§‹ | - | - |
| **é˜¶æ®µ7** | å®Œæ•´é›†æˆæµ‹è¯• | â³ æœªå¼€å§‹ | - | - |

**çŠ¶æ€å›¾ä¾‹**ï¼šâ³ æœªå¼€å§‹ | ğŸ”„ è¿›è¡Œä¸­ | âœ… å·²å®Œæˆ | âŒ éªŒè¯å¤±è´¥ | ğŸ”™ å·²å›æ»š

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

### **æ ¸å¿ƒéœ€æ±‚**
1. **å½•åˆ¶æ§åˆ¶**: ç®¡ç†å‘˜å¯å¯ç”¨/ç¦ç”¨é¢‘é“å½•åˆ¶
2. **å®šæ—¶å½•åˆ¶**: é»˜è®¤æ—¶é—´ 7:50-17:20ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
3. **åˆ†æ®µå½•åˆ¶**: æ¯1å°æ—¶ä¸€ä¸ªMP4æ–‡ä»¶
4. **è‡ªåŠ¨æ¸…ç†**: ä¿ç•™2å¤©ï¼Œå‡Œæ™¨3ç‚¹è‡ªåŠ¨åˆ é™¤
5. **æ–‡ä»¶ä¸‹è½½**: é€šè¿‡FileBrowserè®¿é—®å½•åƒ

### **å…³é”®æŠ€æœ¯å†³ç­–**

#### 1. FFmpegè¿›ç¨‹å¤ç”¨ â­
- **ç­–ç•¥**: ä¸€ä¸ªFFmpegè¿›ç¨‹åŒæ—¶è¾“å‡ºHLSå’ŒMP4
- **ä¼˜åŠ¿**: CPUä»…å¢åŠ 30%ï¼ŒèŠ‚çœ50%èµ„æº
- **æƒè¡¡**: ä¿®æ”¹é…ç½®éœ€è¦é‡å¯è¿›ç¨‹ï¼ˆå½±å“è§‚çœ‹ç”¨æˆ·7ç§’ï¼‰

#### 2. D1æ•°æ®åº“è®¿é—® â­
- **é™åˆ¶**: VPSæ— æ³•ç›´æ¥è®¿é—®D1ï¼Œå¿…é¡»é€šè¿‡Workers API
- **è§„èŒƒ**: 
  - ğŸ–¥ï¸ VPSç«¯ä»£ç ï¼šé€šè¿‡HTTP APIè®¿é—®
  - â˜ï¸ Workersç«¯ä»£ç ï¼šç›´æ¥ä½¿ç”¨`env.RECORDING_DB`

#### 3. åˆ†æ®µå½•åˆ¶ â­
- **ç­–ç•¥**: æ¯1å°æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°æ–‡ä»¶
- **ä¼˜åŠ¿**: è¿›ç¨‹å´©æºƒæœ€å¤šæŸå¤±1å°æ—¶ï¼Œå…¶ä»–æ®µå®Œå¥½
- **å®ç°**: FFmpeg `-f segment` å‚æ•°

#### 4. è‡ªåŠ¨ä¿®å¤ â­
- **ç­–ç•¥**: æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤æŸåæ–‡ä»¶
- **ä¸‰çº§ä¿®å¤**: æ ‡å‡†ä¿®å¤ â†’ å¼ºåˆ¶é‡å»º â†’ æå–æ•°æ®
- **æˆåŠŸç‡**: æ­£å¸¸åœæ­¢99%ï¼Œå´©æºƒ85%ï¼Œæ–­ç”µ60%

### **æ–‡ä»¶å‘½åè§„åˆ™**
- **æ ¼å¼**: `YYYY-MM-DD_HH-MM-SS.mp4`
- **ç¤ºä¾‹**: `2025-10-24_14-03-25.mp4`
- **è¯´æ˜**: å½•åˆ¶å¼€å§‹æ—¶é—´ï¼ˆå¹´-æœˆ-æ—¥_æ—¶-åˆ†-ç§’ï¼‰
- **ç»“æŸæ—¶é—´**: é€šè¿‡ffprobeè¯»å–è§†é¢‘æ—¶é•¿æˆ–æŸ¥è¯¢D1æ•°æ®åº“çš„end_timeå­—æ®µ

---

## ğŸ¯ å‡†å¤‡é˜¶æ®µï¼šç¯å¢ƒé…ç½®å’Œæ–‡ä»¶å¤‡ä»½

âš ï¸ **åœ¨å¼€å§‹ä»»ä½•ä¿®æ”¹å‰ï¼Œå¿…é¡»å…ˆå®Œæˆå‡†å¤‡å·¥ä½œï¼**

**ç›®æ ‡**ï¼šé…ç½®ç¯å¢ƒå˜é‡ï¼Œåˆ›å»ºD1æ•°æ®åº“ï¼Œå¤‡ä»½å…³é”®æ–‡ä»¶  
**å½±å“èŒƒå›´**ï¼šå…¨å±€é…ç½®  
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½  
**é¢„è®¡æ—¶é—´**ï¼š30åˆ†é’Ÿ

### å‡†å¤‡1ï¼šåˆ›å»ºD1æ•°æ®åº“

```bash
# 1. åˆ›å»ºD1æ•°æ®åº“
cd cloudflare-worker
npx wrangler d1 create yoyo-recordings

# 2. è®°å½•è¿”å›çš„database_id
# 3. æ›´æ–°wrangler.tomlæ·»åŠ ç»‘å®šï¼ˆè§å‡†å¤‡2ï¼‰
```

### å‡†å¤‡2ï¼šé…ç½®ç¯å¢ƒå˜é‡

**Workers (wrangler.toml)**:
```toml
# åœ¨[env.production]éƒ¨åˆ†æ·»åŠ 
RECORDING_ENABLED = "true"
RECORDING_DEFAULT_RETENTION_DAYS = "2"
RECORDING_CLEANUP_HOUR = "3"
RECORDING_MAX_SEGMENT_DURATION = "7200"

# æ·»åŠ D1æ•°æ®åº“ç»‘å®š
[[d1_databases]]
binding = "RECORDING_DB"
database_name = "yoyo-recordings"
database_id = "<your-database-id>"
```

**VPS (.env)**:
```bash
# SSHåˆ°VPSåç¼–è¾‘ /opt/yoyo-transcoder/.env
RECORDINGS_BASE_DIR=/var/recordings
RECORDINGS_CLEANUP_HOUR=3
RECORDINGS_RETENTION_DAYS=2
RECORDINGS_SEGMENT_DURATION=3600
WORKERS_API_URL=https://yoyoapi.5202021.xyz
```

### å‡†å¤‡3ï¼šå¤‡ä»½æ–‡ä»¶

```powershell
cd D:\é¡¹ç›®æ–‡ä»¶\yoyo-kindergarten\code\secure-streaming-platform\vps-transcoder-api

# åˆ›å»ºå¤‡ä»½ç›®å½•
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
New-Item -Path "backups\$timestamp" -ItemType Directory -Force

# å¤‡ä»½å…³é”®æ–‡ä»¶
Copy-Item "vps-transcoder-api\src\services\SimpleStreamManager.js" "backups\$timestamp\"
Copy-Item "vps-transcoder-api\src\routes\simple-stream.js" "backups\$timestamp\"
Copy-Item "vps-transcoder-api\vps-simple-deploy.sh" "backups\$timestamp\"
Copy-Item "vps-transcoder-api\package.json" "backups\$timestamp\"
Copy-Item "cloudflare-worker\src\index.js" "backups\$timestamp\"
Copy-Item "cloudflare-worker\wrangler.toml" "backups\$timestamp\"
```

### å‡†å¤‡4ï¼šæ£€æŸ¥VPSéƒ¨ç½²è„šæœ¬ â­é‡è¦

âš ï¸ **ç¡®ä¿éƒ¨ç½²è„šæœ¬åŒ…å«ä¾èµ–å®‰è£…æ­¥éª¤ï¼Œå¦åˆ™åç»­é˜¶æ®µä¼šå¤±è´¥ï¼**

**æ£€æŸ¥æ–‡ä»¶**: `vps-transcoder-api/vps-simple-deploy.sh`

**å¿…é¡»åŒ…å«çš„å…³é”®æ­¥éª¤**ï¼ˆæ¨èçš„ä¼˜åŒ–ç‰ˆæœ¬ï¼‰ï¼š
```bash
# 1. åŒæ­¥package.jsonï¼ˆç¡®ä¿ä¾èµ–å®šä¹‰æœ€æ–°ï¼‰
cp /tmp/github/secure-streaming-platform/vps-transcoder-api/package.json /opt/yoyo-transcoder/

# 2. æ™ºèƒ½å®‰è£…ä¾èµ–ï¼ˆæ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–ï¼Œé¿å…ä¸å¿…è¦çš„å®‰è£…ï¼‰
cd /opt/yoyo-transcoder

# æ–¹å¼1: æ£€æŸ¥package.jsonæ˜¯å¦å˜åŒ–ï¼ˆæ¨èï¼‰
if ! cmp -s package.json package.json.old 2>/dev/null || [ ! -d node_modules ]; then
  echo "ğŸ“¦ Dependencies changed or missing, installing..."
  npm ci --production  # ä½¿ç”¨npm ciæ›´å¿«æ›´å¯é 
  cp package.json package.json.old
else
  echo "âœ… Dependencies up to date, skipping install"
fi

# æ–¹å¼2: ç®€å•ç‰ˆæœ¬ï¼ˆæ€»æ˜¯å®‰è£…ï¼Œnpmä¼šè‡ªåŠ¨è·³è¿‡å·²å®‰è£…çš„ï¼‰
npm install --production  # npm installæ˜¯å¹‚ç­‰çš„ï¼Œä¸ä¼šæŠ¥é”™

# 3. é‡å¯æœåŠ¡
pm2 reload vps-transcoder-api
```

**npm install vs npm ci**ï¼š
- `npm install`ï¼šå¹‚ç­‰æ“ä½œï¼Œå¯é‡å¤æ‰§è¡Œï¼Œä¸ä¼šæŠ¥é”™
- `npm ci`ï¼šæ›´å¿«æ›´å¯é ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒï¼Œä¼šåˆ é™¤node_modulesé‡æ–°å®‰è£…

**å¦‚æœè„šæœ¬ä¸­ç¼ºå°‘è¿™äº›æ­¥éª¤**ï¼Œéœ€è¦å…ˆå®Œå–„éƒ¨ç½²è„šæœ¬ï¼Œå†ç»§ç»­åç»­é˜¶æ®µã€‚

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹å½“å‰éƒ¨ç½²è„šæœ¬å†…å®¹
cat vps-transcoder-api/vps-simple-deploy.sh

# ç¡®è®¤åŒ…å« npm install æ­¥éª¤
grep "npm install\|npm ci" vps-transcoder-api/vps-simple-deploy.sh
```

### å‡†å¤‡5ï¼šåˆ›å»ºVPSå½•åˆ¶ç›®å½•

```bash
# SSHåˆ°VPS
ssh root@142.171.75.220

# åˆ›å»ºç›®å½•
mkdir -p /var/recordings
mkdir -p /var/log/recordings
chmod 755 /var/recordings /var/log/recordings

# éªŒè¯ç£ç›˜ç©ºé—´
df -h /var
```

### å‡†å¤‡6ï¼šéªŒè¯æ¸…å•

- [ ] D1æ•°æ®åº“å·²åˆ›å»º
- [ ] wrangler.tomlå·²æ›´æ–°ç»‘å®š
- [ ] Workersç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] VPSç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] å…³é”®æ–‡ä»¶å·²å¤‡ä»½ï¼ˆåŒ…æ‹¬vps-simple-deploy.shå’Œpackage.jsonï¼‰
- [ ] **VPSéƒ¨ç½²è„šæœ¬åŒ…å«npm installæ­¥éª¤** â­å…³é”®
- [ ] VPSå½•åˆ¶ç›®å½•å·²åˆ›å»º
- [ ] ç£ç›˜ç©ºé—´ > 200GB

âœ… å®Œæˆåæ›´æ–°è¿›åº¦è¡¨

---

## ğŸ¯ é˜¶æ®µ1ï¼šD1æ•°æ®åº“è®¾è®¡å’ŒWorkers API

**ç›®æ ‡**ï¼šåˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„ï¼Œå®ç°Workersç«¯D1è®¿é—®API  
**å½±å“èŒƒå›´**ï¼šcloudflare-worker/ (3ä¸ªæ–‡ä»¶)  
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­  
**é¢„è®¡æ—¶é—´**ï¼š60åˆ†é’Ÿ

### 1.1 åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„

**åˆ›å»ºæ–‡ä»¶**: `cloudflare-worker/schema.sql`

```sql
-- å½•åˆ¶é…ç½®è¡¨
CREATE TABLE IF NOT EXISTS recording_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  channel_id TEXT NOT NULL UNIQUE,
  enabled INTEGER DEFAULT 0,
  start_time TEXT DEFAULT '07:50',
  end_time TEXT DEFAULT '17:20',
  segment_duration INTEGER DEFAULT 3600,
  video_bitrate INTEGER DEFAULT 1500,
  retention_days INTEGER DEFAULT 2,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- å½•åˆ¶æ–‡ä»¶è¡¨
CREATE TABLE IF NOT EXISTS recording_files (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  channel_id TEXT NOT NULL,
  filename TEXT NOT NULL,
  file_path TEXT NOT NULL,
  start_time TEXT NOT NULL,
  end_time TEXT,
  file_size INTEGER DEFAULT 0,
  status TEXT DEFAULT 'recording',
  repair_attempts INTEGER DEFAULT 0,
  repair_status TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_configs_channel ON recording_configs(channel_id);
CREATE INDEX IF NOT EXISTS idx_files_channel ON recording_files(channel_id);
CREATE INDEX IF NOT EXISTS idx_files_status ON recording_files(status);
```

**æ‰§è¡ŒSQL**:
```bash
cd cloudflare-worker
npx wrangler d1 execute yoyo-recordings --file=schema.sql --env production
```

### 1.2 åˆ›å»ºrecordingHandler.js

**åˆ›å»ºæ–‡ä»¶**: `cloudflare-worker/src/handlers/recordingHandler.js`

è¿™ä¸ªæ–‡ä»¶å®ç°D1æ•°æ®åº“CRUDæ“ä½œã€‚æ ¸å¿ƒæ–¹æ³•ï¼š
- `getRecordingConfig()` - è·å–é¢‘é“å½•åˆ¶é…ç½®
- `updateRecordingConfig()` - æ›´æ–°å½•åˆ¶é…ç½®
- `createRecordingFile()` - åˆ›å»ºå½•åˆ¶æ–‡ä»¶è®°å½•
- `updateRecordingFile()` - æ›´æ–°æ–‡ä»¶çŠ¶æ€
- `getInterruptedRecordings()` - è·å–éœ€è¦ä¿®å¤çš„æ–‡ä»¶
- `getRecordingFiles()` - æŸ¥è¯¢å½•åˆ¶æ–‡ä»¶åˆ—è¡¨

**æ³¨æ„**: ç”±äºä»£ç è¾ƒé•¿ï¼Œå®Œæ•´å®ç°è§VIDEO_RECORDING_SOLUTION.mdç¬¬2200-2500è¡Œ

### 1.3 æ·»åŠ APIè·¯ç”±

**ä¿®æ”¹æ–‡ä»¶**: `cloudflare-worker/src/index.js`

åœ¨è·¯ç”±éƒ¨åˆ†æ·»åŠ ï¼š
```javascript
// å½•åˆ¶é…ç½®API
router.get('/api/recording/config/:channelId', recordingHandler.getRecordingConfig);
router.put('/api/recording/config/:channelId', recordingHandler.updateRecordingConfig);

// å½•åˆ¶æ–‡ä»¶API
router.post('/api/recording/files', recordingHandler.createRecordingFile);
router.patch('/api/recording/files/:id', recordingHandler.updateRecordingFile);
router.get('/api/recording/files/interrupted', recordingHandler.getInterruptedRecordings);
router.get('/api/recording/files', recordingHandler.getRecordingFiles);
```

### 1.4 éƒ¨ç½²Workers

```bash
cd cloudflare-worker
npx wrangler deploy --env production
```

### 1.5 éªŒè¯æµ‹è¯•

**æµ‹è¯•APIç«¯ç‚¹**:
```powershell
# æµ‹è¯•è·å–é…ç½®
$token = "YOUR_ADMIN_TOKEN"
Invoke-RestMethod -Uri "https://yoyoapi.5202021.xyz/api/recording/config/stream_xxx" `
  -Headers @{"Authorization"="Bearer $token"}

# æµ‹è¯•æ›´æ–°é…ç½®
$body = @{
  enabled = $true
  start_time = "07:50"
  end_time = "17:20"
} | ConvertTo-Json

Invoke-RestMethod -Uri "https://yoyoapi.5202021.xyz/api/recording/config/stream_xxx" `
  -Method PUT -Body $body -ContentType "application/json" `
  -Headers @{"Authorization"="Bearer $token"}
```

**éªŒè¯æ¸…å•**:
- [ ] D1è¡¨å·²åˆ›å»ºï¼ˆ3ä¸ªè¡¨ï¼Œ3ä¸ªç´¢å¼•ï¼‰
- [ ] recordingHandler.jså·²åˆ›å»º
- [ ] APIè·¯ç”±å·²æ·»åŠ 
- [ ] Workerséƒ¨ç½²æˆåŠŸ
- [ ] é…ç½®APIè¿”å›200
- [ ] æ–‡ä»¶APIè¿”å›200

**å¦‚æœéªŒè¯å¤±è´¥**: å›æ»šWorkerséƒ¨ç½²ï¼Œæ¢å¤index.jså¤‡ä»½

âœ… å®Œæˆåæ›´æ–°è¿›åº¦è¡¨

---

## ğŸ¯ é˜¶æ®µ2ï¼šSimpleStreamManageræ ¸å¿ƒæ”¹é€ 

**ç›®æ ‡**ï¼šæ‰©å±•SimpleStreamManageræ”¯æŒå½•åˆ¶åŠŸèƒ½  
**å½±å“èŒƒå›´**ï¼šSimpleStreamManager.js (1ä¸ªæ–‡ä»¶ï¼Œçº¦300è¡Œä»£ç )  
**é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š90åˆ†é’Ÿ

**å…³é”®æ”¹åŠ¨**ï¼š
1. `startWatching()` - æ·»åŠ optionså‚æ•°æ”¯æŒå½•åˆ¶é…ç½®
2. `spawnFFmpegProcess()` - æ”¯æŒHLS+MP4åŒè¾“å‡º
3. `cleanupIdleChannels()` - è·³è¿‡æ­£åœ¨å½•åˆ¶çš„é¢‘é“
4. æ–°å¢å½•åˆ¶å¿ƒè·³æœºåˆ¶

### 2.1 ä¿®æ”¹startWatchingæ–¹æ³•

**æ–‡ä»¶**: `vps-transcoder-api/src/services/SimpleStreamManager.js`

åœ¨ç°æœ‰æ–¹æ³•åŸºç¡€ä¸Šæ·»åŠ optionså‚æ•°ï¼ˆå‘åå…¼å®¹ï¼‰ï¼š

```javascript
async startWatching(channelId, rtmpUrl, options = {}) {
  // æ£€æŸ¥é…ç½®æ˜¯å¦å˜æ›´
  const existingChannel = this.activeStreams.get(channelId);
  if (existingChannel) {
    const recordingChanged = this.isRecordingConfigChanged(
      existingChannel.recordingConfig,
      options.recordingConfig
    );
    
    if (existingChannel.rtmpUrl !== rtmpUrl || recordingChanged) {
      await this.stopFFmpegProcess(channelId);
      return await this.startNewStream(channelId, rtmpUrl, options);
    }
    return existingChannel.hlsUrl;
  }
  
  return await this.startNewStream(channelId, rtmpUrl, options);
}
```

### 2.2 ä¿®æ”¹spawnFFmpegProcessæ–¹æ³•

**æ ¸å¿ƒä¿®æ”¹**ï¼šæ”¯æŒFFmpegå¤šè¾“å‡ºï¼ˆHLS + MP4åˆ†æ®µå½•åˆ¶ï¼‰

```javascript
async spawnFFmpegProcess(channelId, rtmpUrl, options = {}) {
  const ffmpegArgs = ['-i', rtmpUrl];
  
  if (options.recordingConfig?.enabled) {
    // è¾“å‡º1: HLSæµ
    ffmpegArgs.push(
      '-map', '0:v:0',
      '-c:v:0', 'libx264', '-preset:v:0', 'ultrafast', '-an',
      '-f', 'hls', '-hls_time', '2',
      // ... HLSå‚æ•°
    );
    
    // è¾“å‡º2: MP4åˆ†æ®µå½•åˆ¶
    const segmentDuration = options.recordingConfig.segment_duration || 3600;
    ffmpegArgs.push(
      '-map', '0:v:0',
      '-c:v:1', 'libx264', '-preset:v:1', 'medium', '-an',
      '-f', 'segment', '-segment_time', segmentDuration,
      '-strftime', '1',
      '-segment_filename', `/var/recordings/${channelId}/%Y-%m-%d_%H-%M-%S.mp4`
    );
  } else {
    // åªè¾“å‡ºHLSï¼ˆç°æœ‰é€»è¾‘ï¼‰
  }
  
  return spawn(this.ffmpegPath, ffmpegArgs, {env});
}
```

### 2.3 æ–°å¢è¾…åŠ©æ–¹æ³•

```javascript
// å½•åˆ¶å¿ƒè·³
setRecordingHeartbeat(channelId) { /* ... */ }
clearRecordingHeartbeat(channelId) { /* ... */ }
isRecordingConfigChanged(oldConfig, newConfig) { /* ... */ }
```

### 2.4 ä¿®æ”¹cleanupIdleChannels

```javascript
async cleanupIdleChannels() {
  for (const [channelId, lastHeartbeat] of this.channelHeartbeats) {
    const processInfo = this.activeStreams.get(channelId);
    
    // è·³è¿‡æ­£åœ¨å½•åˆ¶çš„é¢‘é“
    if (processInfo && processInfo.isRecording) continue;
    
    // æ­£å¸¸æ¸…ç†é€»è¾‘...
  }
}
```

### 2.5 éƒ¨ç½²åˆ°VPS

```bash
# æäº¤ä»£ç 
git add vps-transcoder-api/src/services/SimpleStreamManager.js
git commit -m "feat: SimpleStreamManageræ”¯æŒå½•åˆ¶åŠŸèƒ½"
git push

# éƒ¨ç½²åˆ°VPS
ssh root@142.171.75.220 "cd /tmp/github/secure-streaming-platform/vps-transcoder-api && ./vps-simple-deploy.sh"
```

### 2.6 éªŒè¯æµ‹è¯•

```bash
# æµ‹è¯•å¯åŠ¨å½•åˆ¶
curl -X POST https://yoyo-vps.5202021.xyz/api/simple-stream/start-watching \
  -H "X-API-Key: YOUR_KEY" \
  -d '{
    "channelId": "stream_xxx",
    "rtmpUrl": "rtmp://source/live",
    "options": {
      "recordingConfig": {"enabled": true, "segment_duration": 3600}
    }
  }'

# æ£€æŸ¥è¿›ç¨‹
ssh root@142.171.75.220 "ps aux | grep ffmpeg"

# æ£€æŸ¥æ–‡ä»¶ç”Ÿæˆ
ssh root@142.171.75.220 "ls -la /var/recordings/stream_xxx/"
```

**éªŒè¯æ¸…å•**:
- [ ] FFmpegè¿›ç¨‹åŒ…å«HLSå’ŒMP4è¾“å‡º
- [ ] å½•åˆ¶æ–‡ä»¶å¼€å§‹ç”Ÿæˆ
- [ ] HLSæ’­æ”¾ä»ç„¶æ­£å¸¸
- [ ] æ— JavaScripté”™è¯¯

**å¦‚æœéªŒè¯å¤±è´¥**: æ¢å¤SimpleStreamManager.jså¤‡ä»½ï¼Œé‡æ–°éƒ¨ç½²

âœ… å®Œæˆåæ›´æ–°è¿›åº¦è¡¨

---

## ğŸ¯ é˜¶æ®µ3ï¼šåˆ†æ®µå½•åˆ¶ç®¡ç†å™¨

**ç›®æ ‡**ï¼šå®ç°å½•åˆ¶åˆ†æ®µç›‘å¬å’Œå¤„ç†ï¼Œè‡ªåŠ¨é‡å‘½åä¸´æ—¶æ–‡ä»¶  
**å½±å“èŒƒå›´**ï¼šVPSç«¯æ–°å¢1ä¸ªæœåŠ¡ç±»  
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­  
**é¢„è®¡æ—¶é—´**ï¼š60åˆ†é’Ÿ

### 3.1 åˆ›å»ºSegmentedRecordingManager

**åˆ›å»ºæ–‡ä»¶**: `vps-transcoder-api/src/services/SegmentedRecordingManager.js`

æ ¸å¿ƒåŠŸèƒ½ï¼š
- ç›‘å¬å½•åˆ¶ç›®å½•çš„æ–‡ä»¶å˜åŒ–
- æ£€æµ‹æ–°åˆ†æ®µæ–‡ä»¶ç”Ÿæˆ
- è‡ªåŠ¨é‡å‘½åä¸´æ—¶æ–‡ä»¶ä¸ºæ ‡å‡†æ ¼å¼
- é€šè¿‡Workers APIæ›´æ–°D1æ•°æ®åº“

**å…³é”®æ–¹æ³•**ï¼š
```javascript
class SegmentedRecordingManager {
  constructor() {
    this.recordingsDir = process.env.RECORDINGS_BASE_DIR || '/var/recordings';
    this.activeWatchers = new Map();
  }
  
  // å¼€å§‹ç›‘å¬é¢‘é“å½•åˆ¶ç›®å½•
  startWatching(channelId) { /* ... */ }
  
  // åœæ­¢ç›‘å¬
  stopWatching(channelId) { /* ... */ }
  
  // å¤„ç†æ–°æ–‡ä»¶åˆ›å»ºäº‹ä»¶
  async handleNewFile(channelId, filename) { /* ... */ }
  
  // é‡å‘½åä¸´æ—¶æ–‡ä»¶å¹¶æ›´æ–°æ•°æ®åº“
  async processCompletedSegment(channelId, filePath) { /* ... */ }
}
```

### 3.2 é›†æˆåˆ°SimpleStreamManager

**ä¿®æ”¹æ–‡ä»¶**: `vps-transcoder-api/src/services/SimpleStreamManager.js`

```javascript
const SegmentedRecordingManager = require('./SegmentedRecordingManager');

class SimpleStreamManager {
  constructor() {
    // ... ç°æœ‰ä»£ç 
    this.recordingManager = new SegmentedRecordingManager();
  }
  
  async startNewStream(channelId, rtmpUrl, options = {}) {
    // ... ç°æœ‰ä»£ç 
    
    if (options.recordingConfig?.enabled) {
      // å¯åŠ¨å½•åˆ¶ç›®å½•ç›‘å¬
      this.recordingManager.startWatching(channelId);
    }
  }
  
  async stopChannel(channelId) {
    // ... ç°æœ‰ä»£ç 
    
    // åœæ­¢å½•åˆ¶ç›‘å¬
    this.recordingManager.stopWatching(channelId);
  }
}
```

### 3.3 éƒ¨ç½²å’ŒéªŒè¯

```bash
# æäº¤ä»£ç 
git add vps-transcoder-api/src/services/SegmentedRecordingManager.js
git add vps-transcoder-api/src/services/SimpleStreamManager.js
git commit -m "feat: æ·»åŠ åˆ†æ®µå½•åˆ¶ç®¡ç†å™¨"
git push

# éƒ¨ç½²åˆ°VPS
ssh root@142.171.75.220 "cd /tmp/github/secure-streaming-platform/vps-transcoder-api && ./vps-simple-deploy.sh"

# éªŒè¯æ–‡ä»¶ç›‘å¬
# å¯åŠ¨å½•åˆ¶åï¼Œç­‰å¾…1å°æ—¶æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®é‡å‘½å
ssh root@142.171.75.220 "ls -la /var/recordings/stream_xxx/"
```

**éªŒè¯æ¸…å•**:
- [ ] æ–°åˆ†æ®µæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆ
- [ ] æ–‡ä»¶åæ ¼å¼æ­£ç¡®ï¼ˆYYYY-MM-DD_HH-MM-SS.mp4ï¼‰
- [ ] D1æ•°æ®åº“è®°å½•å·²åˆ›å»º
- [ ] æ–‡ä»¶å¤§å°å’Œæ—¶é•¿æ­£å¸¸

âœ… å®Œæˆåæ›´æ–°è¿›åº¦è¡¨

---

## ğŸ¯ é˜¶æ®µ4ï¼šè‡ªåŠ¨ä¿®å¤æœºåˆ¶

**ç›®æ ‡**ï¼šå®ç°æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤æŸåæ–‡ä»¶  
**å½±å“èŒƒå›´**ï¼šVPSç«¯æ–°å¢1ä¸ªæœåŠ¡ç±» + app.jså¯åŠ¨é€»è¾‘  
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­  
**é¢„è®¡æ—¶é—´**ï¼š90åˆ†é’Ÿ

### 4.1 åˆ›å»ºRecordingRecoveryManager

**åˆ›å»ºæ–‡ä»¶**: `vps-transcoder-api/src/services/RecordingRecoveryManager.js`

æ ¸å¿ƒåŠŸèƒ½ï¼š
- æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œæ¢å¤æµç¨‹
- å¤„ç†ä¸´æ—¶æ–‡ä»¶é‡å‘½å
- æ£€æµ‹æŸåæ–‡ä»¶å¹¶å°è¯•ä¿®å¤
- ä¸‰çº§ä¿®å¤ç­–ç•¥ï¼šæ ‡å‡†ä¿®å¤ â†’ å¼ºåˆ¶é‡å»º â†’ æå–æ•°æ®

**å…³é”®æ–¹æ³•**ï¼š
```javascript
class RecordingRecoveryManager {
  // å¯åŠ¨æ—¶æ‰§è¡Œæ¢å¤
  async recoverOnStartup() { /* ... */ }
  
  // å¤„ç†ä¸´æ—¶æ–‡ä»¶
  async processTempFiles() { /* ... */ }
  
  // è·å–ä¸­æ–­çš„å½•åˆ¶
  async getInterruptedRecordings() { /* ... */ }
  
  // éªŒè¯MP4æ–‡ä»¶
  async validateMP4File(filePath) { /* ... */ }
  
  // ä¿®å¤æ–‡ä»¶ï¼ˆä¸‰çº§ç­–ç•¥ + æ–‡ä»¶ä¿æŠ¤æœºåˆ¶ï¼‰
  async repairMP4WithRecovery(filePath) {
    const backupPath = `${filePath}.backup`;
    const tempPath = `${filePath}.repairing`;
    
    try {
      // ğŸ” å…³é”®ï¼šå…ˆå¤‡ä»½åŸæ–‡ä»¶
      await fs.copyFile(filePath, backupPath);
      
      // åœ¨ä¸´æ—¶æ–‡ä»¶ä¸Šå°è¯•ä¿®å¤ï¼ˆä¿æŠ¤åŸæ–‡ä»¶ï¼‰
      let success = await this.tryStandardRepair(filePath, tempPath);
      if (!success) success = await this.tryForceRebuild(filePath, tempPath);
      if (!success) success = await this.tryDataExtraction(filePath, tempPath);
      
      if (success && await this.validateMP4File(tempPath)) {
        // âœ… ä¿®å¤æˆåŠŸï¼šæ›¿æ¢åŸæ–‡ä»¶ï¼Œåˆ é™¤å¤‡ä»½
        await fs.rename(tempPath, filePath);
        await fs.unlink(backupPath);
        return true;
      }
      
      // âŒ ä¿®å¤å¤±è´¥ï¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œä¿ç•™åŸæ–‡ä»¶
      if (fs.existsSync(tempPath)) await fs.unlink(tempPath);
      return false;
      
    } catch (error) {
      // æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œä¿æŠ¤åŸæ–‡ä»¶ä¸è¢«ç ´å
      if (fs.existsSync(tempPath)) await fs.unlink(tempPath);
      return false;
    }
  }
  
  // æ–¹æ³•1: æ ‡å‡†ä¿®å¤ï¼ˆå¿«é€Ÿï¼Œé€‚åˆè½»å¾®æŸåï¼‰
  async tryStandardRepair(inputPath, outputPath) {
    return execAsync(
      `ffmpeg -err_detect ignore_err -i "${inputPath}" -c copy -movflags +faststart "${outputPath}"`
    ).then(() => true).catch(() => false);
  }
  
  // æ–¹æ³•2: å¼ºåˆ¶é‡å»ºï¼ˆä¸­ç­‰ï¼Œé€‚åˆç´¢å¼•æŸåï¼‰
  async tryForceRebuild(inputPath, outputPath) {
    return execAsync(
      `ffmpeg -fflags +genpts -i "${inputPath}" -c:v libx264 -preset fast -movflags +faststart "${outputPath}"`
    ).then(() => true).catch(() => false);
  }
  
  // æ–¹æ³•3: æå–æ•°æ®ï¼ˆä¿å®ˆï¼Œç¡®ä¿æœ‰è¾“å‡ºï¼‰
  async tryDataExtraction(inputPath, outputPath) {
    return execAsync(
      `ffmpeg -err_detect ignore_err -fflags +genpts -i "${inputPath}" -c:v libx264 -preset ultrafast "${outputPath}"`
    ).then(() => true).catch(() => false);
  }
}
```

**ğŸ” æ–‡ä»¶ä¿æŠ¤æœºåˆ¶**ï¼š
1. **ä¿®å¤å‰å¤‡ä»½** - åˆ›å»º `.backup` æ–‡ä»¶ä¿æŠ¤åŸå§‹æ•°æ®
2. **ä¸´æ—¶æ–‡ä»¶ä¿®å¤** - åœ¨ `.repairing` æ–‡ä»¶ä¸Šæ“ä½œï¼Œä¸ç›´æ¥ä¿®æ”¹åŸæ–‡ä»¶
3. **éªŒè¯åæ›¿æ¢** - ä¿®å¤æˆåŠŸä¸”éªŒè¯é€šè¿‡æ‰æ›¿æ¢åŸæ–‡ä»¶
4. **å¤±è´¥ä¿æŠ¤** - ä¿®å¤å¤±è´¥æ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œä¿ç•™åŸæ–‡ä»¶ä¸å—æŸ
5. **å¼‚å¸¸å®‰å…¨** - catchå—ç¡®ä¿å³ä½¿ç¨‹åºå´©æºƒä¹Ÿä¸ç ´ååŸæ–‡ä»¶

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**ï¼š
- âš ï¸ **é˜²æ­¢äºŒæ¬¡æŸä¼¤** - å¦‚æœä¿®å¤è¿‡ç¨‹ä¸­ç¨‹åºå´©æºƒï¼ŒåŸæ–‡ä»¶ä»ç„¶å®Œå¥½
- âš ï¸ **å¯å›é€€** - å¤‡ä»½æ–‡ä»¶å…è®¸åœ¨ä¿®å¤å¤±è´¥åæ¢å¤åŸå§‹çŠ¶æ€
- âš ï¸ **åŸå­æ“ä½œ** - æ–‡ä»¶æ›¿æ¢æ˜¯åŸå­æ“ä½œï¼Œä¸ä¼šå‡ºç°åŠæŸåçŠ¶æ€

### 4.2 é›†æˆåˆ°app.jså¯åŠ¨æµç¨‹

**ä¿®æ”¹æ–‡ä»¶**: `vps-transcoder-api/src/app.js`

```javascript
const RecordingRecoveryManager = require('./services/RecordingRecoveryManager');

async function startServer() {
  // 1. åˆå§‹åŒ–æ¢å¤ç®¡ç†å™¨
  const recoveryManager = new RecordingRecoveryManager();
  
  // 2. æ‰§è¡Œå¯åŠ¨æ¢å¤ï¼ˆåœ¨åå°è¿›è¡Œï¼Œä¸é˜»å¡æœåŠ¡å¯åŠ¨ï¼‰
  recoveryManager.recoverOnStartup().catch(err => {
    logger.error('Recovery process failed:', err);
  });
  
  // 3. å¯åŠ¨ExpressæœåŠ¡å™¨
  app.listen(PORT, () => {
    logger.info(`Server started on port ${PORT}`);
  });
}

startServer();
```

### 4.3 éƒ¨ç½²å’ŒéªŒè¯

```bash
# æäº¤ä»£ç 
git add vps-transcoder-api/src/services/RecordingRecoveryManager.js
git add vps-transcoder-api/src/app.js
git commit -m "feat: æ·»åŠ å½•åˆ¶æ–‡ä»¶è‡ªåŠ¨ä¿®å¤æœºåˆ¶"
git push

# éƒ¨ç½²åˆ°VPS
ssh root@142.171.75.220 "cd /tmp/github/secure-streaming-platform/vps-transcoder-api && ./vps-simple-deploy.sh"

# é‡å¯æœåŠ¡è§‚å¯Ÿä¿®å¤æ—¥å¿—
ssh root@142.171.75.220 "pm2 restart vps-transcoder-api && pm2 logs --lines 50"
```

**éªŒè¯æ¸…å•**:
- [ ] æœåŠ¡å¯åŠ¨æ—¶æ‰§è¡Œæ¢å¤æµç¨‹
- [ ] æŸåæ–‡ä»¶è¢«æ£€æµ‹åˆ°
- [ ] ä¿®å¤æµç¨‹æ­£å¸¸æ‰§è¡Œ
- [ ] ä¿®å¤æ—¥å¿—å®Œæ•´

âœ… å®Œæˆåæ›´æ–°è¿›åº¦è¡¨

---

## ğŸ¯ é˜¶æ®µ5ï¼šå‰ç«¯ç®¡ç†ç•Œé¢

**ç›®æ ‡**ï¼šåœ¨é¢‘é“ç®¡ç†é¡µé¢æ·»åŠ å½•åˆ¶æ§åˆ¶åŠŸèƒ½  
**å½±å“èŒƒå›´**ï¼šfrontend/src/views/admin/ChannelManagement.vue  
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½  
**é¢„è®¡æ—¶é—´**ï¼š45åˆ†é’Ÿ

### 5.1 æ·»åŠ å½•åˆ¶é…ç½®API

**åˆ›å»ºæ–‡ä»¶**: `frontend/src/services/recordingApi.js`

```javascript
import axios from 'axios';

const API_BASE = process.env.VUE_APP_API_URL;

export default {
  // è·å–å½•åˆ¶é…ç½®
  async getRecordingConfig(channelId) {
    return axios.get(`${API_BASE}/api/recording/config/${channelId}`);
  },
  
  // æ›´æ–°å½•åˆ¶é…ç½®
  async updateRecordingConfig(channelId, config) {
    return axios.put(`${API_BASE}/api/recording/config/${channelId}`, config);
  },
  
  // è·å–å½•åˆ¶æ–‡ä»¶åˆ—è¡¨
  async getRecordingFiles(channelId, params) {
    return axios.get(`${API_BASE}/api/recording/files`, {
      params: { channel_id: channelId, ...params }
    });
  }
};
```

### 5.2 ä¿®æ”¹é¢‘é“ç®¡ç†ç•Œé¢

**ä¿®æ”¹æ–‡ä»¶**: `frontend/src/views/admin/ChannelManagement.vue`

åœ¨é¢‘é“åˆ—è¡¨ä¸­æ·»åŠ å½•åˆ¶å¼€å…³ï¼š

```vue
<template>
  <el-table :data="channels">
    <!-- ç°æœ‰åˆ— -->
    
    <!-- æ–°å¢ï¼šå½•åˆ¶åˆ— -->
    <el-table-column label="å½•åˆ¶" width="100">
      <template #default="{ row }">
        <el-switch
          v-model="row.recordingEnabled"
          @change="handleRecordingToggle(row)"
          :loading="row.recordingLoading"
        />
      </template>
    </el-table-column>
    
    <!-- æ–°å¢ï¼šå½•åˆ¶é…ç½®æŒ‰é’® -->
    <el-table-column label="æ“ä½œ" width="200">
      <template #default="{ row }">
        <el-button @click="openRecordingConfig(row)">
          å½•åˆ¶é…ç½®
        </el-button>
      </template>
    </el-table-column>
  </el-table>
  
  <!-- å½•åˆ¶é…ç½®å¯¹è¯æ¡† -->
  <el-dialog v-model="recordingDialogVisible" title="å½•åˆ¶é…ç½®">
    <el-form :model="recordingForm">
      <el-form-item label="å¼€å§‹æ—¶é—´">
        <el-time-picker v-model="recordingForm.startTime" format="HH:mm" />
      </el-form-item>
      <el-form-item label="ç»“æŸæ—¶é—´">
        <el-time-picker v-model="recordingForm.endTime" format="HH:mm" />
      </el-form-item>
      <el-form-item label="ä¿ç•™å¤©æ•°">
        <el-input-number v-model="recordingForm.retentionDays" :min="1" :max="7" />
      </el-form-item>
    </el-form>
    <template #footer>
      <el-button @click="recordingDialogVisible = false">å–æ¶ˆ</el-button>
      <el-button type="primary" @click="saveRecordingConfig">ä¿å­˜</el-button>
    </template>
  </el-dialog>
</template>

<script setup>
import recordingApi from '@/services/recordingApi';

// åˆ‡æ¢å½•åˆ¶å¼€å…³
async function handleRecordingToggle(channel) {
  channel.recordingLoading = true;
  try {
    await recordingApi.updateRecordingConfig(channel.id, {
      enabled: channel.recordingEnabled
    });
    ElMessage.success('å½•åˆ¶è®¾ç½®å·²æ›´æ–°');
  } catch (error) {
    channel.recordingEnabled = !channel.recordingEnabled;
    ElMessage.error('æ›´æ–°å¤±è´¥ï¼š' + error.message);
  } finally {
    channel.recordingLoading = false;
  }
}
</script>
```

### 5.3 éƒ¨ç½²å‰ç«¯

```bash
cd frontend
npm run build

# è‡ªåŠ¨éƒ¨ç½²åˆ°Cloudflare Pagesï¼ˆé€šè¿‡GitHubæ¨é€ï¼‰
git add frontend/
git commit -m "feat: æ·»åŠ é¢‘é“å½•åˆ¶ç®¡ç†ç•Œé¢"
git push
```

### 5.4 éªŒè¯æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ‰“å¼€é¢‘é“ç®¡ç†é¡µé¢
2. æ‰¾åˆ°ä»»æ„é¢‘é“ï¼Œå¼€å¯å½•åˆ¶å¼€å…³
3. ç‚¹å‡»"å½•åˆ¶é…ç½®"ï¼Œä¿®æ”¹æ—¶é—´è®¾ç½®
4. éªŒè¯VPSä¸ŠFFmpegè¿›ç¨‹å¯åŠ¨
5. æ£€æŸ¥å½•åˆ¶æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ

**éªŒè¯æ¸…å•**:
- [ ] å½•åˆ¶å¼€å…³æ˜¾ç¤ºæ­£å¸¸
- [ ] å¼€å…³çŠ¶æ€ä¸æ•°æ®åº“åŒæ­¥
- [ ] å½•åˆ¶é…ç½®å¯¹è¯æ¡†æ­£å¸¸æ‰“å¼€
- [ ] é…ç½®ä¿å­˜æˆåŠŸ
- [ ] FFmpegè¿›ç¨‹å·²å¯åŠ¨å½•åˆ¶

âœ… å®Œæˆåæ›´æ–°è¿›åº¦è¡¨

---

## ğŸ¯ é˜¶æ®µ6ï¼šå®šæ—¶ä»»åŠ¡å’Œè‡ªåŠ¨æ¸…ç†

**ç›®æ ‡**ï¼šå®ç°å®šæ—¶å½•åˆ¶å’Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ–‡ä»¶  
**å½±å“èŒƒå›´**ï¼šVPSç«¯æ–°å¢å®šæ—¶ä»»åŠ¡æ¨¡å—  
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­  
**é¢„è®¡æ—¶é—´**ï¼š60åˆ†é’Ÿ

### 6.1 åˆ›å»ºå®šæ—¶ä»»åŠ¡ç®¡ç†å™¨

**åˆ›å»ºæ–‡ä»¶**: `vps-transcoder-api/src/services/ScheduledTaskManager.js`

```javascript
const cron = require('node-cron');

class ScheduledTaskManager {
  constructor(simpleStreamManager) {
    this.streamManager = simpleStreamManager;
    this.tasks = new Map();
    this.cleanupHour = process.env.RECORDINGS_CLEANUP_HOUR || 3;
    this.retentionDays = process.env.RECORDINGS_RETENTION_DAYS || 2;
  }
  
  // å¯åŠ¨æ‰€æœ‰å®šæ—¶ä»»åŠ¡
  startAllTasks() {
    this.startRecordingSchedule();
    this.startCleanupSchedule();
  }
  
  // å®šæ—¶å½•åˆ¶ä»»åŠ¡ï¼ˆæ¯å¤©7:50å¯åŠ¨ï¼Œ17:20åœæ­¢ï¼‰
  startRecordingSchedule() {
    // æ¯å¤©7:50å¯åŠ¨å½•åˆ¶
    cron.schedule('50 7 * * *', async () => {
      await this.startDailyRecording();
    });
    
    // æ¯å¤©17:20åœæ­¢å½•åˆ¶
    cron.schedule('20 17 * * *', async () => {
      await this.stopDailyRecording();
    });
  }
  
  // å®šæ—¶æ¸…ç†ä»»åŠ¡ï¼ˆå‡Œæ™¨3ç‚¹ï¼‰
  startCleanupSchedule() {
    const hour = this.cleanupHour;
    cron.schedule(`0 ${hour} * * *`, async () => {
      await this.cleanupOldRecordings();
    });
  }
  
  // æ¸…ç†è¿‡æœŸæ–‡ä»¶
  async cleanupOldRecordings() {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - this.retentionDays);
    
    // éå†æ‰€æœ‰é¢‘é“ç›®å½•
    const channels = await fs.readdir(this.recordingsDir);
    for (const channelDir of channels) {
      const files = await fs.readdir(path.join(this.recordingsDir, channelDir));
      
      for (const file of files) {
        const filePath = path.join(this.recordingsDir, channelDir, file);
        const stats = await fs.stat(filePath);
        
        if (stats.mtime < cutoffDate) {
          await fs.unlink(filePath);
          logger.info('Deleted old recording', { file, age: stats.mtime });
        }
      }
    }
  }
}

module.exports = ScheduledTaskManager;
```

### 6.2 é›†æˆåˆ°app.js

**ä¿®æ”¹æ–‡ä»¶**: `vps-transcoder-api/src/app.js`

```javascript
const ScheduledTaskManager = require('./services/ScheduledTaskManager');

async function startServer() {
  // ... ç°æœ‰ä»£ç 
  
  // å¯åŠ¨å®šæ—¶ä»»åŠ¡
  const taskManager = new ScheduledTaskManager(simpleStreamManager);
  taskManager.startAllTasks();
  
  logger.info('Scheduled tasks started');
}
```

### 6.3 å®‰è£…ä¾èµ–

**æœ¬åœ°å®‰è£…**ï¼š
```bash
cd vps-transcoder-api
npm install node-cron --save
```

è¿™ä¼šæ›´æ–° `package.json` å’Œ `package-lock.json` æ–‡ä»¶ã€‚

### 6.4 æ›´æ–°VPSéƒ¨ç½²è„šæœ¬ â­é‡è¦

âš ï¸ **å¿…é¡»åŒæ­¥ä¿®æ”¹éƒ¨ç½²è„šæœ¬ï¼Œç¡®ä¿VPSéƒ¨ç½²æ—¶è‡ªåŠ¨å®‰è£…æ–°ä¾èµ–ï¼**

**ä¿®æ”¹æ–‡ä»¶**: `vps-transcoder-api/vps-simple-deploy.sh`

åœ¨éƒ¨ç½²è„šæœ¬ä¸­æ·»åŠ ä¾èµ–å®‰è£…æ­¥éª¤ï¼ˆæä¾›ä¸¤ç§æ–¹æ¡ˆï¼‰ï¼š

**æ–¹æ¡ˆ1: æ™ºèƒ½å®‰è£…ï¼ˆæ¨èï¼Œæ›´å¿«ï¼‰**
```bash
# åœ¨é‡å¯æœåŠ¡å‰æ·»åŠ ï¼š
echo "ğŸ“¦ Checking dependencies..."
cd /opt/yoyo-transcoder

# åªåœ¨package.jsonå˜åŒ–æˆ–node_modulesç¼ºå¤±æ—¶å®‰è£…
if ! cmp -s package.json package.json.old 2>/dev/null || [ ! -d node_modules ]; then
  echo "ğŸ“¦ Dependencies changed or missing, installing..."
  npm ci --production
  cp package.json package.json.old
else
  echo "âœ… Dependencies up to date, skipping install"
fi
```

**æ–¹æ¡ˆ2: ç®€å•ç‰ˆæœ¬ï¼ˆæ€»æ˜¯å®‰è£…ï¼Œä½†npmä¼šè‡ªåŠ¨ä¼˜åŒ–ï¼‰**
```bash
echo "ğŸ“¦ Installing dependencies..."
cd /opt/yoyo-transcoder
npm install --production  # å¹‚ç­‰æ“ä½œï¼Œä¸ä¼šæŠ¥é”™
```

**å®Œæ•´å»ºè®®çš„éƒ¨ç½²æµç¨‹**ï¼š
```bash
#!/bin/bash
# vps-simple-deploy.sh å®Œæ•´ç¤ºä¾‹

echo "ğŸš€ Starting deployment..."

# 1. åŒæ­¥ä»£ç 
echo "ğŸ“ Syncing source code..."
cp -r /tmp/github/secure-streaming-platform/vps-transcoder-api/src/* /opt/yoyo-transcoder/src/

# 2. åŒæ­¥package.jsonï¼ˆç¡®ä¿ä¾èµ–å®šä¹‰æœ€æ–°ï¼‰
echo "ğŸ“¦ Syncing package.json..."
cp /tmp/github/secure-streaming-platform/vps-transcoder-api/package.json /opt/yoyo-transcoder/

# 3. æ™ºèƒ½å®‰è£…ä¾èµ–
cd /opt/yoyo-transcoder
if ! cmp -s package.json package.json.old 2>/dev/null || [ ! -d node_modules ]; then
  echo "ğŸ“¦ Installing dependencies..."
  npm ci --production
  cp package.json package.json.old
else
  echo "âœ… Dependencies up to date"
fi

# 4. é‡å¯æœåŠ¡
echo "ğŸ”„ Reloading service..."
pm2 reload vps-transcoder-api

echo "âœ… Deployment completed!"
```

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- âŒ ä¸æ›´æ–°éƒ¨ç½²è„šæœ¬ â†’ VPSç¼ºå°‘node-cron â†’ å®šæ—¶ä»»åŠ¡åŠŸèƒ½æ— æ³•å¯åŠ¨ â†’ é˜¶æ®µ6å¤±è´¥
- âœ… æ›´æ–°éƒ¨ç½²è„šæœ¬ â†’ è‡ªåŠ¨å®‰è£…ä¾èµ– â†’ æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

**npm install vs npm ci**ï¼š
| å‘½ä»¤ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| `npm install` | å¹‚ç­‰æ“ä½œï¼Œå¯é‡å¤æ‰§è¡Œ | å¼€å‘ç¯å¢ƒ |
| `npm ci` | åˆ é™¤node_modulesé‡æ–°å®‰è£…ï¼Œæ›´å¿«æ›´å¯é  | ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² â­æ¨è |

### 6.5 éƒ¨ç½²å’ŒéªŒè¯

```bash
# 1. æäº¤ä»£ç ï¼ˆåŒ…æ‹¬package.jsonå’Œéƒ¨ç½²è„šæœ¬ï¼‰
git add vps-transcoder-api/package.json
git add vps-transcoder-api/package-lock.json
git add vps-transcoder-api/vps-simple-deploy.sh
git add vps-transcoder-api/src/services/ScheduledTaskManager.js
git add vps-transcoder-api/src/app.js
git commit -m "feat: æ·»åŠ å®šæ—¶å½•åˆ¶å’Œè‡ªåŠ¨æ¸…ç†åŠŸèƒ½

- æ–°å¢ScheduledTaskManagerå®šæ—¶ä»»åŠ¡ç®¡ç†å™¨
- é›†æˆnode-cronå®ç°å®šæ—¶å½•åˆ¶å’Œæ¸…ç†
- æ›´æ–°éƒ¨ç½²è„šæœ¬æ”¯æŒä¾èµ–è‡ªåŠ¨å®‰è£…
"
git push

# 2. åŒæ­¥åˆ°VPS Gitç›®å½•
ssh root@142.171.75.220 "cd /tmp/github/secure-streaming-platform && git pull"

# 3. æ‰§è¡Œéƒ¨ç½²è„šæœ¬ï¼ˆä¼šè‡ªåŠ¨å®‰è£…ä¾èµ–ï¼‰
ssh root@142.171.75.220 "/tmp/github/secure-streaming-platform/vps-transcoder-api/vps-simple-deploy.sh"

# 4. éªŒè¯ä¾èµ–å®‰è£…
ssh root@142.171.75.220 "cd /opt/yoyo-transcoder && npm list node-cron"
```

**éªŒè¯æ¸…å•**:
- [ ] node-cronå·²å®‰è£…
- [ ] å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨
- [ ] 7:50è‡ªåŠ¨å¼€å§‹å½•åˆ¶
- [ ] 17:20è‡ªåŠ¨åœæ­¢å½•åˆ¶
- [ ] å‡Œæ™¨3ç‚¹æ¸…ç†è¿‡æœŸæ–‡ä»¶

âœ… å®Œæˆåæ›´æ–°è¿›åº¦è¡¨

---

## ğŸ¯ é˜¶æ®µ7ï¼šå®Œæ•´é›†æˆæµ‹è¯•

**ç›®æ ‡**ï¼šéªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œå‹åŠ›æµ‹è¯•  
**å½±å“èŒƒå›´**ï¼šå…¨ç³»ç»Ÿ  
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½ï¼ˆä»…æµ‹è¯•ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š120åˆ†é’Ÿ

### 7.1 åŠŸèƒ½æµ‹è¯•æ¸…å•

**åŸºç¡€åŠŸèƒ½**:
- [ ] æ‰‹åŠ¨å¯åŠ¨/åœæ­¢å½•åˆ¶
- [ ] å®šæ—¶è‡ªåŠ¨å½•åˆ¶ï¼ˆ7:50-17:20ï¼‰
- [ ] åˆ†æ®µå½•åˆ¶ï¼ˆæ¯1å°æ—¶åˆ‡æ¢æ–‡ä»¶ï¼‰
- [ ] æ–‡ä»¶å‘½åæ ¼å¼æ­£ç¡®
- [ ] D1æ•°æ®åº“è®°å½•åŒæ­¥

**é«˜çº§åŠŸèƒ½**:
- [ ] é…ç½®å˜æ›´è‡ªåŠ¨é‡å¯FFmpeg
- [ ] è¿›ç¨‹å´©æºƒåè‡ªåŠ¨ä¿®å¤æ–‡ä»¶
- [ ] æœåŠ¡é‡å¯åæ¢å¤å½•åˆ¶çŠ¶æ€
- [ ] è¿‡æœŸæ–‡ä»¶è‡ªåŠ¨æ¸…ç†
- [ ] å½•åˆ¶ä¸å½±å“HLSæ’­æ”¾

### 7.2 å‹åŠ›æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
```bash
# åŒæ—¶å½•åˆ¶8ä¸ªé¢‘é“
for i in {1..8}; do
  curl -X POST https://yoyo-vps.5202021.xyz/api/simple-stream/start-watching \
    -H "X-API-Key: YOUR_KEY" \
    -d "{
      \"channelId\": \"stream_$i\",
      \"rtmpUrl\": \"rtmp://source$i/live\",
      \"options\": {\"recordingConfig\": {\"enabled\": true}}
    }"
done

# ç›‘æ§ç³»ç»Ÿèµ„æº
ssh root@142.171.75.220 "top -b -n 1 | head -20"
```

**æ€§èƒ½æŒ‡æ ‡**:
- [ ] CPUä½¿ç”¨ç‡ < 80%
- [ ] å†…å­˜ä½¿ç”¨ < 4GB
- [ ] ç£ç›˜I/Oæ­£å¸¸
- [ ] æ‰€æœ‰é¢‘é“å½•åˆ¶æ­£å¸¸

### 7.3 å¼‚å¸¸æµ‹è¯•

**æµ‹è¯•1ï¼šè¿›ç¨‹å´©æºƒæ¢å¤**
```bash
# å¼ºåˆ¶ç»ˆæ­¢FFmpegè¿›ç¨‹
ssh root@142.171.75.220 "pkill -9 ffmpeg"

# é‡å¯æœåŠ¡
ssh root@142.171.75.220 "pm2 restart vps-transcoder-api"

# éªŒè¯æ–‡ä»¶ä¿®å¤
ssh root@142.171.75.220 "ls -la /var/recordings/*/
```

**æµ‹è¯•2ï¼šç£ç›˜ç©ºé—´ä¸è¶³**
```bash
# æ¨¡æ‹Ÿç£ç›˜æ»¡ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
# éªŒè¯é”™è¯¯å¤„ç†å’Œå‘Šè­¦
```

**æµ‹è¯•3ï¼šç½‘ç»œä¸­æ–­**
```bash
# æ–­å¼€RTMPæº
# éªŒè¯å½•åˆ¶åœæ­¢å’Œé”™è¯¯è®°å½•
```

### 7.4 éªŒè¯æŠ¥å‘Š

å®Œæˆæ‰€æœ‰æµ‹è¯•åï¼Œå¡«å†™éªŒè¯æŠ¥å‘Šï¼š

**åŠŸèƒ½éªŒè¯**: âœ…/âŒ  
**æ€§èƒ½éªŒè¯**: âœ…/âŒ  
**å¼‚å¸¸å¤„ç†**: âœ…/âŒ  
**æ–‡æ¡£å®Œæ•´æ€§**: âœ…/âŒ

**å‘ç°çš„é—®é¢˜**ï¼š
1. é—®é¢˜æè¿°
2. å½±å“èŒƒå›´
3. è§£å†³æ–¹æ¡ˆ
4. æ˜¯å¦é˜»å¡ä¸Šçº¿

âœ… å®Œæˆåæ›´æ–°è¿›åº¦è¡¨ï¼Œæ ‡è®°é¡¹ç›®å®Œæˆ

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœä»»ä½•é˜¶æ®µå¤±è´¥ï¼Œç«‹å³æ‰§è¡Œå›æ»šï¼š

```bash
# å›æ»šåˆ°å¤‡ä»½
$timestamp = "YOUR_BACKUP_TIMESTAMP"
Copy-Item "backups\$timestamp\*" -Destination "å¯¹åº”ç›®å½•" -Force

# é‡æ–°éƒ¨ç½²Workers
cd cloudflare-worker
npx wrangler deploy --env production

# é‡æ–°éƒ¨ç½²VPS
ssh root@142.171.75.220 "cd /tmp/github && ./vps-simple-deploy.sh"
```

---

## ğŸ“Œ é‡è¦æé†’

1. âš ï¸ **ä¿®æ”¹é…ç½®ä¼šå¯¼è‡´é‡å¯** - å½±å“è§‚çœ‹ç”¨æˆ·7ç§’
2. âš ï¸ **VPSæ— æ³•ç›´æ¥è®¿é—®D1** - å¿…é¡»é€šè¿‡Workers API
3. âš ï¸ **ç£ç›˜ç©ºé—´ç›‘æ§** - 8é¢‘é“2å¤©çº¦109GB
4. âš ï¸ **æ–‡ä»¶æƒé™** - ç¡®ä¿/var/recordingså¯å†™
5. âš ï¸ **åˆ†æ®µå½•åˆ¶** - æ¯1å°æ—¶è‡ªåŠ¨åˆ‡æ¢æ–‡ä»¶

---

**æ–‡æ¡£ç»´æŠ¤è€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2025-10-24 22:45 (UTC+8)  
**æ–‡æ¡£çŠ¶æ€**: âœ… åˆå§‹ç‰ˆæœ¬å®Œæˆ